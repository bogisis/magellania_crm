# Quote Calculator v3.0 - Common Nginx Configuration
# Shared configuration for HTTP and HTTPS servers
# Includes location blocks, security headers, and proxy settings

# ============================================================================
# Security Headers (context7 best practices)
# ============================================================================

# Prevent clickjacking attacks
add_header X-Frame-Options "DENY" always;

# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# Enable XSS protection (legacy browsers)
add_header X-XSS-Protection "1; mode=block" always;

# Referrer policy
add_header Referrer-Policy "no-referrer-when-downgrade" always;

# Content Security Policy (strict)
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'none';" always;

# Strict Transport Security (HSTS) - uncomment when SSL is configured
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

# Permissions Policy (formerly Feature-Policy)
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

# ============================================================================
# Root Location - Static Frontend
# ============================================================================

location / {
    # Proxy to backend Node.js server which serves index.html
    proxy_pass http://quote_backend;

    # Proxy headers (context7 best practices)
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $server_name;

    # Timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Buffering
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;

    # Rate limiting (general)
    limit_req zone=api_limit burst=20 nodelay;
}

# ============================================================================
# API Endpoints
# ============================================================================

# Health check endpoint
location /api/health {
    proxy_pass http://quote_backend;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Rate limiting (5 req/s for health checks)
    limit_req zone=health_limit burst=10 nodelay;

    # No security headers needed for health checks
    access_log off;
}

# Export/Import endpoints (resource-intensive)
location ~ ^/api/(export|import) {
    proxy_pass http://quote_backend;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Extended timeouts for large exports/imports
    proxy_connect_timeout 120s;
    proxy_send_timeout 120s;
    proxy_read_timeout 120s;

    # Large body size for imports
    client_max_body_size 50m;

    # Rate limiting (1 req/s for exports/imports)
    limit_req zone=export_limit burst=3 nodelay;

    # Basic auth (optional - uncomment to enable)
    # auth_basic "Restricted Access";
    # auth_basic_user_file /etc/nginx/.htpasswd;
}

# General API endpoints
location /api/ {
    proxy_pass http://quote_backend;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Standard timeouts
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # Rate limiting (10 req/s general)
    limit_req zone=api_limit burst=20 nodelay;

    # Basic auth (optional - uncomment to enable)
    # auth_basic "Restricted Access";
    # auth_basic_user_file /etc/nginx/.htpasswd;
}

# ============================================================================
# Static Files (if served directly from nginx instead of Node.js)
# ============================================================================

# Uncomment if you want nginx to serve static files directly
# location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
#     root /usr/share/nginx/html;
#     expires 1y;
#     add_header Cache-Control "public, immutable";
#     access_log off;
# }

# ============================================================================
# Error Pages
# ============================================================================

error_page 404 /404.html;
error_page 500 502 503 504 /50x.html;

location = /50x.html {
    internal;
    root /usr/share/nginx/html;
}

location = /404.html {
    internal;
    root /usr/share/nginx/html;
}

# ============================================================================
# Let's Encrypt ACME Challenge
# ============================================================================

# Allow access to .well-known for SSL certificate verification
location ~ ^/.well-known/acme-challenge/ {
    allow all;
    root /var/www/certbot;
    default_type "text/plain";
    try_files $uri =404;
}

# ============================================================================
# Security: Block Access to Hidden Files
# ============================================================================

# Block all hidden files EXCEPT .well-known
location ~ /\.(?!well-known) {
    deny all;
    access_log off;
    log_not_found off;
}

# ============================================================================
# Monitoring: Nginx Status (optional, for debugging)
# ============================================================================

# Uncomment to enable nginx status page (only accessible from localhost)
# location /nginx_status {
#     stub_status on;
#     access_log off;
#     allow 127.0.0.1;
#     deny all;
# }
