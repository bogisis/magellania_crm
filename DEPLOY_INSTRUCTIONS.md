# Инструкция по деплою исправления импорта каталога

## Что было исправлено

✅ **Импорт каталога теперь сохраняет данные на сервер**, а не только в localStorage

## Шаги для деплоя на production

### 1. Загрузить исправленный файл на VPS

```bash
# С локальной машины
scp index.html user@your-vps:/path/to/quote-calculator/
```

**ИЛИ** если у вас git на VPS:

```bash
# На VPS
cd /path/to/quote-calculator
git pull  # если используете git
# или просто замените index.html вручную
```

### 2. Перезапустить сервер (если нужно)

```bash
# На VPS - если используете pm2
pm2 restart quote-calculator

# Или если используете systemd
sudo systemctl restart quote-calculator

# Или просто node
pkill -f "node server-with-db.js"
node server-with-db.js &
```

### 3. Проверить что исправление работает

1. Откройте приложение в браузере
2. Перейдите в раздел "Каталог"
3. Нажмите "Загрузить каталог"
4. Выберите файл каталога (JSON формат)
5. **Проверьте консоль браузера (F12)**:
   - Должно быть сообщение: `Catalog for region [region_name] saved to server`
   - НЕ должно быть ошибок

6. Экспортируйте все данные:
   - Нажмите "Экспортировать все данные"
   - Скачайте файл `quote-calculator-export-*.json`
   - Откройте файл и проверьте что `data.catalogs` не пустой:
     ```json
     {
       "version": "2.3.0",
       "data": {
         "catalogs": [
           {
             "filename": "catalog_cuba.json",
             "data": { ... }  // ← Должны быть данные!
           }
         ]
       }
     }
     ```

### 4. Импорт каталога после деплоя

Теперь вы можете импортировать каталог двумя способами:

#### Способ 1: Через файл полного экспорта (рекомендуется)

1. Создайте полный экспорт на старой системе
2. Импортируйте через "Импортировать данные"
3. **Теперь каталоги будут импортированы!** ✅

#### Способ 2: Через отдельный файл каталога

1. Экспортируйте каталог из старой системы (`catalog.json`)
2. Импортируйте через "Загрузить каталог"
3. **Каталог будет сохранён на сервер!** ✅

## Решение проблем (Troubleshooting)

### Проблема: Каталог импортируется, но не отображается в экспорте

**Решение**: Проверьте консоль браузера при импорте. Если видите:
```
Failed to save catalog to server: [error message]
```

Это означает что:
- Сервер не запущен
- Нет соединения с сервером
- Ошибка в API endpoint

**Действия**:
1. Проверьте что сервер запущен: `curl http://your-server:3000/api/catalog/list`
2. Проверьте логи сервера
3. Проверьте что БД SQLite доступна для записи

### Проблема: Ошибка "Неверный формат файла экспорта"

**Причина**: Вы пытаетесь импортировать отдельный файл каталога через "Импортировать данные"

**Решение**:
- Для отдельных файлов каталога используйте "Загрузить каталог"
- Для полного экспорта используйте "Импортировать данные"

### Проблема: После импорта каталог пустой

**Решение**:
1. Проверьте формат файла каталога
2. Убедитесь что файл содержит `templates` и `categories`
3. Проверьте консоль браузера на ошибки

## Откат (Rollback)

Если что-то пошло не так:

```bash
# На VPS
cd /path/to/quote-calculator
git checkout HEAD~1 index.html  # если используете git
# или восстановите из бэкапа
cp index.html.backup index.html

# Перезапустить сервер
pm2 restart quote-calculator
```

## Проверка успешного деплоя

✅ Каталог импортируется через "Загрузить каталог"
✅ В консоли: `Catalog for region X saved to server`
✅ Каталог отображается в экспорте "Экспортировать все данные"
✅ Каталог доступен другим пользователям (если multi-tenant)
✅ Нет ошибок в консоли браузера
✅ Нет ошибок в логах сервера

---

**Дата**: 17 ноября 2025
**Версия**: 2.3.0
**Приоритет**: P0 (критический)
