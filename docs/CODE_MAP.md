# CODE MAP –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤

**–í–µ—Ä—Å–∏—è:** 1.0.0
**–°–æ–∑–¥–∞–Ω–æ:** 6 –Ω–æ—è–±—Ä—è 2025
**–î–ª—è –ø—Ä–æ–µ–∫—Ç–∞:** Quote Calculator v2.3.0

‚ö° **QUICK START –¥–ª—è Claude Code:**
–ü—Ä–∏ –ª—é–±–æ–π –∑–∞–¥–∞—á–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –°–ù–ê–ß–ê–õ–ê —á–∏—Ç–∞–π—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é —ç—Ç–æ–≥–æ —Ñ–∞–π–ª–∞!

---

## üìã –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º –∑–∞–¥–∞—á

**Bug fixing** ‚Üí [Known Issues & Race Conditions](#known-issues)
**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è** ‚Üí [Architecture Overview](#architecture) + [Feature Map](#features)
**–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥** ‚Üí [Refactoring Guidelines](#refactoring)
**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ‚Üí [Integration Points](#integration)
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** ‚Üí [Testing Map](#testing)

---

## üèóÔ∏è Architecture Overview {#architecture}

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Å–ª–æ–∏

**1. Presentation Layer (UI)**
- DOM manipulation: index.html:2000-5000
- Event handlers: index.html:5000-6500
- Rendering functions: index.html:7000-8500

**2. Business Logic Layer**
- **Calculations (–ö–†–ò–¢–ò–ß–ù–û):** index.html:6578-6700
- Validation: index.html:4500-4800
- State management: index.html:1200-1500

**3. Data Layer**
- State object: index.html:1234 (this.state)
- localStorage interaction: index.html:8000-9000
- API client: index.html:1500-2000

**4. Storage/Backend Layer**
- server.js: Express API
- FileStorage: server.js:100-200
- SQLiteStorage: storage/SQLiteStorage.js (NEW v2.3.0)
- server-with-db.js: SQLite integration

### Data Flow

```
User Action (UI)
  ‚Üì
Event Handler (lines 5000-6500)
  ‚Üì
Update State (this.state)
  ‚Üì
Business Logic (calculations)
  ‚Üì
Render UI (renderDetails, updateCalculations)
  ‚Üì
Autosave (debounced 1sec)
  ‚Üì
API call (APIClient)
  ‚Üì
Backend storage (File/SQLite)
```

**‚ö†Ô∏è Critical Points:** Race conditions –≤–æ–∑–º–æ–∂–Ω—ã –º–µ–∂–¥—É autosave –∏ load operations

---

## üó∫Ô∏è Feature Map - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ {#features}

### 1. updateCalculations() - –°–ï–†–î–¶–ï –°–ò–°–¢–ï–ú–´

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `index.html:6578-6700` (~120 —Å—Ç—Ä–æ–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞—Å—á—ë—Ç–∞ –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π —Å–º–µ—Ç—ã.
‚ö†Ô∏è **–ë–ò–ó–ù–ï–°-–õ–û–ì–ò–ö–ê –ö–†–ò–¢–ò–ß–ù–ê** - –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è!

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –ë–∞–∑–æ–≤–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (`baseCost`) = —Å—É–º–º–∞(—Ü–µ–Ω–∞ √ó –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ) –¥–ª—è –≤—Å–µ—Ö —É—Å–ª—É–≥
2. –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–∞—Ü–µ–Ω–∫–∏ –Ω–∞ –∫–∞–∂–¥—É—é —É—Å–ª—É–≥—É (`individualMarkupAmount`)
3. –°–∫—Ä—ã—Ç–∞—è –º–∞—Ä–∂–∞ (`hiddenMarkupAmount`) = % –æ—Ç –±–∞–∑–æ–≤–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –Ω–µ–∏—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö —É—Å–ª—É–≥
4. –ö–æ–º–∏—Å—Å–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞ (`partnerCommissionAmount`) = % –æ—Ç —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏
5. –£—Å–ª—É–≥–∏ "–≤—Å—è —Å—É–º–º–∞ –≤ –ø—Ä–∏–±—ã–ª—å" (`fullProfitAmount`)
6. –ò—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—É = –±–∞–∑–æ–≤–∞—è + –∏–Ω–¥–∏–≤.–Ω–∞—Ü–µ–Ω–∫–∏ + —Å–∫—Ä—ã—Ç–∞—è –º–∞—Ä–∂–∞ + –∫–æ–º–∏—Å—Å–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä–∞

**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ (callers):**
- `addService()` - line 2989
- `removeService()` - line 3326
- `updateService()` - line 3428, 3454
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ PAX, –Ω–∞—Ü–µ–Ω–æ–∫, –∫–æ–º–∏—Å—Å–∏–∏

**–í—ã–∑—ã–≤–∞–µ—Ç (callees):**
- `calculateServiceTotal(service)` - line 6596
- `formatCurrency()` - lines 6642, 6653, 6665, 6674

**UI —ç–ª–µ–º–µ–Ω—Ç—ã (–æ–±–Ω–æ–≤–ª—è–µ—Ç DOM):**
- `#cost-price` - —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å
- `#individual-markup-amount` - —Å—É–º–º–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–∞—Ü–µ–Ω–æ–∫
- `#hidden-markup-amount` - —Å–∫—Ä—ã—Ç–∞—è –º–∞—Ä–∂–∞
- `#grand-total` - –∏—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç—É
- `#profit-analysis` - –∞–Ω–∞–ª–∏–∑ –ø—Ä–∏–±—ã–ª–∏

**Performance:**
- –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —É—Å–ª—É–≥
- –ù–ï debounced (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
- –ü—Ä–∏ 100+ —É—Å–ª—É–≥–∞—Ö –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ~50-100ms

**–¢–µ—Å—Ç—ã:**
- ‚ùå Frontend unit tests: –ù–ï–¢ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –º–æ–¥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏)
- ‚úÖ Manual testing: —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**Known Issues:**
- ‚ö†Ô∏è –ü—Ä–∏ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ —É—Å–ª—É–≥ (1000+) –º–æ–∂–µ—Ç —Ç–æ—Ä–º–æ–∑–∏—Ç—å
- ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û v2.2.0: Race condition —Å autosave –≤–æ –≤—Ä–µ–º—è loadQuote()

**–ù–ï –ú–ï–ù–Ø–¢–¨ –±–µ–∑:**
1. ‚úÖ –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è —Å –±–∏–∑–Ω–µ—Å–æ–º (—Ñ–æ—Ä–º—É–ª—ã —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω—ã)
2. ‚úÖ –ü–æ–Ω–∏–º–∞–Ω–∏—è –≤—Å–µ—Ö callers
3. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∏—è–Ω–∏—è –Ω–∞ UI
4. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

---

### 2. saveQuoteJSON() - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `index.html:8921-9050` (~130 —Å—Ç—Ä–æ–∫)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Å–º–µ—Ç—ã –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ (–≤ —Ñ–∞–π–ª –∏ –±—ç–∫–∞–ø).

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
2. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSON –æ–±—ä–µ–∫—Ç–∞ —Å metadata
3. –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (POST /api/estimates)
4. –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞ (POST /api/backups)
5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI —Å—Ç–∞—Ç—É—Å–∞

**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑:**
- UI button - line 1964 (–º–µ–Ω—é "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å")
- Autosave - line 11289
- Keyboard shortcut (Ctrl+S)

**–í—ã–∑—ã–≤–∞–µ—Ç:**
- `apiClient.saveEstimate(data, filename)`
- `apiClient.saveBackup(data, id)`

**–§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:**
```javascript
{
  version: "1.1.0",
  metadata: {
    appVersion: "2.3.0",
    createdAt: timestamp,
    updatedAt: timestamp
  },
  state: {
    services: [...],
    hotels: [...],
    flights: [...],
    paxCount: number,
    hiddenMarkup: number,
    // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
  }
}
```

**Validation:**
- ‚ùå Email validation: –ù–ï–¢ (TODO: –¥–æ–±–∞–≤–∏—Ç—å)
- ‚úÖ Required fields: –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ
- ‚úÖ File size: –ø—Ä–æ–≤–µ—Ä–∫–∞ < 5MB

**Known Issues:**
- ‚ö†Ô∏è Cyrillic filenames: graceful fallback –µ—Å–ª–∏ rename fails (v2.2.0)
- ‚ö†Ô∏è Dual storage –±–µ–∑ –ø–æ–ª–Ω–æ–π –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ (–º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è estimate/ –∏ backup/)

**Backend endpoints:**
- `POST /api/estimates` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–º–µ—Ç—ã
- `POST /api/backups` - —Å–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞

---

### 3. loadQuoteFromServer() - –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç–æ—á–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:**
–ó–∞–≥—Ä—É–∑–∫–∞ —Å–º–µ—Ç—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
1. GET –∑–∞–ø—Ä–æ—Å –∫ /api/estimates/:id
2. –ü–∞—Ä—Å–∏–Ω–≥ JSON (–ø–æ–¥–¥–µ—Ä–∂–∫–∞ v1.0.0 –∏ v1.1.0)
3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ this.state
4. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ UI
5. –í—ã–∑–æ–≤ updateCalculations()

**–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –º–æ–º–µ–Ω—Ç - Race Condition:**

‚ö†Ô∏è **AUTOSAVE + LOAD RACE CONDITION**
- Autosave —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —á–µ—Ä–µ–∑ 1 —Å–µ–∫ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è state
- loadQuoteFromServer() –º–µ–Ω—è–µ—Ç state —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
- –ï—Å–ª–∏ autosave –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ ‚Üí –º–æ–∂–µ—Ç —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π —Å–º–µ—Ç—ã

**–†–µ—à–µ–Ω–∏–µ (v2.2.0):**
```javascript
loadQuoteFromServer() {
  this.isLoadingQuote = true;  // ‚ö†Ô∏è –ë–ª–æ–∫–∏—Ä—É–µ—Ç autosave
  // ... –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ...
  this.isLoadingQuote = false;
}

scheduleAutosave() {
  if (this.isLoadingQuote) return;  // ‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ guard flag
  // ... —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ...
}
```

**–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑:**
- UI button "–ó–∞–≥—Ä—É–∑–∏—Ç—å"
- –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–º–µ—Ç–∞)

**–°–º–µ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:**
- –ü–æ—Ö–æ–∂–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ `importQuoteFile()`
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å debounced —Ñ—É–Ω–∫—Ü–∏–∏: `updateCalculations()`, `renderDetails()`

---

## ‚ö†Ô∏è Known Issues & Race Conditions {#known-issues}

### 1. Services "sticking" –º–µ–∂–¥—É —Å–º–µ—Ç–∞–º–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–û v2.2.0)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π —Å–º–µ—Ç—ã —É—Å–ª—É–≥–∏ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π "–ø—Ä–∏–ª–∏–ø–∞–ª–∏" –∫ –Ω–æ–≤–æ–π

**–ü—Ä–∏—á–∏–Ω–∞:** Autosave —Å—Ä–∞–±–∞—Ç—ã–≤–∞–ª –≤–æ –≤—Ä–µ–º—è loadQuote(), —Å–æ—Ö—Ä–∞–Ω—è—è —Å—Ç–∞—Ä—ã–µ services

**–†–µ—à–µ–Ω–∏–µ:** Guard flag `isLoadingQuote` –±–ª–æ–∫–∏—Ä—É–µ—Ç autosave –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏

**–ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å:**
- loadQuoteFromServer() - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç isLoadingQuote=true
- scheduleAutosave() - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç isLoadingQuote

---

### 2. Cyrillic filename errors –ø—Ä–∏ rename (–ò–°–ü–†–ê–í–õ–ï–ù–û v2.2.0)

**–ü—Ä–æ–±–ª–µ–º–∞:** ENOENT –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª —Å Cyrillic –∏–º–µ–Ω–µ–º

**–†–µ—à–µ–Ω–∏–µ:** Graceful fallback - –µ—Å–ª–∏ rename fails, —Å–æ–∑–¥–∞—ë—Ç—Å—è –Ω–æ–≤—ã–π —Ñ–∞–π–ª

**–ì–¥–µ —Å–º–æ—Ç—Ä–µ—Ç—å:**
- saveQuoteJSON() - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ rename

---

### 3. Dual storage –±–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏ (–¢–ï–ö–£–©–ê–Ø –ü–†–û–ë–õ–ï–ú–ê)

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
await apiClient.saveEstimate(data, filename);  // –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
await apiClient.saveBackup(data, id);          // –ú–æ–∂–µ—Ç —É–ø–∞—Å—Ç—å
// –ù–µ—Ç –≥–∞—Ä–∞–Ω—Ç–∏–∏, —á—Ç–æ –æ–±–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
```

**–†–∏—Å–∫:** –†–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö estimate/ –∏ backup/

**–ú–∏—Ç–∏–≥–∞—Ü–∏—è:** –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–∞—è –æ–±—ë—Ä—Ç–∫–∞ (v2.4.0)

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P0 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π)

---

## üîå Integration Points {#integration}

### Storage Interface

**–¢–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –î–í–ê –≤–∞—Ä–∏–∞–Ω—Ç–∞ storage

#### 1. File Storage (legacy)
**–§–∞–π–ª:** `server.js:100-200`

–ú–µ—Ç–æ–¥—ã:
- `saveEstimate(data, filename)` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ estimate/
- `loadEstimate(filename)` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ estimate/
- `listEstimates()` - —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Å–º–µ—Ç
- `deleteEstimate(filename)` - —É–¥–∞–ª–∏—Ç—å —Å–º–µ—Ç—É
- `saveBackup(data, id)` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ backup/
- `loadBackup(id)` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ backup/
- `listBackups()` - —Å–ø–∏—Å–æ–∫ –±—ç–∫–∞–ø–æ–≤
- `saveCatalog(data, id)` - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥
- `loadCatalog(id)` - –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥

#### 2. SQLite Storage (NEW v2.3.0)
**–§–∞–π–ª:** `storage/SQLiteStorage.js`

Required interface –¥–ª—è –Ω–æ–≤–æ–≥–æ storage:
```javascript
class StorageInterface {
  async saveEstimate(data, filename) {}
  async loadEstimate(filename) {}
  async listEstimates() {}
  async deleteEstimate(filename) {}
  async saveBackup(data, id) {}
  async loadBackup(id) {}
  async listBackups() {}
  async saveCatalog(data, id) {}
  async loadCatalog(id) {}
}
```

**–ü–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ storage:**
1. ‚úÖ –°–æ–∑–¥–∞—Ç—å FileStorage (–æ–±–µ—Ä–Ω—É—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–¥)
2. ‚úÖ –°–æ–∑–¥–∞—Ç—å SQLiteStorage (–Ω–æ–≤—ã–π)
3. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å factory pattern –¥–ª—è –≤—ã–±–æ—Ä–∞ storage
4. ‚úÖ ENV variable: STORAGE_TYPE=file|sqlite
5. ‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

---

## üîß Refactoring Guidelines {#refactoring}

### CSS Extraction (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è v2.4.0)

**CSS –Ω–∞—Ö–æ–¥–∏—Ç—Å—è:** `index.html:100-1500` (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `<style>`)

**CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ JS:**
- `--primary-color`: —á–∏—Ç–∞–µ—Ç—Å—è –≤ JS –¥–ª—è canvas (–µ—Å–ª–∏ –µ—Å—Ç—å)
- `--animation-duration`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è transitions (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã–µ –∫–ª–∞—Å—Å—ã:**
- `.service-item-{id}`: —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ renderServiceList()
- `.selected-{timestamp}`: —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ highlightService() (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:**
- `.modal-overlay`: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è event delegation
- `.editable`: —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç contenteditable logic (–µ—Å–ª–∏ –µ—Å—Ç—å)

**–ë–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–Ω–æ—Å–∏—Ç—å:**
‚úÖ –í—Å—ë styling, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ JS

**–ü–ª–∞–Ω:**
1. –°–æ–∑–¥–∞—Ç—å `styles.css`
2. –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—Å–µ —Å—Ç–∏–ª–∏ –∫—Ä–æ–º–µ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤ JS
3. –ü–æ–¥–∫–ª—é—á–∏—Ç—å —á–µ—Ä–µ–∑ `<link>`
4. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å UI

---

### Class ProfessionalQuoteCalculator —Ä–∞–∑–±–∏–µ–Ω–∏–µ (–ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è v3.0.0)

**–¢–µ–∫—É—â–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** –ú–æ–Ω–æ–ª–∏—Ç–Ω—ã–π –∫–ª–∞—Å—Å 9979 —Å—Ç—Ä–æ–∫

**–ü–ª–∞–Ω –º–æ–¥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏:**
1. **CalculationEngine** - –≤—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Ä–∞—Å—á—ë—Ç–æ–≤
2. **UIRenderer** - –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ DOM
3. **StateManager** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º + undo/redo
4. **DataManager** - load/save –æ–ø–µ—Ä–∞—Ü–∏–∏
5. **ValidationEngine** - –≤—Å—è –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–ö—Ä–∏—Ç–∏—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:**
- ‚úÖ –û–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å API
- ‚úÖ –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏
- ‚úÖ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É —Ä–∞—Å—á—ë—Ç–æ–≤ –ë–ï–ó –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üß™ Testing Map {#testing}

### Backend Tests

**–§–∞–π–ª:** `server.test.js`
**Coverage:** 11/11 —Ç–µ—Å—Ç–æ–≤ ‚úÖ

–ß—Ç–æ –ø–æ–∫—Ä—ã—Ç–æ:
- API endpoints (GET/POST/DELETE)
- File operations
- Error handling

### Utils Tests

**–§–∞–π–ª:** `utils.test.js`
**Coverage:** 10/10 —Ç–µ—Å—Ç–æ–≤ ‚úÖ

–ß—Ç–æ –ø–æ–∫—Ä—ã—Ç–æ:
- `transliterate()` —Ñ—É–Ω–∫—Ü–∏—è
- `generateId()` —Ñ—É–Ω–∫—Ü–∏—è

### Frontend Tests

**Status:** ‚ùå –ù–ï–¢ unit —Ç–µ—Å—Ç–æ–≤

**–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –º–æ–¥—É–ª—è—Ä–∏–∑–∞—Ü–∏–∏:**
- CalculationEngine.test.js
- UIRenderer.test.js
- StateManager.test.js
- DataManager.test.js

**Manual Testing Checklist:**
- ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–º–µ—Ç—ã
- ‚úÖ Bulk operations
- ‚úÖ JSON –∏ CSV load/save
- ‚úÖ Keyboard shortcuts
- ‚úÖ –ü–µ—á–∞—Ç—å
- ‚úÖ –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è

**–ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã:**
```bash
# –í—Å–µ —Ç–µ—Å—Ç—ã
npm test

# Watch mode
npm run test:watch

# Coverage
npm run test:coverage
```

---

## üì¶ Dependencies {#dependencies}

### NPM –ø–∞–∫–µ—Ç—ã

**Production:**
- `express` - backend API server
- `cors` - Cross-Origin Resource Sharing
- `better-sqlite3` - SQLite database (NEW v2.3.0)

**Development:**
- `jest` - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- `supertest` - HTTP —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- `nodemon` - auto-restart –ø—Ä–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ

### –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

**–ì–ª–∞–≤–Ω—ã–µ —Ñ–∞–π–ª—ã:**
- `index.html` - –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π frontend (9979 —Å—Ç—Ä–æ–∫)
- `server.js` - file-based backend
- `server-with-db.js` - SQLite backend (NEW)
- `utils.js` - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- `version.js` - –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –≤–µ—Ä—Å–∏–π

**–£—Ç–∏–ª–∏—Ç—ã:**
- `utils.js`:
  - `transliterate(text)` - —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
  - `generateId()` - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö ID

**–í–µ—Ä—Å–∏–∏ (–∏–∑ version.js):**
```javascript
APP_VERSION = '2.3.0'
CATALOG_VERSION = '1.2.0'
QUOTE_VERSION = '1.1.0'
DATA_SCHEMA_VERSION = '1.0.0'
```

---

## üîÑ Maintenance Guidelines

### –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞:

**–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:**
1. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å —ç—Ç–æ—Ç CODE_MAP.md –µ—Å–ª–∏:
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–æ–≤–∞—è –∫—Ä–∏—Ç–∏—á–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
   - –ò–∑–º–µ–Ω–µ–Ω—ã –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
   - –ù–∞–π–¥–µ–Ω –Ω–æ–≤—ã–π known issue
   - –ò–∑–º–µ–Ω–µ–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

2. ‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ callers —Ñ—É–Ω–∫—Ü–∏–∏ (–∏–∑ —Å–µ–∫—Ü–∏–∏ Feature Map)

3. ‚úÖ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã: `npm test`

4. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å CLAUDE.md –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è workflow

### CODE_MAP - —ç—Ç–æ –∂–∏–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç!

**–ü—Ä–∞–≤–∏–ª–æ:** –ò–∑–º–µ–Ω–∏–ª –∫–æ–¥ ‚Üí –æ–±–Ω–æ–≤–∏ CODE_MAP

**–ö–æ–≥–¥–∞ –ù–ï –æ–±–Ω–æ–≤–ª—è—Ç—å:**
- –¢—Ä–∏–≤–∏–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è (typo fix –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö)
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –Ω–µ–∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
- CSS styling (–µ—Å–ª–∏ –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ JS)

---

## üéØ Quick Reference

### –°–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –∑–∞–¥–∞—á–∏:

**"–ì–¥–µ —Ä–∞—Å—á—ë—Ç—ã?"**
‚Üí `index.html:6578` - updateCalculations()

**"–ì–¥–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ?"**
‚Üí `index.html:8921` - saveQuoteJSON()

**"–ì–¥–µ –∑–∞–≥—Ä—É–∑–∫–∞?"**
‚Üí –ù–∞–π—Ç–∏ loadQuoteFromServer()

**"–ì–¥–µ race conditions?"**
‚Üí –°–µ–∫—Ü–∏—è [Known Issues](#known-issues)

**"–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π storage?"**
‚Üí –°–µ–∫—Ü–∏—è [Integration Points](#integration)

**"–ì–¥–µ —Ç–µ—Å—Ç—ã?"**
‚Üí –°–µ–∫—Ü–∏—è [Testing Map](#testing)

---

**–í–µ—Ä—Å–∏—è CODE_MAP:** 1.0.0
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 6 –Ω–æ—è–±—Ä—è 2025
**–°–ª–µ–¥—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

**–í–æ–ø—Ä–æ—Å—ã?** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ [CLAUDE.md](../CLAUDE.md) –¥–ª—è –æ–±—â–µ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞.
