# FAQ - Частые вопросы

**Версия:** 2.3.0

Ответы на самые частые вопросы пользователей Quote Calculator.

---

## Общие вопросы

### Можно ли использовать систему без интернета?

**Да**, Quote Calculator полностью оффлайн система.

**Требования:**
- Локально установленный сервер (node server-with-db.js)
- Браузер для доступа к frontend
- Никакого интернета не нужно

**Исключение:** Если вы хотите синхронизировать данные между компьютерами, нужен будет интернет для передачи backup файлов.

---

### Какие браузеры поддерживаются?

**Рекомендуемые:**
- ✅ Chrome 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Edge 90+

**Не поддерживаются:**
- ❌ Internet Explorer (любые версии)
- ❌ Старые браузеры без ES6+ support

---

### Сколько смет можно создать?

**Технически:** Неограниченно

**Практически:**
- Рекомендуется: до 1000 смет
- Допустимо: до 5000 смет
- При большем количестве может потребоваться оптимизация БД

**Размер базы:**
```
100 смет   = ~5 MB
500 смет   = ~25 MB
1000 смет  = ~50 MB
```

---

### Можно ли работать на нескольких компьютерах?

**Да**, через экспорт/импорт:

```
Компьютер 1:
  Меню → Экспорт → Полный backup
  → Файл full_backup.zip

Компьютер 2:
  Меню → Импорт → Полный импорт
  → Выбрать full_backup.zip
```

**Время переноса:** 5-10 минут для 1000 смет

**Автоматическая синхронизация:** Не поддерживается в текущей версии

---

## Работа со сметами

### В чём разница между autosave и Ctrl+S?

**Autosave (каждые 30 сек):**
- ❌ Не сохраняет на сервер
- ✅ Сохраняет в localStorage (временно)
- ✅ Защищает от потери при сбое браузера
- ❌ НЕ создаёт backup

**Ctrl+S (ручное сохранение):**
- ✅ Сохраняет на сервер (в БД)
- ✅ Создаёт автоматический backup
- ✅ Данные доступны после перезагрузки
- ✅ Дедупликация backups (не создаст дубль если ничего не менялось)

**Рекомендация:** Всегда нажимайте Ctrl+S после завершения работы!

---

### Почему услуги "прилипают" к другим сметам?

**Это был баг в v2.2.0, исправлен в v2.3.0.**

**Причина:** Autosave срабатывал во время загрузки новой сметы

**Решение:** Обновиться до v2.3.0 или новее

**Workaround для v2.2.0:**
```
1. Загрузить смету
2. Подождать 3 секунды
3. Только потом начинать редактировать
```

---

### Как скопировать смету?

**Способ 1: Дублирование (Ctrl+D)**
```
1. Открыть смету
2. Ctrl+D или Меню → Дублировать
3. Новая смета создана с именем "Копия {original}"
4. Изменить данные клиента
5. Сохранить Ctrl+S
```

**Способ 2: Экспорт/Импорт**
```
1. Экспортировать смету → estimate.json
2. Импортировать → выбрать estimate.json
3. Система создаст новую смету с новым ID
```

---

### Можно ли удалить смету?

**Да:**
```
Меню → Управление сметами → Список смет
→ Выбрать смету → Кнопка "Удалить"
→ Подтвердить
```

**Безопасность:**
- ✅ Автоматически создаётся backup перед удалением
- ✅ Можно восстановить в течение 90 дней
- ✅ Запрос подтверждения

---

### Что такое PAX и зачем он нужен?

**PAX = Количество туристов в группе**

**Где используется:**
- Отображается в шапке сметы
- Используется для планирования (например, расчёт мест в автобусе)
- НЕ влияет на автоматические расчёты цен (это ручной параметр)

**Пример:**
```
PAX = 10
Услуга "Трансфер аэропорт-отель"
Цена: $25
Количество: 1 (один трансфер на всю группу)
Итого: $25 (НЕ $25 × 10)

Если нужно "$25 за каждого":
Цена: $25
Количество: 10
Итого: $250
```

---

## Расчёты и наценки

### Что такое скрытая наценка?

**Определение:** Наценка, которая НЕ показывается клиенту в печатной версии

**Как работает:**
```javascript
// 1. Рассчитывается от базовой стоимости
hiddenMarkupAmount = baseCost × (hiddenMarkup / 100)

// 2. Добавляется к вашей прибыли
totalProfit = individualMarkups + hiddenMarkupAmount

// 3. НЕ показывается клиенту
clientTotal = baseCost + individualMarkups + tax
// (БЕЗ hiddenMarkup)

// 4. При печати распределяется пропорционально в цены услуг
```

**Зачем нужна:**
- Внутренняя маржа компании
- Не хотите показывать полную маржу клиенту
- Резерв на непредвиденные расходы

**Где видна:**
- ✅ Панель расчётов (для вас)
- ❌ Печать для клиента

**Подробнее:** [Calculations Guide](../working-with-estimates/calculations.md#скрытая-наценка)

---

### В чём разница между индивидуальной и скрытой наценкой?

**Индивидуальная наценка (Individual Markup):**
```
На каждую услугу отдельно
Видна клиенту в итоговой цене
Включена в clientTotal

Пример:
Базовая цена: $100
Markup: 10%
→ Клиент видит: $110
```

**Скрытая наценка (Hidden Markup):**
```
% от ВСЕЙ базовой стоимости
НЕ показывается клиенту как отдельная строка
Распределяется в ценах услуг при печати

Пример:
Базовая стоимость: $1000
Hidden Markup: 5%
→ +$50 к вашей прибыли
→ Клиент видит детализацию без отдельной строки "наценка"
```

**Можно использовать обе одновременно.**

---

### Почему итого не сходится с моими расчётами?

**Проверьте порядок расчётов:**

```javascript
// Правильный порядок:
1. baseCost = Σ(price × quantity)
2. serviceTotal = price × quantity × (1 + markup/100)
3. hiddenMarkup = baseCost × (hiddenMarkup/100)
4. tax = totalWithMarkup × (taxRate/100)
5. clientTotal = totalWithMarkup + tax  // БЕЗ скрытой
```

**Частые ошибки:**
- ❌ НДС считают от базовой стоимости (правильно: от суммы с наценками)
- ❌ Скрытую наценку включают в clientTotal (правильно: только в profit)
- ❌ Индивидуальную наценку считают от итога (правильно: от базовой цены услуги)

---

### Как округляются цены?

**Автоматическое округление:**
```
До 2 знаков после запятой
$25.3456 → $25.35
$99.999  → $100.00
$100.001 → $100.00
```

**В печатной версии:**
```
Валюта слева: $100.00
Разделитель: запятая для тысяч (1,000.00)
```

---

## Каталоги и услуги

### Что такое регион каталога?

**Определение:** Географическая привязка каталога

**UNIQUE constraint:**
```sql
UNIQUE(name, region)
-- Один каталог с именем на регион
```

**Пример:**
```
Название: "Стандартные услуги"
Регион: "Indonesia"
→ Отдельный каталог

Название: "Стандартные услуги"
Регион: "Georgia"
→ Другой каталог (не конфликт)
```

**Зачем нужно:**
- Разные цены в разных странах
- Разная валюта
- Разный набор услуг

---

### Почему не импортируется CSV с кириллицей?

**Проблема:** Excel/LibreOffice сохраняет CSV в неправильной кодировке

**Решение:**

**При экспорте из Quote Calculator:**
```
Формат: CSV
Кодировка: UTF-8 BOM ✓
→ Файл откроется правильно в Excel
```

**При импорте внешнего CSV:**
```
Открыть CSV в текстовом редакторе (VS Code, Sublime)
Проверить кодировку: UTF-8 или UTF-8 BOM
Пересохранить если нужно
```

**Альтернатива:** Используйте JSON формат (рекомендуется)

---

### Как удалить дубликаты услуг?

**Вариант 1: Ручное удаление**
```
1. Каталог → Сортировка по названию
2. Визуально найти дубли
3. Ctrl+Click на дублях
4. Delete → Подтвердить
```

**Вариант 2: Экспорт → Очистка → Импорт**
```
1. Экспорт каталога → catalog.json
2. Открыть в редакторе
3. Удалить дубликаты
4. Импортировать обратно
```

**Предотвращение:**
```
Перед импортом нового каталога:
☑ Создать backup
☑ Проверить на дубли
☑ Использовать уникальные названия
```

---

### Можно ли изменить услугу, которая уже в смете?

**В каталоге:**
```
Изменение услуги в каталоге НЕ меняет её в существующих сметах
Только в новых сметах будет новая версия
```

**В смете:**
```
✅ Можно изменить цену
✅ Можно изменить количество
✅ Можно изменить наценку
✅ Можно изменить название (только для этой сметы)

Изменения сохраняются только в этой смете
```

---

## Backups и восстановление

### Когда создаются автоматические backups?

**Триггеры:**
- Сохранение сметы (Ctrl+S)
- Autosave (каждые 30 сек, только если данные изменились)
- Перед массовыми операциями (>10 услуг)
- Перед импортом (если перезапись)
- Перед удалением каталога

**Дедупликация:**
```
Если данные не изменились с предыдущего backup,
новый backup НЕ создаётся (экономия места)
```

---

### Сколько хранятся backups?

**По умолчанию:**
```
90 дней
После этого автоудаление
```

**Настройка:**
```
Можно изменить от 30 до 365 дней
В настройках системы
```

**Ручные backups с описанием:**
```
Хранятся бессрочно
Не удаляются автоматически
```

---

### Как восстановить смету из backup?

**Процесс:**
```
1. Меню → Backups → История
2. Фильтр: выбрать период
3. Найти нужный backup (по времени/описанию)
4. Кнопка "Просмотр" → проверить содержимое
5. Кнопка "Восстановить"
6. Подтверждение:
   ☑ Создать backup текущей версии
   [Восстановить] [Отмена]
7. Готово
```

**Безопасность:**
```
Перед восстановлением создаётся backup текущего состояния
Можно откатить восстановление
```

---

### База данных стала очень большой - что делать?

**Причина:** Слишком много backups (тысячи автоматических)

**Решение:**
```sql
-- Удалить автоматические backups старше 30 дней
DELETE FROM backups
WHERE created_at < date('now', '-30 days')
AND description IS NULL;

-- Уменьшить размер файла БД
VACUUM;
```

**Или через UI:**
```
Меню → Backups → Очистка
Удалить старше: 30 дней
Тип: Только автоматические
→ Очистить
```

**После очистки:**
```
База 500MB → 50MB (типичный результат)
```

---

## API и интеграция

### Как получить список всех смет через API?

**Request:**
```bash
GET http://localhost:4000/api/estimates

# С пагинацией
GET http://localhost:4000/api/estimates?limit=50&offset=0
```

**Response:**
```json
{
  "estimates": [
    {
      "id": "est_001",
      "client_name": "Иванов Иван",
      "created_at": "2025-02-03T15:30:00Z",
      "updated_at": "2025-02-03T16:00:00Z"
    }
  ],
  "total": 127
}
```

**Подробнее:** [Estimates API](../../developer-guide/api-reference/estimates.md)

---

### Почему получаю CORS error?

**Проблема:** Браузер блокирует запросы к API с другого origin

**Решение для development:**
```javascript
// server-with-db.js уже настроен:
app.use(cors({
  origin: '*',  // Разрешить все origins
  credentials: true
}));
```

**Решение для production:**
```javascript
app.use(cors({
  origin: 'https://yourdomain.com',  // Только ваш домен
  credentials: true
}));
```

---

### Как создать смету через API?

**Request:**
```bash
POST http://localhost:4000/api/estimates
Content-Type: application/json

{
  "data": {
    "client": {
      "name": "Иванов Иван",
      "phone": "+7 999 123-45-67",
      "email": "ivan@example.com"
    },
    "group": {
      "pax": 10,
      "dates": "15-22 февраля 2025"
    },
    "services": [
      {
        "id": "svc_001",
        "name": "Трансфер",
        "price": 25,
        "quantity": 1,
        "markup": 10
      }
    ],
    "pricing": {
      "hiddenMarkup": 5,
      "taxRate": 0
    }
  },
  "client_name": "Иванов Иван"
}
```

**Response:**
```json
{
  "id": "est_042",
  "message": "Estimate created"
}
```

**Подробнее:** [Estimates API - Create](../../developer-guide/api-reference/estimates.md#create-estimate)

---

## Печать и экспорт

### Как распечатать смету?

**Процесс:**
```
1. Открыть смету
2. Ctrl+P или Меню → Печать
3. Настроить печать:
   ☑ Показать PAX
   ☑ Показать даты
   ☐ Показать внутренние расчёты (для клиента - НЕТ!)
4. Печать или PDF
```

**Что попадёт в печать:**
- ✅ Данные клиента
- ✅ Группа (PAX, даты)
- ✅ Таблица услуг с ценами
- ✅ Итоговая стоимость
- ✅ НДС (если есть)
- ❌ Скрытая наценка (распределена в ценах)
- ❌ Прибыль (внутренняя информация)

---

### Можно ли экспортировать в Excel?

**Прямой экспорт:** Нет (в текущей версии)

**Workaround:**
```
1. Печать → Сохранить как PDF
2. PDF → Excel (онлайн конвертер)

Или:

1. Экспорт → JSON
2. JSON → CSV (через импорт каталога)
3. CSV → Excel
```

**Планируется в v2.4.0:** Прямой экспорт в XLSX

---

### Как передать смету клиенту?

**Вариант 1: PDF**
```
Ctrl+P → Сохранить как PDF
→ Отправить PDF клиенту
```

**Вариант 2: Print → Paper**
```
Ctrl+P → Печать
→ Передать распечатку
```

**Вариант 3: Export → Import**
```
Экспорт → estimate.json
→ Отправить файл
→ Клиент импортирует (если у него тоже Quote Calculator)
```

---

## Производительность

### Система тормозит при большом количестве услуг

**Симптом:** Медленный рендеринг, залипание UI

**Причины:**
- Слишком много услуг в смете (>100)
- Слишком много услуг в каталоге (>1000)
- Slow browser

**Решения:**

**1. Фильтрация:**
```
В каталоге: используйте фильтр по категории
Добавляйте только нужные услуги
```

**2. Пагинация:**
```
Показывать по 50 услуг
Загружать следующие по требованию
```

**3. Разделение каталогов:**
```
Вместо одного огромного каталога (1000 услуг)
→ Несколько маленьких по регионам/типам
```

**4. Обновить браузер:**
```
Chrome 90+ значительно быстрее старых версий
```

---

### Autosave замедляет систему

**Симптом:** Лаги каждые 30 секунд

**Решение:**
```
Autosave использует debouncing и дедупликацию
Не должно тормозить

Проверьте:
  - Размер БД (должна быть <100MB)
  - Количество backups (удалите старые)
  - Очистить browser cache
```

**Отключить autosave:** Не рекомендуется (потеря данных при сбое)

---

**Назад:** [← Troubleshooting](index.md)
**Далее:** [Common Issues →](common-issues.md)
