# Фаза 6: Финальная проверка миграции v3.0.0

**Reference:** MIGRATION_V3_SPEC.md Section 7, Фаза 6 (lines 1365-1375)
**Время выполнения:** ~1 час
**Статус:** Мануальная проверка

---

## Цель

Убедиться, что все компоненты миграции v3.0.0 работают корректно:
- ✅ Backend API v1 функционирует
- ✅ Frontend синхронизация работает
- ✅ Данные мигрированы корректно
- ✅ UI/UX без регрессий

---

## Автоматизированная проверка

Перед мануальной проверкой запустите автоматизированные тесты:

```bash
# 1. Запустить сервер (если ещё не запущен)
cd "/Users/bogisis/Desktop/сметы/for_deploy copy"
STORAGE_TYPE=sqlite node server-with-db.js &

# 2. Запустить валидацию миграции
node scripts/validate-migration.js

# 3. Запустить финальные интеграционные тесты
node scripts/test-final-integration.js
```

**Ожидаемый результат:**
```
✅ Migration validated successfully
✅ All integration tests PASSED
Migration v3.0.0 is ready for production!
```

---

## Мануальный Checklist

### Шаг 1: Открыть приложение в браузере

- [ ] Открыть http://localhost:4000 в браузере
- [ ] Убедиться, что страница загружается без ошибок
- [ ] Открыть DevTools Console (F12)
- [ ] Проверить отсутствие критических ошибок в консоли

**Ожидаемые логи в консоли:**
```
[Init] ErrorBoundary initialized successfully
[Init] CacheManager initialized
[Init] SyncManager started
[Init] Full sync completed successfully
```

**Критерий успеха:** ✅ Страница загружается, в консоли нет красных ошибок

---

### Шаг 2: Войти как admin@localhost / admin123

- [ ] Если появляется форма логина, ввести:
  - Email: `admin@localhost`
  - Password: `admin123`
- [ ] Нажать "Войти"
- [ ] Убедиться, что авторизация прошла успешно

**Примечание:** В текущей версии может использоваться session-based auth, не JWT. Это нормально для переходного периода.

**Критерий успеха:** ✅ Успешная авторизация, доступ к приложению

---

### Шаг 3: Проверить список смет - все на месте?

- [ ] Открыть "Управление сметами" (кнопка или меню)
- [ ] Проверить, что список смет отображается
- [ ] Убедиться, что количество смет соответствует ожидаемому
- [ ] Проверить, что у каждой сметы есть:
  - Название (filename)
  - Клиент (client_name)
  - Дата обновления (updated_at)

**Проверка в DevTools:**
```javascript
// В консоли браузера
cacheManager.getEstimatesList()
// Должен вернуть массив смет
```

**Критерий успеха:** ✅ Все сметы на месте, данные корректны

---

### Шаг 4: Открыть смету - загружается корректно?

- [ ] Выбрать любую смету из списка
- [ ] Кликнуть "Открыть" или "Загрузить"
- [ ] Убедиться, что смета загружается
- [ ] Проверить, что отображаются:
  - Данные клиента (имя, email, телефон)
  - Список услуг (services)
  - Расчёты (total cost, profit)
  - Количество участников (pax count)

**Проверка в DevTools:**
```javascript
// В консоли браузера
QuoteCalc.state.services
// Должен показать массив услуг текущей сметы
```

**Критерий успеха:** ✅ Смета загружается полностью, все данные корректны

---

### Шаг 5: Проверить каталоги - все регионы доступны?

- [ ] Открыть раздел "Каталог" или "Услуги"
- [ ] Переключиться между регионами (Ushuaia, Patagonia, Buenos Aires)
- [ ] Убедиться, что для каждого региона:
  - Отображаются шаблоны услуг (templates)
  - Отображаются категории (categories)
  - Можно добавить услугу в смету

**Проверка в DevTools:**
```javascript
// В консоли браузера
cacheManager.getCachedCatalog('ushuaia')
// Должен вернуть данные каталога для Ushuaia
```

**Критерий успеха:** ✅ Все каталоги доступны, шаблоны загружаются

---

### Шаг 6: Создать новую смету - сохраняется?

- [ ] Нажать "Новая смета" или "Создать"
- [ ] Заполнить данные:
  - Имя клиента: "Test Client"
  - Email: "test@example.com"
  - Количество участников: 10
- [ ] Добавить несколько услуг из каталога
- [ ] Нажать "Сохранить"
- [ ] Проверить, что смета появилась в списке

**Проверка сохранения на сервере:**
```bash
# В терминале
curl http://localhost:4000/api/v1/estimates | jq '.data.estimates[] | select(.client_name == "Test Client")'
```

**Критерий успеха:** ✅ Новая смета создаётся и сохраняется на сервере

---

### Шаг 7: Проверить autosave - работает?

- [ ] Открыть существующую смету
- [ ] Изменить данные клиента (например, имя)
- [ ] Подождать 2-3 секунды (не сохранять вручную)
- [ ] Проверить в DevTools Network tab:
  - Должен быть запрос POST /api/estimates/:id или PUT /api/v1/estimates/:id
  - Статус ответа: 200 OK

**Проверка в консоли:**
```javascript
// В консоли браузера
syncManager.pendingChanges
// Должен показать очередь изменений для синхронизации
```

**Критерий успеха:** ✅ Autosave срабатывает, изменения отправляются на сервер

---

### Шаг 8: Проверить синхронизацию - работает?

- [ ] Открыть DevTools Console
- [ ] Подождать 5 минут (или вызвать вручную)
- [ ] Проверить логи синхронизации:
  ```
  [SyncManager] Starting sync cycle...
  [SyncManager] Pushing X local changes...
  [SyncManager] Pulling updates since ...
  [SyncManager] Sync completed successfully
  ```

**Проверка вручную:**
```javascript
// В консоли браузера
syncManager.manualSync()
```

**Проверка метаданных кэша:**
```javascript
// В консоли браузера
cacheManager.getMetadata()
// Должен показать last_sync, status: 'success'
```

**Критерий успеха:** ✅ Синхронизация работает, данные обновляются

---

## Проверка на регрессии

### Существующий функционал должен работать:

- [ ] Bulk operations (выбор нескольких услуг, удаление)
- [ ] Keyboard shortcuts (Ctrl+S, Ctrl+O, Ctrl+P, Delete, Escape)
- [ ] Печать КП (Ctrl+P) - без внутренних расчётов
- [ ] Импорт/экспорт каталогов (JSON, CSV)
- [ ] Расчёты корректны:
  - Базовая стоимость
  - Индивидуальные наценки
  - Скрытая наценка (не показывается клиенту)
  - НДС
  - Итого для клиента

---

## Производительность

### Проверка времени отклика:

- [ ] Загрузка списка смет: < 1 сек
- [ ] Открытие сметы: < 500 мс
- [ ] Autosave: < 200 мс
- [ ] Синхронизация: < 3 сек для 50 изменений
- [ ] Загрузка каталога: < 500 мс

---

## Тестирование на разных браузерах

- [ ] Chrome 90+ ✅
- [ ] Firefox 88+ ✅
- [ ] Safari 14+ ✅
- [ ] Edge 90+ ✅

---

## Итоговый чеклист

### Обязательные проверки:
- [ ] ✅ Автоматизированные тесты пройдены
- [ ] ✅ Приложение загружается без ошибок
- [ ] ✅ Логин работает
- [ ] ✅ Список смет отображается
- [ ] ✅ Смета загружается корректно
- [ ] ✅ Каталоги доступны
- [ ] ✅ Создание новой сметы работает
- [ ] ✅ Autosave функционирует
- [ ] ✅ Синхронизация работает

### Дополнительные проверки:
- [ ] ✅ Нет регрессий в существующем функционале
- [ ] ✅ Производительность в норме
- [ ] ✅ Протестировано в основных браузерах

---

## Действия при обнаружении проблем

### Если тесты не проходят:

1. **Проверить логи сервера:**
   ```bash
   # Проверить последние 100 строк логов
   docker logs quote-calculator-quote-production-1 --tail 100
   ```

2. **Проверить состояние БД:**
   ```bash
   sqlite3 db/quotes.db "SELECT COUNT(*) FROM estimates WHERE organization_id IS NOT NULL"
   ```

3. **Проверить миграции:**
   ```bash
   node db/migrations/runner.js status
   ```

### Если нужен rollback:

См. MIGRATION_V3_SPEC.md Section 7 "Rollback Plan" (lines 1377-1395)

```bash
# 1. Остановить приложение
docker compose down

# 2. Восстановить backup
cp db/quotes.db.pre-migration-TIMESTAMP db/quotes.db

# 3. Откатить миграции
node db/migrations/runner.js down 008
node db/migrations/runner.js down 007
node db/migrations/runner.js down 006

# 4. Запустить приложение
docker compose up
```

---

## Критерии готовности к продакшену

Миграция v3.0.0 готова к продакшену, если:

- ✅ Все автоматизированные тесты пройдены (validate-migration.js, test-final-integration.js)
- ✅ Все пункты мануального чеклиста выполнены
- ✅ Нет критических ошибок в консоли браузера
- ✅ Нет ошибок в логах сервера
- ✅ Производительность соответствует требованиям
- ✅ Нет регрессий в существующем функционале

**Если все критерии выполнены:**

```
✅✅✅ MIGRATION v3.0.0 READY FOR PRODUCTION ✅✅✅
```

---

## Контакты и поддержка

**Документация:**
- MIGRATION_V3_SPEC.md - полная спецификация миграции
- db/migrations/README.md - логика миграций БД

**Скрипты:**
- `scripts/validate-migration.js` - валидация миграции
- `scripts/test-final-integration.js` - интеграционные тесты
- `scripts/migrate-catalogs.js` - миграция каталогов
- `scripts/migrate-settings.js` - миграция настроек

**Версия:** 3.0.0
**Дата:** 2025-11-19
