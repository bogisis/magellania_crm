# üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

**–î–∞—Ç–∞:** 25 –Ω–æ—è–±—Ä—è 2025
**–í–µ—Ä—Å–∏—è:** 2.3.1
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** üî¥ HIGH

---

## üö® –ü—Ä–æ–±–ª–µ–º—ã

–ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤–æ–∑–Ω–∏–∫–∞–ª–∏ –¥–≤–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏:

### –û—à–∏–±–∫–∞ #1: `TypeError: self.generateId is not a function`

**–°–∏–º–ø—Ç–æ–º—ã:**
```javascript
‚úó Exception importing unknown: TypeError: self.generateId is not a function
    at reader.onload ((index):9822:67)
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ —Å–º–µ—Ç –±–µ–∑ ID –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π ID
- –í—ã–∑–æ–≤ `self.generateId()` –Ω–∞ —Å—Ç—Ä–æ–∫–µ 9822
- –ù–æ –º–µ—Ç–æ–¥ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è `generateQuoteId()`, –∞ –Ω–µ `generateId()`

---

### –û—à–∏–±–∫–∞ #2: `Failed to fetch` –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã

**–°–∏–º–ø—Ç–æ–º—ã:**
```javascript
Save catalog error: TypeError: Failed to fetch
–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏: TypeError: Failed to fetch
```

**–û–ø–∏—Å–∞–Ω–∏–µ:**
- –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (beforeunload event) –∫–æ–¥ –ø—ã—Ç–∞–ª—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `fetch()` –¥–ª—è API –∑–∞–ø—Ä–æ—Å–∞
- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –º–æ–≥—É—Ç –æ—Ç–º–µ–Ω—è—Ç—å fetch –∑–∞–ø—Ä–æ—Å—ã –≤–æ –≤—Ä–µ–º—è unload
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –æ—à–∏–±–∫–∞ "Failed to fetch" –≤ –∫–æ–Ω—Å–æ–ª–∏

---

## üîç Root Cause Analysis

### –û—à–∏–±–∫–∞ #1: –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –∏–º—è –º–µ—Ç–æ–¥–∞

**–§–∞–π–ª:** `index.html:9822`

**–ë—ã–ª–æ:**
```javascript
const estimateId = est.id || est.data?.id || self.generateId();
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- –ú–µ—Ç–æ–¥ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∫–∞–∫ `generateQuoteId()` –Ω–∞ —Å—Ç—Ä–æ–∫–µ 3197
- –ö–æ–¥ –≤—ã–∑—ã–≤–∞–ª –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `generateId()`
- JavaScript –≤—ã–±—Ä–∞—Å—ã–≤–∞–ª TypeError

**–ì–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
```javascript
// Line 3197 - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞
generateQuoteId() {
    return 'xxxxxxxxxxxx'.replace(/x/g, () => {
        return (Math.random() * 16 | 0).toString(16);
    });
}

// Line 9822 - –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤—ã–∑–æ–≤
const estimateId = est.id || est.data?.id || self.generateId(); // ‚ùå WRONG
```

---

### –û—à–∏–±–∫–∞ #2: fetch() –≤–æ –≤—Ä–µ–º—è beforeunload

**–§–∞–π–ª:** `index.html:11717-11727`

**–ë—ã–ª–æ:**
```javascript
window.addEventListener('beforeunload', function() {
    try {
        if (window.QuoteCalc && window.QuoteCalc.currentRegion) {
            // ‚ùå Async fetch() –≤–æ –≤—Ä–µ–º—è page unload
            window.QuoteCalc.saveCatalogToRegion(window.QuoteCalc.currentRegion);
            console.log('–ö–∞—Ç–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:', error);
    }
});
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
1. `saveCatalogToRegion()` –¥–µ–ª–∞–µ—Ç async `fetch()` –∑–∞–ø—Ä–æ—Å –∫ API
2. –í–æ –≤—Ä–µ–º—è `beforeunload` –±—Ä–∞—É–∑–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã –º–æ–≥—É—Ç –æ—Ç–º–µ–Ω—è—Ç—å pending fetch –∑–∞–ø—Ä–æ—Å—ã
4. Fetch –ø—Ä–æ–º–∏—Å –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è —Å "Failed to fetch"
5. –û—à–∏–±–∫–∞ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- –ö–∞—Ç–∞–ª–æ–≥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö:
  - –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ template (line 6989)
  - –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ template (line 6961)
  - –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (line 7125)
- beforeunload save - —ç—Ç–æ –∏–∑–±—ã—Ç–æ—á–Ω–∞—è "–ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞"
- –ù–æ fetch() –≤–æ –≤—Ä–µ–º—è unload –Ω–µ–Ω–∞–¥—ë–∂–µ–Ω
- –°–æ–∑–¥–∞—ë—Ç –ª–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### Fix #1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –∏–º—è –º–µ—Ç–æ–¥–∞

**–§–∞–π–ª:** `index.html:9822`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
```javascript
// –ë–´–õ–û:
const estimateId = est.id || est.data?.id || self.generateId();

// –°–¢–ê–õ–û:
const estimateId = est.id || est.data?.id || self.generateQuoteId();
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ú–µ—Ç–æ–¥ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- ‚úÖ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è UUID –¥–ª—è —Å–º–µ—Ç –±–µ–∑ ID
- ‚úÖ –ò–º–ø–æ—Ä—Ç –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

---

### Fix #2: –£–¥–∞–ª–∏—Ç—å beforeunload save

**–§–∞–π–ª:** `index.html:11716-11729`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:**
```javascript
// ‚úÖ FIX: Removed beforeunload catalog save - unreliable with fetch() during page unload
// Catalog is already saved automatically when user makes changes to templates/categories
// Modern browsers may cancel fetch() requests during beforeunload, causing "Failed to fetch" errors
//
// window.addEventListener('beforeunload', function() {
//     try {
//         if (window.QuoteCalc && window.QuoteCalc.currentRegion) {
//             window.QuoteCalc.saveCatalogToRegion(window.QuoteCalc.currentRegion);
//             console.log('–ö–∞—Ç–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã');
//         }
//     } catch (error) {
//         console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏:', error);
//     }
// });
```

**–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:**
1. **–ö–∞—Ç–∞–ª–æ–≥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö:
   - `addTemplateDialog()` ‚Üí line 6989
   - `editTemplateDialog()` ‚Üí line 6961
   - `saveCategories()` ‚Üí line 7125

2. **fetch() –≤–æ –≤—Ä–µ–º—è beforeunload –Ω–µ–Ω–∞–¥—ë–∂–µ–Ω**:
   - –ë—Ä–∞—É–∑–µ—Ä—ã –º–æ–≥—É—Ç –æ—Ç–º–µ–Ω—è—Ç—å –∑–∞–ø—Ä–æ—Å—ã
   - Async –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `navigator.sendBeacon()` –¥–ª—è critical data

3. **–ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è**:
   - –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å debounced autosave –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞
   - –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `navigator.sendBeacon()` API
   - –ò–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ "–ù–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ "Failed to fetch" –≤ –∫–æ–Ω—Å–æ–ª–∏
- ‚úÖ –ö–∞—Ç–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- ‚úÖ –ß–∏—Å—Ç–∞—è –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞

```bash
# 1. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
lsof -i :4000

# 2. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
open http://localhost:4000

# 3. –ó–∞–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è
# Email: admin@magellania.com
# Password: magellania2025
```

---

### –¢–µ—Å—Ç #1: –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —Å generateQuoteId

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å DevTools (F12) ‚Üí Console
2. –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω—é "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏"
3. –ù–∞–∂–∞—Ç—å "üì• –ò–º–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö"
4. –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª: `/Users/bogisis/Downloads/Quote Calculator Export Nov 21 2025.json`
5. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏–º–ø–æ—Ä—Ç

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
Starting catalogs import...
Export format: importing 7 catalogs with filename and data structure
‚úì Successfully imported catalog: Ushuaia (56 templates, 16 categories)
‚úì Successfully imported catalog: Ushuaia (60 templates, 18 categories)
...

Starting estimates import (9 estimates)...
Importing estimate: estimate_xxx.json (yyy-zzz-...)
‚úì Successfully imported: estimate_xxx.json
...
Imported 9/9 estimates
```

**‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:**
- –ù–ï–¢ –æ—à–∏–±–∫–∏ "generateId is not a function"
- –í—Å–µ —Å–º–µ—Ç—ã –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ID —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è —Å–º–µ—Ç –±–µ–∑ ID

---

### –¢–µ—Å—Ç #2: –ó–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–µ–∑ –æ—à–∏–±–æ–∫

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å DevTools (F12) ‚Üí Console
2. –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ http://localhost:4000
3. –î–æ–∂–¥–∞—Ç—å—Å—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞
4. –ó–∞–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
[–ö–æ–Ω—Å–æ–ª—å –ø—É—Å—Ç–∞—è - –Ω–µ—Ç –æ—à–∏–±–æ–∫]
```

**‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:**
- –ù–ï–¢ –æ—à–∏–±–∫–∏ "Failed to fetch"
- –ù–ï–¢ –æ—à–∏–±–∫–∏ "Save catalog error"
- –ö–æ–Ω—Å–æ–ª—å —á–∏—Å—Ç–∞—è

---

### –¢–µ—Å—Ç #3: –ö–∞—Ç–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö

**–®–∞–≥–∏:**
1. –û—Ç–∫—Ä—ã—Ç—å "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞–º–∏"
2. –í—ã–±—Ä–∞—Ç—å —Ä–µ–≥–∏–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, "Ushuaia")
3. –ù–∞–∂–∞—Ç—å "–î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É –≤ –∫–∞—Ç–∞–ª–æ–≥"
4. –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É:
   - –ù–∞–∑–≤–∞–Ω–∏–µ: "–¢–µ—Å—Ç–æ–≤–∞—è —É—Å–ª—É–≥–∞"
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è: "–¢—Ä–∞–Ω—Å—Ñ–µ—Ä—ã"
   - –¶–µ–Ω–∞: 100
5. –ù–∞–∂–∞—Ç—å "–î–æ–±–∞–≤–∏—Ç—å"
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Å–æ–ª—å

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
[Catalog Save] Request data: { name: "Ushuaia", hasTemplates: 57, ... }
‚úì –£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥ —Ä–µ–≥–∏–æ–Ω–∞ "Ushuaia"
```

**‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–π —É—Å–ø–µ—Ö–∞:**
- –£—Å–ª—É–≥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥
- API –∑–∞–ø—Ä–æ—Å —É—Å–ø–µ—à–µ–Ω
- –ù–ï–¢ –æ—à–∏–±–æ–∫ –≤ –∫–æ–Ω—Å–æ–ª–∏

---

## üìä –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. **index.html**
   - Line 9822: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ `self.generateId()` ‚Üí `self.generateQuoteId()`
   - Lines 11716-11729: –£–¥–∞–ª—ë–Ω beforeunload catalog save

2. **IMPORT_ERRORS_FIX.md** (NEW)
   - –≠—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## ‚úÖ Checklist

- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è –º–µ—Ç–æ–¥–∞ generateQuoteId
- [x] –£–¥–∞–ª—ë–Ω –ø—Ä–æ–±–ª–µ–º–Ω—ã–π beforeunload save
- [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ —á—Ç–æ –∫–∞—Ç–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
- [x] –°–æ–∑–¥–∞–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] **TODO: –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–º–ø–æ—Ä—Ç –≤—Ä—É—á–Ω—É—é**
- [ ] **TODO: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–µ–∑ –æ—à–∏–±–æ–∫**

---

## üìå –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- `CATALOG_IMPORT_FIX.md` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
- `–¶–ò–ö–õ–ò–ß–ï–°–ö–ò–ô_–†–ï–î–ò–†–ï–ö–¢_FIX.md` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞
- `AUTH_SECURITY_FIX.md` - –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
- `docs/ru/developer-guide/data-integrity/` - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞

–í–º–µ—Å—Ç–æ beforeunload –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

**–í–∞—Ä–∏–∞–Ω—Ç 1: Debounced autosave –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞**
```javascript
// –í initRegions()
this.debouncedCatalogSave = this.debounce(
    () => this.saveCatalogToRegion(this.currentRegion),
    5000, // 5 —Å–µ–∫—É–Ω–¥
    'catalogAutosave'
);

// –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ templates/categories
this.debouncedCatalogSave();
```

**–í–∞—Ä–∏–∞–Ω—Ç 2: navigator.sendBeacon() –≤ beforeunload**
```javascript
window.addEventListener('beforeunload', function() {
    const catalogData = JSON.stringify({
        region: window.QuoteCalc.currentRegion,
        templates: window.QuoteCalc.templates,
        categories: window.QuoteCalc.categories
    });

    // Fire-and-forget - –±—Ä–∞—É–∑–µ—Ä –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É
    navigator.sendBeacon('/api/v1/catalogs/beacon', catalogData);
});
```

**–í–∞—Ä–∏–∞–Ω—Ç 3: –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö**
```javascript
let hasUnsavedChanges = false;

window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ—Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è. –ü–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
    }
});
```

---

**–í–∞–∂–Ω–æ:** –¢–µ–∫—É—â–µ–µ —Ä–µ—à–µ–Ω–∏–µ (—É–¥–∞–ª–µ–Ω–∏–µ beforeunload save) –±–µ–∑–æ–ø–∞—Å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –∫–∞—Ç–∞–ª–æ–≥ —É–∂–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö. –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤–Ω–æ—Å–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è, —Ç–æ –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –Ω–µ—á–µ–≥–æ.
