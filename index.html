<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="cache-version" content="v2.3.0-json-import-fix-20251118-004">
    <title>MAGELLANIA CRM v2.0-iOS</title>
    <!-- Favicon SVG - монохромная иконка компаса для туризма -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23333' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='10'/%3E%3Cpolygon points='16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76'/%3E%3C/svg%3E">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Quill.js Rich Text Editor - ОТКЛЮЧЕНО из-за ORB блокировки
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    -->
    <style>
        :root {
            --primary: #1e40af;
            --secondary: #059669;
            --accent: #d97706;
            --warning: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --spacing: 0.25rem;
            --radius: 0.375rem;
            --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: var(--font);
            font-size: 14px;
            line-height: 1.4;
            color: var(--gray-800);
            background: var(--gray-50);
        }

        .app {
            display: grid;
            grid-template-columns: minmax(280px, 350px) 1fr minmax(280px, 350px);
            height: calc(100vh - 65px); /* Вычитаем высоту global header */
            gap: 1px;
            background: var(--gray-200);
        }

        .panel {
            background: white;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: calc(var(--spacing) * 4);
            border-bottom: 1px solid var(--gray-200);
            background: var(--gray-50);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .panel-content {
            flex: 1;
            padding: calc(var(--spacing) * 3);
        }

        /* Typography */
        .text-xs { font-size: 11px; }
        .text-sm { font-size: 12px; }
        .text-base { font-size: 14px; }
        .text-lg { font-size: 16px; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .text-muted { color: var(--gray-500); }
        .text-primary { color: var(--primary); }
        .text-success { color: var(--secondary); }
        .text-warning { color: var(--accent); }
        .text-error { color: var(--warning); }

        /* Components */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: calc(var(--spacing) * 1);
            padding: calc(var(--spacing) * 2) calc(var(--spacing) * 3);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            background: white;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
            min-height: 28px;
        }

        .btn:hover { background: var(--gray-50); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Status icon buttons */
        .status-icon-btn:hover {
            background: var(--gray-100) !important;
        }
        .status-icon-btn:active {
            transform: scale(0.95);
        }
        .btn-primary { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-primary:hover { filter: brightness(0.9); background: var(--primary); }
        .btn-secondary { background: var(--secondary); color: white; border-color: var(--secondary); }
        .btn-secondary:hover { filter: brightness(0.9); background: var(--secondary); }
        .btn-warning { background: var(--warning); color: white; border-color: var(--warning); }
        .btn-warning:hover { filter: brightness(0.9); background: var(--warning); }
        .btn-sm { padding: calc(var(--spacing) * 1) calc(var(--spacing) * 2); font-size: 11px; min-height: 24px; }

        /* Lucide Icons - уменьшенные */
        .btn i[data-lucide], i[data-lucide] { width: 11px; height: 11px; stroke-width: 2.5; }
        .btn-sm i[data-lucide] { width: 10px; height: 10px; stroke-width: 2.5; }

        .input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 10px;
            min-height: 26px;
            transition: border-color 0.15s;
            font-family: var(--font);
            color: var(--gray-900);
        }

        .textarea {
            width: 100%;
            padding: calc(var(--spacing) * 2);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 12px;
            resize: none; /* Отключаем ручное изменение размера */
            font-family: var(--font);
            transition: border-color 0.15s;
            overflow: hidden; /* Скрываем скроллбар */
            min-height: 60px; /* Минимальная высота */
        }

        .input:focus, .textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgb(30 64 175 / 0.1);
        }

        .input.error, .textarea.error {
            border-color: var(--warning);
        }

        /* Quill Editor Styles */
        .quill-editor-container {
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            background: white;
        }

        .quill-editor-container .ql-toolbar {
            border: none;
            border-bottom: 1px solid var(--gray-300);
            background: #f9fafb;
            border-radius: var(--radius) var(--radius) 0 0;
            padding: 6px; /* уменьшено с 8px */
        }

        /* Уменьшаем размер кнопок тулбара на 20% */
        .quill-editor-container .ql-toolbar button {
            width: 22px !important; /* уменьшено с ~28px */
            height: 22px !important;
            padding: 3px !important;
        }

        .quill-editor-container .ql-toolbar button svg {
            width: 14px !important; /* уменьшено с ~18px */
            height: 14px !important;
        }

        .quill-editor-container .ql-toolbar .ql-picker-label {
            font-size: 11px !important; /* уменьшено с ~14px */
            padding: 2px 4px !important;
        }

        .quill-editor-container .ql-container {
            border: none;
            font-family: var(--font);
            font-size: 11px; /* уменьшено с 12px */
            min-height: 120px; /* уменьшено с 150px */
            max-height: 320px; /* уменьшено с 400px */
            overflow-y: auto;
        }

        .quill-editor-container .ql-editor {
            min-height: 120px; /* уменьшено с 150px */
            max-height: 320px; /* уменьшено с 400px */
            padding: 10px; /* уменьшено с 12px */
        }

        .quill-editor-container .ql-editor.ql-blank::before {
            color: #9ca3af;
            font-style: normal;
            font-size: 11px;
        }

        /* Кастомные tooltips для редактора - быстрые и красивые */
        .quill-editor-container .ql-toolbar button,
        .quill-editor-container .ql-toolbar .ql-picker-label {
            position: relative;
        }

        .quill-editor-container .ql-toolbar button[data-tooltip]::after,
        .quill-editor-container .ql-toolbar .ql-picker-label[data-tooltip]::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: calc(100% + 4px);
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.15s ease-in-out;
            z-index: 1000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .quill-editor-container .ql-toolbar button[data-tooltip]:hover::after,
        .quill-editor-container .ql-toolbar .ql-picker-label[data-tooltip]:hover::after {
            opacity: 1;
            transition-delay: 0.2s; /* Небольшая задержка перед появлением */
        }


        .form-row {
            display: flex;
            gap: calc(var(--spacing) * 2);
            align-items: center;
            margin-bottom: calc(var(--spacing) * 3);
        }

        .form-row.vertical {
            flex-direction: column;
            align-items: stretch;
        }

        /* Checkbox with better browser support */
        .checkbox {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 16px;
            height: 16px;
            border: 1px solid var(--gray-300);
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: all 0.15s;
            background: white;
        }

        .checkbox:checked {
            background: var(--primary);
            border-color: var(--primary);
        }

        .checkbox:checked::before {
            content: '✓';
            position: absolute;
            top: -1px;
            left: 2px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            line-height: 1;
        }

        /* Bulk Controls - показывается только когда есть выбранные услуги */
        .bulk-controls {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: calc(var(--spacing) * 2);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: calc(var(--spacing) * 2);
        }

        .selection-counter {
            font-size: 12px;
            color: var(--gray-600);
            font-weight: 500;
        }

        /* Collapsible section */
        .collapsible {
            margin-bottom: calc(var(--spacing) * 3);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: calc(var(--spacing) * 1.92) calc(var(--spacing) * 2.4);
            background: var(--gray-50);
            cursor: pointer;
            user-select: none;
            transition: background 0.15s;
        }

        .collapsible-header:hover {
            background: var(--gray-100);
        }

        .collapsible-header-title {
            font-weight: 500;
            font-size: 12px;
            color: var(--gray-700);
        }

        .collapsible-toggle {
            display: inline-block;
            transition: transform 0.2s ease;
            color: var(--gray-500);
            font-size: 14px;
        }

        .collapsible.expanded .collapsible-toggle {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .collapsible.expanded .collapsible-content {
            /* max-height устанавливается динамически через JavaScript */
        }

        .collapsible-content-inner {
            padding: calc(var(--spacing) * 3);
        }

        /* Client Info Grid - Adaptive */
        .client-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: calc(var(--spacing) * 1.5);
            margin-bottom: calc(var(--spacing) * 2);
        }

        .client-info-row {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing) * 0.5);
        }

        .client-info-row label {
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-700);
        }

        .dates-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .dates-group input {
            flex: 1;
            min-width: 0; /* Важно для правильной работы flex в узких контейнерах */
        }

        /* ===== VIEW MODE TOGGLE - iOS Style Switch (КОМПАКТНЫЙ) ===== */
        .view-mode-toggle-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .view-mode-label {
            font-size: 11px;
            color: #6b7280;
            font-weight: 500;
            white-space: nowrap;
            user-select: none;
        }

        /* iOS Switch - компактная версия */
        .ios-switch {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
            flex-shrink: 0;
        }

        .ios-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .ios-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #e5e5ea;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 22px;
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.04);
        }

        .ios-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        /* Активное состояние - зеленый как в iOS */
        .ios-switch input:checked + .ios-slider {
            background-color: #34c759;
        }

        .ios-switch input:checked + .ios-slider:before {
            transform: translateX(16px);
        }

        /* Hover эффект */
        .ios-switch:hover .ios-slider {
            opacity: 0.9;
        }

        /* ===== TABLE VIEW MODE - МИНИМАЛИСТИЧНЫЙ ===== */
        /* Чистая таблица с фокусом на содержании */
        .services-table-view {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            background: white;
        }

        .services-table-view thead {
            background: transparent;
            border-bottom: 1px solid #e2e8f0;
        }

        .services-table-view th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 500;
            font-size: 10px;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: none;
            white-space: nowrap;
        }

        .services-table-view tbody tr {
            border-bottom: 1px solid #f1f5f9;
            transition: background 0.15s ease;
        }

        .services-table-view tbody tr:last-child {
            border-bottom: none;
        }

        .services-table-view tbody tr:hover {
            background: #fafbfc;
        }

        .services-table-view td {
            padding: 12px;
            color: #334155;
            vertical-align: middle;
            line-height: 1.4;
        }

        /* Колонка названия - компактная с переносом */
        .services-table-view th.col-name,
        .services-table-view td.col-name {
            max-width: 180px;
            font-weight: 500;
            font-size: 11px;
            color: #0f172a;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
        }

        /* Колонка подрядчика - вторичная информация */
        .services-table-view th.col-contractor,
        .services-table-view td.col-contractor {
            width: 100px;
            font-size: 10px;
            color: #64748b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Колонка дня - редактируемая */
        .services-table-view th.col-day,
        .services-table-view td.col-day {
            width: 50px;
            text-align: center;
            font-weight: 600;
        }

        /* Колонка количества - компактная */
        .services-table-view th.col-qty,
        .services-table-view td.col-qty {
            width: 50px;
            text-align: center;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: #475569;
            font-size: 11px;
        }

        /* Колонка итого - акцент на главном */
        .services-table-view th.col-total,
        .services-table-view td.col-total {
            width: 85px;
            text-align: right;
            font-weight: 700;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: #059669;
            font-size: 13px;
        }

        /* Максимально компактные инпуты */
        .services-table-view .table-input {
            width: 38px;
            padding: 3px 4px;
            font-size: 11px;
            font-weight: 500;
            border: 1px solid #d1d5db;
            border-radius: 3px;
            text-align: center;
            background: white;
            transition: all 0.15s ease;
            font-family: 'SF Mono', 'Monaco', monospace;
            color: #1e293b;
        }

        .services-table-view .table-input:hover {
            border-color: #94a3b8;
        }

        .services-table-view .table-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        /* Кнопки в таблице - минимум */
        .services-table-view .table-btn {
            padding: 2px 6px;
            font-size: 16px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .services-table-view .table-btn-delete {
            background: transparent;
            color: #dc2626;
            font-weight: bold;
        }

        .services-table-view .table-btn-delete:hover {
            background: #fee;
            color: #991b1b;
        }

        /* Mobile: Stack все поля вертикально */
        @media (max-width: 768px) {
            .client-info-grid {
                grid-template-columns: 1fr;
                gap: calc(var(--spacing) * 2);
            }

            .dates-group {
                flex-direction: column;
                align-items: stretch;
            }

            .dates-group .text-xs {
                display: none; /* Скрываем тире на мобильных */
            }
        }

        /* Tablet: 2 колонки только для имени и телефона */
        @media (min-width: 769px) and (max-width: 1024px) {
            .client-info-grid {
                grid-template-columns: 1fr;
            }

            /* Даты в одну строку */
            .client-info-row:first-child {
                grid-column: 1;
            }
        }

        /* Service Cards */
        .service-card {
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            margin-bottom: 12px; /* 3-4 пикселя больше для воздуха между карточками */
            overflow: hidden;
            transition: all 0.15s;
        }

        .service-card:hover {
            border-color: var(--gray-300);
            box-shadow: var(--shadow);
        }

        .service-card.selected {
            border-color: var(--primary);
            background: rgb(30 64 175 / 0.02);
        }

        .service-card.updating {
            opacity: 0.7;
        }

        .service-card.excluded {
            border-color: var(--accent);
            background: rgb(217 119 6 / 0.02);
        }

        .service-card.excluded .service-header {
            background: rgb(217 119 6 / 0.05);
        }

        .service-card.full-profit {
            border-color: #16a34a;
            background: rgb(22 163 74 / 0.03);
        }

        .service-card.full-profit .service-header {
            background: rgb(22 163 74 / 0.08);
        }

        .service-header {
            padding: calc(var(--spacing) * 1.5) calc(var(--spacing) * 2.5); /* top/bottom, left/right */
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .service-header-left {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing) * 1.5); /* Уменьшено для компактности */
        }

        .service-content {
            padding: calc(var(--spacing) * 1.5) calc(var(--spacing) * 2.5) calc(var(--spacing) * 2); /* top, left/right, bottom */
        }

        .editable {
            background: transparent;
            border: 1px dashed transparent;
            border-radius: calc(var(--radius) / 2);
            padding: calc(var(--spacing) * 1);
            cursor: text;
            transition: all 0.15s;
            min-width: 60px;
            display: inline-block;
            font-family: var(--font);
        }

        .editable:hover {
            background: var(--gray-100);
            border-color: var(--gray-300);
        }

        .editable:focus {
            outline: none;
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgb(30 64 175 / 0.1);
        }

        .qty-control {
            display: inline-flex;
            align-items: center;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            overflow: visible; /* Изменено с hidden, чтобы не обрезать содержимое */
        }

        .qty-btn {
            width: 28px; /* Немного увеличено для лучшего клика */
            height: 28px;
            border: none;
            background: var(--gray-100);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.15s;
            flex-shrink: 0; /* Не сжимать кнопки */
        }

        .qty-btn:first-child {
            border-top-left-radius: var(--radius);
            border-bottom-left-radius: var(--radius);
        }

        .qty-btn:last-child {
            border-top-right-radius: var(--radius);
            border-bottom-right-radius: var(--radius);
        }

        .qty-btn:hover {
            background: var(--gray-200);
        }

        /* Status icon buttons with lucide */
        .status-icon-btn:hover {
            background: rgba(156, 163, 175, 0.1);
        }

        .duplicate-service-btn:hover {
            background: rgba(59, 130, 246, 0.1) !important;
            border-color: #3b82f6 !important;
            color: #3b82f6 !important;
        }

        .duplicate-service-btn:active {
            transform: scale(0.95);
        }

        .qty-input {
            width: 60px; /* Увеличено для трехзначных значений */
            min-width: 60px; /* Минимальная ширина для стабильности */
            border: none;
            text-align: center;
            font-size: 11px;
            font-weight: 500;
            padding: 4px 2px; /* Уменьшен padding для лучшего отображения */
            background: transparent;
        }

        /* Убираем стрелки вверх/вниз из input type="number" */
        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .qty-input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        /* Template Grid - компактная сетка по 2 в ряд */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: calc(var(--spacing) * 1.5);
        }

        .template-item {
            padding: 10px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            cursor: default;
            transition: all 0.15s;
            background: white;
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100px;
        }

        .template-item:hover {
            border-color: var(--gray-400);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .template-optional-btn {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            opacity: 0;
            z-index: 10;
        }

        .template-item:hover .template-optional-btn {
            opacity: 1;
        }

        .template-optional-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            transform: scale(1.1);
        }

        .template-optional-btn:active {
            transform: scale(0.95);
        }

        .template-other-services-btn {
            position: absolute;
            bottom: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.15s;
            opacity: 0;
            z-index: 10;
        }

        .template-item:hover .template-other-services-btn {
            opacity: 1;
        }

        .template-other-services-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: scale(1.1);
        }

        .template-other-services-btn:active {
            transform: scale(0.95);
        }

        .template-controls {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 5;
            pointer-events: none;
        }

        .template-btn {
            position: absolute;
            top: 0;
            height: 24px;
            width: 24px;
            border: none;
            border-radius: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 9px;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--gray-400);
            box-shadow: none;
            overflow: hidden;
            white-space: nowrap;
            background: var(--gray-50);
            pointer-events: auto;
        }

        .template-btn::before {
            content: attr(data-text);
            position: absolute;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 8px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .template-btn:hover {
            width: 120px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .template-btn:hover::before {
            opacity: 1;
            color: white;
        }

        .template-btn.edit {
            right: 0;
            border-top-right-radius: var(--radius);
            justify-content: flex-end;
            padding-right: 4px;
        }

        .template-btn.edit::before {
            left: 8px;
        }

        .template-btn.edit:hover {
            background: rgb(34, 197, 94);
            color: white;
        }

        .template-btn.add {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .template-btn.delete {
            left: 0;
            border-top-left-radius: var(--radius);
            justify-content: flex-start;
            padding-left: 4px;
        }

        .template-btn.delete::before {
            right: 8px;
            left: auto;
        }

        .template-btn.delete:hover {
            background: rgb(239, 68, 68);
            color: white;
        }

        .template-item.loading {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }

        .template-icon {
            font-size: 20px;
            margin-bottom: 6px;
            display: block;
            line-height: 1;
        }

        .template-name {
            font-size: 11px;
            font-weight: 600;
            color: var(--gray-900);
            margin-bottom: 2px;
            line-height: 1.3;
            word-break: break-word;
            hyphens: auto;
        }

        .template-item .text-xs {
            font-size: 9px;
            color: var(--gray-500);
            line-height: 1.2;
            margin-bottom: 4px;
            font-weight: 400;
        }

        .template-price {
            font-size: 11px;
            color: var(--success);
            font-weight: 600;
            margin-top: auto;
        }

        /* Totals */
        .total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(var(--spacing) * 2) 0;
            border-bottom: 1px solid var(--gray-200);
            font-size: 12px;
            transition: background-color 0.15s;
        }

        .total-row:last-child { border-bottom: none; }
        .total-row.updating { background-color: var(--gray-50); }

        .grand-total {
            background: linear-gradient(135deg, var(--primary), #3b82f6);
            color: white;
            padding: calc(var(--spacing) * 4);
            margin: calc(var(--spacing) * 4) 0;
            border-radius: var(--radius);
            font-weight: 700;
            transition: transform 0.15s;
        }

        .grand-total.updating {
            transform: scale(1.02);
        }

        .profit-box {
            background: var(--accent);
            color: white;
            padding: calc(var(--spacing) * 3);
            border-radius: var(--radius);
            font-size: 12px;
            margin-top: 0;
        }

        .hidden-markup {
            background: #f59e0b;
            color: white;
            padding: calc(var(--spacing) * 3);
            border-radius: var(--radius);
            font-size: 12px;
            margin-top: calc(var(--spacing) * 3);
        }

        /* Quote Settings */
        .quote-settings {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: calc(var(--spacing) * 3);
            margin-bottom: calc(var(--spacing) * 4);
        }

        /* Global Settings - now in right column */
        .global-settings {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: calc(var(--spacing) * 3);
            margin-bottom: calc(var(--spacing) * 4);
        }

        /* Services Detail List */
        .services-detail {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: calc(var(--spacing) * 3);
        }

        .service-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: calc(var(--spacing) * 2) 0;
            border-bottom: 1px solid var(--gray-200);
            font-size: 11px;
        }

        .service-detail-item:last-child {
            border-bottom: none;
        }

        .service-detail-name {
            flex: 1;
            font-weight: 500;
        }

        .service-detail-info {
            display: flex;
            gap: calc(var(--spacing) * 2);
            color: var(--gray-600);
        }

        /* Search and filters */
        .search-box {
            position: relative;
            margin-bottom: calc(var(--spacing) * 3);
        }

        .category-filter {
            display: flex;
            gap: calc(var(--spacing) * 1);
            margin-bottom: calc(var(--spacing) * 3);
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 3px 7px;
            border: 1px solid var(--gray-300);
            border-radius: 3px;
            background: white;
            font-size: 11px;
            font-weight: 500;
            color: var(--gray-700);
            cursor: pointer;
            transition: all 0.15s;
            line-height: 1.3;
        }

        .category-btn:hover {
            background: var(--gray-50);
            border-color: var(--gray-400);
        }

        .category-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 600;
        }

        /* Кнопка переключения категорий */
        #categories-toggle-btn:hover {
            color: var(--gray-700) !important;
        }

        /* Разворачивающаяся кнопка поиска */
        .search-expand-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
        }

        .search-expand-btn .search-icon {
            display: inline-block;
            transition: opacity 0.3s;
        }

        .search-expand-btn .search-input {
            width: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
            border: none;
            background: transparent;
            font-size: 11px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
        }

        .search-expand-btn.expanded {
            padding-right: 8px;
        }

        .search-expand-btn.expanded .search-icon {
            opacity: 0.7;
            margin-right: 4px;
        }

        .search-expand-btn.expanded .search-input {
            width: 120px;
            opacity: 1;
            padding: 0 4px;
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: calc(var(--spacing) * 3) calc(var(--spacing) * 4);
            background: var(--secondary);
            color: white;
            border-radius: var(--radius);
            font-size: 12px;
            z-index: 1001;
            transform: translateX(calc(100% + 20px));
            transition: transform 0.3s;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--warning);
        }

        /* Modal improvements */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: calc(var(--radius) * 2);
            padding: calc(var(--spacing) * 6);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        /* Расширенное окно для менеджера категорий */
        #categories-manager-modal .modal-content {
            width: 95vw;
            max-width: 95vw;
            height: 95vh;
            max-height: 95vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        /* Settings tabs */
        .settings-tab:hover {
            background-color: var(--gray-50);
            border-radius: 4px 4px 0 0;
        }

        .settings-tab:active {
            background-color: var(--gray-100);
        }

        /* Inline editing for regions */
        .region-manager-item.editing {
            background: #fffbeb !important;
            border: 2px solid var(--primary) !important;
        }

        .region-inline-edit {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .region-inline-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 13px;
            font-weight: 600;
            color: #92400e;
            padding: 4px 8px;
            outline: none;
        }

        .region-inline-input:focus {
            background: white;
            border: 1px solid var(--primary);
            border-radius: 4px;
        }

        .region-item-selected {
            background: #f3f4f6 !important;
            border-left: 3px solid var(--primary) !important;
        }

        /* Version display */
        .version-display {
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 10px;
            color: var(--gray-400);
            z-index: 1000;
            background: rgba(255,255,255,0.8);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .app {
                grid-template-columns: minmax(280px, 300px) 1fr minmax(280px, 300px);
            }
        }

        @media (max-width: 1024px) {
            .app {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr auto;
                height: auto;
                min-height: 100vh;
            }
            .panel {
                max-height: none;
                min-height: 300px;
            }
            .bulk-controls {
                flex-wrap: wrap;
                gap: calc(var(--spacing) * 2);
            }
        }

        /* Средние экраны - подстройка для узких панелей */
        @media (max-width: 1100px) {
            .global-settings .form-row label {
                width: 100% !important;
                margin-bottom: calc(var(--spacing) * 1);
            }

            .global-settings .form-row {
                flex-direction: column;
                align-items: stretch;
            }

            /* Карточки услуг - делаем labels короче */
            .service-content .form-row label[style*="width: 100px"] {
                width: 80px !important;
                font-size: 9px !important;
            }
        }

        @media (max-width: 768px) {
            .qty-btn, .btn-sm {
                min-width: 44px;
                min-height: 44px;
                font-size: 14px;
            }

            .template-btn {
                height: 32px;
                width: 32px;
                font-size: 14px;
            }

            .template-btn::before {
                font-size: 10px;
            }

            .template-controls {
                opacity: 1;
            }

            .template-item {
                min-height: 100px;
                padding: 10px;
            }

            .template-icon {
                font-size: 22px;
                margin-bottom: 6px;
            }

            .template-name {
                font-size: 11px;
                margin-bottom: 3px;
            }

            .template-item .text-xs {
                font-size: 9px;
            }

            .template-price {
                font-size: 11px;
                margin-top: 3px;
            }

            .template-optional-btn {
                width: 28px;
                height: 28px;
                font-size: 14px;
                opacity: 1;
                bottom: 4px;
                right: 4px;
            }

            .category-btn {
                padding: 5px 9px;
                font-size: 10px;
                min-height: 44px;
            }

            .form-row {
                flex-direction: column;
                gap: calc(var(--spacing) * 2);
            }

            .service-header-left {
                flex-direction: column;
                align-items: flex-start;
                gap: calc(var(--spacing) * 2);
            }

            /* ===== VIEW MODE TOGGLE - iOS Style Switch ===== */
            /* Настоящий iOS-style переключатель с плавной анимацией */
            .view-mode-toggle-container {
                display: flex;
                align-items: center;
                gap: 12px;
                margin: 0;
            }

            .view-mode-label {
                font-size: 13px;
                color: #6b7280;
                font-weight: 500;
                white-space: nowrap;
                user-select: none;
            }

            /* iOS Switch - точная копия переключателя iOS */
            .ios-switch {
                position: relative;
                display: inline-block;
                width: 51px;
                height: 31px;
                flex-shrink: 0;
            }

            .ios-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .ios-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #e5e5ea;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                border-radius: 31px;
                box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.04);
            }

            .ios-slider:before {
                position: absolute;
                content: "";
                height: 27px;
                width: 27px;
                left: 2px;
                bottom: 2px;
                background-color: white;
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                border-radius: 50%;
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15), 0 1px 1px rgba(0, 0, 0, 0.16);
            }

            /* Активное состояние - зеленый как в iOS */
            .ios-switch input:checked + .ios-slider {
                background-color: #34c759;
            }

            .ios-switch input:checked + .ios-slider:before {
                transform: translateX(20px);
            }

            /* Hover эффект */
            .ios-switch:hover .ios-slider {
                opacity: 0.9;
            }

            /* ===== TABLE VIEW MODE ===== */
            /* КРУПНАЯ и ЧИТАЕМАЯ таблица для быстрого просмотра услуг */
            .services-table-view {
                width: 100%;
                border-collapse: separate;
                border-spacing: 0;
                font-size: 15px;
                background: white;
                border-radius: 12px;
                overflow: hidden;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                border: 2px solid #e5e7eb;
            }

            .services-table-view thead {
                background: linear-gradient(180deg, #f8fafc 0%, #f1f5f9 100%);
                position: sticky;
                top: 0;
                z-index: 10;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .services-table-view th {
                padding: 18px 20px;
                text-align: left;
                font-weight: 700;
                font-size: 14px;
                color: #1e293b;
                text-transform: none;
                letter-spacing: 0;
                border-bottom: 3px solid #cbd5e1;
                white-space: nowrap;
            }

            .services-table-view tbody tr {
                border-bottom: 2px solid #f1f5f9;
                transition: all 0.2s ease;
            }

            .services-table-view tbody tr:last-child {
                border-bottom: none;
            }

            .services-table-view tbody tr:hover {
                background: #f8fafc;
                box-shadow: inset 0 0 0 1px #e2e8f0;
            }

            .services-table-view tbody tr.selected {
                background: #eff6ff;
                border-left: 4px solid var(--primary);
            }

            .services-table-view td {
                padding: 20px;
                color: #0f172a;
                vertical-align: middle;
                line-height: 1.5;
            }

            /* Колонка чекбокса */
            .services-table-view th.col-checkbox,
            .services-table-view td.col-checkbox {
                width: 50px;
                text-align: center;
                padding: 20px 12px;
            }

            /* Колонка названия - основная, КРУПНО */
            .services-table-view th.col-name,
            .services-table-view td.col-name {
                min-width: 250px;
                max-width: 400px;
                font-weight: 600;
                font-size: 15px;
                color: #0f172a;
            }

            /* Колонка дня - выделяем */
            .services-table-view th.col-day,
            .services-table-view td.col-day {
                width: 90px;
                text-align: center;
                font-weight: 700;
                color: #475569;
                font-size: 15px;
            }

            /* Колонка региона */
            .services-table-view th.col-region,
            .services-table-view td.col-region {
                width: 160px;
                font-size: 13px;
                color: #64748b;
            }

            /* Колонка цены */
            .services-table-view th.col-price,
            .services-table-view td.col-price {
                width: 110px;
                text-align: center;
            }

            /* Колонка количества */
            .services-table-view th.col-qty,
            .services-table-view td.col-qty {
                width: 90px;
                text-align: center;
            }

            /* Колонка наценки */
            .services-table-view th.col-markup,
            .services-table-view td.col-markup {
                width: 100px;
                text-align: center;
            }

            /* Колонка итого - КРУПНО и ЯРКО */
            .services-table-view th.col-total,
            .services-table-view td.col-total {
                width: 140px;
                text-align: right;
                font-weight: 800;
                font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
                color: #059669;
                font-size: 16px;
            }

            /* Колонка действий */
            .services-table-view th.col-actions,
            .services-table-view td.col-actions {
                width: 80px;
                text-align: center;
            }

            /* КРУПНЫЕ инпуты для таблицы */
            .services-table-view .table-input {
                width: 70px;
                padding: 10px 12px;
                font-size: 15px;
                font-weight: 600;
                border: 2px solid #cbd5e1;
                border-radius: 8px;
                text-align: center;
                background: white;
                transition: all 0.2s ease;
                font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
                color: #0f172a;
            }

            .services-table-view .table-input:hover {
                border-color: #94a3b8;
                background: #f8fafc;
            }

            .services-table-view .table-input:focus {
                outline: none;
                border-color: #3b82f6;
                box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15);
                background: white;
            }

            /* Кнопки в таблице */
            .services-table-view .table-btn {
                padding: 3px 8px;
                font-size: 10px;
                background: transparent;
                border: 1px solid #e5e7eb;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.15s ease;
            }

            .services-table-view .table-btn:hover {
                background: #f3f4f6;
                border-color: #d1d5db;
            }

            .services-table-view .table-btn-delete {
                color: #ef4444;
                border-color: #fecaca;
            }

            .services-table-view .table-btn-delete:hover {
                background: #fef2f2;
                border-color: #ef4444;
            }

            /* Адаптивность модального окна настроек */
            #categories-manager-modal .modal-content {
                width: 98vw;
                height: 98vh;
                padding: calc(var(--spacing) * 3);
            }

            /* Вкладки в модальном окне - однаколоночный режим */
            .settings-tab-content > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: calc(var(--spacing) * 3) !important;
            }
        }

        /* Планшеты - адаптация двухколоночной системы */
        @media (max-width: 1024px) {
            #categories-manager-modal .modal-content {
                width: 95vw;
                height: 95vh;
            }

            .settings-tab-content > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
            }
        }

        /* Print */
        @media print {
            body { background: white; font-size: 11pt; }
            #global-header { display: none !important; }
            .app { display: none !important; }
            .notification { display: none !important; }
            .version-display { display: none !important; }
            .print-preview { display: block !important; padding: 1cm; }
            .print-table { width: 100%; border-collapse: collapse; margin: 1cm 0; }
            .print-table th, .print-table td { padding: 8pt; border: 1px solid #ddd; }
            .print-table th { background: #f5f5f5; font-weight: 600; }
        }

        .print-preview { display: none; }

        .template-edit-btn, .template-add-btn {
            width: 16px;
            height: 16px;
            border: 1px solid var(--gray-400);
            background: white;
            border-radius: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            transition: all 0.15s;
            color: var(--gray-600);
        }

        .template-edit-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .template-add-btn:hover {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }

        .template-item.editing {
            border-color: var(--primary);
            background: var(--gray-50);
            transform: none;
        }

        .template-edit-field {
            border: 1px solid var(--gray-300);
            border-radius: calc(var(--radius) / 2);
            padding: 2px 4px;
            background: white;
        }

        .template-edit-field:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Loading states */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* Cancellation Policy Table */
        .policy-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.5cm 0;
            font-size: 9pt;
        }
        
        .policy-table th, .policy-table td {
            padding: 6pt;
            border: 1px solid #333;
            text-align: left;
        }
        
        .policy-table th {
            background: #f0f0f0;
            font-weight: 700;
        }
        
        .policy-table .no-fee {
            color: #059669;
            font-weight: 600;
        }
        
        .policy-table .penalty {
            color: #dc2626;
            font-weight: 600;
        }

        /* Inline input for editing fields */
        .inline-input {
            border: 1px solid var(--gray-300);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 13px;
            text-align: center;
            background: white;
        }

        .inline-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }

        /* Checklist Mode Styles */
        .checklist-filter-btn,
        .checklist-view-btn {
            padding: 6px 12px;
            border: none;
            background: transparent;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--gray-600);
        }

        .checklist-filter-btn:hover,
        .checklist-view-btn:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .checklist-filter-btn.active,
        .checklist-view-btn.active {
            background: white;
            color: inherit;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .checklist-group {
            animation: fadeIn 0.2s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .checklist-service-card {
            transition: all 0.2s;
        }

        .checklist-service-card:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Dropdown menu styles */
        .dropdown-item:hover {
            background: #f3f4f6 !important;
        }

        #file-dropdown-menu button:first-child {
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }

        #file-dropdown-menu button:last-child {
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
            border-bottom: none !important;
        }
    </style>
</head>
<body>
    <!-- Global Header - всегда видимый header с переключателем режимов -->
    <div id="global-header" style="background: white; border-bottom: 1px solid var(--gray-200); padding: 12px 20px; display: flex; align-items: center; gap: 20px;">
        <!-- Логотип по левому краю -->
        <div style="line-height: 1.2; text-align: left;">
            <div style="font-family: 'Georgia', serif; font-size: 18px; font-weight: 900; color: #1e40af; letter-spacing: 0.5px;">MAGELLANIA</div>
            <div style="font-size: 10px; color: #6b7280; font-weight: 500; text-transform: uppercase; letter-spacing: 1px;">Travel Company</div>
        </div>

        <!-- Переключатель режимов -->
        <div class="mode-switcher" style="display: flex; background: var(--gray-100); border-radius: 6px; padding: 2px; gap: 2px;">
            <button id="mode-quote-btn" class="mode-tab active" onclick="window.QuoteCalc.switchMode('quote')"
                    style="padding: 6px 16px; border: none; background: white; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                Смета
            </button>
            <button id="mode-checklist-btn" class="mode-tab" onclick="window.QuoteCalc.switchMode('checklist')"
                    style="padding: 6px 16px; border: none; background: transparent; border-radius: 4px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--gray-600);">
                Чеклист
            </button>
        </div>

        <!-- Quote Status Bar - компактная версия для header -->
        <div id="quote-status-bar-header" style="display: flex; gap: 12px; align-items: center; font-size: 11px; color: #6b7280; flex: 1; min-width: 0;">
            <span id="quote-file-status-header" title="Текущий файл" style="display: flex; align-items: center; gap: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                <i data-lucide="file-text" style="width: 12px; height: 12px; flex-shrink: 0;"></i>
                <span style="color: #374151;">Новая смета</span>
            </span>
            <span id="quote-save-status-header" style="font-size: 14px; flex-shrink: 0;">●</span>
        </div>

        <!-- Правая панель: Dropdown меню файлов + Настройки -->
        <div style="display: flex; gap: 8px; align-items: center;">
            <!-- Кнопка "Мои сметы" -->
            <button id="my-estimates-btn" class="btn btn-sm" onclick="window.showEstimatesList()" title="Показать все сохранённые сметы"
                    style="padding: 6px 12px; background: #1e40af; color: white; display: flex; align-items: center; gap: 6px;">
                <i data-lucide="list" style="width: 14px; height: 14px;"></i>
                <span style="font-size: 11px;">Мои сметы</span>
            </button>

            <!-- Dropdown меню управления файлами -->
            <div style="position: relative;">
                <button id="file-menu-btn" class="btn btn-sm" onclick="window.QuoteCalc.toggleFileMenu()"
                        style="padding: 6px 12px; background: #f3f4f6; color: #374151; display: flex; align-items: center; gap: 6px;">
                    <i data-lucide="folder-open" style="width: 14px; height: 14px;"></i>
                    <span style="font-size: 11px;">Файл</span>
                    <i data-lucide="chevron-down" style="width: 12px; height: 12px;"></i>
                </button>
                <!-- Dropdown меню (скрыто по умолчанию) -->
                <div id="file-dropdown-menu" style="display: none; position: absolute; top: calc(100% + 4px); right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); min-width: 180px; z-index: 1000;">
                    <input type="file" id="load-quote" accept=".json,.csv" style="display: none;" onchange="QuoteCalc.loadQuoteFile(event)">
                    <button class="dropdown-item" onclick="window.QuoteCalc.reset(); window.QuoteCalc.toggleFileMenu();" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; color: #374151; border-bottom: 1px solid #f3f4f6;">
                        <i data-lucide="file-plus" style="width: 14px; height: 14px;"></i>
                        Новая смета
                    </button>
                    <button class="dropdown-item" onclick="window.QuoteCalc.openQuoteFile(); window.QuoteCalc.toggleFileMenu();" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; color: #374151; border-bottom: 1px solid #f3f4f6;">
                        <i data-lucide="folder-open" style="width: 14px; height: 14px;"></i>
                        Открыть смету
                    </button>
                    <button class="dropdown-item" onclick="window.QuoteCalc.saveQuoteJSON(); window.QuoteCalc.toggleFileMenu();" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; color: #374151; border-bottom: 1px solid #f3f4f6;">
                        <i data-lucide="save" style="width: 14px; height: 14px;"></i>
                        Сохранить на сервер
                    </button>
                    <button class="dropdown-item" onclick="window.QuoteCalc.downloadBackup(); window.QuoteCalc.toggleFileMenu();" style="width: 100%; text-align: left; padding: 10px 16px; border: none; background: none; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 8px; color: #374151;">
                        <i data-lucide="download" style="width: 14px; height: 14px;"></i>
                        Скачать бэкап
                    </button>
                </div>
            </div>

            <!-- Кнопка настроек -->
            <button class="btn btn-sm" onclick="window.QuoteCalc.showCategoriesManager()" title="Управление категориями" style="padding: 6px 10px; background: #e5e7eb; color: #374151;">
                <i data-lucide="settings" style="width: 14px; height: 14px;"></i>
            </button>
        </div>
    </div>

    <div class="app">
        <!-- Services Catalog + Global Settings -->
        <div class="panel">
            <div class="panel-content">
                <!-- Каталог услуг и управление -->
                <div style="margin-bottom: calc(var(--spacing) * 2); padding-bottom: calc(var(--spacing) * 1.5); border-bottom: 1px solid var(--gray-200);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 1);">
                        <div class="text-sm font-medium" style="color: var(--gray-700);">Каталог услуг</div>
                        <!-- Селектор регионов -->
                        <div id="region-selector-block" style="display: flex; align-items: center; gap: 6px;">
                            <span class="text-xs" style="color: var(--gray-500);">Регион:</span>
                            <select id="region-selector" class="input" style="width: 140px; font-size: 11px; padding: 4px 8px;" onchange="QuoteCalc.changeRegion(this.value)">
                                <option value="Default">По умолчанию</option>
                            </select>
                        </div>
                    </div>
                    <div style="display: flex; gap: 6px; align-items: center; flex-wrap: wrap;">
                        <button class="category-btn active" data-category="all">Все</button>
                        <button id="categories-toggle-btn" onclick="window.QuoteCalc.toggleCategories()" style="border: none; background: none; cursor: pointer; padding: 4px; color: var(--gray-500); font-size: 12px; transition: color 0.15s;" title="Показать/скрыть категории">▼</button>
                    </div>
                    <div id="category-buttons-container" style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: calc(var(--spacing) * 1);"></div>
                </div>

                <!-- Поиск и добавление услуги -->
                <div style="display: flex; gap: 6px; align-items: center; margin-bottom: calc(var(--spacing) * 2);">
                    <button id="search-expand-btn" class="btn btn-sm search-expand-btn" onclick="window.QuoteCalc.toggleSearchExpand()" title="Поиск" style="padding: 4px 8px; font-size: 12px;">
                        <span class="search-icon"><i data-lucide="search"></i></span>
                        <input type="text" class="search-input" placeholder="Поиск..." id="search" oninput="QuoteCalc.filterTemplates(this.value)" onclick="event.stopPropagation()">
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.showCatalogModal()" style="padding: 4px 10px; font-size: 11px; margin-left: auto;">+ Услуга</button>
                </div>

                <div id="templates-list" class="template-grid"></div>
            </div>
        </div>

        <!-- Quote Builder -->
        <div class="panel">
            <div class="panel-header" style="display: flex; align-items: center; justify-content: space-between;">
                <div class="font-semibold" style="font-size: 14px;">Расчет сметы</div>
            </div>

            <div class="panel-content">
                <!-- Quote Settings -->
                <div class="quote-settings">
                    <!-- Адаптивная сетка для данных клиента -->
                    <div class="client-info-grid">
                        <div style="grid-column: 1 / -1; display: flex; gap: 10px; align-items: flex-end;">
                            <div style="display: flex; flex-direction: column; gap: 2px;">
                                <label style="font-size: 11px; font-weight: 500; color: var(--gray-700);">PAX:</label>
                                <input type="number" class="input" value="27" min="1" id="pax-count" style="width: 60px;">
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 2px; flex: 1;">
                                <label style="font-size: 11px; font-weight: 500; color: var(--gray-700);">Даты:</label>
                                <div class="dates-group">
                                    <input type="date" class="input" id="tour-start">
                                    <span class="text-xs text-muted">—</span>
                                    <input type="date" class="input" id="tour-end">
                                </div>
                            </div>

                            <div style="display: flex; flex-direction: column; gap: 2px; flex: 1;">
                                <label style="font-size: 11px; font-weight: 500; color: var(--gray-700);">Заказчик:</label>
                                <input type="text" class="input" placeholder="ФИО" id="client-name">
                            </div>
                        </div>

                        <div class="client-info-row">
                            <label>Телефон:</label>
                            <input type="text" class="input" placeholder="Любой формат" id="client-phone">
                        </div>

                        <div class="client-info-row">
                            <label>Email:</label>
                            <input type="email" class="input" placeholder="email@example.com" id="client-email">
                        </div>
                    </div>

                    <!-- Комментарии под катом -->
                    <div class="collapsible" id="quote-comments-section">
                        <div class="collapsible-header" onclick="window.QuoteCalc.toggleQuoteComments()">
                            <span class="collapsible-header-title">
                                💬 Комментарии
                                <span style="font-size: 0.85em; color: #999; font-weight: normal;">(не печатается)</span>
                            </span>
                            <span class="collapsible-toggle">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-content-inner">
                                <div id="quote-description-editor" class="quill-editor-container"></div>
                                <textarea class="textarea" placeholder="Внутренние заметки, пожелания клиента, важная информация" id="quote-description" style="display: none;"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible Program Description -->
                    <div class="collapsible" id="program-description-section">
                        <div class="collapsible-header" onclick="window.QuoteCalc.toggleProgramDescription()">
                            <span class="collapsible-header-title">
                                <i data-lucide="clipboard-list" style="width: 14px; height: 14px; vertical-align: middle;"></i> Описание программы
                                <span style="font-size: 0.85em; color: #999; font-weight: normal;">(для печати)</span>
                            </span>
                            <span class="collapsible-toggle">▼</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="collapsible-content-inner">
                                <div id="program-description-editor" class="quill-editor-container"></div>
                                <textarea class="textarea" placeholder="Описание программы тура для клиента" id="program-description" style="display: none;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- STICKY CONTROLS CONTAINER -->
                <div id="sticky-controls-wrapper" style="position: sticky; top: 0; z-index: 100; background: white; padding: 12px 0; margin: 0 -16px; padding-left: 16px; padding-right: 16px; border-bottom: 1px solid #e5e7eb;">
                    <!-- Add Service Button & Services Filters -->
                    <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.showServiceModal()" style="padding: 4px 10px; font-size: 11px;">+ Добавить услугу</button>

                        <div id="services-filters" style="display: none; flex: 1;">
                            <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                                <!-- VIEW MODE TOGGLE - iOS Style Switch -->
                                <!-- Переключатель режимов отображения: карточки / таблица -->
                                <div class="view-mode-toggle-container">
                                    <span class="view-mode-label">Карточки</span>
                                    <label class="ios-switch">
                                        <input type="checkbox" id="view-mode-checkbox" onchange="QuoteCalc.toggleViewMode()">
                                        <span class="ios-slider"></span>
                                    </label>
                                    <span class="view-mode-label">Таблица</span>
                                </div>

                                <!-- Разделитель -->
                                <div style="width: 1px; height: 20px; background: #e5e7eb; margin: 0 4px;"></div>

                                <label style="font-size: 11px; color: #9ca3af;">Сортировка:</label>
                                <select id="services-sort-by" class="input" style="width: auto; min-width: 120px; font-size: 10px; padding: 4px 8px; height: 26px;" onchange="QuoteCalc.handleServicesSortChange()">
                                    <option value="order">Отсутствует</option>
                                    <option value="region">По региону → по дням</option>
                                    <option value="day" selected>По дням тура</option>
                                    <option value="contractor">По подрядчикам</option>
                                </select>
                                <button class="btn btn-sm" onclick="window.QuoteCalc.toggleSortDirection()" id="sort-direction-btn" title="Изменить направление сортировки" style="padding: 4px 8px; font-size: 12px; height: 26px; background: #f3f4f6; color: #6b7280;">↑</button>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Controls Container -->
                    <div id="bulk-controls-container"></div>
                </div>

                <div id="services-list"></div>

                <!-- Секция: Отели -->
                <div style="margin-top: calc(var(--spacing) * 6); border-top: 2px dashed var(--gray-300); padding-top: calc(var(--spacing) * 4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 3);">
                        <h3 style="margin: 0; font-size: 16px; color: var(--gray-900); font-weight: 600;">🏨 Отели</h3>
                        <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.showAddHotelModal()" style="font-size: 12px; padding: 6px 12px;">+ Добавить отель</button>
                    </div>
                    <div id="hotels-list">
                        <!-- Динамически генерируется -->
                    </div>
                </div>

                <!-- Секция: Перелёты -->
                <div style="margin-top: calc(var(--spacing) * 6); border-top: 2px dashed var(--gray-300); padding-top: calc(var(--spacing) * 4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 3);">
                        <h3 style="margin: 0; font-size: 16px; color: var(--gray-900); font-weight: 600;">✈️ Перелёты</h3>
                        <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.showAddFlightModal()" style="font-size: 12px; padding: 6px 12px;">+ Добавить перелёт</button>
                    </div>
                    <div id="flights-list">
                        <!-- Динамически генерируется -->
                    </div>
                </div>

                <!-- Секция: Прочие услуги -->
                <div style="margin-top: calc(var(--spacing) * 6); border-top: 2px dashed var(--gray-300); padding-top: calc(var(--spacing) * 4);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 3);">
                        <h3 style="margin: 0; font-size: 16px; color: var(--gray-900); font-weight: 600;">📋 Прочие услуги</h3>
                        <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.showAddOtherServiceModal()" style="font-size: 12px; padding: 6px 12px;">+ Добавить</button>
                    </div>
                    <div id="other-services-list">
                        <!-- Динамически генерируется -->
                    </div>
                </div>

                <!-- Optional Services Section -->
                <div style="margin-top: calc(var(--spacing) * 8); border-top: 2px dashed var(--gray-300); padding-top: calc(var(--spacing) * 6);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: calc(var(--spacing) * 4);">
                        <div>
                            <h3 style="margin: 0; color: var(--gray-700); font-size: 14px; font-weight: 600;">Опциональные услуги</h3>
                            <p style="margin: calc(var(--spacing) * 1) 0 0 0; font-size: 11px; color: var(--gray-500);">
                                Услуги на выбор клиента (не входят в основную стоимость)
                            </p>
                        </div>
                        <button class="btn btn-sm" onclick="window.QuoteCalc.showOptionalServiceModal()" style="flex-shrink: 0;">+ Добавить услугу</button>
                    </div>
                    <div id="optional-services-list"></div>
                </div>
            </div>
        </div>

        <!-- Totals & Controls & Details -->
        <div class="panel">
            <div class="panel-header">
                <div class="font-semibold" style="font-size: 14px;">Расчет стоимости</div>
            </div>
            <div class="panel-content">
                <!-- Global Settings moved to right column -->
                <div class="global-settings">
                    <div style="font-weight: 600; margin-bottom: calc(var(--spacing) * 2); color: var(--gray-700); font-size: 11px;">
                        Настройки ценообразования
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: calc(var(--spacing) * 1.5);">
                        <div>
                            <label style="font-size: 10px; color: var(--gray-600); display: block; margin-bottom: 4px;">Скрытая наценка:</label>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <input type="text" id="hidden-markup" class="input" style="width: 50px; text-align: center;" value="0,0" inputmode="decimal">
                                <span style="font-size: 10px; color: var(--gray-500);">%</span>
                            </div>
                        </div>
                        <div>
                            <label style="font-size: 10px; color: var(--gray-600); display: block; margin-bottom: 4px;" title="Комиссия за привлечение клиента">Комиссия партнера:</label>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <input type="text" id="partner-commission" class="input" style="width: 50px; text-align: center;" value="0,0" inputmode="decimal">
                                <span style="font-size: 10px; color: var(--gray-500);">%</span>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Calculations - единая плашка -->
                <div class="profit-box" style="background: white; border: 1px solid var(--gray-200); color: var(--gray-900);">
                    <!-- Себестоимость -->
                    <div style="display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 6px;">
                        <span style="color: var(--gray-600);">Себестоимость:</span>
                        <span id="cost-price" style="font-weight: 600;">$0</span>
                    </div>

                    <!-- Individual Markup (if any) -->
                    <div id="individual-markup-info" style="display: none; margin-bottom: 6px;">
                        <div style="display: flex; justify-content: space-between; font-size: 10px;">
                            <span style="color: var(--gray-600);">+ Индивидуальные наценки:</span>
                            <span id="individual-markup-amount" style="font-weight: 500; color: var(--gray-700);">$0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 10px; margin-top: 2px; padding-top: 4px; border-top: 1px solid var(--gray-200);">
                            <span style="color: var(--gray-600);">= Сумма с наценками:</span>
                            <span id="total-with-markup" style="font-weight: 500; color: var(--gray-700);">$0</span>
                        </div>
                    </div>

                    <!-- Hidden Markup -->
                    <div id="hidden-markup-info" style="display: none; margin-bottom: 6px;">
                        <div style="display: flex; justify-content: space-between; font-size: 10px;">
                            <span style="color: #d97706;">+ Скрытая маржа:</span>
                            <span id="hidden-markup-amount" style="font-weight: 500; color: #d97706;">$0</span>
                        </div>
                    </div>

                    <!-- Наша прибыль -->
                    <div style="display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; padding-top: 8px; border-top: 1px solid var(--gray-200);">
                        <span style="color: #16a34a; font-weight: 600;">Наша прибыль:</span>
                        <span id="total-profit" style="font-weight: 700; color: #16a34a;">$0</span>
                    </div>

                    <!-- Комиссия партнера -->
                    <div id="partner-commission-row" style="display: none; margin-bottom: 6px;">
                        <div style="display: flex; justify-content: space-between; font-size: 10px;">
                            <span style="color: var(--gray-600);">Комиссия партнера:</span>
                            <span id="partner-commission-amount" style="font-weight: 500; color: var(--gray-700);">$0</span>
                        </div>
                    </div>

                    <!-- Итого клиенту -->
                    <div style="display: flex; justify-content: space-between; font-size: 14px; padding-top: 10px; margin-top: 6px; border-top: 2px solid var(--primary);">
                        <span style="font-weight: 700; color: var(--primary);">ИТОГО КЛИЕНТУ</span>
                        <span id="grand-total" style="font-weight: 700; color: var(--primary);">$0</span>
                    </div>
                </div>

                <!-- Кнопки печати и отправки -->
                <div style="display: flex; gap: 8px; margin-top: calc(var(--spacing) * 3);">
                    <button class="btn btn-sm btn-secondary" style="flex: 1;" title="Печать КП (Ctrl+P)" onclick="window.QuoteCalc.print()">
                        <i data-lucide="printer"></i> Печать КП
                    </button>
                    <button class="btn btn-sm" style="flex: 1;" onclick="window.QuoteCalc.sendEmail()" title="Отправить КП по email">
                        <i data-lucide="mail"></i> Email
                    </button>
                </div>

                <!-- Services Detail List -->
                <div class="services-detail" style="margin-top: calc(var(--spacing) * 4.2);">
                    <div style="font-weight: 600; margin-bottom: calc(var(--spacing) * 3); color: var(--gray-700);">
                        Детализация услуг
                    </div>
                    <div id="services-detail-list"></div>
                </div>
            </div>
        </div>

        <!-- Checklist Mode Container (hidden by default) -->
        <div id="checklist-container" class="panel" style="display: none; grid-column: 1 / -1; grid-row: 1;">
            <!-- Checklist Header with counters and controls -->
            <div class="panel-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <div class="font-semibold" style="font-size: 14px;">Чеклист бронирований</div>

                    <!-- Counters -->
                    <div style="display: flex; gap: 16px; font-size: 12px;">
                        <div><span style="color: var(--gray-600);">Забронировано:</span> <span id="cnt-booked" style="font-weight: 600;">0</span></div>
                        <div><span style="color: var(--gray-600);">Оплачено:</span> <span id="cnt-paid" style="font-weight: 600;">0</span></div>
                        <div><span style="color: var(--gray-600);">Не обработано:</span> <span id="cnt-unprocessed" style="font-weight: 600;">0</span></div>
                    </div>
                </div>
            </div>

            <div class="panel-content">
                <!-- Controls: Filters and View Modes -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 3); padding-bottom: calc(var(--spacing) * 2); border-bottom: 1px solid var(--gray-200);">
                    <!-- Filters -->
                    <div style="display: flex; gap: 8px; background: var(--gray-100); padding: 3px; border-radius: 6px;">
                        <button class="checklist-filter-btn active" data-filter="all" style="padding: 4px 12px; border: none; background: white; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s;">Все</button>
                        <button class="checklist-filter-btn" data-filter="booked" style="padding: 4px 12px; border: none; background: transparent; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--gray-600);">Забронировано</button>
                        <button class="checklist-filter-btn" data-filter="paid" style="padding: 4px 12px; border: none; background: transparent; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--gray-600);">Оплачено</button>
                        <button class="checklist-filter-btn" data-filter="unprocessed" style="padding: 4px 12px; border: none; background: transparent; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--gray-600);">Не обработано</button>
                    </div>

                    <!-- View Mode -->
                    <div style="display: flex; gap: 8px; background: var(--gray-100); padding: 3px; border-radius: 6px;">
                        <button id="view-by-day" class="checklist-view-btn active" data-view="day" style="padding: 4px 12px; border: none; background: white; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s;">По дням</button>
                        <button id="view-by-supplier" class="checklist-view-btn" data-view="supplier" style="padding: 4px 12px; border: none; background: transparent; border-radius: 4px; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; color: var(--gray-600);">По поставщикам</button>
                    </div>
                </div>

                <!-- Checklist content -->
                <div id="checklist-content" style="display: flex; flex-direction: column; gap: calc(var(--spacing) * 3);"></div>
            </div>
        </div>
    </div>

    <!-- Service Modal -->
    <div class="modal" id="service-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 4);">
                <h3 id="service-modal-title">Добавить услугу</h3>
                <button onclick="window.QuoteCalc.hideServiceModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            </div>

            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Название:</label>
                <input type="text" class="input" id="service-name" placeholder="Название услуги">
            </div>

            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Описание:</label>
                <input type="text" class="input" id="service-description" placeholder="Комментарии">
            </div>

            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Контрагент:</label>
                <input type="text" class="input" id="service-contractor" placeholder="Название компании (необязательно)">
            </div>

            <div class="form-row" id="service-region-row" style="display: none;">
                <label class="text-sm font-medium" style="width: 80px;">📍 Регион:</label>
                <select class="input" id="service-region" style="width: 200px;">
                    <!-- Заполняется динамически -->
                </select>
            </div>

            <div class="form-row" id="service-day-row">
                <label class="text-sm font-medium" style="width: 80px;">День тура:</label>
                <input type="number" class="input" id="service-day" placeholder="1" min="1" style="width: 60px;">
            </div>

            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;" id="service-price-label">Цена:</label>
                <input type="number" class="input" id="service-price" placeholder="0" min="0" style="width: 80px;">
                <span class="text-xs text-muted">USD</span>
            </div>

            <div style="display: flex; gap: calc(var(--spacing) * 2); margin-top: calc(var(--spacing) * 6);">
                <button class="btn" onclick="window.QuoteCalc.hideServiceModal()">Отмена</button>
                <button class="btn btn-primary" onclick="window.QuoteCalc.addCustomService()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Catalog Modal -->
    <div class="modal" id="catalog-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 4);">
                <h3 id="catalog-modal-title">Добавить в каталог</h3>
                <button onclick="window.QuoteCalc.hideCatalogModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            </div>
            
            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Название:</label>
                <input type="text" class="input" id="catalog-name" placeholder="Название услуги">
            </div>

            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Регион:</label>
                <select class="input" id="catalog-region" style="width: 150px;"></select>
            </div>

            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Категория:</label>
                <select class="input" id="catalog-category" style="width: 120px;"></select>
            </div>

            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Описание:</label>
                <input type="text" class="input" id="catalog-description" placeholder="Комментарии к услуге">
            </div>

            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Контрагент:</label>
                <input type="text" class="input" id="catalog-contractor" placeholder="Название компании (необязательно)">
            </div>
            
            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Иконка:</label>
                <select class="input" id="catalog-icon" style="width: 100px;">
                    <optgroup label="Транспорт">
                        <option value="🚗">🚗 Легковой</option>
                        <option value="🚐">🚐 Минивэн</option>
                        <option value="🚌">🚌 Автобус</option>
                        <option value="🚕">🚕 Такси</option>
                        <option value="🚙">🚙 Внедорожник</option>
                        <option value="🛻">🛻 Пикап</option>
                        <option value="🚂">🚂 Поезд</option>
                        <option value="✈️">✈️ Самолет</option>
                        <option value="🛳️">🛳️ Корабль</option>
                        <option value="⛵">⛵ Яхта</option>
                        <option value="🚁">🚁 Вертолет</option>
                        <option value="🚠">🚠 Канатная дорога</option>
                    </optgroup>
                    <optgroup label="Размещение">
                        <option value="🏨">🏨 Отель</option>
                        <option value="🏩">🏩 Мотель</option>
                        <option value="🏠">🏠 Дом</option>
                        <option value="🏡">🏡 Коттедж</option>
                        <option value="🏘️">🏘️ Комплекс</option>
                        <option value="🏢">🏢 Апартаменты</option>
                        <option value="🏰">🏰 Замок</option>
                        <option value="⛺">⛺ Кемпинг</option>
                    </optgroup>
                    <optgroup label="Активности">
                        <option value="🏛️">🏛️ Музей</option>
                        <option value="🎭">🎭 Театр</option>
                        <option value="🎪">🎪 Цирк</option>
                        <option value="🎢">🎢 Парк развлечений</option>
                        <option value="🎡">🎡 Колесо обозрения</option>
                        <option value="🎠">🎠 Карусель</option>
                        <option value="🎯">🎯 Активность</option>
                        <option value="🎳">🎳 Боулинг</option>
                        <option value="🎮">🎮 Игры</option>
                        <option value="🎲">🎲 Казино</option>
                        <option value="🏊">🏊 Плавание</option>
                        <option value="🚴">🚴 Велосипед</option>
                        <option value="⛷️">⛷️ Лыжи</option>
                        <option value="🏔️">🏔️ Горы</option>
                        <option value="🏖️">🏖️ Пляж</option>
                        <option value="🌊">🌊 Море</option>
                    </optgroup>
                    <optgroup label="Питание">
                        <option value="🍽️">🍽️ Ресторан</option>
                        <option value="🍕">🍕 Пиццерия</option>
                        <option value="🍔">🍔 Фаст-фуд</option>
                        <option value="☕">☕ Кафе</option>
                        <option value="🍷">🍷 Бар</option>
                        <option value="🥂">🥂 Банкет</option>
                        <option value="🍰">🍰 Кондитерская</option>
                    </optgroup>
                    <optgroup label="Услуги">
                        <option value="👨‍🏫">👨‍🏫 Гид</option>
                        <option value="📷">📷 Фотограф</option>
                        <option value="🎤">🎤 Аудиогид</option>
                        <option value="💼">💼 Бизнес</option>
                        <option value="🛡️">🛡️ Страховка</option>
                        <option value="💊">💊 Медицина</option>
                        <option value="🔧">🔧 Техподдержка</option>
                        <option value="📱">📱 Связь</option>
                        <option value="💳">💳 Платежи</option>
                        <option value="🎫">🎫 Билеты</option>
                        <option value="📋">📋 Документы</option>
                        <option value="📄">📄 Виза</option>
                    </optgroup>
                    <optgroup label="Прочее">
                        <option value="⭐">⭐ VIP</option>
                        <option value="🎁">🎁 Подарок</option>
                        <option value="🎉">🎉 Праздник</option>
                        <option value="👍">👍 Сюрприз</option>
                        <option value="🌟">🌟 Премиум</option>
                        <option value="💎">💎 Люкс</option>
                        <option value="🏆">🏆 Эксклюзив</option>
                        <option value="📍">📍 Локация</option>
                        <option value="🗺️">🗺️ Маршрут</option>
                        <option value="⏰">⏰ Время</option>
                        <option value="📅">📅 Расписание</option>
                        <option value="✅">✅ Включено</option>
                        <option value="❓">❓ Опция</option>
                        <option value="💰">💰 Оплата</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Цена:</label>
                <input type="number" class="input" id="catalog-price" placeholder="0" min="0" style="width: 80px;">
                <span class="text-xs text-muted">USD</span>
            </div>
            
            <div style="display: flex; gap: calc(var(--spacing) * 2); margin-top: calc(var(--spacing) * 6);">
                <button class="btn" onclick="window.QuoteCalc.hideCatalogModal()">Отмена</button>
                <button class="btn" id="catalog-duplicate-btn" onclick="window.QuoteCalc.duplicateCurrentTemplate()" style="display: none; background: var(--gray-100); flex: 1;">📋 Дублировать шаблон</button>
                <button class="btn btn-primary" id="catalog-modal-btn" onclick="window.QuoteCalc.addToCatalog()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Category Modal -->
    <div class="modal" id="category-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 4);">
                <h3>Добавить категорию</h3>
                <button onclick="window.QuoteCalc.hideCategoryModal()" style="background: none; border: none; font-size: 20px; cursor: pointer;">×</button>
            </div>
            
            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Название:</label>
                <input type="text" class="input" id="category-name" placeholder="Название категории">
            </div>
            
            <div class="form-row">
                <label class="text-sm font-medium" style="width: 80px;">Иконка:</label>
                <select class="input" id="category-icon" style="width: 100px;">
                    <option value="🚗">🚗 Трансфер</option>
                    <option value="🏨">🏨 Отели</option>
                    <option value="👨‍🏫">👨‍🏫 Гиды</option>
                    <option value="🏛️">🏛️ Активности</option>
                    <option value="🔧">🔧 Сервис</option>
                    <option value="🍽️">🍽️ Питание</option>
                    <option value="🎫">🎫 Билеты</option>
                    <option value="📋">📋 Документы</option>
                    <option value="💼">💼 Бизнес</option>
                    <option value="🛡️">🛡️ Страховка</option>
                </select>
            </div>
            
            <div style="display: flex; gap: calc(var(--spacing) * 2); margin-top: calc(var(--spacing) * 6);">
                <button class="btn" onclick="window.QuoteCalc.hideCategoryModal()">Отмена</button>
                <button class="btn btn-primary" onclick="window.QuoteCalc.addCategory()">Добавить</button>
            </div>
        </div>
    </div>

    <!-- Categories Manager Modal -->
    <div class="modal" id="categories-manager-modal">
        <div class="modal-content">
            <!-- Заголовок -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: calc(var(--spacing) * 2); padding-bottom: calc(var(--spacing) * 2); border-bottom: 1px solid var(--gray-200);">
                <h3 class="text-lg font-semibold" style="color: var(--gray-900);">Настройки</h3>
                <button onclick="window.QuoteCalc.hideCategoriesManager()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--gray-400); line-height: 1;">×</button>
            </div>

            <!-- Вкладки -->
            <div style="display: flex; gap: calc(var(--spacing) * 1); margin-bottom: calc(var(--spacing) * 3); border-bottom: 2px solid var(--gray-200);">
                <button class="settings-tab active" data-tab="main" onclick="window.QuoteCalc.switchSettingsTab('main')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid var(--primary); color: var(--primary); font-weight: 600; cursor: pointer; margin-bottom: -2px; transition: all 0.2s;">
                    Основные
                </button>
                <button class="settings-tab" data-tab="advanced" onclick="window.QuoteCalc.switchSettingsTab('advanced')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--gray-500); font-weight: 500; cursor: pointer; margin-bottom: -2px; transition: all 0.2s;">
                    Каталоги и регионы
                </button>
                <button class="settings-tab" data-tab="document" onclick="window.QuoteCalc.switchSettingsTab('document')" style="padding: 12px 24px; background: none; border: none; border-bottom: 3px solid transparent; color: var(--gray-500); font-weight: 500; cursor: pointer; margin-bottom: -2px; transition: all 0.2s;">
                    Условия бронирования
                </button>
            </div>

            <!-- Контент вкладок -->
            <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0;">

                <!-- ВКЛАДКА 1: Основные -->
                <div class="settings-tab-content" data-tab="main" style="display: flex; flex-direction: column; height: 100%;">

                    <!-- Двухколоночная структура -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: calc(var(--spacing) * 4); flex: 1;">

                        <!-- ЛЕВАЯ КОЛОНКА -->
                        <div>
                            <!-- Управление каталогом -->
                            <div style="background: white; border-radius: var(--radius); padding: calc(var(--spacing) * 2); border: 1px solid var(--gray-200);">
                                <div class="text-sm font-medium" style="margin-bottom: calc(var(--spacing) * 2); color: var(--gray-700);">Управление каталогом</div>

                                <div style="display: flex; flex-direction: column; gap: calc(var(--spacing) * 2);">
                                    <!-- Выбор папки -->
                                    <div>
                                        <label class="text-xs text-muted" style="display: block; margin-bottom: calc(var(--spacing) * 1);">Папка для сохранения:</label>
                                        <div style="display: flex; gap: calc(var(--spacing) * 1); align-items: center;">
                                            <button class="btn btn-sm" id="select-folder-btn" style="white-space: nowrap;">
                                                Выбрать папку
                                            </button>
                                            <div id="catalog-folder-display" style="flex: 1; min-width: 0; font-size: 11px; color: var(--gray-600);"></div>
                                        </div>
                                    </div>

                                    <input type="file" id="load-catalog" accept=".json,.csv" style="display: none;" onchange="QuoteCalc.loadCatalogFile(event)">

                                    <!-- Кнопки действий -->
                                    <div style="display: flex; gap: calc(var(--spacing) * 1);">
                                        <button class="btn btn-sm" onclick="document.getElementById('load-catalog').click()" style="flex: 1; white-space: nowrap;" title="Загрузить каталог">Загрузить каталог</button>
                                        <button class="btn btn-sm" onclick="window.QuoteCalc.saveCatalogJSON()" style="flex: 1; white-space: nowrap;" title="Сохранить каталог">Сохранить каталог</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ПРАВАЯ КОЛОНКА -->
                        <div>
                            <!-- Импорт/Экспорт данных -->
                            <div style="background: white; border-radius: var(--radius); padding: calc(var(--spacing) * 2); border: 1px solid var(--gray-200);">
                                <div class="text-sm font-medium" style="margin-bottom: calc(var(--spacing) * 2); color: var(--gray-700);">Импорт/Экспорт данных</div>

                                <div style="display: flex; flex-direction: column; gap: calc(var(--spacing) * 1);">
                                    <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.handleExportAll()" style="white-space: nowrap;" title="Экспорт всех данных (сметы, каталоги, настройки, бэкапы) в JSON">
                                        ⬇️ Экспорт всех данных (JSON)
                                    </button>
                                    <button class="btn btn-sm" onclick="document.getElementById('import-all-data').click()" style="white-space: nowrap;" title="Импорт данных из JSON файла">
                                        ⬆️ Импорт данных (JSON)
                                    </button>
                                    <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.handleExportDatabase()" style="white-space: nowrap;" title="Экспорт SQLite базы данных">
                                        💾 Экспорт базы данных (SQLite)
                                    </button>
                                    <button class="btn btn-sm" onclick="document.getElementById('import-database-file').click()" style="white-space: nowrap;" title="Импорт SQLite базы данных (ЗАМЕНИТ все данные!)">
                                        📥 Импорт базы данных (SQLite)
                                    </button>
                                </div>

                                <!-- Hidden input для импорта -->
                                <input type="file" id="import-all-data" accept=".json" style="display: none;" onchange="window.QuoteCalc.handleImportAll(event)">
                                <input type="file" id="import-database-file" accept=".db" style="display: none;" onchange="window.QuoteCalc.handleImportDatabase(event)">
                            </div>
                        </div>

                    </div>

                </div>

                <!-- ВКЛАДКА 2: Настройка каталогов и регионов -->
                <div class="settings-tab-content" data-tab="advanced" style="display: none; flex-direction: column; height: 100%;">

                    <!-- Двухколоночная структура -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: calc(var(--spacing) * 4); flex: 1; min-height: 0;">

                        <!-- ЛЕВАЯ КОЛОНКА: Регионы -->
                        <div style="display: flex; flex-direction: column; min-height: 0;">
                            <div class="text-sm font-medium" style="margin-bottom: calc(var(--spacing) * 2); color: var(--gray-700); flex-shrink: 0;">Управление регионами</div>

                            <!-- Добавление региона -->
                            <div style="display: flex; gap: calc(var(--spacing) * 1); margin-bottom: calc(var(--spacing) * 2); flex-shrink: 0;">
                                <input type="text" class="input" id="region-manager-name" placeholder="Название региона" style="flex: 1;">
                                <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.addRegionFromManager()" style="white-space: nowrap;">Добавить</button>
                            </div>

                            <!-- Список регионов -->
                            <div id="regions-manager-list" style="flex: 1; overflow-y: auto; min-height: 0; border: 1px solid var(--gray-200); border-radius: var(--radius); background: white;">
                                <!-- Regions list will be rendered here -->
                            </div>
                        </div>

                        <!-- ПРАВАЯ КОЛОНКА: Категории -->
                        <div style="display: flex; flex-direction: column; min-height: 0;">
                            <div class="text-sm font-medium" style="margin-bottom: calc(var(--spacing) * 2); color: var(--gray-700); flex-shrink: 0;">
                                Управление категориями
                                <div style="font-size: 11px; color: var(--gray-500); font-weight: 400; margin-top: 4px;">Кликните на регион слева для просмотра категорий</div>
                            </div>

                            <!-- Добавление категории -->
                            <div style="display: flex; gap: calc(var(--spacing) * 1); margin-bottom: calc(var(--spacing) * 2); flex-shrink: 0;">
                                <input type="text" class="input" id="category-manager-name" placeholder="Название" style="width: 120px;">
                                <select class="input" id="category-manager-icon" style="flex: 1;">
                                    <option value="🚗">🚗 Трансфер</option>
                                    <option value="🏨">🏨 Отели</option>
                                    <option value="👨‍🏫">👨‍🏫 Гиды</option>
                                    <option value="🏛️">🏛️ Активности</option>
                                    <option value="🔧">🔧 Сервис</option>
                                    <option value="🍽️">🍽️ Питание</option>
                                    <option value="🎫">🎫 Билеты</option>
                                    <option value="📋">📋 Документы</option>
                                    <option value="💼">💼 Бизнес</option>
                                    <option value="🛡️">🛡️ Страховка</option>
                                </select>
                                <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.addCategoryFromManager()" style="white-space: nowrap;">Добавить</button>
                            </div>

                            <!-- Список категорий -->
                            <div id="categories-manager-list" style="flex: 1; overflow-y: auto; min-height: 0; border: 1px solid var(--gray-200); border-radius: var(--radius); background: white;">
                                <!-- Categories list will be rendered here -->
                            </div>
                        </div>

                    </div>

                    <!-- Автосортировка - внизу на всю ширину -->
                    <div style="margin-top: calc(var(--spacing) * 3); padding-top: calc(var(--spacing) * 2); border-top: 1px solid var(--gray-200); flex-shrink: 0;">
                        <div class="text-sm font-medium" style="margin-bottom: calc(var(--spacing) * 2); color: var(--gray-700);">Автосортировка</div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: calc(var(--spacing) * 2);">
                            <!-- Автосортировка категорий -->
                            <div style="background: white; border-radius: var(--radius); padding: calc(var(--spacing) * 2); border: 1px solid var(--gray-200);">
                                <div class="text-sm font-medium" style="margin-bottom: calc(var(--spacing) * 1); color: var(--gray-700);">Категории</div>
                                <div class="text-xs text-muted" style="margin-bottom: calc(var(--spacing) * 2);" id="reorganization-status">Последняя: никогда</div>

                                <div style="display: flex; gap: calc(var(--spacing) * 1);">
                                    <button class="btn btn-sm" onclick="window.QuoteCalc.manualReorganizeCategories()" style="flex: 1;">Сортировать</button>
                                    <button class="btn btn-sm" onclick="window.QuoteCalc.resetCategoryStats()" style="background: var(--gray-100); color: var(--gray-600);" title="Сбросить статистику">Сбросить</button>
                                </div>
                            </div>

                            <!-- Автосортировка услуг -->
                            <div style="background: white; border-radius: var(--radius); padding: calc(var(--spacing) * 2); border: 1px solid var(--gray-200);">
                                <div class="text-sm font-medium" style="margin-bottom: calc(var(--spacing) * 1); color: var(--gray-700);">Услуги</div>
                                <div class="text-xs text-muted" style="margin-bottom: calc(var(--spacing) * 2);" id="template-reorganization-status">Последняя: никогда</div>

                                <div style="display: flex; gap: calc(var(--spacing) * 1);">
                                    <button class="btn btn-sm" onclick="window.QuoteCalc.manualReorganizeTemplates()" style="flex: 1;">Сортировать</button>
                                    <button class="btn btn-sm" onclick="window.QuoteCalc.resetTemplateStats()" style="background: var(--gray-100); color: var(--gray-600);" title="Сбросить статистику">Сбросить</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- ВКЛАДКА 3: Условия бронирования -->
                <div class="settings-tab-content" data-tab="document" style="display: none; flex-direction: column; height: 100%;">
                    <div style="background: white; border-radius: var(--radius); padding: calc(var(--spacing) * 3); border: 1px solid var(--gray-200);">
                        <div class="text-sm font-medium" style="margin-bottom: calc(var(--spacing) * 2); color: var(--gray-700);">
                            Условия бронирования
                            <div style="font-size: 11px; color: var(--gray-500); font-weight: 400; margin-top: 4px;">Эти условия будут напечатаны в коммерческом предложении</div>
                        </div>

                        <div id="booking-terms-editor" class="quill-editor-container"></div>
                        <textarea class="textarea" placeholder="Условия бронирования, сроки оплаты, правила отмены..." id="booking-terms" style="display: none;"></textarea>
                    </div>
                </div>

            </div>

            <!-- Кнопка закрытия -->
            <div style="display: flex; justify-content: flex-end; margin-top: calc(var(--spacing) * 3); padding-top: calc(var(--spacing) * 2); border-top: 1px solid var(--gray-200);">
                <button class="btn" onclick="window.QuoteCalc.hideCategoriesManager()" style="padding: 8px 24px;">Закрыть</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Version Display -->
    <div class="version-display" id="app-version">v2.2.0</div>

    <div class="print-preview" id="print-preview">
        <div style="display: flex; justify-content: space-between; margin-bottom: 1cm; border-bottom: 2px solid #000; padding-bottom: 0.5cm;">
            <div style="font-size: 24pt; font-weight: 900;">MAGELLANIA</div>
            <div style="text-align: right; font-size: 12pt;">
                <div>+54 11 27 44 01 61</div>
                <div>magellania.travel@gmail.com</div>
            </div>
        </div>
        <div style="text-align: center; margin-bottom: 0.5cm; font-size: 12pt;" id="quote-date"></div>
        <h1 style="text-align: center; margin: 1cm 0;">КОММЕРЧЕСКОЕ ПРЕДЛОЖЕНИЕ</h1>
        <div id="print-content"></div>
        <div style="margin-top: 2cm; font-size: 9pt; page-break-inside: avoid;">
            <p style="margin-bottom: 0.5cm;">Цены действительны 4 дня с момента предоставления заказчику.</p>
            
            <h3 style="margin-bottom: 0.3cm; font-size: 10pt;">Политика отмены бронирования</h3>
            <table class="policy-table">
                <thead>
                    <tr>
                        <th>Время отмены</th>
                        <th>Штраф</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>До 7 дней до прибытия пассажиров</td>
                        <td class="no-fee">БЕЗ КОМИССИИ</td>
                    </tr>
                    <tr>
                        <td>От 6 до 2 дней до прибытия пассажиров</td>
                        <td class="penalty">50% штраф за отмену</td>
                    </tr>
                    <tr>
                        <td>С 48 часов до прибытия</td>
                        <td class="penalty">No Show 100% штраф</td>
                    </tr>
                </tbody>
            </table>
            <p style="font-size: 8pt; margin-bottom: 0.5cm;">Политика отмены бронирований может варьировать и зависит от условий конкретных поставщиков</p>
            
            <h3 style="margin-bottom: 0.3cm; font-size: 10pt;">Важная информация</h3>
            <ul style="font-size: 8pt; margin-left: 1cm;">
                <li>Цены нетто указаны в долларах США по официальному курсу Banco Nación (продажа)</li>
                <li>Все услуги предоставляются при условии наличия на момент подтверждения бронирования</li>
                <li>Цены действительны для указанных дат и количества пассажиров</li>
            </ul>
        </div>
    </div>

    <script>
        // Глобальная защита от ошибок браузерных расширений (LastPass, Grammarly и т.д.)
        window.addEventListener('error', function(event) {
            // Игнорировать ошибки из content_script расширений браузера
            if (event.filename && event.filename.includes('content_script')) {
                event.preventDefault();
                event.stopPropagation();
                return true;
            }
            // Игнорировать ошибки расширений с типичными признаками
            if (event.message && (
                event.message.includes('ControlLooksLikePasswordCredentialField') ||
                event.message.includes('chrome-extension://') ||
                event.message.includes('moz-extension://')
            )) {
                event.preventDefault();
                event.stopPropagation();
                return true;
            }
        }, true);

        class ProfessionalQuoteCalculator {
            constructor() {
                // Version control constants
                this.APP_VERSION = '2.2.0';           // App version
                this.CATALOG_VERSION = '1.2.0';       // Catalog format version
                this.QUOTE_VERSION = '1.1.0';         // Quote format version
                this.DATA_SCHEMA_VERSION = '1.0.0';   // localStorage schema version

                // Configuration object
                this.config = {
                    currency: '$',
                    locale: 'en-US',
                    maxFileSize: 5 * 1024 * 1024, // 5MB
                    debounceDelays: {
                        search: 300,
                        calculations: 150,
                        detailRender: 100,
                        bulkControls: 50,
                        autosave: 8000 // Автосохранение через 8 секунд после изменений (5-10 сек диапазон)
                    },
                    ui: {
                        animationDuration: 300,
                        notificationTimeout: 3000,
                        minTouchTarget: 44 // px
                    },
                    validation: {
                        maxServices: 1000,
                        maxServiceNameLength: 100,
                        minPrice: 0
                    }
                };

                // Timeout IDs for race condition prevention
                this.timeoutIds = {
                    update: null,
                    search: null,
                    detailRender: null,
                    bulkUpdate: null,
                    autosave: null
                };

                // Timeout для сохранения глобальных настроек
                this.globalSettingsSaveTimeout = null;

                // Храним состояние раскрытых секций деталей в чеклисте
                this.expandedChecklistDetails = new Set();

                this.state = {
                    services: [],
                    optionalServices: [], // Опциональные услуги (не входят в основную смету)
                    hotels: [], // Отели (отдельная секция)
                    flights: [], // Перелёты (отдельная секция)
                    otherServices: [], // Прочие услуги - визы, страховки и т.д.
                    paxCount: 27,
                    hiddenMarkup: 0,
                    partnerCommission: 0, // Комиссия партнера (% от себестоимости)
                    tourStart: '',
                    tourEnd: '',
                    clientName: '',
                    clientPhone: '',
                    clientEmail: '',
                    quoteDescription: '',
                    programDescription: '', // Описание программы для печати
                    bookingTerms: '', // Условия бронирования для печати
                    activeCategory: 'all',
                    currentServiceType: 'service', // Тип создаваемой услуги: 'service', 'hotel', 'flight', 'other', 'optional'
                    selectedServices: new Set(), // For bulk operations
                    saveFolder: '', // Выбранная папка для сохранения
                    currentQuoteFile: '', // Имя текущего открытого файла
                    currentQuoteId: null, // Уникальный ID текущей сметы (UUID)
                    isQuoteSaved: true, // Флаг сохранения
                    lastSaveFolder: '', // Последняя папка сохранения
                    lastLoadFolder: '', // Последняя папка загрузки
                    servicesSortBy: 'day', // day по умолчанию, order (отсутствует), region, contractor
                    servicesSortDirection: 'asc', // asc, desc
                    // ===== VIEW MODE STATE - Режим отображения услуг =====
                    servicesViewMode: 'cards', // 'cards' - карточки (по умолчанию), 'table' - таблица
                    // ===== CHECKLIST MODE STATE - Режим чеклиста бронирований =====
                    currentMode: 'quote', // 'quote' - смета, 'checklist' - чеклист
                    checklistViewMode: 'day', // 'day' - по дням, 'supplier' - по поставщикам
                    checklistFilter: 'all' // 'all', 'booked', 'paid', 'unprocessed'
                };

                // File System Access API handles
                this.catalogDirectoryHandle = null;

                // Emoji to Lucide icon mapping
                this.iconMap = {
                    // Транспорт
                    '🚗': 'car', '🚐': 'bus', '🚌': 'bus', '✈️': 'plane', '🚁': 'plane',
                    '🚂': 'train', '🚇': 'train', '🚆': 'train', '🚢': 'ship', '⛴️': 'ship',
                    '🚤': 'ship', '🛥️': 'ship', '⛵': 'sailboat', '🚴': 'bike', '🚲': 'bike',
                    // Размещение
                    '🏨': 'hotel', '🏩': 'hotel', '🏠': 'home', '🏡': 'home', '🏘️': 'home',
                    '🏕️': 'tent', '⛺': 'tent', '🏰': 'castle', '🏛️': 'landmark',
                    // Питание
                    '🍽️': 'utensils', '🍕': 'pizza', '🍔': 'burger', '☕': 'coffee',
                    '🍷': 'wine', '🥂': 'wine', '🍰': 'cake', '🍺': 'beer',
                    // Активности и развлечения
                    '🎭': 'drama', '🎪': 'tent', '🎢': 'ferris-wheel', '🎡': 'ferris-wheel',
                    '🎠': 'ferris-wheel', '🎯': 'target', '🎳': 'circle', '🎮': 'gamepad-2',
                    '🎬': 'film', '🎨': 'palette', '🎸': 'music', '🎹': 'music',
                    '⛷️': 'mountain-snow', '🏔️': 'mountain', '🏖️': 'palmtree', '🌊': 'waves',
                    '🌲': 'tree-pine', '⛰️': 'mountain', '🌮': 'utensils', '🏛️': 'landmark',
                    // Услуги
                    '👨‍🏫': 'user', '📷': 'camera', '🎤': 'mic', '💼': 'briefcase',
                    '🛡️': 'shield', '💊': 'pill', '🔧': 'wrench', '📱': 'smartphone',
                    '💳': 'credit-card', '🎫': 'ticket', '📋': 'clipboard', '📄': 'file-text',
                    // Разное
                    '💎': 'gem', '🏆': 'trophy', '📍': 'map-pin', '🗺️': 'map',
                    '⏰': 'clock', '📅': 'calendar', '✅': 'check', '❓': 'help-circle',
                    '💰': 'dollar-sign', '📊': 'bar-chart', '🎁': 'gift', '⭐': 'star'
                };

                // Default categories
                this.categories = [
                    { id: 'undefined', name: 'Не определено', icon: '❓', system: true }, // Системная категория для услуг без категории
                    { id: 'transfer', name: 'Трансфер', icon: '🚗' },
                    { id: 'accommodation', name: 'Отели', icon: '🏨' },
                    { id: 'guide', name: 'Гиды', icon: '👨‍🏫' },
                    { id: 'activity', name: 'Активности', icon: '🏛️' },
                    { id: 'service', name: 'Сервис', icon: '🔧' }
                ];

                // Category usage statistics (локальная - для сортировки, сбрасывается)
                this.categoryStats = {
                    usage: {}, // { categoryId: count }
                    lastReorganization: null, // timestamp
                    reorganizationInterval: 3 * 24 * 60 * 60 * 1000 // 3 days in ms
                };

                // Template usage statistics (локальная - для сортировки шаблонов внутри категорий)
                this.templateStats = {
                    usage: {}, // { templateId: count }
                    lastReorganization: null, // timestamp
                    reorganizationInterval: 3 * 24 * 60 * 60 * 1000 // 3 days in ms
                };

                // Global statistics (НИКОГДА не сбрасывается - для аналитики)
                this.globalStats = {
                    services: {}, // { templateId: { count, name, category, lastUsed: timestamp } }
                    categories: {}, // { categoryId: { count, name, lastUsed: timestamp } }
                    totalServicesAdded: 0, // Общее количество добавленных услуг
                    firstUsage: null, // timestamp первого использования
                    lastUsage: null // timestamp последнего использования
                };

                this.templates = [];
                this.editingTemplateId = null;

                // Регионы для управления каталогами
                this.regions = [];
                this.currentRegion = 'Default';

                // Enhanced debounced functions with cleanup
                this.debouncedUpdate = this.debounce(this.updateCalculations.bind(this), this.config.debounceDelays.calculations, 'update');
                this.debouncedSearch = this.debounce(this.filterTemplates.bind(this), this.config.debounceDelays.search, 'search');
                this.debouncedRenderDetail = this.debounce(this.renderServicesDetailList.bind(this), this.config.debounceDelays.detailRender, 'detailRender');
                this.debouncedBulkUpdate = this.debounce(this.updateBulkControls.bind(this), this.config.debounceDelays.bulkControls, 'bulkUpdate');
                this.debouncedAutosave = this.debounce(this.autoSaveQuote.bind(this), this.config.debounceDelays.autosave, 'autosave');

                this.updatePending = false;

                this.init();
            }

            // Enhanced debounce with timeout tracking
            debounce(func, wait, timeoutKey) {
                return (...args) => {
                    if (this.timeoutIds[timeoutKey]) {
                        clearTimeout(this.timeoutIds[timeoutKey]);
                    }
                    
                    this.timeoutIds[timeoutKey] = setTimeout(() => {
                        func.apply(this, args);
                        this.timeoutIds[timeoutKey] = null;
                    }, wait);
                };
            }

            scheduleUpdate() {
                if (this.updatePending) return;
                this.updatePending = true;
                requestAnimationFrame(() => {
                    this.updateCalculations();
                    this.updatePending = false;
                });
            }

            // Загрузить глобальные настройки при инициализации
            async loadGlobalSettings() {
                try {
                    const settings = await window.apiClient.loadSettings();
                    console.log('[Settings] Загружены глобальные настройки:', settings);

                    // Если есть сохраненные условия бронирования, применяем их только если текущие пусты
                    if (settings.bookingTerms && !this.state.bookingTerms) {
                        this.state.bookingTerms = settings.bookingTerms;

                        // Обновляем редактор если он уже инициализирован
                        if (this.quillEditors && this.quillEditors.bookingTerms) {
                            this.quillEditors.bookingTerms.root.innerHTML = settings.bookingTerms;
                        }
                    }
                } catch (err) {
                    console.warn('[Settings] Не удалось загрузить настройки:', err.message);
                    // Не показываем ошибку пользователю - это не критично
                }
            }

            // Отложенное сохранение глобальных настроек (debounce 3 секунды)
            scheduleGlobalSettingsSave() {
                if (this.globalSettingsSaveTimeout) {
                    clearTimeout(this.globalSettingsSaveTimeout);
                }

                this.globalSettingsSaveTimeout = setTimeout(async () => {
                    try {
                        const settings = {
                            bookingTerms: this.state.bookingTerms || '',
                            version: '1.0.0',
                            lastUpdated: new Date().toISOString()
                        };

                        await window.apiClient.saveSettings(settings);
                        console.log('[Settings] Глобальные настройки сохранены');
                    } catch (err) {
                        console.error('[Settings] Ошибка сохранения настроек:', err.message);
                        // Не показываем ошибку пользователю - автосохранение не критично
                    }
                }, 3000); // 3 секунды
            }

            showNotification(message, isError = false) {
                const notification = document.getElementById('notification');
                notification.textContent = message;
                notification.className = `notification ${isError ? 'error' : ''}`;
                
                // Show notification
                setTimeout(() => notification.classList.add('show'), 10);
                
                // Hide after configured timeout
                setTimeout(() => {
                    notification.classList.remove('show');
                }, this.config.ui.notificationTimeout);
            }

            validateService(service) {
                const errors = [];
                if (!service.name || !service.name.trim()) {
                    errors.push('Название услуги обязательно');
                }
                if (service.price < 0) {
                    errors.push('Цена не может быть отрицательной');
                }
                if (service.quantity < 1) {
                    errors.push('Количество должно быть больше 0');
                }
                if (service.day < 1) {
                    errors.push('День тура должен быть больше 0');
                }
                return errors;
            }

            validateField(fieldId, value) {
                const element = document.getElementById(fieldId);
                if (!element) return;

                element.classList.remove('error');

                switch (fieldId) {
                    case 'pax-count':
                        if (!value || value < 1) {
                            element.classList.add('error');
                            this.showNotification('Количество человек должно быть больше 0', true);
                        }
                        break;
                    case 'client-email':
                        // Проверяем email только если поле не пустое
                        if (value && !this.isValidEmail(value)) {
                            element.classList.add('error');
                            element.title = 'Некорректный email адрес';
                            // Не показываем notification при вводе, только визуальная индикация
                        } else if (value && this.isValidEmail(value)) {
                            element.classList.remove('error');
                            element.title = '';
                        }
                        break;
                    case 'tour-start':
                    case 'tour-end':
                        // Очищаем ошибки для обеих дат
                        const startElement = document.getElementById('tour-start');
                        const endElement = document.getElementById('tour-end');
                        if (startElement) startElement.classList.remove('error');
                        if (endElement) endElement.classList.remove('error');

                        // Проверяем диапазон дат
                        this.validateDateRange();
                        break;
                }
            }

            isValidEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            validateDateRange() {
                const startDate = this.state.tourStart;
                const endDate = this.state.tourEnd;

                if (startDate && endDate) {
                    const start = new Date(startDate);
                    const end = new Date(endDate);

                    if (end < start) {
                        const endElement = document.getElementById('tour-end');
                        if (endElement) endElement.classList.add('error');
                        this.showNotification('Дата окончания не может быть раньше даты начала', true);
                        return false;
                    }
                }
                return true;
            }

            // Enhanced CSV parsing
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            }

            escapeCSVField(field) {
                if (typeof field !== 'string') field = String(field);
                if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                    return `"${field.replace(/"/g, '""')}"`;
                }
                return field;
            }

            formatDate(dateString) {
                if (!dateString) return '';

                // Создаем дату без проблем с часовыми поясами
                const [year, month, day] = dateString.split('-');
                const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));

                return date.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }

            // Рассчитать дату активности по дню тура
            calculateActivityDate(tourDay) {
                if (!this.state.tourStart || tourDay < 1) return '';

                const [year, month, day] = this.state.tourStart.split('-');
                const startDate = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));

                // Добавляем (день - 1) дней к начальной дате
                const activityDate = new Date(startDate);
                activityDate.setDate(activityDate.getDate() + (tourDay - 1));

                return activityDate.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            }

            // Рендеринг иконки: emoji → Lucide
            renderIcon(emoji, size = '20px') {
                const lucideIcon = this.iconMap[emoji];
                if (lucideIcon) {
                    return `<i data-lucide="${lucideIcon}" style="width: ${size}; height: ${size}; display: inline-block;"></i>`;
                }
                return emoji; // Если нет маппинга, возвращаем сам emoji
            }

            // ===== UUID & FILENAME GENERATION - Генерация ID и имён файлов =====

            /**
             * Генерирует уникальный ID для сметы (UUID v4, 12 символов)
             * @returns {string} Уникальный ID
             */
            generateQuoteId() {
                return 'xxxxxxxxxxxx'.replace(/x/g, () => {
                    return (Math.random() * 16 | 0).toString(16);
                });
            }

            /**
             * Генерирует имя файла из данных сметы с ID
             * @param {Object} quoteData - Данные сметы
             * @returns {string} Имя файла
             */
            generateFilenameWithId(quoteData) {
                const id = quoteData.id || this.state.currentQuoteId;
                const pax = quoteData.paxCount || this.state.paxCount || 0;
                const date = quoteData.tourStart || this.state.tourStart || new Date().toISOString().split('T')[0];

                // Транслитерация имени клиента
                let clientName = quoteData.clientName || this.state.clientName || '';
                clientName = clientName.trim();

                if (clientName === '') {
                    // Без ФИО - untitled
                    return `untitled_${date}_${pax}pax_${id}.json`;
                } else {
                    // С ФИО - транслитерация
                    const name = this.transliterate(clientName.toLowerCase()).replace(/\s+/g, '_');
                    return `${name}_${date}_${pax}pax_${id}.json`;
                }
            }

            /**
             * Транслитерация кириллицы в латиницу
             * @param {string} text - Текст для транслитерации
             * @returns {string} Транслитерированный текст
             */
            transliterate(text) {
                const map = {
                    'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo',
                    'ж': 'zh', 'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm',
                    'н': 'n', 'о': 'o', 'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
                    'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch', 'ш': 'sh', 'щ': 'sch',
                    'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya',
                    ' ': '_'
                };
                return text.toLowerCase().split('').map(char => map[char] || char).join('');
            }

            /**
             * Проверяет нужно ли переименовать файл при изменении данных
             * @returns {Promise<boolean>} true если файл был переименован
             */
            async checkAndRenameFile() {
                if (!this.state.currentQuoteId || !this.state.currentQuoteFile) {
                    return false; // Смета ещё не сохранена
                }

                const currentData = {
                    id: this.state.currentQuoteId,
                    clientName: this.state.clientName,
                    tourStart: this.state.tourStart,
                    paxCount: this.state.paxCount
                };

                const newFilename = this.generateFilenameWithId(currentData);

                if (this.state.currentQuoteFile !== newFilename) {
                    try {
                        // Переименовываем файл на сервере
                        await apiClient.renameEstimate(this.state.currentQuoteFile, newFilename);
                        this.state.currentQuoteFile = newFilename;
                        this.updateQuoteStatusBar();
                        return true;
                    } catch (err) {
                        console.error('Error renaming file:', err);
                        return false;
                    }
                }

                return false;
            }

            /**
             * Создаёт новую смету с уникальным ID
             */
            async createNewQuote() {
                // Генерируем ID
                this.state.currentQuoteId = this.generateQuoteId();

                // Сбрасываем данные
                this.state.services = [];
                this.state.hotels = [];
                this.state.flights = [];
                this.state.otherServices = [];
                this.state.clientName = '';
                this.state.clientPhone = '';
                this.state.clientEmail = '';
                this.state.paxCount = 0;
                this.state.tourStart = '';
                this.state.tourEnd = '';
                this.state.programDescription = '';
                this.state.quoteComments = '';

                // Генерируем начальное имя файла
                const filename = this.generateFilenameWithId({
                    id: this.state.currentQuoteId,
                    clientName: '',
                    tourStart: new Date().toISOString().split('T')[0],
                    paxCount: 0
                });

                this.state.currentQuoteFile = filename;
                this.state.isQuoteSaved = false;

                // Обновляем UI
                this.loadStateToUI();
                this.renderServices();
                this.renderHotels();
                this.renderFlights();
                this.renderOtherServices();
                this.updateCalculations();
                this.updateQuoteStatusBar();

                // Создаём начальный backup файл
                const initialData = {
                    id: this.state.currentQuoteId,
                    version: this.QUOTE_VERSION,
                    timestamp: new Date().toISOString(),
                    clientName: '',
                    clientPhone: '',
                    clientEmail: '',
                    paxCount: 0,
                    tourStart: '',
                    tourEnd: '',
                    services: [],
                    hotels: [],
                    flights: [],
                    otherServices: [],
                    hiddenMarkup: 0,
                    taxRate: 0,
                    programDescription: '',
                    quoteComments: ''
                };

                try {
                    // ID-First: сохранение по ID
                    await apiClient.saveEstimate(initialData.id, initialData);
                    this.showNotification('Создана новая смета: ' + filename, false);
                } catch (err) {
                    console.error('Error creating new quote:', err);
                    this.showNotification('Ошибка создания новой сметы: ' + err.message, true);
                }
            }

            /**
             * Восстанавливает последнюю рабочую смету после перезагрузки страницы
             * Проверяет последний изменённый backup (не старше 5 минут)
             */
            async restoreLastWorkingEstimate() {
                try {
                    // 1. Попытка восстановить конкретную смету из localStorage
                    const lastId = localStorage.getItem('lastOpenedEstimateId');

                    if (lastId) {
                        try {
                            console.log('[Restore] Attempting to restore estimate:', lastId);

                            // Загрузить смету по ID
                            const estimateData = await apiClient.getEstimate(lastId);

                            // Применяем данные к состоянию
                            this.state.currentQuoteId = estimateData.id;
                            this.state.clientName = estimateData.clientName || '';
                            this.state.clientPhone = estimateData.clientPhone || '';
                            this.state.clientEmail = estimateData.clientEmail || '';
                            this.state.paxCount = estimateData.paxCount || 0;
                            this.state.tourStart = estimateData.tourStart || '';
                            this.state.tourEnd = estimateData.tourEnd || '';
                            this.state.hiddenMarkup = estimateData.hiddenMarkup || 0;
                            this.state.taxRate = estimateData.taxRate || 0;
                            this.state.programDescription = estimateData.programDescription || '';
                            this.state.quoteComments = estimateData.quoteComments || '';
                            this.state.services = estimateData.services || [];
                            this.state.hotels = estimateData.hotels || [];
                            this.state.flights = estimateData.flights || [];
                            this.state.otherServices = estimateData.otherServices || [];

                            // Генерируем имя файла
                            const filename = this.generateFilenameWithId({
                                id: estimateData.id,
                                clientName: estimateData.clientName,
                                tourStart: estimateData.tourStart,
                                paxCount: estimateData.paxCount
                            });

                            this.state.currentQuoteFile = filename;
                            this.state.isQuoteSaved = true;

                            // Обновляем UI
                            this.loadStateToUI();
                            this.renderServices();
                            this.renderHotels();
                            this.renderFlights();
                            this.renderOtherServices();
                            this.updateCalculations();
                            this.updateQuoteStatusBar();

                            // Показываем уведомление
                            const clientName = estimateData.clientName || 'Без имени';
                            this.showNotification(`Восстановлена смета: ${clientName}`, false);

                            console.log('[Restore] Successfully restored estimate:', lastId);
                            return true;

                        } catch (err) {
                            console.warn('[Restore] Last estimate not found, clearing localStorage:', err);
                            localStorage.removeItem('lastOpenedEstimateId');
                            // Продолжаем к fallback
                        }
                    }

                    // 2. Fallback: пустое состояние (новая смета)
                    console.log('[Restore] No last estimate found, starting with empty state');
                    return false;

                } catch (err) {
                    console.error('[Restore] Error restoring estimate:', err);
                    return false;
                }
            }

            init() {
                // ✅ FIX: Установить ссылку на window.apiClient для catalog operations
                this.apiClient = window.apiClient;

                this.initRegions(); // Инициализация регионов (должна быть первой!)
                // loadCategories() не нужен - loadCatalogForRegion() уже загружает категории
                // renderCategories() и renderCategoryOptions() вызываются в loadCatalogForRegion() после загрузки данных
                this.loadExternalCatalog();
                this.bindEvents();
                this.initQuillEditors(); // Инициализация WYSIWYG редакторов
                this.loadGlobalSettings(); // Загрузка глобальных настроек (условия бронирования)
                this.bindKeyboardShortcuts();
                this.updateCalculations();
                // loadFromLocalStorage теперь async (загружает автосохранение с сервера)
                this.loadFromLocalStorage().catch(err => {
                    console.error('Error loading from localStorage:', err);
                });
                this.migrateServicesRegions(); // Миграция данных: добавляем region к существующим услугам
                this.initVersionDisplay();
                this.restoreProgramDescriptionState();
                this.restoreQuoteCommentsState();
                this.restoreBookingTermsState();
                this.loadSavedCatalogFolder();

                // Рендерим новые секции
                this.renderHotels();
                this.renderFlights();
                this.renderOtherServices();
                this.initChecklistEvents(); // Инициализация событий чеклиста
                this.initNewSectionsEvents(); // Инициализация событий новых секций

                // Восстанавливаем последнюю рабочую смету после перезагрузки
                this.restoreLastWorkingEstimate().catch(err => {
                    console.error('Error restoring last working estimate:', err);
                });

                // Восстанавливаем последний активный режим (смета/чеклист)
                // Если был сохранен режим чеклиста, переключаемся на него
                if (this.state.currentMode === 'checklist') {
                    this.switchMode('checklist');
                } else {
                    // По умолчанию режим сметы, просто обновляем UI
                    this.switchMode('quote');
                }
            }

            // ===== MODE SWITCHING - Переключение режимов (Смета/Чеклист) =====
            switchMode(mode) {
                this.state.currentMode = mode;

                // Обновляем стили кнопок переключателя
                const quoteBtn = document.getElementById('mode-quote-btn');
                const checklistBtn = document.getElementById('mode-checklist-btn');

                if (mode === 'quote') {
                    // Активируем режим сметы
                    quoteBtn.style.background = 'white';
                    quoteBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    quoteBtn.style.color = 'inherit';
                    checklistBtn.style.background = 'transparent';
                    checklistBtn.style.boxShadow = 'none';
                    checklistBtn.style.color = 'var(--gray-600)';

                    // Показываем панели сметы, скрываем чеклист
                    const panels = document.querySelectorAll('.app > .panel');
                    panels.forEach((panel, index) => {
                        if (index < 3) { // Первые 3 панели - это смета
                            panel.style.display = '';
                        }
                    });
                    document.getElementById('checklist-container').style.display = 'none';
                } else if (mode === 'checklist') {
                    // Активируем режим чеклиста
                    checklistBtn.style.background = 'white';
                    checklistBtn.style.boxShadow = '0 1px 3px rgba(0,0,0,0.1)';
                    checklistBtn.style.color = 'inherit';
                    quoteBtn.style.background = 'transparent';
                    quoteBtn.style.boxShadow = 'none';
                    quoteBtn.style.color = 'var(--gray-600)';

                    // Скрываем панели сметы, показываем чеклист
                    const panels = document.querySelectorAll('.app > .panel');
                    panels.forEach((panel, index) => {
                        if (index < 3) { // Первые 3 панели - это смета
                            panel.style.display = 'none';
                        }
                    });
                    const checklistContainer = document.getElementById('checklist-container');
                    if (checklistContainer) {
                        checklistContainer.style.display = 'flex';
                    }

                    // Рендерим чеклист
                    this.renderChecklist();
                }

                // Сохраняем режим в localStorage
                localStorage.setItem('quoteCalc_currentMode', mode);
            }

            // ===== CHECKLIST GROUPING & FILTERING - Группировка и фильтрация для чеклиста =====

            groupByDay(services) {
                const groups = {};
                services.forEach(service => {
                    const day = service.day || 0;
                    if (!groups[day]) groups[day] = [];
                    groups[day].push(service);
                });

                return Object.keys(groups)
                    .map(Number)
                    .sort((a, b) => a - b)
                    .map(day => ({
                        day,
                        services: groups[day],
                        total: groups[day].reduce((sum, s) => sum + (s.price * s.quantity), 0)
                    }));
            }

            groupBySupplier(services) {
                const groups = {};
                services.forEach(service => {
                    const supplier = service.contractor || '—';
                    if (!groups[supplier]) groups[supplier] = [];
                    groups[supplier].push(service);
                });

                return Object.keys(groups)
                    .sort()
                    .map(supplier => ({
                        supplier,
                        services: groups[supplier],
                        total: groups[supplier].reduce((sum, s) => sum + (s.price * s.quantity), 0)
                    }));
            }

            passesChecklistFilter(service) {
                const filter = this.state.checklistFilter;

                if (filter === 'all') return true;
                if (filter === 'booked') return service.done === true;
                if (filter === 'paid') return service.paid === true;
                if (filter === 'unprocessed') return !service.done && !service.paid;

                return true;
            }

            updateChecklistCounters() {
                const services = this.state.services;

                const booked = services.filter(s => s.done).length;
                const paid = services.filter(s => s.paid).length;
                const unprocessed = services.filter(s => !s.done && !s.paid).length;

                const bookedEl = document.getElementById('cnt-booked');
                const paidEl = document.getElementById('cnt-paid');
                const unprocessedEl = document.getElementById('cnt-unprocessed');

                if (bookedEl) bookedEl.textContent = booked;
                if (paidEl) paidEl.textContent = paid;
                if (unprocessedEl) unprocessedEl.textContent = unprocessed;
            }

            // ===== CHECKLIST RENDERING - Отображение чеклиста бронирований =====

            renderChecklist() {
                const container = document.getElementById('checklist-content');
                if (!container) return;

                container.innerHTML = '';

                // Объединяем все услуги из всех секций
                const allServices = [
                    ...this.state.services.map(s => ({ ...s, _section: 'service' })),
                    ...this.state.hotels.map(s => ({ ...s, _section: 'hotel' })),
                    ...this.state.flights.map(s => ({ ...s, _section: 'flight' })),
                    ...this.state.otherServices.map(s => ({ ...s, _section: 'other' }))
                ];

                // Фильтруем услуги
                const filteredServices = allServices.filter(s => this.passesChecklistFilter(s));

                if (filteredServices.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--gray-500); font-size: 13px;">Нет услуг для отображения</div>';
                    this.updateChecklistCounters();
                    return;
                }

                // Группируем по типам (основные услуги, отели, перелёты, прочие)
                const serviceTypes = [
                    { key: 'service', label: '🎯 Основные услуги', icon: '🎯' },
                    { key: 'hotel', label: '🏨 Отели', icon: '🏨' },
                    { key: 'flight', label: '✈️ Перелёты', icon: '✈️' },
                    { key: 'other', label: '📋 Прочие услуги', icon: '📋' }
                ];

                serviceTypes.forEach(typeInfo => {
                    const servicesOfType = filteredServices.filter(s => s._section === typeInfo.key);
                    if (servicesOfType.length === 0) return;

                    // Создаём разделитель типа услуг
                    const typeSeparator = document.createElement('div');
                    typeSeparator.style.cssText = 'margin: 24px 0 16px 0; padding: 12px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-left: 4px solid var(--primary); border-radius: 8px;';
                    typeSeparator.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="font-size: 15px; font-weight: 600; color: var(--gray-900);">${typeInfo.label}</div>
                            <div style="font-size: 12px; color: var(--gray-600);">${servicesOfType.length} ${servicesOfType.length === 1 ? 'услуга' : 'услуг'}</div>
                        </div>
                    `;
                    container.appendChild(typeSeparator);

                    // Группируем услуги этого типа по дням или поставщикам
                    const groups = this.state.checklistViewMode === 'day'
                        ? this.groupByDay(servicesOfType)
                        : this.groupBySupplier(servicesOfType);

                    // Рендерим группы
                    groups.forEach(group => {
                        const groupDiv = this.renderChecklistGroup(group);
                        container.appendChild(groupDiv);
                    });
                });

                // Обновляем счетчики
                this.updateChecklistCounters();

                // Обновляем иконки Lucide
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            renderChecklistGroup(group) {
                const div = document.createElement('div');
                div.className = 'checklist-group';
                div.style.cssText = 'background: white; border-radius: 8px; padding: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 16px;';

                // Header
                const header = document.createElement('div');
                header.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--gray-200);';

                const title = document.createElement('div');
                title.style.cssText = 'font-weight: 600; font-size: 14px; color: var(--gray-900);';
                title.textContent = this.state.checklistViewMode === 'day'
                    ? `День ${group.day}`
                    : `Поставщик: ${group.supplier}`;

                const total = document.createElement('div');
                total.style.cssText = 'font-size: 12px; color: var(--gray-600);';
                total.textContent = `Итого: ${this.config.currency}${group.total.toFixed(2)}`;

                header.appendChild(title);
                header.appendChild(total);
                div.appendChild(header);

                // Services
                group.services.forEach(service => {
                    const card = this.renderChecklistServiceCard(service);
                    div.appendChild(card);
                });

                return div;
            }

            renderChecklistServiceCard(service) {
                const card = document.createElement('div');
                card.className = 'checklist-service-card';
                card.style.cssText = `
                    border: 1px solid var(--gray-200);
                    border-radius: 6px;
                    padding: 12px;
                    margin-bottom: 8px;
                    background: ${service.done ? '#ecfdf5' : 'white'};
                    border-left: 4px solid ${service.paid ? '#10b981' : service.done ? '#f59e0b' : '#e5e7eb'};
                `;

                // Main row: checkboxes + info + price badge
                const mainRow = document.createElement('div');
                mainRow.style.cssText = 'display: flex; align-items: flex-start; gap: 12px; margin-bottom: 8px;';

                // Checkbox "Бронь"
                const doneWrap = document.createElement('div');
                doneWrap.style.cssText = 'display: flex; flex-direction: column; align-items: center;';

                const doneCheckbox = document.createElement('input');
                doneCheckbox.type = 'checkbox';
                doneCheckbox.checked = service.done;
                doneCheckbox.style.cssText = 'width: 16px; height: 16px; cursor: pointer;';
                doneCheckbox.addEventListener('change', () => {
                    service.done = doneCheckbox.checked;
                    this.saveToLocalStorage();
                    // Обновить стили карточки без полной перерисовки
                    card.style.background = service.done ? '#ecfdf5' : 'white';
                    card.style.borderLeft = `4px solid ${service.paid ? '#10b981' : service.done ? '#f59e0b' : '#e5e7eb'}`;
                    // Синхронизировать с конструктором смет
                    this.renderServices();
                    this.renderHotels();
                    this.renderFlights();
                    this.renderOtherServices();
                });

                const doneLabel = document.createElement('div');
                doneLabel.style.cssText = 'font-size: 10px; color: var(--gray-600); margin-top: 2px;';
                doneLabel.textContent = 'Бронь';

                doneWrap.appendChild(doneCheckbox);
                doneWrap.appendChild(doneLabel);

                // Checkbox "Оплата"
                const paidWrap = document.createElement('div');
                paidWrap.style.cssText = 'display: flex; flex-direction: column; align-items: center;';

                const paidCheckbox = document.createElement('input');
                paidCheckbox.type = 'checkbox';
                paidCheckbox.checked = service.paid;
                paidCheckbox.style.cssText = 'width: 16px; height: 16px; cursor: pointer;';
                paidCheckbox.addEventListener('change', () => {
                    service.paid = paidCheckbox.checked;
                    this.saveToLocalStorage();
                    // Обновить стили карточки без полной перерисовки
                    card.style.background = service.done ? '#ecfdf5' : 'white';
                    card.style.borderLeft = `4px solid ${service.paid ? '#10b981' : service.done ? '#f59e0b' : '#e5e7eb'}`;
                    // Синхронизировать с конструктором смет
                    this.renderServices();
                    this.renderHotels();
                    this.renderFlights();
                    this.renderOtherServices();
                });

                const paidLabel = document.createElement('div');
                paidLabel.style.cssText = 'font-size: 10px; color: var(--gray-600); margin-top: 2px;';
                paidLabel.textContent = 'Оплата';

                paidWrap.appendChild(paidCheckbox);
                paidWrap.appendChild(paidLabel);

                // Checkbox "Предоплата"
                const prepaymentWrap = document.createElement('div');
                prepaymentWrap.style.cssText = 'display: flex; flex-direction: column; align-items: center;';

                const prepaymentCheckbox = document.createElement('input');
                prepaymentCheckbox.type = 'checkbox';
                prepaymentCheckbox.checked = service.prepaymentReceived || false;
                prepaymentCheckbox.style.cssText = 'width: 16px; height: 16px; cursor: pointer;';
                prepaymentCheckbox.addEventListener('change', () => {
                    service.prepaymentReceived = prepaymentCheckbox.checked;
                    this.saveToLocalStorage();
                    // Обновить стили карточки без полной перерисовки
                    card.style.background = service.done ? '#ecfdf5' : 'white';
                    card.style.borderLeft = `4px solid ${service.paid ? '#10b981' : service.done ? '#f59e0b' : '#e5e7eb'}`;
                    // Синхронизировать с конструктором смет
                    this.renderServices();
                    this.renderHotels();
                    this.renderFlights();
                    this.renderOtherServices();
                });

                const prepaymentLabel = document.createElement('div');
                prepaymentLabel.style.cssText = 'font-size: 10px; color: var(--gray-600); margin-top: 2px;';
                prepaymentLabel.textContent = 'Предоплата';

                prepaymentWrap.appendChild(prepaymentCheckbox);
                prepaymentWrap.appendChild(prepaymentLabel);

                // Info
                const info = document.createElement('div');
                info.style.cssText = 'flex: 1;';

                const serviceName = document.createElement('div');
                serviceName.style.cssText = 'font-weight: 500; font-size: 12px; margin-bottom: 4px;';
                serviceName.textContent = `${service.quantity} × ${service.name}`;

                const serviceDetails = document.createElement('div');
                serviceDetails.style.cssText = 'font-size: 11px; color: var(--gray-600);';

                // Показываем предоплату если указана
                let detailsText = `День ${service.day} • ${service.contractor || '—'} • ${this.config.currency}${service.price}`;
                if (service.prepayment && service.prepayment > 0) {
                    detailsText += ` • 💳 Предоплата: ${this.config.currency}${service.prepayment}`;
                }
                serviceDetails.textContent = detailsText;

                info.appendChild(serviceName);
                info.appendChild(serviceDetails);

                // Price badge - показываем остаток к оплате с учётом предоплаты
                const totalPrice = service.price * service.quantity;
                const prepaymentAmount = (service.prepayment || 0) * (service.prepaymentReceived ? 1 : 0);
                const remainingAmount = totalPrice - prepaymentAmount;

                const priceBadge = document.createElement('div');
                priceBadge.style.cssText = `
                    background: ${service.paid ? '#10b981' : '#e5e7eb'};
                    color: ${service.paid ? 'white' : '#374151'};
                    padding: 4px 8px;
                    border-radius: 6px;
                    font-size: 11px;
                    font-weight: 600;
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                `;

                // Показываем остаток если была предоплата
                if (prepaymentAmount > 0) {
                    priceBadge.innerHTML = `
                        <div style="font-size: 9px; opacity: 0.7;">К оплате:</div>
                        <div>${this.config.currency}${remainingAmount.toFixed(2)}</div>
                    `;
                } else {
                    priceBadge.textContent = `${this.config.currency}${totalPrice.toFixed(2)}`;
                }

                mainRow.appendChild(doneWrap);
                mainRow.appendChild(paidWrap);
                mainRow.appendChild(prepaymentWrap);
                mainRow.appendChild(info);
                mainRow.appendChild(priceBadge);

                card.appendChild(mainRow);

                // Toggle button for collapsible details
                const toggleBtn = document.createElement('button');
                toggleBtn.style.cssText = 'width: 100%; padding: 6px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 10px; color: #6b7280; cursor: pointer; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; transition: background 0.2s;';
                toggleBtn.innerHTML = `<span class="toggle-icon" style="font-size: 8px;">▶</span><span>Детали (предоплата, тайминг, комментарии)</span>`;

                const hasDetails = service.prepayment || service.prepaymentDeadline || service.startTime || service.endTime || service.comment;
                if (hasDetails) {
                    toggleBtn.innerHTML = `<span class="toggle-icon" style="font-size: 8px;">▶</span><span>Детали (предоплата, тайминг, комментарии)</span><span style="font-size: 8px; color: #3b82f6; margin-left: auto;">●</span>`;
                }

                const detailsContent = document.createElement('div');
                detailsContent.className = 'checklist-details-content';
                detailsContent.style.cssText = 'max-height: 0; overflow: hidden; transition: max-height 0.3s ease;';

                // Останавливаем всплытие ВСЕХ событий из detailsContent чтобы не срабатывал toggle
                detailsContent.addEventListener('click', (e) => e.stopPropagation());
                detailsContent.addEventListener('mousedown', (e) => e.stopPropagation());
                detailsContent.addEventListener('mouseup', (e) => e.stopPropagation());
                detailsContent.addEventListener('keydown', (e) => e.stopPropagation());
                detailsContent.addEventListener('keyup', (e) => e.stopPropagation());
                detailsContent.addEventListener('input', (e) => e.stopPropagation());
                detailsContent.addEventListener('change', (e) => e.stopPropagation());

                toggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Останавливаем всплытие от кнопки тоже
                    const isExpanded = detailsContent.style.maxHeight && detailsContent.style.maxHeight !== '0px';
                    if (isExpanded) {
                        detailsContent.style.maxHeight = '0';
                        toggleBtn.querySelector('.toggle-icon').textContent = '▶';
                        // Удаляем из Set раскрытых секций
                        this.expandedChecklistDetails.delete(service.id);
                    } else {
                        // Используем большое фиксированное значение вместо scrollHeight
                        // чтобы избежать проблем с изменяющимся контентом
                        detailsContent.style.maxHeight = '500px';
                        toggleBtn.querySelector('.toggle-icon').textContent = '▼';
                        // Добавляем в Set раскрытых секций
                        this.expandedChecklistDetails.add(service.id);
                    }
                });

                // Автоматически раскрываем секцию если она была раскрыта до перерисовки
                if (this.expandedChecklistDetails.has(service.id)) {
                    detailsContent.style.maxHeight = '500px';
                    toggleBtn.querySelector('.toggle-icon').textContent = '▼';
                }

                card.appendChild(toggleBtn);

                // Prepayment info
                if (service.prepayment && service.prepayment > 0) {
                    const prepaymentInfo = document.createElement('div');
                    prepaymentInfo.style.cssText = 'padding: 8px; background: #fef3c7; border-radius: 4px; margin-bottom: 8px; font-size: 11px;';
                    prepaymentInfo.innerHTML = `
                        <div style="color: #92400e; font-weight: 500; margin-bottom: 4px;">💳 Предоплата: ${this.config.currency}${service.prepayment}</div>
                        ${service.prepaymentDeadline ? `<div style="color: #78350f;">📅 Срок: ${service.prepaymentDeadline}</div>` : ''}
                    `;
                    detailsContent.appendChild(prepaymentInfo);
                }

                // Timing row (время начала/окончания)
                const timingRow = document.createElement('div');
                timingRow.style.cssText = 'display: flex; gap: 12px; margin-bottom: 8px; padding: 8px; background: #f9fafb; border-radius: 4px;';

                const startTimeWrap = document.createElement('div');
                startTimeWrap.style.cssText = 'flex: 1;';
                const startTimeLabel = document.createElement('label');
                startTimeLabel.style.cssText = 'font-size: 10px; color: var(--gray-600); display: block; margin-bottom: 2px;';
                startTimeLabel.textContent = '⏰ Время начала';
                const startTimeInput = document.createElement('input');
                startTimeInput.type = 'time';
                startTimeInput.value = service.startTime || '';
                startTimeInput.style.cssText = 'width: 100%; padding: 4px; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 11px;';
                startTimeInput.addEventListener('change', () => {
                    service.startTime = startTimeInput.value;
                    this.saveToLocalStorage();
                    this.markQuoteAsUnsaved();
                });
                startTimeWrap.appendChild(startTimeLabel);
                startTimeWrap.appendChild(startTimeInput);

                const endTimeWrap = document.createElement('div');
                endTimeWrap.style.cssText = 'flex: 1;';
                const endTimeLabel = document.createElement('label');
                endTimeLabel.style.cssText = 'font-size: 10px; color: var(--gray-600); display: block; margin-bottom: 2px;';
                endTimeLabel.textContent = '⏰ Время окончания';
                const endTimeInput = document.createElement('input');
                endTimeInput.type = 'time';
                endTimeInput.value = service.endTime || '';
                endTimeInput.style.cssText = 'width: 100%; padding: 4px; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 11px;';
                endTimeInput.addEventListener('change', () => {
                    service.endTime = endTimeInput.value;
                    this.saveToLocalStorage();
                    this.markQuoteAsUnsaved();
                });
                endTimeWrap.appendChild(endTimeLabel);
                endTimeWrap.appendChild(endTimeInput);

                timingRow.appendChild(startTimeWrap);
                timingRow.appendChild(endTimeWrap);

                detailsContent.appendChild(timingRow);

                // Comment textarea
                const commentTextarea = document.createElement('textarea');
                commentTextarea.placeholder = 'Комментарий...';
                commentTextarea.value = service.comment || '';
                commentTextarea.style.cssText = 'width: 100%; min-height: 50px; padding: 6px; border: 1px solid var(--gray-300); border-radius: 4px; font-size: 11px; resize: vertical;';
                commentTextarea.addEventListener('input', () => {
                    service.comment = commentTextarea.value;
                    this.saveToLocalStorage();
                });

                detailsContent.appendChild(commentTextarea);

                card.appendChild(detailsContent);

                return card;
            }

            async loadSavedCatalogFolder() {
                try {
                    // Загружаем handle из IndexedDB
                    const handle = await this.loadFolderHandleFromIndexedDB();

                    if (handle) {
                        // Проверяем, есть ли ещё доступ к папке
                        const permission = await handle.queryPermission({ mode: 'readwrite' });

                        if (permission === 'granted') {
                            // Доступ есть, используем handle
                            this.catalogDirectoryHandle = handle;
                            this.state.saveFolder = handle.name;
                            console.log('Папка каталога восстановлена:', handle.name);
                        } else {
                            // Доступ потерян - сохраняем только имя для отображения предупреждения
                            console.log('Доступ к папке потерян, требуется повторный выбор');
                            this.state.saveFolder = handle.name;
                            this.catalogDirectoryHandle = null;
                        }
                    } else {
                        // Загружаем только имя из localStorage для отображения
                        const savedFolder = localStorage.getItem('quoteCalc_catalogFolder');
                        if (savedFolder) {
                            this.state.saveFolder = savedFolder;
                            console.log('Загружено имя папки (без доступа):', savedFolder);
                        }
                    }
                } catch (error) {
                    console.log('Не удалось восстановить папку:', error.message);
                    // Пробуем хотя бы загрузить имя
                    const savedFolder = localStorage.getItem('quoteCalc_catalogFolder');
                    if (savedFolder) {
                        this.state.saveFolder = savedFolder;
                    }
                }

                // Обновляем UI после загрузки
                this.updateCatalogFolderDisplay();
            }

            initVersionDisplay() {
                const versionElement = document.getElementById('app-version');
                if (versionElement) {
                    versionElement.textContent = `v${this.APP_VERSION}`;
                }
            }

            initChecklistEvents() {
                // Filter buttons
                const filterBtns = document.querySelectorAll('.checklist-filter-btn');
                filterBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active from all
                        filterBtns.forEach(b => {
                            b.style.background = 'transparent';
                            b.style.color = 'var(--gray-600)';
                            b.classList.remove('active');
                        });

                        // Set active
                        btn.style.background = 'white';
                        btn.style.color = 'inherit';
                        btn.classList.add('active');

                        // Update state and re-render
                        this.state.checklistFilter = btn.dataset.filter;
                        this.renderChecklist();
                    });
                });

                // View mode buttons
                const viewBtns = document.querySelectorAll('.checklist-view-btn');
                viewBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active from all
                        viewBtns.forEach(b => {
                            b.style.background = 'transparent';
                            b.style.color = 'var(--gray-600)';
                            b.classList.remove('active');
                        });

                        // Set active
                        btn.style.background = 'white';
                        btn.style.color = 'inherit';
                        btn.classList.add('active');

                        // Update state and re-render
                        this.state.checklistViewMode = btn.dataset.view;
                        this.renderChecklist();
                    });
                });
            }

            initNewSectionsEvents() {
                console.log('[EVENTS] initNewSectionsEvents() called');
                // Универсальная функция для обработки событий секций
                const initSectionEvents = (container, arrayName, renderFunc, type) => {
                    console.log(`[EVENTS] initSectionEvents for type: ${type}, arrayName: ${arrayName}, renderFunc: ${renderFunc.name}`);
                    if (!container) return;

                    // Click events
                    container.addEventListener('click', (e) => {
                        const serviceCard = e.target.closest('.service-card');
                        if (!serviceCard) return;
                        const serviceId = serviceCard.dataset.serviceId;

                        // Remove button
                        if (e.target.closest(`.remove-${type}-btn`)) {
                            this.state[arrayName] = this.state[arrayName].filter(s => s.id !== serviceId);
                            this.state.selectedServices.delete(serviceId);
                            renderFunc.call(this);
                            this.scheduleUpdate();
                            this.markQuoteAsUnsaved();
                            return;
                        }

                        // Duplicate button
                        if (e.target.closest(`.duplicate-${type}-btn`)) {
                            const service = this.state[arrayName].find(s => s.id === serviceId);
                            if (service) {
                                const newService = {
                                    ...service,
                                    id: Date.now().toString(),
                                    name: service.name + ' (копия)'
                                };
                                this.state[arrayName].unshift(newService);
                                renderFunc.call(this);
                                this.scheduleUpdate();
                                this.markQuoteAsUnsaved();
                                this.showNotification('Услуга продублирована');
                            }
                            return;
                        }

                        // Booking status button
                        if (e.target.closest(`.${type}-booking-status-btn`)) {
                            const service = this.state[arrayName].find(s => s.id === serviceId);
                            if (service) {
                                service.done = !service.done;
                                renderFunc.call(this);
                                this.scheduleUpdate();
                                this.markQuoteAsUnsaved();
                            }
                            return;
                        }

                        // Payment status button
                        if (e.target.closest(`.${type}-payment-status-btn`)) {
                            const service = this.state[arrayName].find(s => s.id === serviceId);
                            if (service) {
                                service.paid = !service.paid;
                                renderFunc.call(this);
                                this.scheduleUpdate();
                                this.markQuoteAsUnsaved();
                            }
                            return;
                        }

                        // Timing toggle button
                        if (e.target.closest(`.${type}-timing-toggle-btn`)) {
                            console.log(`[CONSTRUCTOR] Timing toggle clicked for ${type}-${serviceId}`);
                            const timingContent = document.getElementById(`${type}-timing-${serviceId}`);
                            const icon = e.target.closest(`.${type}-timing-toggle-btn`).querySelector('.timing-toggle-icon');
                            if (timingContent) {
                                const isHidden = timingContent.style.maxHeight === '0px' || !timingContent.style.maxHeight;
                                console.log(`[CONSTRUCTOR] Toggle: ${isHidden ? 'expanding' : 'collapsing'}`);
                                timingContent.style.maxHeight = isHidden ? '200px' : '0';
                                if (icon) icon.textContent = isHidden ? '▼' : '▶';
                            }
                            return;
                        }

                        // Quantity buttons
                        if (e.target.classList.contains('qty-decrease') || e.target.classList.contains('qty-increase')) {
                            const service = this.state[arrayName].find(s => s.id === serviceId);
                            if (service) {
                                if (e.target.classList.contains('qty-decrease')) {
                                    service.quantity = Math.max(1, service.quantity - 1);
                                } else {
                                    service.quantity = service.quantity + 1;
                                }
                                renderFunc.call(this);
                                this.scheduleUpdate();
                                this.markQuoteAsUnsaved();
                            }
                            return;
                        }
                    });

                    // Change events
                    container.addEventListener('change', (e) => {
                        const serviceId = e.target.dataset.serviceId;
                        const service = this.state[arrayName].find(s => s.id === serviceId);
                        if (!service) return;

                        // Input fields
                        if (e.target.classList.contains(`${type}-field`)) {
                            const field = e.target.dataset.field;
                            console.log(`[CONSTRUCTOR] Field changed: ${field}, value: ${e.target.value}, type: ${type}, serviceId: ${serviceId}`);

                            if (['price', 'quantity', 'markup', 'prepayment', 'day', 'roomsCount'].includes(field)) {
                                service[field] = parseFloat(e.target.value) || 0;
                            } else {
                                service[field] = e.target.value;
                            }

                            // Update duration if startTime or endTime changed
                            // НЕ перерисовываем карточку для полей времени - только обновляем duration
                            if (field === 'startTime' || field === 'endTime') {
                                console.log(`[CONSTRUCTOR] Time field detected - updating duration ONLY, NO RERENDER`);
                                const durationEl = document.getElementById(`${type}-duration-${serviceId}`);
                                if (durationEl) {
                                    durationEl.textContent = this.calculateDuration(service.startTime, service.endTime);
                                    console.log(`[CONSTRUCTOR] Duration updated to: ${durationEl.textContent}`);
                                } else {
                                    console.warn(`[CONSTRUCTOR] Duration element not found: ${type}-duration-${serviceId}`);
                                }
                                // Только обновляем расчёты, НЕ перерисовываем
                                this.scheduleUpdate();
                                this.markQuoteAsUnsaved();
                                console.log(`[CONSTRUCTOR] Time field change complete - NO RERENDER called`);
                                return;
                            }

                            console.log(`[CONSTRUCTOR] Non-time field - calling RERENDER`);
                            console.trace('[CONSTRUCTOR] Stack trace for renderFunc call:');
                            renderFunc.call(this);
                            this.scheduleUpdate();
                            this.markQuoteAsUnsaved();
                            return;
                        }

                        // Region select
                        if (e.target.classList.contains(`${type}-region-select`)) {
                            service.region = e.target.value;
                            renderFunc.call(this);
                            this.scheduleUpdate();
                            this.markQuoteAsUnsaved();
                            return;
                        }

                        // Checkboxes
                        if (e.target.classList.contains(`${type}-checkbox`)) {
                            if (e.target.checked) {
                                this.state.selectedServices.add(serviceId);
                            } else {
                                this.state.selectedServices.delete(serviceId);
                            }
                            renderFunc.call(this);
                            return;
                        }

                        if (e.target.classList.contains(`${type}-exclude-checkbox`)) {
                            service.excludeFromMarkup = e.target.checked;
                            renderFunc.call(this);
                            this.scheduleUpdate();
                            this.markQuoteAsUnsaved();
                            return;
                        }

                        if (e.target.classList.contains(`${type}-full-profit-checkbox`)) {
                            service.fullProfit = e.target.checked;
                            renderFunc.call(this);
                            this.scheduleUpdate();
                            this.markQuoteAsUnsaved();
                            return;
                        }
                    });

                    // Blur events for contenteditable
                    container.addEventListener('blur', (e) => {
                        if (e.target.classList.contains('editable')) {
                            const serviceId = e.target.dataset.id;
                            const field = e.target.dataset.field;
                            const service = this.state[arrayName].find(s => s.id === serviceId);
                            if (service) {
                                service[field] = e.target.textContent.trim();
                                this.markQuoteAsUnsaved();
                            }
                        }
                    }, true);
                };

                // Инициализация для каждой секции
                initSectionEvents(
                    document.getElementById('hotels-list'),
                    'hotels',
                    this.renderHotels,
                    'hotel'
                );

                initSectionEvents(
                    document.getElementById('flights-list'),
                    'flights',
                    this.renderFlights,
                    'flight'
                );

                initSectionEvents(
                    document.getElementById('other-services-list'),
                    'otherServices',
                    this.renderOtherServices,
                    'other'
                );
            }

            bindKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    const isInputField = e.target.tagName === 'INPUT' ||
                                        e.target.tagName === 'TEXTAREA' ||
                                        e.target.contentEditable === 'true';

                    // В полях ввода разрешаем стандартные команды редактирования
                    if (isInputField) {
                        // Разрешаем стандартные команды: Ctrl+A, Ctrl+Z, Ctrl+Y, Ctrl+X, Ctrl+C, Ctrl+V
                        const isEditCommand = (e.ctrlKey || e.metaKey) &&
                            ['a', 'z', 'y', 'x', 'c', 'v'].includes(e.key.toLowerCase());

                        // Разрешаем Escape для закрытия модалов даже в полях ввода
                        if (e.key === 'Escape') {
                            this.closeAllModals();
                            return;
                        }

                        // Блокируем только наши кастомные шорткаты в полях ввода
                        if (!isEditCommand) {
                            if ((e.ctrlKey || e.metaKey) && ['n', 'p'].includes(e.key.toLowerCase())) {
                                // Сохраняем наши кастомные шорткаты (удалено 's' и 'o')
                            } else {
                                // Для всех остальных клавиш - разрешаем нативное поведение
                                return;
                            }
                        } else {
                            // Разрешаем стандартные команды редактирования
                            return;
                        }
                    }

                    // Escape - close modals
                    if (e.key === 'Escape') {
                        this.closeAllModals();
                    }

                    // Ctrl+S отключен (пользователь использует для других целей)
                    // Используйте кнопку "Сохранить смету" вместо этого

                    // Ctrl+O отключен (пользователь использует для других целей)
                    // Используйте кнопку "Загрузить смету" вместо этого

                    // Ctrl+N - new quote
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                        e.preventDefault();
                        this.reset();
                    }

                    // Ctrl+P - print
                    if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                        e.preventDefault();
                        this.print();
                    }

                    // Delete - delete selected services (only if not in input)
                    if (e.key === 'Delete' && this.state.selectedServices.size > 0 && !isInputField) {
                        e.preventDefault();
                        this.deleteSelected();
                    }
                });
            }

            closeAllModals() {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('show');
                });
            }

            toggleProgramDescription() {
                const section = document.getElementById('program-description-section');
                const content = section.querySelector('.collapsible-content');
                const inner = section.querySelector('.collapsible-content-inner');
                const textarea = document.getElementById('program-description');

                section.classList.toggle('expanded');
                const isExpanded = section.classList.contains('expanded');

                // Динамически устанавливаем высоту на основе содержимого
                if (isExpanded) {
                    // Инициализируем высоту textarea при раскрытии
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';

                    // Устанавливаем высоту секции
                    const height = inner.scrollHeight;
                    content.style.maxHeight = height + 'px';
                } else {
                    content.style.maxHeight = '0';
                }

                // Сохраняем состояние в localStorage
                localStorage.setItem('quoteCalc_programDescExpanded', isExpanded);
            }

            toggleQuoteComments() {
                const section = document.getElementById('quote-comments-section');
                const content = section.querySelector('.collapsible-content');
                const inner = section.querySelector('.collapsible-content-inner');
                const textarea = document.getElementById('quote-description');

                section.classList.toggle('expanded');
                const isExpanded = section.classList.contains('expanded');

                // Динамически устанавливаем высоту на основе содержимого
                if (isExpanded) {
                    // Инициализируем высоту textarea при раскрытии
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';

                    // Устанавливаем высоту секции
                    const height = inner.scrollHeight;
                    content.style.maxHeight = height + 'px';
                } else {
                    content.style.maxHeight = '0';
                }

                // Сохраняем состояние в localStorage
                localStorage.setItem('quoteCalc_quoteCommentsExpanded', isExpanded);
            }

            toggleBookingTerms() {
                const section = document.getElementById('booking-terms-section');
                const content = section.querySelector('.collapsible-content');
                const inner = section.querySelector('.collapsible-content-inner');
                const textarea = document.getElementById('booking-terms');

                section.classList.toggle('expanded');
                const isExpanded = section.classList.contains('expanded');

                // Динамически устанавливаем высоту на основе содержимого
                if (isExpanded) {
                    // Инициализируем высоту textarea при раскрытии
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';

                    // Устанавливаем высоту секции
                    const height = inner.scrollHeight;
                    content.style.maxHeight = height + 'px';
                } else {
                    content.style.maxHeight = '0';
                }

                // Сохраняем состояние в localStorage
                localStorage.setItem('quoteCalc_bookingTermsExpanded', isExpanded);
            }

            // ===== НОВЫЕ СЕКЦИИ: Отели, Перелёты, Прочие услуги =====

            renderHotels() {
                console.log('[RENDER] renderHotels() called');
                const container = document.getElementById('hotels-list');
                if (!container) return;

                if (this.state.hotels.length === 0) {
                    container.innerHTML = '<div class="text-xs text-muted" style="padding: calc(var(--spacing) * 4); text-align: center;">Отели не добавлены</div>';
                    return;
                }

                container.innerHTML = this.state.hotels.map(service => this.renderServiceCard(service, 'hotel')).join('');
                lucide.createIcons();
            }

            renderFlights() {
                console.log('[RENDER] renderFlights() called');
                const container = document.getElementById('flights-list');
                if (!container) return;

                if (this.state.flights.length === 0) {
                    container.innerHTML = '<div class="text-xs text-muted" style="padding: calc(var(--spacing) * 4); text-align: center;">Перелёты не добавлены</div>';
                    return;
                }

                container.innerHTML = this.state.flights.map(service => this.renderServiceCard(service, 'flight')).join('');
                lucide.createIcons();
            }

            renderOtherServices() {
                console.log('[RENDER] renderOtherServices() called');
                const container = document.getElementById('other-services-list');
                if (!container) return;

                if (this.state.otherServices.length === 0) {
                    container.innerHTML = '<div class="text-xs text-muted" style="padding: calc(var(--spacing) * 4); text-align: center;">Прочие услуги не добавлены</div>';
                    return;
                }

                container.innerHTML = this.state.otherServices.map(service => this.renderServiceCard(service, 'other')).join('');
                lucide.createIcons();
            }

            renderServiceCard(service, type) {
                const serviceTotal = this.calculateServiceTotal(service);
                const isSelected = this.state.selectedServices.has(service.id);
                const isExcluded = service.excludeFromMarkup;
                const isFullProfit = service.fullProfit;
                const classes = [];
                if (isSelected) classes.push('selected');
                if (isExcluded) classes.push('excluded');
                if (isFullProfit) classes.push('full-profit');

                // Определяем специфичные поля price/quantity в зависимости от типа
                let priceLabel, quantityLabel, dayField;

                if (type === 'hotel') {
                    priceLabel = '💵 За ночь:';
                    quantityLabel = '🌙 Ночей:';
                    dayField = false; // Для отелей нет поля "день"
                } else if (type === 'flight') {
                    priceLabel = '💵 За билет:';
                    quantityLabel = '👥 Пассажиров:';
                    dayField = false; // Для перелётов нет поля "день"
                } else if (type === 'other') {
                    priceLabel = 'Цена:';
                    quantityLabel = 'Кол-во:';
                    dayField = false; // Для прочих услуг нет поля "день"
                } else {
                    priceLabel = 'Цена:';
                    quantityLabel = 'Кол-во:';
                    dayField = true; // Для основных услуг есть поле "день"
                }

                // Регион - для отелей из селекта, для остальных не показываем
                const regionHtml = type === 'hotel' ? `
                    <div style="font-size: 11px; color: var(--gray-500); margin-top: 1px; display: flex; align-items: center; gap: 4px;">
                        <i data-lucide="map-pin" style="width: 10px; height: 10px; display: inline; vertical-align: text-top;"></i>
                        <select class="${type}-region-select" data-service-id="${service.id}" style="font-size: 11px; border: none; background: transparent; color: var(--gray-500); padding: 0; cursor: pointer;" title="Изменить регион">
                            ${this.regions.map(region => `<option value="${region}" ${service.region === region ? 'selected' : ''}>${region}</option>`).join('')}
                        </select>
                    </div>
                ` : '';

                return `
                    <div class="service-card ${classes.join(' ')}" data-service-id="${service.id}" data-service-type="${type}">
                        <div class="service-header">
                            <div class="service-header-left">
                                <input type="checkbox" class="checkbox ${type}-checkbox" ${isSelected ? 'checked' : ''}
                                       data-service-id="${service.id}"
                                       title="Выбрать для пакетных операций">
                                <div>
                                    <div class="editable" contenteditable="true" data-field="name" data-id="${service.id}" style="font-size: 14px; font-weight: 600; color: var(--gray-900); line-height: 1.3;">${service.name}</div>
                                    ${regionHtml}
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <!-- Статусы бронирования и оплаты -->
                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <button
                                        class="status-icon-btn ${type}-booking-status-btn"
                                        data-service-id="${service.id}"
                                        data-status="${service.done ? 'booked' : 'none'}"
                                        title="Статус бронирования: ${service.done ? 'Забронировано' : 'Не забронировано'}"
                                        style="border: none; background: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s; color: ${service.done ? '#10b981' : '#9ca3af'};">
                                        <i data-lucide="${service.done ? 'check-circle' : 'circle'}" style="width: 18px; height: 18px;"></i>
                                    </button>
                                    <button
                                        class="status-icon-btn ${type}-payment-status-btn"
                                        data-service-id="${service.id}"
                                        data-status="${service.paid ? 'paid' : 'none'}"
                                        title="Статус оплаты: ${service.paid ? 'Оплачено' : 'Не оплачено'}"
                                        style="border: none; background: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s; color: ${service.paid ? '#10b981' : '#9ca3af'};">
                                        <i data-lucide="${service.paid ? 'circle-dollar-sign' : 'dollar-sign'}" style="width: 18px; height: 18px;"></i>
                                    </button>
                                </div>
                                <button class="btn btn-sm duplicate-${type}-btn" data-service-id="${service.id}" title="Дублировать" style="padding: 4px 8px; font-size: 12px; background: transparent; color: #9ca3af; border: 1px solid #e5e7eb; margin-right: 4px; transition: all 0.2s;">
                                    <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                </button>
                                <button class="btn btn-sm remove-${type}-btn" data-service-id="${service.id}" title="Удалить">×</button>
                            </div>
                        </div>
                        <div class="service-content">
                            <div class="form-row" style="align-items: flex-start; margin-bottom: calc(var(--spacing) * 1);">
                                <label style="padding-top: 3px; font-size: 10px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; width: 100px; flex-shrink: 0;">Описание:</label>
                                <div class="editable" contenteditable="true" data-field="description" data-id="${service.id}" style="flex: 1; min-width: 0; font-size: 12px; color: var(--gray-700); line-height: 1.5;">${service.description}</div>
                            </div>

                            <div class="form-row" style="align-items: flex-start; margin-bottom: calc(var(--spacing) * 1);">
                                <label style="padding-top: 3px; font-size: 10px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; width: 100px; flex-shrink: 0;">Контрагент:</label>
                                <div class="editable" contenteditable="true" data-field="contractor" data-id="${service.id}" style="flex: 1; min-width: 0; font-size: 12px; color: var(--gray-700); line-height: 1.5;">${service.contractor || ''}</div>
                            </div>

                            <div class="form-row" style="margin-bottom: calc(var(--spacing) * 1); flex-wrap: wrap; row-gap: calc(var(--spacing) * 0.75);">
                                ${dayField ? `
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">День:</label>
                                        <input type="number" class="input ${type}-field" data-field="day" data-service-id="${service.id}" value="${service.day}" min="1" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;" autocomplete="off" data-lpignore="true" data-form-type="other">
                                    </div>
                                ` : ''}

                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">${priceLabel}</label>
                                    <input type="number" class="input ${type}-field" data-field="price" data-service-id="${service.id}" value="${service.price}" min="0" style="width: 80px; font-size: 11px; padding: 4px 6px; text-align: center;" autocomplete="off" data-lpignore="true" data-form-type="other">
                                </div>

                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">${quantityLabel}</label>
                                    <div class="qty-control">
                                        <button class="qty-btn qty-decrease" data-service-id="${service.id}" data-type="${type}">−</button>
                                        <input type="number" class="qty-input ${type}-field" data-field="quantity" data-service-id="${service.id}" value="${service.quantity}" min="1" autocomplete="off" data-lpignore="true" data-form-type="other">
                                        <button class="qty-btn qty-increase" data-service-id="${service.id}" data-type="${type}">+</button>
                                    </div>
                                </div>

                                ${type === 'hotel' ? `
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">🚪 Номеров:</label>
                                        <input type="number" class="input ${type}-field" data-field="roomsCount" data-service-id="${service.id}" value="${service.roomsCount || 1}" min="1" style="width: 60px; font-size: 11px; padding: 4px 6px; text-align: center;" autocomplete="off" data-lpignore="true" data-form-type="other">
                                    </div>
                                ` : ''}

                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Наценка:</label>
                                    <input type="number" class="input ${type}-field" data-field="markup" data-service-id="${service.id}" value="${service.markup || 0}" min="0" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;" autocomplete="off" data-lpignore="true" data-form-type="other">
                                    <span style="font-size: 10px; color: var(--gray-500);">%</span>
                                </div>
                            </div>

                            <!-- Время начала/окончания -->
                            <div style="border-top: 1px solid #f3f4f6; padding-top: calc(var(--spacing) * 0.5);">
                                <button
                                    class="btn btn-sm ${type}-timing-toggle-btn"
                                    data-service-id="${service.id}"
                                    style="font-size: 9px; padding: 2px 6px; background: #f9fafb; color: #6b7280; border: none; width: 100%; text-align: left; display: flex; align-items: center; gap: 4px;"
                                    title="Показать время начала/окончания">
                                    <span class="timing-toggle-icon" style="font-size: 8px;">▶</span>
                                    <span>⏰ Тайминг</span>
                                    ${service.startTime || service.endTime ? `<span style="font-size: 8px; color: #3b82f6;">●</span>` : ''}
                                </button>
                                <div class="timing-content" id="${type}-timing-${service.id}" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                                    <div style="padding: calc(var(--spacing) * 0.75) 0; display: flex; flex-wrap: wrap; gap: calc(var(--spacing) * 0.75);">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">⏰ Начало:</label>
                                            <input type="time" class="input ${type}-field" data-field="startTime" data-service-id="${service.id}" value="${service.startTime || ''}" style="width: 90px; font-size: 11px; padding: 4px 6px;">
                                        </div>

                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Окончание:</label>
                                            <input type="time" class="input ${type}-field" data-field="endTime" data-service-id="${service.id}" value="${service.endTime || ''}" style="width: 90px; font-size: 11px; padding: 4px 6px;">
                                        </div>

                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <span style="font-size: 10px; color: var(--gray-500);">Длительность:</span>
                                            <span style="font-size: 11px; font-weight: 500; color: var(--gray-700);" id="${type}-duration-${service.id}">
                                                ${this.calculateDuration(service.startTime, service.endTime)}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row" style="margin-bottom: 0; align-items: center; flex-wrap: wrap; row-gap: calc(var(--spacing) * 1);">
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--gray-600); white-space: nowrap;">
                                    <input type="checkbox" class="checkbox ${type}-exclude-checkbox" data-service-id="${service.id}" ${service.excludeFromMarkup ? 'checked' : ''} title="Выключить наценку для этой услуги">
                                    <span>Выключить наценку</span>
                                </label>

                                <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--gray-600); white-space: nowrap;">
                                    <input type="checkbox" class="checkbox ${type}-full-profit-checkbox" data-service-id="${service.id}" ${service.fullProfit ? 'checked' : ''} title="Вся сумма в прибыль (себестоимость = 0)">
                                    <span>💰 Вся сумма в прибыль</span>
                                </label>

                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <label style="font-size: 10px; color: var(--gray-600); white-space: nowrap;">💳 Предоплата:</label>
                                    <input type="number" class="input ${type}-field" data-field="prepayment" data-service-id="${service.id}" value="${service.prepayment || 0}" min="0" step="0.01" style="width: 90px; font-size: 11px; padding: 4px 6px;" title="Размер требуемой предоплаты">
                                </div>

                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <label style="font-size: 10px; color: var(--gray-600); white-space: nowrap;">📅 Срок предоплаты:</label>
                                    <input type="date" class="input ${type}-field" data-field="prepaymentDeadline" data-service-id="${service.id}" value="${service.prepaymentDeadline || ''}" style="width: 130px; font-size: 11px; padding: 4px 6px;" title="Крайняя дата внесения предоплаты">
                                </div>

                                <div style="margin-left: auto; text-align: right; min-width: 80px;">
                                    <div style="font-size: 15px; font-weight: 600; color: var(--success); white-space: nowrap;">
                                        ${this.formatCurrency(serviceTotal)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            showAddHotelModal() {
                // Открываем модальное окно создания отеля
                this.state.currentServiceType = 'hotel';
                this.showServiceModal();
            }

            showAddFlightModal() {
                // Открываем модальное окно создания перелёта
                this.state.currentServiceType = 'flight';
                this.showServiceModal();
            }

            showAddOtherServiceModal() {
                // Открываем модальное окно создания прочей услуги
                this.state.currentServiceType = 'other';
                this.showServiceModal();
            }


            restoreProgramDescriptionState() {
                const section = document.getElementById('program-description-section');
                const content = section.querySelector('.collapsible-content');
                const inner = section.querySelector('.collapsible-content-inner');
                const textarea = document.getElementById('program-description');
                const savedState = localStorage.getItem('quoteCalc_programDescExpanded');

                // Инициализируем высоту textarea
                if (textarea.value) {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                }

                // По умолчанию свернут, разворачиваем только если было сохранено expanded состояние
                if (savedState === 'true') {
                    section.classList.add('expanded');
                    // Устанавливаем динамическую высоту
                    const height = inner.scrollHeight;
                    content.style.maxHeight = height + 'px';
                }
            }

            restoreQuoteCommentsState() {
                const section = document.getElementById('quote-comments-section');
                const content = section.querySelector('.collapsible-content');
                const inner = section.querySelector('.collapsible-content-inner');
                const textarea = document.getElementById('quote-description');
                const savedState = localStorage.getItem('quoteCalc_quoteCommentsExpanded');

                // Инициализируем высоту textarea
                if (textarea.value) {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                }

                // По умолчанию свернут
                if (savedState === 'true') {
                    section.classList.add('expanded');
                    // Устанавливаем динамическую высоту
                    const height = inner.scrollHeight;
                    content.style.maxHeight = height + 'px';
                }
            }


            restoreBookingTermsState() {
                // Booking terms теперь в настройках, а не в основном интерфейсе
                const section = document.getElementById('booking-terms-section');
                if (!section) {
                    // Элемент не существует (удалён), просто возвращаемся
                    return;
                }

                const content = section.querySelector('.collapsible-content');
                const inner = section.querySelector('.collapsible-content-inner');
                const textarea = document.getElementById('booking-terms');
                const savedState = localStorage.getItem('quoteCalc_bookingTermsExpanded');

                // Инициализируем высоту textarea
                if (textarea && textarea.value) {
                    textarea.style.height = 'auto';
                    textarea.style.height = textarea.scrollHeight + 'px';
                }

                // По умолчанию свернут
                if (savedState === 'true') {
                    section.classList.add('expanded');
                    // Устанавливаем динамическую высоту
                    const height = inner.scrollHeight;
                    content.style.maxHeight = height + 'px';
                }
            }

            updateCollapsibleHeight(textareaId) {
                // Автоматически изменяем размер textarea
                const textarea = document.getElementById(textareaId);
                textarea.style.height = 'auto'; // Сбрасываем высоту для корректного расчета
                textarea.style.height = textarea.scrollHeight + 'px'; // Устанавливаем новую высоту

                // Определяем какую секцию обновлять
                const sectionId = textareaId === 'quote-description' ? 'quote-comments-section' : 'program-description-section';
                const section = document.getElementById(sectionId);

                // Обновляем высоту коллапсируемой секции только если она развернута
                if (section.classList.contains('expanded')) {
                    const content = section.querySelector('.collapsible-content');
                    const inner = section.querySelector('.collapsible-content-inner');
                    const height = inner.scrollHeight;
                    content.style.maxHeight = height + 'px';
                }
            }

            initQuillEditors() {
                console.log('[Quill] Инициализация редакторов...');

                // Проверяем, загружена ли библиотека Quill
                if (typeof Quill === 'undefined') {
                    console.warn('[Quill] Библиотека Quill не загружена, повторная попытка через 500ms...');
                    // Retry после загрузки CDN
                    setTimeout(() => {
                        if (typeof Quill !== 'undefined') {
                            console.log('[Quill] Библиотека загружена, инициализируем...');
                            this.initQuillEditors();
                        } else {
                            console.warn('[Quill] Библиотека так и не загрузилась, используем fallback на textarea');
                        }
                    }, 500);
                    return; // Graceful degradation - используем обычные textarea
                }

                // Конфигурация тулбара
                const toolbarOptions = [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'align': [] }],
                    ['link'],
                    ['clean']
                ];

                const editorConfig = {
                    theme: 'snow',
                    modules: {
                        toolbar: toolbarOptions
                    }
                };

                // Инициализация редактора для описания программы
                console.log('[Quill] Создаём programDescEditor...');
                const programDescEditor = new Quill('#program-description-editor', {
                    ...editorConfig,
                    placeholder: 'Описание программы тура для клиента'
                });
                console.log('[Quill] programDescEditor создан');

                // Инициализация редактора для условий (quote-description)
                console.log('[Quill] Создаём quoteDescEditor...');
                const quoteDescEditor = new Quill('#quote-description-editor', {
                    ...editorConfig,
                    placeholder: 'Внутренние заметки, пожелания клиента, важная информация'
                });
                console.log('[Quill] quoteDescEditor создан');

                // Инициализация редактора для условий бронирования
                console.log('[Quill] Создаём bookingTermsEditor...');
                const bookingTermsEditor = new Quill('#booking-terms-editor', {
                    ...editorConfig,
                    placeholder: 'Условия бронирования, сроки оплаты, правила отмены...'
                });
                console.log('[Quill] bookingTermsEditor создан');

                // Сохраняем ссылки на редакторы
                this.quillEditors = {
                    programDescription: programDescEditor,
                    quoteDescription: quoteDescEditor,
                    bookingTerms: bookingTermsEditor
                };

                // Синхронизация с hidden textarea и автосохранение
                programDescEditor.on('text-change', () => {
                    const html = programDescEditor.root.innerHTML;
                    document.getElementById('program-description').value = html;
                    this.state.programDescription = html;
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();
                });

                quoteDescEditor.on('text-change', () => {
                    const html = quoteDescEditor.root.innerHTML;
                    document.getElementById('quote-description').value = html;
                    this.state.quoteComments = html;
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();
                });

                bookingTermsEditor.on('text-change', () => {
                    const html = bookingTermsEditor.root.innerHTML;
                    document.getElementById('booking-terms').value = html;
                    this.state.bookingTerms = html;
                    this.markQuoteAsUnsaved();
                    // Автосохранение глобальных настроек
                    this.scheduleGlobalSettingsSave();
                });

                // Загружаем сохранённые данные в редакторы
                if (this.state.programDescription) {
                    programDescEditor.root.innerHTML = this.state.programDescription;
                }
                if (this.state.quoteComments) {
                    quoteDescEditor.root.innerHTML = this.state.quoteComments;
                }
                if (this.state.bookingTerms) {
                    bookingTermsEditor.root.innerHTML = this.state.bookingTerms;
                }

                // Добавляем tooltips сразу к DOM элементам редакторов
                // Используем querySelector напрямую на контейнерах редакторов
                this.addQuillTooltips();
            }

            addQuillTooltips() {
                console.log('[Tooltips] Начинаем добавление tooltips...');

                // Tooltips для всех кнопок редактора
                const tooltips = {
                    'bold': 'Жирный (Ctrl+B)',
                    'italic': 'Курсив (Ctrl+I)',
                    'underline': 'Подчёркнутый (Ctrl+U)',
                    'strike': 'Зачёркнутый',
                    'header': 'Заголовок',
                    'list': 'Список',
                    'indent': 'Отступ',
                    'align': 'Выравнивание',
                    'link': 'Вставить ссылку',
                    'clean': 'Очистить форматирование'
                };

                // Находим все контейнеры редакторов
                const editorContainers = ['#program-description-editor', '#quote-description-editor', '#booking-terms-editor'];

                let totalButtons = 0;
                editorContainers.forEach((containerId, index) => {
                    const container = document.querySelector(containerId);
                    if (!container) {
                        console.warn(`[Tooltips] Контейнер ${containerId} не найден`);
                        return;
                    }

                    const toolbar = container.previousElementSibling; // Тулбар обычно перед редактором
                    if (!toolbar || !toolbar.classList.contains('ql-toolbar')) {
                        // Пробуем найти внутри родителя
                        const parent = container.parentElement;
                        const toolbarInside = parent ? parent.querySelector('.ql-toolbar') : null;

                        if (toolbarInside) {
                            console.log(`[Tooltips] Найден тулбар внутри родителя для ${containerId}`);
                            this.applyTooltipsToToolbar(toolbarInside, tooltips);
                            totalButtons += Object.keys(tooltips).length;
                        } else {
                            console.warn(`[Tooltips] Тулбар не найден для ${containerId}`);
                        }
                    } else {
                        console.log(`[Tooltips] Найден тулбар рядом с ${containerId}`);
                        this.applyTooltipsToToolbar(toolbar, tooltips);
                        totalButtons += Object.keys(tooltips).length;
                    }
                });

                console.log('[Tooltips] Всего tooltips добавлено:', totalButtons);
            }

            applyTooltipsToToolbar(toolbar, tooltips) {
                // Применяем tooltips к кнопкам в тулбаре
                Object.keys(tooltips).forEach(format => {
                    const buttons = toolbar.querySelectorAll(`.ql-${format}`);
                    buttons.forEach(button => {
                        // Используем стандартный title для надежности
                        button.setAttribute('title', tooltips[format]);
                    });
                });
            }

            bindEvents() {
                // Search with debouncing
                document.getElementById('search').addEventListener('input', (e) => {
                    this.debouncedSearch(e.target.value);
                });

                // Category filters
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.state.activeCategory = e.target.dataset.category;
                        this.renderTemplates();
                    });
                });

                // Settings with validation
                ['pax-count', 'tour-start', 'tour-end', 'client-name', 'client-phone', 'client-email', 'quote-description', 'program-description', 'booking-terms'].forEach(id => {
                    const element = document.getElementById(id);
                    element.addEventListener('change', (e) => {
                        const field = id.replace(/-([a-z])/g, (match, letter) => letter.toUpperCase());

                        if (field === 'paxCount') {
                            const value = Math.max(1, parseInt(e.target.value) || 1);
                            this.state.paxCount = value;
                            e.target.value = value;
                        } else if (field === 'tourStart' || field === 'tourEnd') {
                            this.state[field] = e.target.value;
                            // При изменении любой даты проверяем весь диапазон
                            setTimeout(() => this.validateDateRange(), 0);
                            // Отмечаем смету как несохраненную
                            this.markQuoteAsUnsaved();
                            // Обновляем отображение календарных дат в списке услуг
                            if (this.state.services.length > 0) {
                                this.renderServices();
                                this.renderServicesDetailList();
                            }
                        } else {
                            this.state[field] = e.target.value;
                        }

                        this.scheduleUpdate();
                    });

                    // Real-time validation feedback
                    element.addEventListener('blur', () => {
                        this.validateField(id, element.value);
                    });

                    // Автоматическое обновление высоты для textarea в коллапсируемых секциях
                    if (id === 'quote-description' || id === 'program-description') {
                        element.addEventListener('input', () => {
                            this.updateCollapsibleHeight(id);
                        });
                    }
                });

                // Hidden markup input (without slider)
                const hiddenMarkupInput = document.getElementById('hidden-markup');

                hiddenMarkupInput.addEventListener('input', (e) => {
                    // Разрешаем только цифры, запятую и точку (один разделитель)
                    let inputValue = e.target.value;

                    // Удаляем все символы кроме цифр, точки и запятой
                    inputValue = inputValue.replace(/[^\d.,]/g, '');

                    // Разрешаем только один разделитель
                    const separatorCount = (inputValue.match(/[.,]/g) || []).length;
                    if (separatorCount > 1) {
                        // Оставляем только первый разделитель
                        const firstSeparatorIndex = inputValue.search(/[.,]/);
                        inputValue = inputValue.substring(0, firstSeparatorIndex + 1) +
                                    inputValue.substring(firstSeparatorIndex + 1).replace(/[.,]/g, '');
                    }

                    // Заменяем точку на запятую
                    inputValue = inputValue.replace('.', ',');

                    // Обновляем поле без форматирования (чтобы можно было вводить)
                    e.target.value = inputValue;

                    // Парсим для state и валидации
                    const parsedValue = parseFloat(inputValue.replace(',', '.'));
                    if (!isNaN(parsedValue)) {
                        const value = Math.max(0, Math.min(100, parsedValue));
                        this.state.hiddenMarkup = value;
                        this.debouncedUpdate();
                    }
                });

                hiddenMarkupInput.addEventListener('blur', (e) => {
                    // При потере фокуса - форматируем значение
                    const parsedValue = parseFloat(e.target.value.replace(',', '.'));
                    if (!isNaN(parsedValue)) {
                        const value = Math.max(0, Math.min(100, parsedValue));
                        this.state.hiddenMarkup = value;
                        e.target.value = value.toFixed(1).replace('.', ',');
                    } else {
                        // Если пустое или невалидное - ставим 0
                        this.state.hiddenMarkup = 0;
                        e.target.value = '0,0';
                    }
                    this.debouncedUpdate();
                });

                // Partner commission input (without slider)
                const partnerCommissionInput = document.getElementById('partner-commission');

                partnerCommissionInput.addEventListener('input', (e) => {
                    // Разрешаем только цифры, запятую и точку (один разделитель)
                    let inputValue = e.target.value;

                    // Удаляем все символы кроме цифр, точки и запятой
                    inputValue = inputValue.replace(/[^\d.,]/g, '');

                    // Разрешаем только один разделитель
                    const separatorCount = (inputValue.match(/[.,]/g) || []).length;
                    if (separatorCount > 1) {
                        // Оставляем только первый разделитель
                        const firstSeparatorIndex = inputValue.search(/[.,]/);
                        inputValue = inputValue.substring(0, firstSeparatorIndex + 1) +
                                    inputValue.substring(firstSeparatorIndex + 1).replace(/[.,]/g, '');
                    }

                    // Заменяем точку на запятую
                    inputValue = inputValue.replace('.', ',');

                    // Обновляем поле без форматирования (чтобы можно было вводить)
                    e.target.value = inputValue;

                    // Парсим для state и валидации
                    const parsedValue = parseFloat(inputValue.replace(',', '.'));
                    if (!isNaN(parsedValue)) {
                        const value = Math.max(0, Math.min(100, parsedValue));
                        this.state.partnerCommission = value;
                        this.debouncedUpdate();
                    }
                });

                partnerCommissionInput.addEventListener('blur', (e) => {
                    // При потере фокуса - форматируем значение
                    const parsedValue = parseFloat(e.target.value.replace(',', '.'));
                    if (!isNaN(parsedValue)) {
                        const value = Math.max(0, Math.min(100, parsedValue));
                        this.state.partnerCommission = value;
                        e.target.value = value.toFixed(1).replace('.', ',');
                    } else {
                        // Если пустое или невалидное - ставим 0
                        this.state.partnerCommission = 0;
                        e.target.value = '0,0';
                    }
                    this.debouncedUpdate();
                });

                // Calendar sync: when tour-start is selected, set tour-end month to match
                const tourStartInput = document.getElementById('tour-start');
                const tourEndInput = document.getElementById('tour-end');

                if (tourStartInput && tourEndInput) {
                    tourStartInput.addEventListener('input', (e) => {
                        if (e.target.value) {
                            // Установить месяц для tour-end соответствующий tour-start
                            const startDate = new Date(e.target.value);
                            if (!isNaN(startDate.getTime())) {
                                // Если tour-end пустой или раньше начала, установить на тот же месяц
                                if (!tourEndInput.value || new Date(tourEndInput.value) < startDate) {
                                    const year = startDate.getFullYear();
                                    const month = String(startDate.getMonth() + 1).padStart(2, '0');
                                    tourEndInput.setAttribute('min', e.target.value);
                                    // Открыть date picker на том же месяце (браузер поддержка)
                                    if (tourEndInput.showPicker) {
                                        setTimeout(() => {
                                            tourEndInput.focus();
                                        }, 100);
                                    }
                                }
                            }
                        }
                    });
                }

                // ✅ Event handler для кнопки "История версий" (Этап 4.3)
                const restoreBackupBtn = document.getElementById('restore-from-backup-btn');
                if (restoreBackupBtn) {
                    restoreBackupBtn.addEventListener('click', () => {
                        this.showBackupsList();
                    });
                }
            }

            renderTemplates() {
                const container = document.getElementById('templates-list');
                if (!container) return;

                let filtered = this.templates;

                console.log('renderTemplates: activeCategory =', this.state.activeCategory);
                console.log('renderTemplates: total templates =', this.templates.length);

                if (this.state.activeCategory !== 'all') {
                    filtered = filtered.filter(t => t.category === this.state.activeCategory);
                    console.log('renderTemplates: filtered templates =', filtered.length, 'for category', this.state.activeCategory);
                }

                container.innerHTML = filtered.map(template => `
                    <div class="template-item"
                         onclick="window.QuoteCalc.addServiceFromTemplate('${template.id}')"
                         data-name="${(template.name || '').toLowerCase()}"
                         data-contractor="${(template.contractor || '').toLowerCase()}"
                         data-description="${(template.description || '').toLowerCase()}">
                        <div class="template-controls">
                            <button class="template-btn delete" data-text="УДАЛИТЬ" onclick="event.stopPropagation(); window.QuoteCalc.deleteTemplate('${template.id}')" title="Удалить">×</button>
                            <button class="template-btn edit" data-text="РЕДАКТИРОВАТЬ" onclick="event.stopPropagation(); window.QuoteCalc.editTemplate('${template.id}')" title="Редактировать">✎</button>
                        </div>
                        <div class="template-icon">${this.renderIcon(template.icon, '20px')}</div>
                        <div class="template-name">${template.name}</div>
                        ${template.contractor ? `<div class="text-xs text-muted">${template.contractor}</div>` : ''}
                        <div class="template-price">${template.price}</div>
                        <button class="template-other-services-btn"
                                onclick="event.stopPropagation(); window.QuoteCalc.addServiceFromTemplateToOtherServices('${template.id}')"
                                title="Добавить в прочие услуги">
                            📝
                        </button>
                        <button class="template-optional-btn"
                                onclick="event.stopPropagation(); window.QuoteCalc.addServiceFromTemplateAsOptional('${template.id}')"
                                title="Добавить в опциональные услуги">
                            <i data-lucide="clipboard-plus" style="width: 12px; height: 12px;"></i>
                        </button>
                    </div>
                `).join('');
                lucide.createIcons();
            }

            addServiceFromTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template || template.editing) return;

                // Track category usage (локальная статистика для сортировки)
                if (template.category) {
                    this.trackCategoryUsage(template.category);
                }

                // Track template usage (локальная статистика для сортировки шаблонов)
                this.trackTemplateUsage(templateId);

                // Track global usage (глобальная статистика для аналитики)
                this.trackGlobalUsage(templateId, template.name, template.category);

                // Visual feedback
                const templateElement = document.querySelector(`[data-template-id="${templateId}"]`);
                if (templateElement) {
                    templateElement.classList.add('loading');
                }

                const service = {
                    id: Date.now().toString(),
                    name: template.name,
                    description: template.description || template.name,
                    day: 1,
                    price: template.price,
                    quantity: 1,
                    markup: 0,
                    contractor: template.contractor || '',
                    excludeFromMarkup: false,
                    region: template.region || this.currentRegion, // Берем регион из шаблона
                    // Checklist fields
                    done: false,        // Забронировано
                    paid: false,        // Оплачено
                    comment: ''         // Комментарий менеджера
                };

                // Validate before adding
                const errors = this.validateService(service);
                if (errors.length > 0) {
                    this.showNotification(errors.join(', '), true);
                    if (templateElement) templateElement.classList.remove('loading');
                    return;
                }

                // Автоматическая сортировка по категориям
                const category = template.category || '';

                if (category === 'accommodation' || category.toLowerCase().includes('отел') || category.toLowerCase().includes('hotel') || category.toLowerCase().includes('гостиниц')) {
                    // Добавляем в отели
                    this.state.hotels.unshift(service);
                    this.renderHotels();
                    this.showNotification('Отель добавлен');
                } else if (category.toLowerCase().includes('перелет') || category.toLowerCase().includes('полет') || category.toLowerCase().includes('flight') || category.toLowerCase().includes('авиа')) {
                    // Добавляем в перелёты
                    this.state.flights.unshift(service);
                    this.renderFlights();
                    this.showNotification('Перелёт добавлен');
                } else if (service.noDayAssignment) {
                    // Услуга отмечена как "без дня" - в прочие
                    this.state.otherServices.unshift(service);
                    this.renderOtherServices();
                    this.showNotification('Услуга добавлена в прочие');
                } else {
                    // Добавляем в обычные услуги
                    this.state.services.unshift(service);
                    this.renderServices();
                    this.showNotification('Услуга добавлена');
                }

                this.scheduleUpdate();
                this.markQuoteAsUnsaved();

                // Remove loading state
                setTimeout(() => {
                    if (templateElement) templateElement.classList.remove('loading');
                }, 200);
            }

            addServiceFromTemplateAsOptional(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template || template.editing) return;

                // Track category usage (локальная статистика для сортировки)
                if (template.category) {
                    this.trackCategoryUsage(template.category);
                }

                // Track template usage (локальная статистика для сортировки шаблонов)
                this.trackTemplateUsage(templateId);

                // Track global usage (глобальная статистика для аналитики)
                this.trackGlobalUsage(templateId, template.name, template.category);

                const service = {
                    id: Date.now().toString(),
                    name: template.name,
                    description: template.description || template.name,
                    day: 1,
                    price: template.price,
                    quantity: 1,
                    markup: 0,
                    contractor: template.contractor || '',
                    excludeFromMarkup: false,
                    fullProfit: false,
                    region: template.region || this.currentRegion, // Берем регион из шаблона
                    // Checklist fields
                    done: false,        // Забронировано
                    paid: false,        // Оплачено
                    comment: ''         // Комментарий менеджера
                };

                // Validate before adding
                const errors = this.validateService(service);
                if (errors.length > 0) {
                    this.showNotification(errors.join(', '), true);
                    return;
                }

                // Add to optional services array
                this.state.optionalServices.unshift(service);
                this.renderOptionalServices();
                this.markQuoteAsUnsaved();

                this.showNotification('Услуга добавлена в опциональные');
            }

            addServiceFromTemplateToOtherServices(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template || template.editing) return;

                // Track category usage (локальная статистика для сортировки)
                if (template.category) {
                    this.trackCategoryUsage(template.category);
                }

                // Track template usage (локальная статистика для сортировки шаблонов)
                this.trackTemplateUsage(templateId);

                // Track global usage (глобальная статистика для аналитики)
                this.trackGlobalUsage(templateId, template.name, template.category);

                const service = {
                    id: Date.now().toString(),
                    name: template.name,
                    description: template.description || template.name,
                    day: 1,
                    price: template.price,
                    quantity: 1,
                    markup: 0,
                    contractor: template.contractor || '',
                    excludeFromMarkup: false,
                    fullProfit: false,
                    region: template.region || this.currentRegion, // Берем регион из шаблона
                    // Checklist fields
                    done: false,        // Забронировано
                    paid: false,        // Оплачено
                    comment: ''         // Комментарий менеджера
                };

                // Validate before adding
                const errors = this.validateService(service);
                if (errors.length > 0) {
                    this.showNotification(errors.join(', '), true);
                    return;
                }

                // Add to other services array
                this.state.otherServices.unshift(service);
                this.renderOtherServices();
                this.updateCalculations();
                this.markQuoteAsUnsaved();

                this.showNotification('Услуга добавлена в прочие услуги');
            }

            showServiceModal() {
                // Если currentServiceType не указан, устанавливаем по умолчанию
                if (!this.state.currentServiceType || this.state.currentServiceType === 'service') {
                    this.state.currentServiceType = 'service';
                }

                const modal = document.getElementById('service-modal');
                if (modal) {
                    modal.classList.add('show');

                    const type = this.state.currentServiceType;

                    // Меняем заголовок
                    const title = document.getElementById('service-modal-title');
                    if (title) {
                        if (type === 'hotel') {
                            title.textContent = '🏨 Добавить отель';
                        } else if (type === 'flight') {
                            title.textContent = '✈️ Добавить перелёт';
                        } else if (type === 'other') {
                            title.textContent = '📋 Добавить прочую услугу';
                        } else if (type === 'optional') {
                            title.textContent = 'Добавить опциональную услугу';
                        } else {
                            title.textContent = 'Добавить услугу';
                        }
                    }

                    // Показываем/скрываем поле "День"
                    const dayRow = document.getElementById('service-day-row');
                    if (dayRow) {
                        if (type === 'hotel' || type === 'flight' || type === 'other') {
                            dayRow.style.display = 'none';
                        } else {
                            dayRow.style.display = 'flex';
                        }
                    }

                    // Показываем/скрываем поле "Регион" (только для отеля)
                    const regionRow = document.getElementById('service-region-row');
                    const regionSelect = document.getElementById('service-region');
                    if (regionRow && regionSelect) {
                        if (type === 'hotel') {
                            regionRow.style.display = 'flex';
                            // Заполняем регионы
                            regionSelect.innerHTML = this.regions.map(region =>
                                `<option value="${region}" ${region === this.currentRegion ? 'selected' : ''}>${region}</option>`
                            ).join('');
                        } else {
                            regionRow.style.display = 'none';
                        }
                    }

                    // Меняем подпись поля "Цена"
                    const priceLabel = document.getElementById('service-price-label');
                    if (priceLabel) {
                        if (type === 'hotel') {
                            priceLabel.textContent = '💵 За ночь:';
                        } else if (type === 'flight') {
                            priceLabel.textContent = '💵 За билет:';
                        } else {
                            priceLabel.textContent = 'Цена:';
                        }
                    }

                    // Focus on first input
                    setTimeout(() => {
                        const nameInput = document.getElementById('service-name');
                        if (nameInput) nameInput.focus();
                    }, 300);
                }
            }

            hideServiceModal() {
                const modal = document.getElementById('service-modal');
                if (modal) {
                    modal.classList.remove('show');
                    
                    // Clear form
                    ['service-name', 'service-description', 'service-contractor', 'service-day', 'service-price'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = '';
                            element.classList.remove('error');
                        }
                    });
                }
            }

            addCustomService() {
                const nameElement = document.getElementById('service-name');
                const descriptionElement = document.getElementById('service-description');
                const contractorElement = document.getElementById('service-contractor');
                const dayElement = document.getElementById('service-day');
                const priceElement = document.getElementById('service-price');
                const regionElement = document.getElementById('service-region');

                if (!nameElement || !priceElement) return;

                const name = nameElement.value.trim();
                const description = descriptionElement ? descriptionElement.value.trim() : '';
                const contractor = contractorElement ? contractorElement.value.trim() : '';
                const price = Math.max(0, parseFloat(priceElement.value) || 0);

                // День нужен только для обычных услуг
                const needsDay = this.state.currentServiceType === 'service' || this.state.currentServiceType === 'optional';
                const day = needsDay ? Math.max(1, parseInt(dayElement?.value) || 1) : 1;

                // Регион: для отелей из модального окна, для остальных текущий регион
                const serviceType = this.state.currentServiceType;
                const region = (serviceType === 'hotel' && regionElement)
                    ? regionElement.value
                    : this.currentRegion;

                const service = {
                    id: Date.now().toString(),
                    name: name,
                    description: description || name,
                    day: day,
                    price: price,
                    quantity: 1,
                    markup: 0,
                    contractor: contractor,
                    excludeFromMarkup: false,
                    region: region,
                    // Checklist fields
                    done: false,        // Забронировано
                    paid: false,        // Оплачено
                    comment: ''         // Комментарий менеджера
                };

                const errors = this.validateService(service);
                if (errors.length > 0) {
                    this.showNotification(errors.join(', '), true);
                    return;
                }

                // Track global usage (для кастомных услуг без templateId, только общий счетчик)
                this.trackGlobalUsage(null, name, null);

                // Определяем куда добавлять в зависимости от типа (serviceType уже объявлен выше)
                if (serviceType === 'hotel') {
                    this.state.hotels.unshift(service);
                    this.renderHotels();
                    this.showNotification('Отель добавлен');
                } else if (serviceType === 'flight') {
                    this.state.flights.unshift(service);
                    this.renderFlights();
                    this.showNotification('Перелёт добавлен');
                } else if (serviceType === 'other') {
                    this.state.otherServices.unshift(service);
                    this.renderOtherServices();
                    this.showNotification('Прочая услуга добавлена');
                } else if (this.isAddingOptional || serviceType === 'optional') {
                    this.state.optionalServices.unshift(service);
                    this.renderOptionalServices();
                    this.showNotification('Опциональная услуга добавлена');
                    this.isAddingOptional = false;
                } else {
                    // Обычная услуга
                    this.state.services.unshift(service);
                    this.renderServices();
                    this.showNotification('Услуга добавлена');
                }

                this.scheduleUpdate();
                this.markQuoteAsUnsaved();
                this.hideServiceModal();

                // Сбрасываем тип после добавления
                this.state.currentServiceType = 'service';
            }

            // Optional Services Methods
            showOptionalServiceModal() {
                this.isAddingOptional = true;
                this.showServiceModal();
            }

            addOptionalService(service) {
                this.state.optionalServices.unshift(service);
                this.renderOptionalServices();
                this.markQuoteAsUnsaved();
            }

            renderOptionalServices() {
                const container = document.getElementById('optional-services-list');
                if (!container) return;

                if (this.state.optionalServices.length === 0) {
                    container.innerHTML = '<div class="text-xs text-muted" style="padding: calc(var(--spacing) * 4); text-align: center;">Опциональные услуги не добавлены</div>';
                    return;
                }

                container.innerHTML = this.state.optionalServices.map(service => {
                    const activityDate = this.calculateActivityDate(service.day);
                    const serviceTotal = this.calculateServiceTotal(service);
                    const unitPrice = service.price * (1 + service.markup / 100);
                    const totalPrice = unitPrice * service.quantity;

                    return `
                        <div class="service-card" data-optional-service-id="${service.id}" style="border-color: #8b5cf6; background: rgb(139 92 246 / 0.02);">
                            <div class="service-header" style="background: rgb(139 92 246 / 0.05);">
                                <div class="service-header-left">
                                    <div>
                                        <div style="font-size: 14px; font-weight: 600; color: var(--gray-900); line-height: 1.3;">${service.name}</div>
                                        <div style="font-size: 11px; color: var(--gray-500); margin-top: 1px;">День ${service.day}${activityDate ? ' (' + activityDate + ')' : ''}</div>
                                    </div>
                                </div>
                                <div style="display: flex; gap: calc(var(--spacing) * 1); align-items: center;">
                                    <span style="font-size: 10px; color: #6b7280; white-space: nowrap;"><i data-lucide="map-pin" style="width: 9px; height: 9px; display: inline; vertical-align: text-top;"></i> ${service.region || this.currentRegion}</span>
                                    <button class="btn btn-sm btn-primary" onclick="window.QuoteCalc.moveOptionalToMain('${service.id}')" title="Перенести в основную смету" style="font-size: 10px; padding: 4px 8px;">→ В основную</button>
                                    <button class="btn btn-sm remove-service-btn" onclick="window.QuoteCalc.removeOptionalService('${service.id}')" title="Удалить услугу">×</button>
                                </div>
                            </div>
                            <div class="service-content">
                                <div class="form-row" style="margin-bottom: calc(var(--spacing) * 1); flex-wrap: wrap; row-gap: calc(var(--spacing) * 0.75);">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">День:</label>
                                        <input type="number" class="input" value="${service.day}" min="1" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;" onchange="QuoteCalc.updateOptionalServiceField('${service.id}', 'day', parseInt(this.value) || 1)">
                                    </div>

                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Цена:</label>
                                        <input type="number" class="input" value="${service.price}" min="0" style="width: 80px; font-size: 11px; padding: 4px 6px; text-align: center;" onchange="QuoteCalc.updateOptionalServiceField('${service.id}', 'price', parseFloat(this.value) || 0)">
                                    </div>

                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Кол-во:</label>
                                        <input type="number" class="input" value="${service.quantity}" min="1" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;" onchange="QuoteCalc.updateOptionalServiceField('${service.id}', 'quantity', parseInt(this.value) || 1)">
                                    </div>

                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Наценка:</label>
                                        <input type="number" class="input" value="${service.markup}" min="0" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;" onchange="QuoteCalc.updateOptionalServiceField('${service.id}', 'markup', parseFloat(this.value) || 0)">
                                        <span style="font-size: 10px; color: var(--gray-500);">%</span>
                                    </div>
                                </div>

                                ${service.contractor ? `
                                <div class="form-row" style="align-items: flex-start; margin-bottom: calc(var(--spacing) * 1);">
                                    <label style="padding-top: 3px; font-size: 10px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; width: 100px; flex-shrink: 0;">Контрагент:</label>
                                    <div style="flex: 1; min-width: 0; font-size: 12px; color: var(--gray-700); line-height: 1.5;">${service.contractor}</div>
                                </div>
                                ` : ''}

                                <div class="form-row" style="margin-bottom: 0; align-items: center; flex-wrap: wrap; row-gap: calc(var(--spacing) * 1);">
                                    <div style="margin-left: auto; text-align: right; min-width: 80px;">
                                        <div style="font-size: 15px; font-weight: 600; color: var(--success); white-space: nowrap;">
                                            ${this.formatCurrency(totalPrice)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            moveOptionalToMain(serviceId) {
                const service = this.state.optionalServices.find(s => s.id === serviceId);
                if (!service) return;

                // Remove from optional
                this.state.optionalServices = this.state.optionalServices.filter(s => s.id !== serviceId);

                // Add to main services
                this.state.services.unshift(service);

                this.renderServices();
                this.renderOptionalServices();
                this.scheduleUpdate();
                this.markQuoteAsUnsaved();
                this.showNotification('Услуга перенесена в основную смету');
            }

            updateOptionalServiceField(serviceId, field, value) {
                const service = this.state.optionalServices.find(s => s.id === serviceId);
                if (!service) return;

                service[field] = value;
                this.renderOptionalServices();
                this.markQuoteAsUnsaved();
            }

            removeOptionalService(serviceId) {
                if (!confirm('Удалить опциональную услугу?')) return;

                this.state.optionalServices = this.state.optionalServices.filter(s => s.id !== serviceId);
                this.renderOptionalServices();
                this.markQuoteAsUnsaved();
                this.showNotification('Опциональная услуга удалена');
            }

            // Bulk selection methods
            toggleServiceSelection(serviceId) {
                if (this.state.selectedServices.has(serviceId)) {
                    this.state.selectedServices.delete(serviceId);
                } else {
                    this.state.selectedServices.add(serviceId);
                }
                
                // Update visual state and controls efficiently
                const serviceCard = document.querySelector(`[data-service-id="${serviceId}"]`);
                const checkbox = document.querySelector(`input[data-service-id="${serviceId}"]`);
                
                if (serviceCard && checkbox) {
                    const isSelected = this.state.selectedServices.has(serviceId);
                    serviceCard.classList.toggle('selected', isSelected);
                    checkbox.checked = isSelected;
                }
                
                this.debouncedBulkUpdate();
            }

            toggleSelectAll() {
                const allSelected = this.state.selectedServices.size === this.state.services.length && this.state.services.length > 0;
                
                if (allSelected) {
                    this.state.selectedServices.clear();
                } else {
                    this.state.services.forEach(service => {
                        this.state.selectedServices.add(service.id);
                    });
                }
                
                // Update all checkboxes and cards efficiently
                document.querySelectorAll('.service-checkbox').forEach(checkbox => {
                    const serviceId = checkbox.dataset.serviceId;
                    const isSelected = this.state.selectedServices.has(serviceId);
                    checkbox.checked = isSelected;
                    
                    const serviceCard = checkbox.closest('.service-card');
                    if (serviceCard) {
                        serviceCard.classList.toggle('selected', isSelected);
                    }
                });
                
                this.updateBulkControls();
            }

            updateBulkControls() {
                const selectedCount = this.state.selectedServices.size;
                const totalCount = this.state.services.length;
                const container = document.getElementById('bulk-controls-container');

                if (!container) return;

                if (selectedCount > 0) {
                    // Создаем или обновляем bulk controls
                    const selectAllText = selectedCount === totalCount ? 'Снять все' : 'Выбрать все';
                    container.innerHTML = `
                        <div class="bulk-controls" id="bulk-controls">
                            <div class="selection-counter">Выбрано: ${selectedCount} из ${totalCount} услуг</div>
                            <button class="btn btn-sm" onclick="window.QuoteCalc.toggleSelectAll()" id="select-all-btn">${selectAllText}</button>
                            <button class="btn btn-sm btn-warning" onclick="window.QuoteCalc.deleteSelected()" id="delete-selected-btn">Удалить выбранные</button>
                        </div>
                    `;
                } else {
                    // Полностью удаляем из DOM
                    container.innerHTML = '';
                }
            }

            deleteSelected() {
                if (this.state.selectedServices.size === 0) return;

                const selectedCount = this.state.selectedServices.size;
                
                // Add confirmation dialog
                if (!confirm(`Удалить ${selectedCount} услуг? Это действие нельзя отменить.`)) {
                    return;
                }

                this.state.services = this.state.services.filter(service =>
                    !this.state.selectedServices.has(service.id)
                );

                this.state.selectedServices.clear();
                this.renderServices();
                this.updateBulkControls();
                this.scheduleUpdate();
                this.markQuoteAsUnsaved();

                this.showNotification(`Удалено ${selectedCount} услуг`);
            }

            renderServices() {
                const container = document.getElementById('services-list');
                if (!container) return;

                // ===== VIEW MODE CHECK - Проверка режима отображения =====
                // Если выбран табличный режим - используем renderServicesTable()
                if (this.state.servicesViewMode === 'table') {
                    this.renderServicesTable();
                    return;
                }

                // ===== CARDS MODE - Режим карточек (по умолчанию) =====
                // Проверяем режим сортировки
                const sortBy = this.state.servicesSortBy || 'order';

                // Если сортировка НЕ по дням и НЕ по регионам, показываем услуги без группировки
                if (sortBy !== 'day' && sortBy !== 'region') {
                    this.renderServicesFlat();
                    return;
                }

                // Группируем услуги по дням
                const servicesByDay = {};
                this.state.services.forEach(service => {
                    const day = service.day || 1;
                    if (!servicesByDay[day]) {
                        servicesByDay[day] = [];
                    }
                    servicesByDay[day].push(service);
                });

                // Сортируем дни
                const sortedDays = Object.keys(servicesByDay).map(d => parseInt(d)).sort((a, b) => a - b);

                // Рендерим услуги по дням с разделителями
                const html = sortedDays.map(day => {
                    const servicesInDay = servicesByDay[day];

                    // Собираем уникальные регионы для этого дня
                    const regions = [...new Set(servicesInDay.map(s => s.region || this.currentRegion))];
                    const regionText = regions.join(', ');

                    // Получаем дату для первой услуги дня (все услуги дня имеют одинаковую дату)
                    const activityDate = this.calculateActivityDate(day);
                    const dateText = activityDate ? ` (${activityDate})` : '';

                    // Разделитель дня - современный минималистичный стиль
                    const daySeparator = `
                        <div style="
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            margin: 24px 0 16px 0;
                        ">
                            <div style="
                                flex: 0 0 auto;
                                font-size: 13px;
                                font-weight: 600;
                                color: #0f172a;
                                letter-spacing: -0.01em;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            ">День ${day}${dateText}</div>
                            <div style="
                                flex: 1;
                                height: 1px;
                                background: linear-gradient(90deg, #e2e8f0 0%, transparent 100%);
                            "></div>
                            <div style="
                                flex: 0 0 auto;
                                font-size: 10px;
                                font-weight: 600;
                                color: #64748b;
                                background: #f8fafc;
                                padding: 3px 10px;
                                border-radius: 12px;
                                text-transform: uppercase;
                                letter-spacing: 0.05em;
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                            ">${regionText}</div>
                        </div>
                    `;

                    // Услуги этого дня
                    const servicesHtml = servicesInDay.map(service => {
                        const isSelected = this.state.selectedServices.has(service.id);
                        const isExcluded = service.excludeFromMarkup;
                        const isFullProfit = service.fullProfit;
                        const classes = [];
                        if (isSelected) classes.push('selected');
                        if (isExcluded) {
                            classes.push('excluded');
                        }
                        if (isFullProfit) {
                            classes.push('full-profit');
                        }

                        return `
                            <div class="service-card ${classes.join(' ')}" data-service-id="${service.id}">
                                <div class="service-header">
                                    <div class="service-header-left">
                                        <input type="checkbox" class="checkbox service-checkbox" ${isSelected ? 'checked' : ''}
                                               data-service-id="${service.id}"
                                               title="Выбрать для пакетных операций">
                                        <div>
                                            <div class="editable" contenteditable="true" data-field="name" data-id="${service.id}" style="font-size: 14px; font-weight: 600; color: var(--gray-900); line-height: 1.3;">${service.name}</div>
                                            <div style="font-size: 11px; color: var(--gray-500); margin-top: 1px; display: flex; align-items: center; gap: 4px;">
                                                <i data-lucide="map-pin" style="width: 10px; height: 10px; display: inline; vertical-align: text-top;"></i>
                                                <select class="service-region-select" data-service-id="${service.id}" style="font-size: 11px; border: none; background: transparent; color: var(--gray-500); padding: 0; cursor: pointer;" title="Изменить регион">
                                                    ${this.regions.map(region => `<option value="${region}" ${service.region === region ? 'selected' : ''}>${region}</option>`).join('')}
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <!-- Статусы бронирования и оплаты -->
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <button
                                                class="status-icon-btn booking-status-btn"
                                                data-service-id="${service.id}"
                                                data-status="${service.done ? 'booked' : 'none'}"
                                                title="Статус бронирования: ${service.done ? 'Забронировано' : 'Не забронировано'}"
                                                style="border: none; background: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s; color: ${service.done ? '#10b981' : '#9ca3af'};">
                                                <i data-lucide="${service.done ? 'check-circle' : 'circle'}" style="width: 18px; height: 18px;"></i>
                                            </button>
                                            <button
                                                class="status-icon-btn payment-status-btn"
                                                data-service-id="${service.id}"
                                                data-status="${service.paid ? 'paid' : 'none'}"
                                                title="Статус оплаты: ${service.paid ? 'Оплачено' : 'Не оплачено'}"
                                                style="border: none; background: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s; color: ${service.paid ? '#10b981' : '#9ca3af'};">
                                                <i data-lucide="${service.paid ? 'circle-dollar-sign' : 'dollar-sign'}" style="width: 18px; height: 18px;"></i>
                                            </button>
                                        </div>
                                        <button class="btn btn-sm duplicate-service-btn" data-service-id="${service.id}" title="Дублировать услугу" style="padding: 4px 8px; font-size: 12px; background: transparent; color: #9ca3af; border: 1px solid #e5e7eb; margin-right: 4px; transition: all 0.2s;">
                                            <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                                        </button>
                                        <button class="btn btn-sm remove-service-btn" data-service-id="${service.id}" title="Удалить услугу">×</button>
                                    </div>
                                </div>
                                <div class="service-content">
                                    <div class="form-row" style="align-items: flex-start; margin-bottom: calc(var(--spacing) * 1);">
                                        <label style="padding-top: 3px; font-size: 10px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; width: 100px; flex-shrink: 0;">Описание:</label>
                                        <div class="editable" contenteditable="true" data-field="description" data-id="${service.id}" style="flex: 1; min-width: 0; font-size: 12px; color: var(--gray-700); line-height: 1.5;">${service.description}</div>
                                    </div>

                                    <div class="form-row" style="align-items: flex-start; margin-bottom: calc(var(--spacing) * 1);">
                                        <label style="padding-top: 3px; font-size: 10px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; width: 100px; flex-shrink: 0;">Контрагент:</label>
                                        <div class="editable" contenteditable="true" data-field="contractor" data-id="${service.id}" style="flex: 1; min-width: 0; font-size: 12px; color: var(--gray-700); line-height: 1.5;">${service.contractor || ''}</div>
                                    </div>

                                    <div class="form-row" style="margin-bottom: calc(var(--spacing) * 1); flex-wrap: wrap; row-gap: calc(var(--spacing) * 0.75);">
                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">День:</label>
                                            <input type="number" class="input service-field" data-field="day" data-service-id="${service.id}" value="${service.day}" min="1" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;">
                                        </div>

                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Цена:</label>
                                            <input type="number" class="input service-field" data-field="price" data-service-id="${service.id}" value="${service.price}" min="0" style="width: 80px; font-size: 11px; padding: 4px 6px; text-align: center;">
                                        </div>

                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Кол-во:</label>
                                            <div class="qty-control">
                                                <button class="qty-btn qty-decrease" data-service-id="${service.id}">−</button>
                                                <input type="number" class="qty-input service-field" data-field="quantity" data-service-id="${service.id}" value="${service.quantity}" min="1">
                                                <button class="qty-btn qty-increase" data-service-id="${service.id}">+</button>
                                            </div>
                                        </div>

                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Наценка:</label>
                                            <input type="number" class="input service-field" data-field="markup" data-service-id="${service.id}" value="${service.markup}" min="0" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;">
                                            <span style="font-size: 10px; color: var(--gray-500);">%</span>
                                        </div>
                                    </div>

                                    <!-- Время начала/окончания (под катом) -->
                                    <div style="border-top: 1px solid #f3f4f6; padding-top: calc(var(--spacing) * 0.5);">
                                        <button
                                            class="btn btn-sm timing-toggle-btn"
                                            data-service-id="${service.id}"
                                            style="font-size: 9px; padding: 2px 6px; background: #f9fafb; color: #6b7280; border: none; width: 100%; text-align: left; display: flex; align-items: center; gap: 4px;"
                                            title="Показать время начала/окончания">
                                            <span class="timing-toggle-icon" style="font-size: 8px;">▶</span>
                                            <span>⏰ Тайминг</span>
                                            ${service.startTime || service.endTime ? `<span style="font-size: 8px; color: #3b82f6;">●</span>` : ''}
                                        </button>
                                        <div class="timing-content" id="timing-${service.id}" style="max-height: 0; overflow: hidden; transition: max-height 0.3s ease;">
                                            <div style="padding: calc(var(--spacing) * 0.75) 0; display: flex; flex-wrap: wrap; gap: calc(var(--spacing) * 0.75);">
                                                <div style="display: flex; align-items: center; gap: 6px;">
                                                    <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">⏰ Начало:</label>
                                                    <input type="time" class="input service-field" data-field="startTime" data-service-id="${service.id}" value="${service.startTime || ''}" style="width: 90px; font-size: 11px; padding: 4px 6px;">
                                                </div>

                                                <div style="display: flex; align-items: center; gap: 6px;">
                                                    <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Окончание:</label>
                                                    <input type="time" class="input service-field" data-field="endTime" data-service-id="${service.id}" value="${service.endTime || ''}" style="width: 90px; font-size: 11px; padding: 4px 6px;">
                                                </div>

                                                <div style="display: flex; align-items: center; gap: 6px;">
                                                    <span style="font-size: 10px; color: var(--gray-500);">Длительность:</span>
                                                    <span style="font-size: 11px; font-weight: 500; color: var(--gray-700);" id="duration-${service.id}">
                                                        ${this.calculateDuration(service.startTime, service.endTime)}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-row" style="margin-bottom: 0; align-items: center; flex-wrap: wrap; row-gap: calc(var(--spacing) * 1);">
                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--gray-600); white-space: nowrap;">
                                            <input type="checkbox" class="checkbox service-move-to-other-checkbox" data-service-id="${service.id}" title="Переместить в секцию Прочие услуги">
                                            <span>📋 Прочее</span>
                                        </label>

                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--gray-600); white-space: nowrap;">
                                            <input type="checkbox" class="checkbox service-exclude-checkbox" data-service-id="${service.id}" ${service.excludeFromMarkup ? 'checked' : ''} title="Выключить наценку для этой услуги">
                                            <span>Выключить наценку</span>
                                        </label>

                                        <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--gray-600); white-space: nowrap;">
                                            <input type="checkbox" class="checkbox service-full-profit-checkbox" data-service-id="${service.id}" ${service.fullProfit ? 'checked' : ''} title="Вся сумма в прибыль (себестоимость = 0)">
                                            <span>💰 Вся сумма в прибыль</span>
                                        </label>

                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 10px; color: var(--gray-600); white-space: nowrap;">💳 Предоплата:</label>
                                            <input type="number" class="input service-field" data-field="prepayment" data-service-id="${service.id}" value="${service.prepayment || 0}" min="0" step="0.01" style="width: 90px; font-size: 11px; padding: 4px 6px;" title="Размер требуемой предоплаты">
                                        </div>

                                        <div style="display: flex; align-items: center; gap: 6px;">
                                            <label style="font-size: 10px; color: var(--gray-600); white-space: nowrap;">📅 Срок предоплаты:</label>
                                            <input type="date" class="input service-field" data-field="prepaymentDeadline" data-service-id="${service.id}" value="${service.prepaymentDeadline || ''}" style="width: 130px; font-size: 11px; padding: 4px 6px;" title="Крайняя дата внесения предоплаты">
                                        </div>

                                        <div style="margin-left: auto; text-align: right; min-width: 80px;">
                                            <div style="font-size: 15px; font-weight: 600; color: var(--success); white-space: nowrap;">
                                                ${this.formatCurrency(this.calculateServiceTotal(service))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');

                    return daySeparator + servicesHtml;
                }).join('');

                container.innerHTML = html;

                // Bind events with delegation
                this.bindServiceEvents();

                // Update bulk controls
                this.updateBulkControls();

                // Update filters visibility
                this.updateFiltersVisibility();

                // Debounced detail list rendering for better performance
                this.debouncedRenderDetail();

                // Инициализация Lucide иконок
                lucide.createIcons();
            }

            renderServicesFlat() {
                const container = document.getElementById('services-list');
                if (!container) return;

                container.innerHTML = this.state.services.map(service => {
                    const isSelected = this.state.selectedServices.has(service.id);
                    const isExcluded = service.excludeFromMarkup;
                    const isFullProfit = service.fullProfit;
                    const classes = [];
                    if (isSelected) classes.push('selected');
                    if (isExcluded) {
                        classes.push('excluded');
                    }
                    if (isFullProfit) {
                        classes.push('full-profit');
                    }

                    const activityDate = this.calculateActivityDate(service.day);

                    return `
                        <div class="service-card ${classes.join(' ')}" data-service-id="${service.id}">
                            <div class="service-header">
                                <div class="service-header-left">
                                    <input type="checkbox" class="checkbox service-checkbox" ${isSelected ? 'checked' : ''}
                                           data-service-id="${service.id}"
                                           title="Выбрать для пакетных операций">
                                    <div>
                                        <div class="editable" contenteditable="true" data-field="name" data-id="${service.id}" style="font-size: 14px; font-weight: 600; color: var(--gray-900); line-height: 1.3;">${service.name}</div>
                                        <div style="font-size: 11px; color: var(--gray-500); margin-top: 1px; display: flex; align-items: center; gap: 4px;">
                                            День ${service.day}${activityDate ? ' (' + activityDate + ')' : ''} ·
                                            <i data-lucide="map-pin" style="width: 10px; height: 10px; display: inline; vertical-align: text-top;"></i>
                                            <select class="service-region-select" data-service-id="${service.id}" style="font-size: 11px; border: none; background: transparent; color: var(--gray-500); padding: 0; cursor: pointer;" title="Изменить регион">
                                                ${this.regions.map(region => `<option value="${region}" ${service.region === region ? 'selected' : ''}>${region}</option>`).join('')}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <button class="btn btn-sm remove-service-btn" data-service-id="${service.id}" title="Удалить услугу">×</button>
                                </div>
                            </div>
                            <div class="service-content">
                                <div class="form-row" style="align-items: flex-start; margin-bottom: calc(var(--spacing) * 1);">
                                    <label style="padding-top: 3px; font-size: 10px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; width: 100px; flex-shrink: 0;">Описание:</label>
                                    <div class="editable" contenteditable="true" data-field="description" data-id="${service.id}" style="flex: 1; min-width: 0; font-size: 12px; color: var(--gray-700); line-height: 1.5;">${service.description}</div>
                                </div>

                                <div class="form-row" style="align-items: flex-start; margin-bottom: calc(var(--spacing) * 1);">
                                    <label style="padding-top: 3px; font-size: 10px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.3px; width: 100px; flex-shrink: 0;">Контрагент:</label>
                                    <div class="editable" contenteditable="true" data-field="contractor" data-id="${service.id}" style="flex: 1; min-width: 0; font-size: 12px; color: var(--gray-700); line-height: 1.5;">${service.contractor || ''}</div>
                                </div>

                                <div class="form-row" style="margin-bottom: calc(var(--spacing) * 1); flex-wrap: wrap; row-gap: calc(var(--spacing) * 0.75);">
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">День:</label>
                                        <input type="number" class="input service-field" data-field="day" data-service-id="${service.id}" value="${service.day}" min="1" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;">
                                    </div>

                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Цена:</label>
                                        <input type="number" class="input service-field" data-field="price" data-service-id="${service.id}" value="${service.price}" min="0" style="width: 80px; font-size: 11px; padding: 4px 6px; text-align: center;">
                                    </div>

                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Кол-во:</label>
                                        <div class="qty-control">
                                            <button class="qty-btn qty-decrease" data-service-id="${service.id}">−</button>
                                            <input type="number" class="qty-input service-field" data-field="quantity" data-service-id="${service.id}" value="${service.quantity}" min="1">
                                            <button class="qty-btn qty-increase" data-service-id="${service.id}">+</button>
                                        </div>
                                    </div>

                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <label style="font-size: 10px; color: var(--gray-500); white-space: nowrap;">Наценка:</label>
                                        <input type="number" class="input service-field" data-field="markup" data-service-id="${service.id}" value="${service.markup}" min="0" style="width: 50px; font-size: 11px; padding: 4px 6px; text-align: center;">
                                        <span style="font-size: 10px; color: var(--gray-500);">%</span>
                                    </div>
                                </div>

                                <div class="form-row" style="margin-bottom: 0; align-items: center; flex-wrap: wrap; row-gap: calc(var(--spacing) * 1);">
                                    <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--gray-600); white-space: nowrap;">
                                        <input type="checkbox" class="checkbox service-exclude-checkbox" data-service-id="${service.id}" ${service.excludeFromMarkup ? 'checked' : ''} title="Выключить наценку для этой услуги">
                                        <span>Выключить наценку</span>
                                    </label>

                                    <label style="display: flex; align-items: center; gap: 6px; font-size: 10px; color: var(--gray-600); white-space: nowrap;">
                                        <input type="checkbox" class="checkbox service-full-profit-checkbox" data-service-id="${service.id}" ${service.fullProfit ? 'checked' : ''} title="Вся сумма в прибыль (себестоимость = 0)">
                                        <span>💰 Вся сумма в прибыль</span>
                                    </label>

                                    <div style="margin-left: auto; text-align: right; min-width: 80px;">
                                        <div style="font-size: 15px; font-weight: 600; color: var(--success); white-space: nowrap;">
                                            ${this.formatCurrency(this.calculateServiceTotal(service))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

                // Bind events with delegation
                this.bindServiceEvents();

                // Update bulk controls
                this.updateBulkControls();

                // Update filters visibility
                this.updateFiltersVisibility();

                // Debounced detail list rendering for better performance
                this.debouncedRenderDetail();

                // Инициализация Lucide иконок
                lucide.createIcons();
            }

            // ===== TABLE VIEW MODE - Табличный режим отображения =====
            // Компактный табличный вид для быстрого просмотра всех услуг без прокрутки
            renderServicesTable() {
                const container = document.getElementById('services-list');
                if (!container) return;

                if (this.state.services.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;">Нет добавленных услуг</div>';
                    return;
                }

                const sortBy = this.state.servicesSortBy || 'order';

                // Группируем услуги в зависимости от типа сортировки
                let groupedServices = {};
                let groupKey = '';

                if (sortBy === 'day') {
                    // Группировка по дням
                    this.state.services.forEach(service => {
                        const day = service.day || 1;
                        const activityDate = this.calculateActivityDate(day);
                        const key = `День ${day}${activityDate ? ' (' + activityDate + ')' : ''}`;
                        if (!groupedServices[key]) {
                            groupedServices[key] = [];
                        }
                        groupedServices[key].push(service);
                    });
                } else if (sortBy === 'region') {
                    // Группировка по регионам (заглавными буквами)
                    this.state.services.forEach(service => {
                        const region = (service.region || this.currentRegion || 'Без региона').toUpperCase();
                        const key = region;
                        if (!groupedServices[key]) {
                            groupedServices[key] = [];
                        }
                        groupedServices[key].push(service);
                    });
                } else if (sortBy === 'contractor') {
                    // Группировка по поставщикам
                    this.state.services.forEach(service => {
                        const contractor = service.contractor || 'Без поставщика';
                        const key = `🏢 ${contractor}`;
                        if (!groupedServices[key]) {
                            groupedServices[key] = [];
                        }
                        groupedServices[key].push(service);
                    });
                } else {
                    // Без группировки (сортировка по порядку)
                    groupedServices['Все услуги'] = this.state.services;
                }

                // Создаем HTML для каждой группы
                let tablesHTML = '';

                Object.keys(groupedServices).forEach(groupName => {
                    const services = groupedServices[groupName];

                    tablesHTML += `
                        <div style="margin-bottom: 32px;">
                            ${sortBy !== 'order' ? `
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div style="flex: 0 0 auto; font-size: 13px; font-weight: 600; color: #0f172a; letter-spacing: -0.01em; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">${groupName}</div>
                                    <div style="flex: 1; height: 1px; background: linear-gradient(90deg, #e2e8f0 0%, transparent 100%);"></div>
                                    <div style="flex: 0 0 auto; font-size: 11px; font-weight: 600; color: #64748b; background: #f8fafc; padding: 3px 10px; border-radius: 12px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;">${services.length}</div>
                                </div>
                            ` : ''}

                            <table class="services-table-view">
                                <thead>
                                    <tr>
                                        <th class="col-name">Услуга</th>
                                        <th class="col-contractor">Подрядчик</th>
                                        <th class="col-day">День</th>
                                        <th class="col-qty">Кол-во</th>
                                        <th class="col-total">Итого</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${services.map(service => {
                                        const total = this.calculateServiceTotal(service);

                                        return `
                                            <tr data-service-id="${service.id}">
                                                <td class="col-name" title="${this.escapeHtml(service.description || '')}">
                                                    ${this.escapeHtml(service.name)}
                                                </td>
                                                <td class="col-contractor" title="${this.escapeHtml(service.contractor || '')}">
                                                    <span style="color: #64748b; font-size: 10px;">${this.escapeHtml(service.contractor || '—')}</span>
                                                </td>
                                                <td class="col-day">
                                                    <input type="number"
                                                           class="table-input service-field"
                                                           data-field="day"
                                                           data-service-id="${service.id}"
                                                           value="${service.day}"
                                                           min="1">
                                                </td>
                                                <td class="col-qty">
                                                    ${service.quantity}
                                                </td>
                                                <td class="col-total">
                                                    <strong>${this.formatCurrency(total)}</strong>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                });

                container.innerHTML = tablesHTML;

                // Bind events with delegation (только для редактирования дня)
                this.bindServiceEvents();

                // Update filters visibility
                this.updateFiltersVisibility();

                // Debounced detail list rendering for better performance
                this.debouncedRenderDetail();

                // Инициализация Lucide иконок
                lucide.createIcons();
            }

            // Improved event binding with delegation
            bindServiceEvents() {
                const container = document.getElementById('services-list');
                if (!container) return;

                // Remove old listeners to prevent duplicates
                if (this.handleServiceChange) {
                    container.removeEventListener('change', this.handleServiceChange);
                    container.removeEventListener('click', this.handleServiceClick);
                }

                // Bind new listeners
                this.handleServiceChange = (e) => {
                    if (e.target.classList.contains('service-checkbox')) {
                        this.toggleServiceSelection(e.target.dataset.serviceId);
                    } else if (e.target.classList.contains('service-region-select')) {
                        this.updateServiceRegion(e.target.dataset.serviceId, e.target.value);
                    } else if (e.target.classList.contains('service-move-to-other-checkbox')) {
                        this.moveServiceToOther(e.target.dataset.serviceId, e.target.checked);
                    } else if (e.target.classList.contains('service-exclude-checkbox')) {
                        this.toggleServiceExclusion(e.target.dataset.serviceId);
                    } else if (e.target.classList.contains('service-full-profit-checkbox')) {
                        this.toggleServiceFullProfit(e.target.dataset.serviceId);
                    } else if (e.target.classList.contains('service-field')) {
                        const field = e.target.dataset.field;
                        const serviceId = e.target.dataset.serviceId;
                        this.updateServiceField(serviceId, field, e.target.value);
                    } else {
                        console.log('No matching class found for:', e.target.classList);
                    }
                };

                this.handleServiceClick = (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    if (target.classList.contains('remove-service-btn')) {
                        this.removeService(target.dataset.serviceId);
                    } else if (target.classList.contains('qty-decrease')) {
                        this.changeQuantity(target.dataset.serviceId, -1);
                    } else if (target.classList.contains('qty-increase')) {
                        this.changeQuantity(target.dataset.serviceId, 1);
                    } else if (target.classList.contains('booking-status-btn')) {
                        this.toggleBookingStatus(target.dataset.serviceId);
                    } else if (target.classList.contains('payment-status-btn')) {
                        this.togglePaymentStatus(target.dataset.serviceId);
                    } else if (target.classList.contains('timing-toggle-btn')) {
                        this.toggleServiceTiming(target.dataset.serviceId);
                    } else if (target.classList.contains('duplicate-service-btn')) {
                        this.duplicateService(target.dataset.serviceId);
                    }
                };

                container.addEventListener('change', this.handleServiceChange);
                container.addEventListener('click', this.handleServiceClick);

                // Bind editable events
                container.querySelectorAll('.editable').forEach(el => {
                    el.addEventListener('blur', (e) => this.handleEdit(e.target));
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            e.target.blur();
                        }
                    });
                });
            }

            renderServicesDetailList() {
                const container = document.getElementById('services-detail-list');

                if (this.state.services.length === 0) {
                    container.innerHTML = '<div class="text-xs text-muted">Услуги не добавлены</div>';
                    return;
                }

                container.innerHTML = this.state.services.map(service => {
                    const activityDate = this.calculateActivityDate(service.day);
                    return `
                        <div class="service-detail-item">
                            <div class="service-detail-name">${service.name}</div>
                            <div class="service-detail-info">
                                <span>День ${service.day}${activityDate ? ' (' + activityDate + ')' : ''}</span>
                                <span>×${service.quantity}</span>
                                <span>${this.formatCurrency(this.calculateServiceTotal(service))}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            calculateServiceTotal(service) {
                const baseTotal = service.price * service.quantity;
                const withMarkup = baseTotal * (1 + service.markup / 100);
                return withMarkup;
            }

            calculateDuration(startTime, endTime) {
                if (!startTime || !endTime) {
                    return '—';
                }

                try {
                    const [startHours, startMinutes] = startTime.split(':').map(Number);
                    const [endHours, endMinutes] = endTime.split(':').map(Number);

                    const startTotalMinutes = startHours * 60 + startMinutes;
                    const endTotalMinutes = endHours * 60 + endMinutes;

                    let durationMinutes = endTotalMinutes - startTotalMinutes;

                    // Handle overnight services
                    if (durationMinutes < 0) {
                        durationMinutes += 24 * 60;
                    }

                    const hours = Math.floor(durationMinutes / 60);
                    const minutes = durationMinutes % 60;

                    if (hours === 0) {
                        return `${minutes} мин`;
                    } else if (minutes === 0) {
                        return `${hours} ч`;
                    } else {
                        return `${hours} ч ${minutes} мин`;
                    }
                } catch (e) {
                    return '—';
                }
            }

            handleEdit(element) {
                const field = element.dataset.field;
                const serviceId = element.dataset.id;
                const value = element.textContent.trim();

                if (!serviceId) return;

                const service = this.state.services.find(s => s.id === serviceId);
                if (!service) return;

                service[field] = value;
                
                // Validate change
                const errors = this.validateService(service);
                if (errors.length > 0) {
                    this.showNotification(errors[0], true);
                    element.classList.add('error');
                } else {
                    element.classList.remove('error');
                }
                
                this.scheduleUpdate();
            }

            updateServiceRegion(serviceId, newRegion) {
                const service = this.state.services.find(s => s.id === serviceId);
                if (!service) {
                    this.showNotification('Услуга не найдена', true);
                    return;
                }

                const oldRegion = service.region;
                service.region = newRegion;

                this.renderServices();
                this.scheduleUpdate();
                this.markQuoteAsUnsaved();

                this.showNotification(`Регион изменен: ${oldRegion} → ${newRegion}`);
            }

            updateServiceField(serviceId, field, value) {
                console.log(`[CHECKLIST] updateServiceField called: ${field}, value: ${value}, serviceId: ${serviceId}`);
                const service = this.state.services.find(s => s.id === serviceId);
                if (!service) return;

                if (field === 'day' || field === 'quantity') {
                    service[field] = Math.max(1, parseInt(value) || 1);
                } else if (field === 'price' || field === 'markup') {
                    service[field] = Math.max(0, parseFloat(value) || 0);
                } else {
                    service[field] = value;
                }

                // Update duration display if time fields changed
                // НЕ перерисовываем для полей времени - только обновляем duration
                if (field === 'startTime' || field === 'endTime') {
                    console.log(`[CHECKLIST] Time field detected - updating duration ONLY, NO RERENDER`);
                    const durationElement = document.getElementById(`duration-${serviceId}`);
                    if (durationElement) {
                        durationElement.textContent = this.calculateDuration(service.startTime, service.endTime);
                        console.log(`[CHECKLIST] Duration updated to: ${durationElement.textContent}`);
                    }
                    // Только обновляем расчёты, НЕ перерисовываем
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();
                    console.log(`[CHECKLIST] Time field change complete - NO RERENDER called`);
                    return; // ВАЖНО: ранний выход, не вызываем renderServices()
                }

                // Validate
                const errors = this.validateService(service);
                if (errors.length > 0) {
                    this.showNotification(errors[0], true);
                }

                console.log(`[CHECKLIST] Non-time field - calling RERENDER`);
                this.renderServices();
                this.scheduleUpdate();
                this.markQuoteAsUnsaved();
            }

            changeQuantity(serviceId, delta) {
                const service = this.state.services.find(s => s.id === serviceId);
                if (service) {
                    service.quantity = Math.max(1, service.quantity + delta);
                    this.renderServices();
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();
                }
            }

            toggleServiceNoDayAssignment(serviceId) {
                const service = this.state.services.find(s => s.id === serviceId);

                if (service) {
                    service.noDayAssignment = !service.noDayAssignment;

                    this.renderServices();
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();

                    const message = service.noDayAssignment ?
                        '📌 Услуга не привязана к дням (перелеты, визы, etc.)' :
                        'Услуга привязана к дням';
                    this.showNotification(message);
                }
            }

            toggleServiceExclusion(serviceId) {
                const service = this.state.services.find(s => s.id === serviceId);

                if (service) {
                    service.excludeFromMarkup = !service.excludeFromMarkup;

                    this.renderServices();
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();

                    const message = service.excludeFromMarkup ?
                        'Услуга исключена из общей прибыли' :
                        'Услуга включена в общую прибыль';
                    this.showNotification(message);
                } else {
                    console.error('Service not found with id:', serviceId);
                }
            }

            toggleServiceFullProfit(serviceId) {
                const service = this.state.services.find(s => s.id === serviceId);

                if (service) {
                    service.fullProfit = !service.fullProfit;

                    this.renderServices();
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();

                    const message = service.fullProfit ?
                        'Вся сумма услуги идет в прибыль (себестоимость = 0)' :
                        'Услуга в обычном режиме расчета';
                    this.showNotification(message);
                } else {
                    console.error('Service not found with id:', serviceId);
                }
            }

            moveServiceToOther(serviceId, isChecked) {
                if (!isChecked) {
                    // Чекбокс снят - ничего не делаем (нельзя вернуть обратно)
                    this.showNotification('Используйте перетаскивание для возврата услуги', true);
                    return;
                }

                const service = this.state.services.find(s => s.id === serviceId);

                if (service) {
                    // Удаляем из основных услуг
                    this.state.services = this.state.services.filter(s => s.id !== serviceId);

                    // Удаляем из выбранных если была выбрана
                    this.state.selectedServices.delete(serviceId);

                    // Добавляем в прочие услуги
                    this.state.otherServices.unshift(service);

                    // Перерендериваем обе секции
                    this.renderServices();
                    this.renderOtherServices();
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();

                    this.showNotification(`Услуга "${service.name}" перемещена в Прочие`);
                } else {
                    console.error('Service not found with id:', serviceId);
                }
            }

            toggleBookingStatus(serviceId) {
                const service = this.state.services.find(s => s.id === serviceId);

                if (service) {
                    service.done = !service.done;

                    this.renderServices();
                    this.renderChecklist(); // Синхронизируем с чеклистом
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();

                    const message = service.done ?
                        '✅ Услуга забронирована' :
                        '⬜ Бронирование отменено';
                    this.showNotification(message);
                }
            }

            togglePaymentStatus(serviceId) {
                const service = this.state.services.find(s => s.id === serviceId);

                if (service) {
                    service.paid = !service.paid;

                    this.renderServices();
                    this.renderChecklist(); // Синхронизируем с чеклистом
                    this.scheduleUpdate();
                    this.markQuoteAsUnsaved();

                    const message = service.paid ?
                        '💵 Услуга оплачена' :
                        '💰 Оплата не подтверждена';
                    this.showNotification(message);
                }
            }

            toggleServiceTiming(serviceId) {
                const content = document.getElementById(`timing-${serviceId}`);
                const btn = document.querySelector(`.timing-toggle-btn[data-service-id="${serviceId}"]`);
                const icon = btn?.querySelector('.timing-toggle-icon');

                if (!content) return;

                const isExpanded = content.style.maxHeight && content.style.maxHeight !== '0px';

                if (isExpanded) {
                    content.style.maxHeight = '0';
                    if (icon) icon.textContent = '▶';
                } else {
                    content.style.maxHeight = content.scrollHeight + 'px';
                    if (icon) icon.textContent = '▼';
                }
            }

            removeService(serviceId) {
                // Fixed: Add cleanup for selectedServices
                this.state.services = this.state.services.filter(s => s.id !== serviceId);
                this.state.selectedServices.delete(serviceId); // Clean up selection
                this.renderServices();
                this.scheduleUpdate();
                this.markQuoteAsUnsaved();
                this.showNotification('Услуга удалена');
            }

            duplicateService(serviceId) {
                const serviceIndex = this.state.services.findIndex(s => s.id === serviceId);

                if (serviceIndex === -1) {
                    this.showNotification('Услуга не найдена', true);
                    return;
                }

                const originalService = this.state.services[serviceIndex];

                // Создать глубокую копию с новым ID
                const duplicatedService = {
                    ...originalService,
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    // Копируем все поля включая новые
                    done: originalService.done || false,
                    paid: originalService.paid || false,
                    startTime: originalService.startTime || '',
                    endTime: originalService.endTime || '',
                    noDayAssignment: originalService.noDayAssignment || false
                };

                // Вставить дублированную услугу сразу после оригинала
                this.state.services.splice(serviceIndex + 1, 0, duplicatedService);

                this.renderServices();
                this.scheduleUpdate();
                this.markQuoteAsUnsaved();
                this.showNotification('📋 Услуга продублирована');
            }

            updateCalculations() {
                // Базовая стоимость услуг (себестоимость)
                let baseCost = 0;
                let baseCostForHiddenMarkup = 0; // Базовая стоимость для общей наценки (исключая отмеченные услуги)
                let totalWithIndividualMarkup = 0;
                let individualMarkupAmount = 0;
                let fullProfitAmount = 0; // Сумма от услуг "вся сумма в прибыль"

                // Объединяем все массивы услуг для расчёта
                const allServices = [
                    ...(this.state.services || []),
                    ...(this.state.hotels || []),
                    ...(this.state.flights || []),
                    ...(this.state.otherServices || [])
                ];

                allServices.forEach(service => {
                    const serviceCost = service.price * service.quantity;
                    const serviceWithMarkup = this.calculateServiceTotal(service);
                    const serviceMarkupAmount = serviceWithMarkup - serviceCost;

                    // Если "вся сумма в прибыль" - вся сумма идёт в прибыль, но участвует в расчёте комиссии
                    if (service.fullProfit) {
                        fullProfitAmount += serviceWithMarkup;
                        totalWithIndividualMarkup += serviceWithMarkup;
                        baseCost += serviceWithMarkup; // Добавляем в baseCost для расчёта комиссии партнера
                    } else {
                        baseCost += serviceCost;
                        totalWithIndividualMarkup += serviceWithMarkup;
                        individualMarkupAmount += serviceMarkupAmount; // Всегда добавляем индивидуальные наценки

                        // Добавляем в базу для общей наценки только если услуга НЕ исключена
                        if (!service.excludeFromMarkup) {
                            baseCostForHiddenMarkup += serviceCost;
                        }
                    }
                });

                // Скрытая маржа применяется только к неисключенным услугам
                const hiddenMarkupAmount = baseCostForHiddenMarkup * (this.state.hiddenMarkup / 100);

                // Комиссия партнера рассчитывается от СЕБЕСТОИМОСТИ
                const partnerCommissionAmount = baseCost * (this.state.partnerCommission / 100);

                // Сумма после добавления скрытой маржи и комиссии партнера
                const totalWithHiddenMarkup = totalWithIndividualMarkup + hiddenMarkupAmount + partnerCommissionAmount;

                // Итого для клиента (без НДС)
                const clientTotal = totalWithHiddenMarkup;

                // Общая прибыль = индивидуальные наценки + скрытая маржа + услуги "вся сумма в прибыль"
                const totalProfit = individualMarkupAmount + hiddenMarkupAmount + fullProfitAmount;


                // Visual feedback for updates
                const grandTotal = document.getElementById('grand-total');
                if (grandTotal) {
                    grandTotal.classList.add('updating');
                    setTimeout(() => grandTotal.classList.remove('updating'), 300);
                }

                // Update individual calculation blocks with null checks
                const costPrice = document.getElementById('cost-price');
                if (costPrice) {
                    costPrice.textContent = this.formatCurrency(baseCost);
                }

                // Individual markup info
                const individualInfo = document.getElementById('individual-markup-info');
                const individualAmount = document.getElementById('individual-markup-amount');
                const totalWithMarkupElement = document.getElementById('total-with-markup');
                if (individualInfo && individualAmount && totalWithMarkupElement) {
                    if (individualMarkupAmount > 0) {
                        individualInfo.style.display = 'block';
                        individualAmount.textContent = this.formatCurrency(individualMarkupAmount);
                        totalWithMarkupElement.textContent = this.formatCurrency(totalWithIndividualMarkup);
                    } else {
                        individualInfo.style.display = 'none';
                    }
                }

                // Hidden markup info
                const hiddenInfo = document.getElementById('hidden-markup-info');
                const hiddenAmount = document.getElementById('hidden-markup-amount');
                if (hiddenInfo && hiddenAmount) {
                    if (this.state.hiddenMarkup > 0) {
                        hiddenInfo.style.display = 'block';
                        hiddenAmount.textContent = this.formatCurrency(hiddenMarkupAmount);
                    } else {
                        hiddenInfo.style.display = 'none';
                    }
                }

                // Update grand total (показываем клиенту сумму БЕЗ скрытой маржи)
                const finalTotal = document.getElementById('grand-total');
                if (finalTotal) {
                    finalTotal.textContent = this.formatCurrency(clientTotal);
                }
                
                // Update profit analysis
                const totalProfitElement = document.getElementById('total-profit');
                if (totalProfitElement) {
                    totalProfitElement.textContent = this.formatCurrency(totalProfit);
                }

                // Partner commission display - теперь внутри блока "Наша прибыль"
                const partnerCommissionRow = document.getElementById('partner-commission-row');
                const partnerCommissionAmountElement = document.getElementById('partner-commission-amount');

                if (partnerCommissionRow && partnerCommissionAmountElement) {
                    if (this.state.partnerCommission > 0) {
                        partnerCommissionRow.style.display = 'block';
                        partnerCommissionAmountElement.textContent = this.formatCurrency(partnerCommissionAmount);
                    } else {
                        partnerCommissionRow.style.display = 'none';
                    }
                }

                // Update accommodations if section is expanded
                // Save to localStorage automatically
                this.saveToLocalStorage();
            }

            showCatalogModal() {
                this.editingTemplateId = null; // Reset editing state

                const modal = document.getElementById('catalog-modal');
                const modalTitle = document.getElementById('catalog-modal-title');
                const modalBtn = document.getElementById('catalog-modal-btn');
                const duplicateBtn = document.getElementById('catalog-duplicate-btn');

                if (modalTitle) modalTitle.textContent = 'Добавить в каталог';
                if (modalBtn) modalBtn.textContent = 'Добавить';

                // Hide duplicate button in add mode
                if (duplicateBtn) duplicateBtn.style.display = 'none';

                // Заполняем селектор регионов
                const regionSelect = document.getElementById('catalog-region');
                if (regionSelect) {
                    regionSelect.innerHTML = this.regions.map(region =>
                        `<option value="${this.escapeHtml(region)}">${this.escapeHtml(region)}</option>`
                    ).join('');
                    regionSelect.value = this.currentRegion;

                    // При изменении региона обновляем категории
                    regionSelect.onchange = () => this.updateCatalogModalCategories();
                }

                // Обновляем категории для текущего региона
                this.updateCatalogModalCategories();

                // Обновляем отображение папки
                this.updateCatalogFolderDisplay();

                if (modal) {
                    modal.classList.add('show');

                    setTimeout(() => {
                        const nameInput = document.getElementById('catalog-name');
                        if (nameInput) nameInput.focus();
                    }, 300);
                }
            }

            updateCatalogModalCategories() {
                const regionSelect = document.getElementById('catalog-region');
                const categorySelect = document.getElementById('catalog-category');

                if (!regionSelect || !categorySelect) return;

                const selectedRegion = regionSelect.value;

                // Загружаем категории выбранного региона
                const categoriesKey = `quoteCalc_categories_${selectedRegion}`;
                const savedCategories = localStorage.getItem(categoriesKey);

                let categories = this.categories; // По умолчанию текущие
                if (savedCategories) {
                    categories = JSON.parse(savedCategories);
                }

                // Заполняем селектор категорий
                categorySelect.innerHTML = categories
                    .filter(cat => cat.id !== 'undefined') // Не показываем "Не определено"
                    .map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`)
                    .join('');
                // Note: В <option> нельзя использовать HTML, поэтому оставляем emoji
            }

            hideCatalogModal() {
                const modal = document.getElementById('catalog-modal');
                const duplicateBtn = document.getElementById('catalog-duplicate-btn');

                if (modal) {
                    modal.classList.remove('show');

                    // Clear form and reset modal state
                    ['catalog-name', 'catalog-region', 'catalog-description', 'catalog-contractor', 'catalog-price'].forEach(id => {
                        const element = document.getElementById(id);
                        if (element) {
                            element.value = '';
                            element.classList.remove('error');
                        }
                    });

                    // Hide duplicate button
                    if (duplicateBtn) duplicateBtn.style.display = 'none';

                    // Reset modal to add mode
                    this.editingTemplateId = null;
                }
            }

            editTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template) return;

                // Store the template ID being edited FIRST
                this.editingTemplateId = templateId;

                // Заполняем селектор регионов
                const regionSelect = document.getElementById('catalog-region');
                if (regionSelect) {
                    regionSelect.innerHTML = this.regions.map(region =>
                        `<option value="${this.escapeHtml(region)}">${this.escapeHtml(region)}</option>`
                    ).join('');
                    // Устанавливаем регион услуги (или текущий, если не указан)
                    regionSelect.value = template.region || this.currentRegion;
                    regionSelect.onchange = () => this.updateCatalogModalCategories();
                }

                // Обновляем категории для региона услуги
                this.updateCatalogModalCategories();

                // Populate catalog modal with existing data
                const fields = {
                    'catalog-name': template.name,
                    'catalog-category': template.category,
                    'catalog-description': template.description || '',
                    'catalog-contractor': template.contractor || '',
                    'catalog-icon': template.icon,
                    'catalog-price': template.price
                };

                Object.entries(fields).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.value = value;
                });

                // Change modal title and button text
                const modal = document.getElementById('catalog-modal');
                const modalTitle = document.getElementById('catalog-modal-title');
                const modalBtn = document.getElementById('catalog-modal-btn');
                const duplicateBtn = document.getElementById('catalog-duplicate-btn');

                if (modalTitle) modalTitle.textContent = 'Редактировать услугу';
                if (modalBtn) modalBtn.textContent = 'Сохранить';

                // Show duplicate button in edit mode
                if (duplicateBtn) duplicateBtn.style.display = 'block';

                // Show modal WITHOUT resetting editingTemplateId
                if (modal) {
                    modal.classList.add('show');

                    setTimeout(() => {
                        const nameInput = document.getElementById('catalog-name');
                        if (nameInput) nameInput.focus();
                    }, 300);
                }
            }

            duplicateTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template) {
                    this.showNotification('Шаблон не найден', true);
                    return;
                }

                // Создать копию с новым ID и пометкой "(копия)"
                const duplicatedTemplate = {
                    ...template,
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    name: template.name + ' (копия)'
                };

                // Добавить копию в массив шаблонов
                this.templates.push(duplicatedTemplate);

                // Сохранить и перерендерить
                this.renderTemplates();
                this.saveToLocalStorage();

                this.showNotification(`📋 Шаблон "${template.name}" продублирован`);
            }

            duplicateCurrentTemplate() {
                if (!this.editingTemplateId) {
                    this.showNotification('Не выбран шаблон для дублирования', true);
                    return;
                }

                // Дублировать текущий редактируемый шаблон
                this.duplicateTemplate(this.editingTemplateId);

                // Закрыть модальное окно
                this.hideCatalogModal();
            }

            deleteTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (!template) return;

                if (!confirm(`Удалить "${template.name}" из каталога?`)) {
                    return;
                }

                this.templates = this.templates.filter(t => t.id !== templateId);
                this.renderTemplates();
                this.saveToLocalStorage();
                this.showNotification('Услуга удалена из каталога');
            }

            addToCatalog() {
                const nameElement = document.getElementById('catalog-name');
                const regionElement = document.getElementById('catalog-region');
                const categoryElement = document.getElementById('catalog-category');
                const descriptionElement = document.getElementById('catalog-description');
                const contractorElement = document.getElementById('catalog-contractor');
                const iconElement = document.getElementById('catalog-icon');
                const priceElement = document.getElementById('catalog-price');

                if (!nameElement || !regionElement || !categoryElement || !iconElement || !priceElement) return;

                const name = nameElement.value.trim();
                const selectedRegion = regionElement.value;
                const category = categoryElement.value;
                const description = descriptionElement ? descriptionElement.value.trim() : '';
                const contractor = contractorElement ? contractorElement.value.trim() : '';
                const icon = iconElement.value;
                const price = Math.max(0, parseFloat(priceElement.value) || 0);

                if (!name) {
                    this.showNotification('Введите название услуги', true);
                    nameElement.classList.add('error');
                    return;
                }

                if (!category || category === '') {
                    this.showNotification('Выберите категорию', true);
                    categoryElement.classList.add('error');
                    return;
                }

                if (price <= 0) {
                    this.showNotification('Укажите корректную цену', true);
                    priceElement.classList.add('error');
                    return;
                }

                if (this.editingTemplateId) {
                    // Update existing template
                    const oldRegion = this.currentRegion;
                    const template = this.templates.find(t => t.id === this.editingTemplateId);

                    if (template) {
                        const oldTemplateRegion = template.region || oldRegion;

                        // Обновляем данные услуги
                        template.name = name;
                        template.category = category;
                        template.description = description;
                        template.contractor = contractor;
                        template.icon = icon;
                        template.price = price;
                        template.region = selectedRegion;

                        // Если регион изменился - переносим услугу
                        if (oldTemplateRegion !== selectedRegion) {
                            // Удаляем из старого региона
                            const oldTemplatesKey = `quoteCalc_templates_${oldTemplateRegion}`;
                            let oldTemplates = JSON.parse(localStorage.getItem(oldTemplatesKey) || '[]');
                            oldTemplates = oldTemplates.filter(t => t.id !== this.editingTemplateId);
                            localStorage.setItem(oldTemplatesKey, JSON.stringify(oldTemplates));

                            // Добавляем в новый регион
                            const newTemplatesKey = `quoteCalc_templates_${selectedRegion}`;
                            let newTemplates = JSON.parse(localStorage.getItem(newTemplatesKey) || '[]');
                            newTemplates.push(template);
                            localStorage.setItem(newTemplatesKey, JSON.stringify(newTemplates));

                            // Обновляем текущий каталог если смотрим на один из этих регионов
                            if (this.currentRegion === oldTemplateRegion) {
                                this.templates = this.templates.filter(t => t.id !== this.editingTemplateId);
                            } else if (this.currentRegion === selectedRegion) {
                                this.templates.push(template);
                            }

                            this.showNotification(`Услуга перемещена в регион "${selectedRegion}"`);
                        } else {
                            // Регион не изменился - просто сохраняем каталог
                            this.saveCatalogToRegion(selectedRegion).catch(err => {
                                console.error('Failed to save catalog:', err);
                            });
                            this.showNotification('Услуга обновлена');
                        }

                        console.log('Template updated:', template);
                    }
                } else {
                    // Add new template
                    const template = {
                        id: 'custom_' + Date.now(),
                        name: name,
                        category: category,
                        description: description,
                        contractor: contractor,
                        icon: icon,
                        price: price,
                        region: selectedRegion
                    };

                    // ✅ Добавляем шаблон в память и сохраняем на сервер
                    // Если добавляем в текущий регион - обновляем отображение
                    if (selectedRegion === this.currentRegion) {
                        this.templates.push(template);
                    }

                    // Сохраняем каталог на сервер после добавления шаблона
                    this.saveCatalogToRegion(selectedRegion).catch(err => {
                        console.error('Failed to save catalog:', err);
                    });

                    this.showNotification(`Услуга добавлена в каталог региона "${selectedRegion}"`);
                    console.log('Added new template to region:', selectedRegion, template);
                }

                this.renderTemplates();
                this.hideCatalogModal();
            }

            formatCurrency(amount) {
                return `${this.config.currency}${Math.round(amount).toLocaleString(this.config.locale)}`;
            }

            filterTemplates(query) {
                const items = document.querySelectorAll('.template-item');
                const searchQuery = query.toLowerCase();

                items.forEach(item => {
                    // Поиск по названию, контрагенту и комментариям
                    const name = item.getAttribute('data-name') || '';
                    const contractor = item.getAttribute('data-contractor') || '';
                    const description = item.getAttribute('data-description') || '';

                    const matches = name.includes(searchQuery) ||
                                   contractor.includes(searchQuery) ||
                                   description.includes(searchQuery);

                    item.style.display = matches ? 'block' : 'none';

                    // Highlight search terms
                    if (query && matches) {
                        item.style.backgroundColor = 'var(--gray-100)';
                    } else {
                        item.style.backgroundColor = '';
                    }
                });
            }

            // Category Management
            loadCategories() {
                const saved = localStorage.getItem('quoteCalc_categories');
                if (saved) {
                    this.categories = JSON.parse(saved);
                    console.log('Loaded categories:', this.categories.map(c => `${c.name}(${c.id})`).join(', '));
                }

                // Исправляем или удаляем поломанные категории (без ID или с пустым ID)
                const beforeCleanup = this.categories.length;
                const brokenCategories = this.categories.filter(cat => !cat.id || cat.id === '');

                if (brokenCategories.length > 0) {
                    console.warn('Found broken categories:', brokenCategories);

                    // Пытаемся исправить категории с пустым ID
                    brokenCategories.forEach(cat => {
                        if (cat.name) {
                            // Генерируем новый ID
                            let newId = cat.name.toLowerCase()
                                .replace(/\s+/g, '_')
                                .replace(/[^a-z0-9_]/g, '');

                            if (!newId || newId === '') {
                                newId = 'cat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                            }

                            console.log(`Fixing category "${cat.name}": setting id to "${newId}"`);
                            cat.id = newId;
                        }
                    });

                    // Удаляем те, которые все еще без ID
                    this.categories = this.categories.filter(cat => cat.id && cat.id !== '');

                    if (this.categories.length < beforeCleanup) {
                        console.log(`Удалено ${beforeCleanup - this.categories.length} поломанных категорий`);
                    }

                    this.saveCategories();
                }

                // Убедимся, что системная категория "Не определено" существует
                const hasUndefinedCategory = this.categories.some(cat => cat.id === 'undefined');
                if (!hasUndefinedCategory) {
                    // Добавляем системную категорию в начало списка
                    this.categories.unshift({
                        id: 'undefined',
                        name: 'Не определено',
                        icon: '❓',
                        system: true
                    });
                    this.saveCategories(); // Сохраняем обновленный список
                    console.log('Системная категория "Не определено" добавлена');
                }

                // Load category statistics
                const savedStats = localStorage.getItem('quoteCalc_categoryStats');
                if (savedStats) {
                    this.categoryStats = JSON.parse(savedStats);
                } else {
                    // Initialize usage stats for all categories
                    this.categories.forEach(cat => {
                        if (!this.categoryStats.usage[cat.id]) {
                            this.categoryStats.usage[cat.id] = 0;
                        }
                    });
                }

                // Check if reorganization is needed
                this.checkCategoryReorganization();

                // Load template statistics
                const savedTemplateStats = localStorage.getItem('quoteCalc_templateStats');
                if (savedTemplateStats) {
                    this.templateStats = JSON.parse(savedTemplateStats);
                } else {
                    // Initialize usage stats for all templates
                    this.templates.forEach(tpl => {
                        if (!this.templateStats.usage[tpl.id]) {
                            this.templateStats.usage[tpl.id] = 0;
                        }
                    });
                }

                // Check if template reorganization is needed
                this.checkTemplateReorganization();

                // Загрузка глобальной статистики
                this.loadGlobalStats();
            }

            saveCategories() {
                // ✅ Сохраняем категории через сервер (не localStorage)
                // Каталог сохраняется целиком (templates + categories)
                this.saveCatalogToRegion(this.currentRegion).catch(err => {
                    console.error('Failed to save categories:', err);
                });
            }

            saveCategoryStats() {
                // Статистика категорий общая для всех регионов
                localStorage.setItem('quoteCalc_categoryStats', JSON.stringify(this.categoryStats));
            }

            saveTemplateStats() {
                // Статистика шаблонов общая для всех регионов
                localStorage.setItem('quoteCalc_templateStats', JSON.stringify(this.templateStats));
            }

            // ======= УПРАВЛЕНИЕ РЕГИОНАМИ =======

            initRegions() {
                // Загружаем список регионов из localStorage
                const savedRegions = localStorage.getItem('quoteCalc_regions');

                // Проверяем, есть ли сохранённые регионы и нужна ли миграция
                let needsMigration = false;

                if (savedRegions) {
                    const parsed = JSON.parse(savedRegions);
                    // Если сохранён только Default или пустой массив - создаём предустановленные регионы
                    if (!parsed.length || (parsed.length === 1 && parsed[0] === 'Default')) {
                        needsMigration = true;
                    } else {
                        this.regions = parsed;
                    }
                } else {
                    needsMigration = true;
                }

                if (needsMigration) {
                    console.log('Миграция на новую систему регионов...');

                    // Создаём предустановленные регионы
                    this.regions = [
                        'Ushuaia',
                        'El Calafate',
                        'Torres del Paine',
                        'Bariloche',
                        'Buenos Aires',
                        'Mendoza',
                        'Salta/Jujuy'
                    ];
                    localStorage.setItem('quoteCalc_regions', JSON.stringify(this.regions));

                    // Migration v3: Legacy localStorage migration removed - catalogs now loaded from server
                    console.log('Каталоги будут загружены с сервера');
                }

                // Загружаем текущий регион
                const savedCurrent = localStorage.getItem('quoteCalc_currentRegion');
                if (savedCurrent && this.regions.includes(savedCurrent)) {
                    this.currentRegion = savedCurrent;
                } else {
                    this.currentRegion = this.regions[0] || 'Ushuaia';
                    localStorage.setItem('quoteCalc_currentRegion', this.currentRegion);
                }

                console.log('Регионы инициализированы:', this.regions, 'Текущий:', this.currentRegion);

                // Рендерим селектор регионов
                this.renderRegionSelector();

                // Загружаем каталог для текущего региона
                this.loadCatalogForRegion(this.currentRegion);
            }

            renderRegionSelector() {
                const selector = document.getElementById('region-selector');
                if (!selector) return;

                selector.innerHTML = this.regions.map(region =>
                    `<option value="${this.escapeHtml(region)}">${this.escapeHtml(region)}</option>`
                ).join('');
                selector.value = this.currentRegion;
            }

            renderRegionsManager() {
                const container = document.getElementById('regions-manager-list');
                if (!container) return;

                // Сохраняем выбранный регион для просмотра категорий
                if (!this.selectedRegionForView) {
                    this.selectedRegionForView = this.currentRegion;
                }

                container.innerHTML = this.regions.map((region, index) => {
                    const isActive = region === this.currentRegion;
                    const isSelected = region === this.selectedRegionForView;
                    const activeBadge = isActive ? '<span style="font-size: 10px; color: #f59e0b; background: #fef3c7; padding: 2px 6px; border-radius: 3px; margin-left: 6px; font-weight: 600;">активный</span>' : '';
                    const canDelete = this.regions.length > 1;

                    return `
                        <div class="region-manager-item ${isSelected ? 'region-item-selected' : ''}"
                             data-region="${this.escapeHtml(region)}"
                             onclick="window.QuoteCalc.selectRegionForView('${this.escapeHtml(region)}')"
                             style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #e5e7eb; background: ${isActive ? '#fffbeb' : 'white'}; transition: all 0.2s; cursor: pointer;">
                            <div class="region-inline-edit" style="display: flex; align-items: center; gap: 8px;">
                                <i data-lucide="map-pin" style="width: 14px; height: 14px; color: ${isActive ? '#92400e' : '#6b7280'};"></i>
                                <span class="region-name" style="font-weight: ${isActive ? '600' : '400'}; color: ${isActive ? '#92400e' : '#374151'};">${this.escapeHtml(region)}</span>
                                ${activeBadge}
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <button onclick="event.stopPropagation(); window.QuoteCalc.startInlineRename('${this.escapeHtml(region)}')"
                                        style="width: 28px; height: 28px; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.15s;"
                                        onmouseover="this.style.background='#f3f4f6'; this.style.color='#4b5563';"
                                        onmouseout="this.style.background='transparent'; this.style.color='#9ca3af';"
                                        title="Переименовать регион"><i data-lucide="edit" style="width: 12px; height: 12px;"></i></button>
                                ${canDelete ? `
                                    <button onclick="event.stopPropagation(); window.QuoteCalc.deleteRegion('${this.escapeHtml(region)}')"
                                            style="width: 28px; height: 28px; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.15s;"
                                            onmouseover="this.style.background='#fee2e2'; this.style.color='#dc2626';"
                                            onmouseout="this.style.background='transparent'; this.style.color='#9ca3af';"
                                            title="Удалить регион">×</button>
                                ` : '<div style="width: 28px;"></div>'}
                            </div>
                        </div>
                    `;
                }).join('');

                // Загружаем категории для выбранного региона
                this.loadCategoriesForRegionView(this.selectedRegionForView);
            }

            selectRegionForView(region) {
                this.selectedRegionForView = region;
                this.renderRegionsManager();
            }

            loadCategoriesForRegionView(region) {
                // Загружаем категории выбранного региона в правую панель
                const categoriesKey = `quoteCalc_categories_${region}`;
                const savedCategories = localStorage.getItem(categoriesKey);

                let categories = [];
                if (savedCategories) {
                    categories = JSON.parse(savedCategories);
                } else {
                    // Используем дефолтные категории
                    categories = [
                        { id: 'undefined', name: 'Не определено', icon: '❓', system: true },
                        { id: 'transfer', name: 'Трансфер', icon: '🚗' },
                        { id: 'accommodation', name: 'Отели', icon: '🏨' },
                        { id: 'guide', name: 'Гиды', icon: '👨‍🏫' },
                        { id: 'activity', name: 'Активности', icon: '🏛️' },
                        { id: 'service', name: 'Сервис', icon: '🔧' }
                    ];
                }

                // Временно сохраняем текущие категории
                const tempCategories = this.categories;
                this.categories = categories;

                // Рендерим список категорий
                this.renderCategoriesManager();

                // Восстанавливаем текущие категории
                this.categories = tempCategories;

                // Обновляем заголовок списка категорий
                const categoriesList = document.querySelector('#categories-manager-list');
                if (categoriesList && categoriesList.previousElementSibling) {
                    const titleDiv = categoriesList.previousElementSibling;
                    if (titleDiv.classList && titleDiv.classList.contains('text-sm')) {
                        titleDiv.innerHTML = `Управление категориями<div style="font-size: 11px; color: var(--gray-500); font-weight: 400; margin-top: 4px;">Регион: ${region}</div>`;
                    }
                }
            }

            startInlineRename(oldName) {
                const items = document.querySelectorAll('.region-manager-item');
                items.forEach(item => {
                    if (item.dataset.region === oldName) {
                        item.classList.add('editing');
                        const nameSpan = item.querySelector('.region-name');
                        const currentName = nameSpan.textContent;

                        const input = document.createElement('input');
                        input.type = 'text';
                        input.value = currentName;
                        input.className = 'region-inline-input';

                        // Сохранение по Enter
                        input.onkeydown = (e) => {
                            if (e.key === 'Enter') {
                                this.finishInlineRename(oldName, input.value.trim());
                            } else if (e.key === 'Escape') {
                                this.renderRegionsManager();
                            }
                        };

                        // Сохранение при потере фокуса
                        input.onblur = () => {
                            setTimeout(() => {
                                this.finishInlineRename(oldName, input.value.trim());
                            }, 200);
                        };

                        nameSpan.replaceWith(input);
                        input.focus();
                        input.select();
                    }
                });
            }

            finishInlineRename(oldName, newName) {
                if (!newName || newName === oldName) {
                    this.renderRegionsManager();
                    return;
                }

                if (this.regions.includes(newName)) {
                    alert('Регион с таким названием уже существует');
                    this.renderRegionsManager();
                    return;
                }

                // Переименовываем регион
                const index = this.regions.indexOf(oldName);
                if (index !== -1) {
                    this.regions[index] = newName;
                    localStorage.setItem('quoteCalc_regions', JSON.stringify(this.regions));

                    // Переименовываем ключи в localStorage
                    const oldCatalogKey = `quoteCalc_templates_${oldName}`;
                    const newCatalogKey = `quoteCalc_templates_${newName}`;
                    const oldCategoriesKey = `quoteCalc_categories_${oldName}`;
                    const newCategoriesKey = `quoteCalc_categories_${newName}`;

                    const catalog = localStorage.getItem(oldCatalogKey);
                    const categories = localStorage.getItem(oldCategoriesKey);

                    if (catalog) {
                        localStorage.setItem(newCatalogKey, catalog);
                        localStorage.removeItem(oldCatalogKey);
                    }

                    if (categories) {
                        localStorage.setItem(newCategoriesKey, categories);
                        localStorage.removeItem(oldCategoriesKey);
                    }

                    // Обновляем текущий регион если нужно
                    if (this.currentRegion === oldName) {
                        this.currentRegion = newName;
                        localStorage.setItem('quoteCalc_currentRegion', newName);
                    }

                    // Обновляем выбранный регион для просмотра
                    if (this.selectedRegionForView === oldName) {
                        this.selectedRegionForView = newName;
                    }

                    this.renderRegionSelector();
                    this.renderRegionsManager();
                    this.showNotification(`Регион переименован: "${oldName}" → "${newName}"`);
                }
            }

            addRegionFromManager() {
                const input = document.getElementById('region-manager-name');
                if (!input) return;

                const name = input.value.trim();
                if (!name) {
                    alert('Введите название региона');
                    return;
                }

                if (this.regions.includes(name)) {
                    alert('Регион с таким названием уже существует');
                    return;
                }

                // Добавляем регион
                this.regions.push(name);
                localStorage.setItem('quoteCalc_regions', JSON.stringify(this.regions));

                // Создаём пустой каталог для нового региона
                localStorage.setItem(`quoteCalc_templates_${name}`, JSON.stringify([]));

                // Копируем категории текущего региона в новый (или используем дефолтные)
                let newRegionCategories = JSON.parse(localStorage.getItem(`quoteCalc_categories_${this.currentRegion}`) || 'null');

                if (!newRegionCategories) {
                    // Если нет категорий в текущем регионе - используем дефолтные
                    newRegionCategories = [
                        { id: 'undefined', name: 'Не определено', icon: '❓', system: true },
                        { id: 'transfer', name: 'Трансфер', icon: '🚗' },
                        { id: 'accommodation', name: 'Отели', icon: '🏨' },
                        { id: 'guide', name: 'Гиды', icon: '👨‍🏫' },
                        { id: 'activity', name: 'Активности', icon: '🏛️' },
                        { id: 'service', name: 'Сервис', icon: '🔧' }
                    ];
                } else {
                    // ВАЖНО: Гарантируем наличие системной категории "Не определено"
                    const hasUndefinedCategory = newRegionCategories.some(cat => cat.id === 'undefined');
                    if (!hasUndefinedCategory) {
                        console.log(`Добавляем системную категорию "Не определено" в новый регион "${name}"`);
                        newRegionCategories.unshift({
                            id: 'undefined',
                            name: 'Не определено',
                            icon: '❓',
                            system: true
                        });
                    }
                }

                localStorage.setItem(`quoteCalc_categories_${name}`, JSON.stringify(newRegionCategories));

                input.value = '';
                this.renderRegionSelector();
                this.renderRegionsManager();
                this.showNotification(`Регион "${name}" добавлен`);
            }

            deleteRegion(regionName) {
                if (this.regions.length === 1) {
                    alert('Нельзя удалить последний регион');
                    return;
                }

                if (!confirm(`Удалить регион "${regionName}"?\n\nВсе услуги и категории этого региона будут удалены.`)) {
                    return;
                }

                // Удаляем регион из списка
                this.regions = this.regions.filter(r => r !== regionName);
                localStorage.setItem('quoteCalc_regions', JSON.stringify(this.regions));

                // Удаляем данные региона
                localStorage.removeItem(`quoteCalc_templates_${regionName}`);
                localStorage.removeItem(`quoteCalc_categories_${regionName}`);

                // Если удалили текущий регион - переключаемся на первый доступный
                if (this.currentRegion === regionName) {
                    this.currentRegion = this.regions[0];
                    localStorage.setItem('quoteCalc_currentRegion', this.currentRegion);
                    this.loadCatalogForRegion(this.currentRegion);
                }

                this.renderRegionSelector();
                this.renderRegionsManager();
                this.showNotification(`Регион "${regionName}" удалён`);
            }

            changeRegion(newRegion) {
                if (newRegion === this.currentRegion) return;

                try {
                    // Сохраняем текущий каталог перед переключением
                    this.saveCatalogToRegion(this.currentRegion);

                    // Переключаемся на новый регион
                    this.currentRegion = newRegion;
                    localStorage.setItem('quoteCalc_currentRegion', newRegion);

                    // Загружаем каталог нового региона
                    this.loadCatalogForRegion(newRegion);

                    this.showNotification(`Переключено на регион: ${newRegion}`);
                } catch (error) {
                    console.error('Ошибка переключения региона:', error);
                    this.showNotification(`Ошибка переключения региона: ${error.message}`, true);
                }
            }

            async saveCatalogToRegion(regionName) {
                try {
                    // Prepare catalog data
                    const catalogData = {
                        name: regionName,
                        data: {
                            version: this.CATALOG_VERSION,
                            region: regionName,
                            templates: this.templates,
                            categories: this.categories,
                            updated_at: new Date().toISOString()
                        },
                        visibility: 'organization'  // or 'public'/'private' based on UI
                    };

                    // Save to server
                    const response = await this.apiClient.saveCatalog(
                        catalogData.name,
                        catalogData.data,
                        catalogData.visibility
                    );

                    if (!response.success) {
                        throw new Error(response.error || 'Save failed');
                    }

                    // Success feedback
                    this.showNotification(`Каталог "${regionName}" сохранён`, false);
                    console.log(`Каталог "${regionName}" сохранён на сервере`);

                } catch (error) {
                    console.error('Save catalog error:', error);

                    // Обработка специфичных ошибок
                    if (error.message.includes('Authentication required')) {
                        this.showNotification('Сессия истекла. Войдите снова.', true);
                    } else if (error.message.includes('Concurrent modification')) {
                        this.showNotification('Каталог был изменён другим пользователем. Обновите и попробуйте снова.', true);
                    } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                        // Migration v3: Queue for offline sync
                        if (window.offlineManager) {
                            window.offlineManager.queueSave(catalogData);
                            this.showNotification('Сервер недоступен. Изменения будут синхронизированы при подключении.', false);
                        } else {
                            this.showNotification('Сервер недоступен. Проверьте соединение.', true);
                        }
                    } else {
                        this.showNotification(`Ошибка сохранения каталога: ${error.message}`, true);
                    }
                }
            }

            async loadCatalogForRegion(regionName) {
                // Guard flag для предотвращения concurrent operations
                if (this.isLoadingCatalog) {
                    console.warn('Catalog load already in progress');
                    return;
                }

                this.isLoadingCatalog = true;

                try {
                    // Step 1: Get list of catalogs from server
                    const listResponse = await this.apiClient.getCatalogsList();
                    if (!listResponse.success) {
                        throw new Error('Failed to fetch catalogs list');
                    }

                    // Step 2: Find catalog matching regionName
                    const catalogs = listResponse.data.catalogs;
                    const catalog = catalogs.find(c => c.region === regionName);

                    if (!catalog) {
                        // Region doesn't exist yet - создаем пустой
                        console.log(`Каталог для региона "${regionName}" не найден, создаем пустой`);
                        this.templates = [];
                        this.categories = this.getDefaultCategories();
                        this.currentCatalogId = null;
                    } else {
                        // Step 3: Load full catalog data by ID
                        const dataResponse = await this.apiClient.loadCatalogById(catalog.id);
                        if (!dataResponse.success) {
                            throw new Error('Failed to load catalog data');
                        }

                        // Step 4: Populate application state
                        const data = dataResponse.data;
                        this.templates = (data.templates || []).map(t => ({
                            ...t,
                            region: t.region || regionName
                        }));
                        this.categories = data.categories || this.getDefaultCategories();
                        this.currentCatalogId = catalog.id;  // Store for future saves

                        // Migration v3: Cache успешно загруженных данных
                        if (window.catalogCache) {
                            window.catalogCache.set(catalog.id, {
                                templates: this.templates,
                                categories: this.categories,
                                region: regionName
                            });
                        }

                        console.log(`Загружен каталог "${regionName}" (ID: ${catalog.id}) с сервера: ${this.templates.length} услуг`);
                    }

                    // ВАЖНО: Убеждаемся что системная категория "Не определено" ВСЕГДА существует
                    const hasUndefinedCategory = this.categories.some(cat => cat.id === 'undefined');
                    if (!hasUndefinedCategory) {
                        console.log(`Добавляем системную категорию "Не определено" в регион "${regionName}"`);
                        this.categories.unshift({
                            id: 'undefined',
                            name: 'Не определено',
                            icon: '❓',
                            system: true
                        });
                    }

                    // Загружаем статистику категорий (общая для всех регионов)
                    const savedStats = localStorage.getItem('quoteCalc_categoryStats');
                    if (savedStats) {
                        this.categoryStats = JSON.parse(savedStats);
                    } else {
                        // Инициализируем статистику для всех категорий
                        this.categories.forEach(cat => {
                            if (!this.categoryStats.usage[cat.id]) {
                                this.categoryStats.usage[cat.id] = 0;
                            }
                        });
                    }

                    // Загружаем статистику шаблонов (общая для всех регионов)
                    const savedTemplateStats = localStorage.getItem('quoteCalc_templateStats');
                    if (savedTemplateStats) {
                        this.templateStats = JSON.parse(savedTemplateStats);
                    } else {
                        // Инициализируем статистику для всех шаблонов
                        this.templates.forEach(tpl => {
                            if (!this.templateStats.usage[tpl.id]) {
                                this.templateStats.usage[tpl.id] = 0;
                            }
                        });
                    }

                    // Проверяем нужна ли реорганизация
                    this.checkCategoryReorganization();
                    this.checkTemplateReorganization();

                    // Загружаем глобальную статистику (при первой загрузке)
                    if (!this.globalStats) {
                        this.loadGlobalStats();
                    }

                    // Перерисовываем UI
                    this.renderTemplates();
                    this.renderCategories();
                    this.renderCategoryOptions();
                    this.renderRegionsManager();

                    // Показываем уведомление об успешной загрузке
                    this.showNotification(`Каталог "${regionName}" загружен`, false);

                } catch (error) {
                    console.error('Load catalog error:', error);

                    // Migration v3: Check cache before fallback
                    let usedCache = false;
                    if (window.catalogCache && this.currentCatalogId) {
                        const cached = window.catalogCache.get(this.currentCatalogId);
                        if (cached) {
                            this.templates = cached.templates;
                            this.categories = cached.categories;
                            this.showNotification('Загружено из кэша (оффлайн)', false);
                            usedCache = true;

                            // Render UI with cached data
                            this.renderTemplates();
                            this.renderCategories();
                            return;
                        }
                    }

                    // Обработка специфичных ошибок (если кэш не помог)
                    if (error.message.includes('Authentication required')) {
                        this.showNotification('Сессия истекла. Войдите снова.', true);
                        // TODO: Redirect to login page
                    } else if (error.message.includes('Catalog not found') || error.message.includes('not found')) {
                        this.showNotification(`Каталог "${regionName}" не найден. Создайте новый.`, true);
                    } else if (error.message.includes('Access denied')) {
                        this.showNotification('Доступ запрещён к этому каталогу.', true);
                    } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                        this.showNotification('Сервер недоступен. Проверьте соединение.', true);
                    } else {
                        this.showNotification(`Ошибка загрузки каталога: ${error.message}`, true);
                    }

                    // Fallback: используем пустой каталог (только если не использовали кэш)
                    if (!usedCache) {
                        this.templates = [];
                        this.categories = this.getDefaultCategories();
                        this.renderTemplates();
                        this.renderCategories();
                    }

                } finally {
                    this.isLoadingCatalog = false;
                }
            }

            async loadDefaultCatalog() {
                try {
                    // Option A: Load first catalog from list
                    const listResponse = await this.apiClient.getCatalogsList();
                    if (listResponse.success && listResponse.data.catalogs.length > 0) {
                        const firstCatalog = listResponse.data.catalogs[0];
                        await this.loadCatalogForRegion(firstCatalog.region);
                        console.log(`Default catalog loaded: ${firstCatalog.region}`);
                        return;
                    }

                    // Fallback: Empty catalog
                    console.log('No catalogs found, starting with empty catalog');
                    this.templates = [];
                    this.categories = this.getDefaultCategories();

                } catch (error) {
                    // Non-blocking error - app still usable
                    console.warn('Default catalog not loaded:', error);
                    this.showNotification('Каталог не загружен. Загрузите вручную.', false);

                    // Fallback: Empty catalog
                    this.templates = [];
                    this.categories = this.getDefaultCategories();
                }
            }

            getDefaultCategories() {
                return [
                    { id: 'undefined', name: 'Не определено', icon: '❓', system: true },
                    { id: 'transfer', name: 'Трансфер', icon: '🚗' },
                    { id: 'accommodation', name: 'Отели', icon: '🏨' },
                    { id: 'guide', name: 'Гиды', icon: '👨‍🏫' },
                    { id: 'activity', name: 'Активности', icon: '🏛️' },
                    { id: 'service', name: 'Сервис', icon: '🔧' }
                ];
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Migration v3: copyRegionCatalog() and copySelectedServicesToRegion() removed
            // These methods used localStorage - catalog operations now use server API

            // ======= КОНЕЦ УПРАВЛЕНИЯ РЕГИОНАМИ =======

            // Загрузка глобальной статистики (НИКОГДА не сбрасывается)
            loadGlobalStats() {
                const saved = localStorage.getItem('quoteCalc_globalStats');
                if (saved) {
                    try {
                        this.globalStats = JSON.parse(saved);
                        console.log('Global statistics loaded:', this.globalStats);
                    } catch (error) {
                        console.error('Error loading global stats:', error);
                        // Initialize empty stats on error
                        this.initGlobalStats();
                    }
                } else {
                    this.initGlobalStats();
                }
            }

            // Инициализация глобальной статистики
            initGlobalStats() {
                this.globalStats = {
                    services: {},
                    categories: {},
                    totalServicesAdded: 0,
                    firstUsage: null,
                    lastUsage: null
                };
                this.saveGlobalStats();
            }

            // Сохранение глобальной статистики
            saveGlobalStats() {
                try {
                    localStorage.setItem('quoteCalc_globalStats', JSON.stringify(this.globalStats));
                    console.log('Global statistics saved');
                } catch (error) {
                    console.error('Error saving global stats:', error);
                }
            }

            // Проверяет и исправляет категории услуг (только при загрузке данных)
            validateAndFixTemplateCategories() {
                // Получаем список ID всех существующих категорий (исключая системные)
                const validCategoryIds = this.categories.map(cat => cat.id);
                let fixedCount = 0;

                // Проверяем каждую услугу
                this.templates.forEach(template => {
                    // Если у услуги нет категории, пустая категория, или категория не существует
                    if (!template.category || template.category === '' || !validCategoryIds.includes(template.category)) {
                        const oldCategory = template.category || 'none';
                        template.category = 'undefined';
                        fixedCount++;
                        console.log(`Услуга "${template.name}" перемещена из категории "${oldCategory}" в "Не определено"`);
                    }
                });

                // Если были исправления, сохраняем
                if (fixedCount > 0) {
                    this.saveToLocalStorage();
                    console.log(`Исправлено категорий: ${fixedCount}`);
                }
            }

            trackCategoryUsage(categoryId) {
                if (!this.categoryStats.usage[categoryId]) {
                    this.categoryStats.usage[categoryId] = 0;
                }
                this.categoryStats.usage[categoryId]++;
                this.saveCategoryStats();
                console.log(`Tracked usage for ${categoryId}: ${this.categoryStats.usage[categoryId]}`);
            }

            trackTemplateUsage(templateId) {
                if (!this.templateStats.usage[templateId]) {
                    this.templateStats.usage[templateId] = 0;
                }
                this.templateStats.usage[templateId]++;
                this.saveTemplateStats();
                console.log(`Tracked template usage for ${templateId}: ${this.templateStats.usage[templateId]}`);
            }

            // Отслеживание глобальной статистики (НИКОГДА не сбрасывается)
            trackGlobalUsage(templateId, serviceName, categoryId) {
                const now = Date.now();

                // Обновляем общий счетчик
                this.globalStats.totalServicesAdded++;

                // Устанавливаем первое использование если еще не установлено
                if (!this.globalStats.firstUsage) {
                    this.globalStats.firstUsage = now;
                }

                // Обновляем последнее использование
                this.globalStats.lastUsage = now;

                // Статистика по услугам
                if (templateId) {
                    if (!this.globalStats.services[templateId]) {
                        this.globalStats.services[templateId] = {
                            count: 0,
                            name: serviceName,
                            category: categoryId || 'undefined',
                            firstUsed: now,
                            lastUsed: now
                        };
                    }
                    this.globalStats.services[templateId].count++;
                    this.globalStats.services[templateId].lastUsed = now;
                }

                // Статистика по категориям
                if (categoryId) {
                    const category = this.categories.find(c => c.id === categoryId);
                    const categoryName = category ? category.name : 'Неизвестно';

                    if (!this.globalStats.categories[categoryId]) {
                        this.globalStats.categories[categoryId] = {
                            count: 0,
                            name: categoryName,
                            firstUsed: now,
                            lastUsed: now
                        };
                    }
                    this.globalStats.categories[categoryId].count++;
                    this.globalStats.categories[categoryId].lastUsed = now;
                }

                // Сохраняем глобальную статистику
                this.saveGlobalStats();

                console.log(`Global stats tracked: service=${serviceName}, category=${categoryId}, total=${this.globalStats.totalServicesAdded}`);
            }

            checkCategoryReorganization() {
                const now = Date.now();
                const lastReorg = this.categoryStats.lastReorganization;

                // If never reorganized or 3 days passed
                if (!lastReorg || (now - lastReorg) >= this.categoryStats.reorganizationInterval) {
                    this.reorganizeCategoriesByPopularity();
                }
            }

            checkTemplateReorganization() {
                const now = Date.now();
                const lastReorg = this.templateStats.lastReorganization;

                // If never reorganized or 3 days passed
                if (!lastReorg || (now - lastReorg) >= this.templateStats.reorganizationInterval) {
                    this.reorganizeTemplatesByPopularity();
                }
            }

            reorganizeCategoriesByPopularity() {
                // Get total usage for percentage calculation
                const totalUsage = Object.values(this.categoryStats.usage).reduce((sum, count) => sum + count, 0);

                if (totalUsage === 0) {
                    // No usage data yet, skip reorganization
                    console.log('Reorganization skipped: no usage data');
                    return;
                }

                console.log('Before reorganization:', this.categories.map(c => `${c.name}:${this.categoryStats.usage[c.id] || 0}`));

                // Sort categories by usage count (descending)
                this.categories.sort((a, b) => {
                    const usageA = this.categoryStats.usage[a.id] || 0;
                    const usageB = this.categoryStats.usage[b.id] || 0;
                    return usageB - usageA;
                });

                console.log('After reorganization:', this.categories.map(c => `${c.name}:${this.categoryStats.usage[c.id] || 0}`));

                // Save new order and update timestamp
                this.categoryStats.lastReorganization = Date.now();
                this.saveCategories();
                this.saveCategoryStats();
                this.renderCategories();
                this.renderCategoryOptions();

                console.log('Categories reorganized by popularity');
            }

            reorganizeTemplatesByPopularity() {
                // Get total usage for percentage calculation
                const totalUsage = Object.values(this.templateStats.usage).reduce((sum, count) => sum + count, 0);

                if (totalUsage === 0) {
                    // No usage data yet, skip reorganization
                    console.log('Template reorganization skipped: no usage data');
                    return;
                }

                console.log('Before template reorganization:', this.templates.slice(0, 5).map(t => `${t.name}:${this.templateStats.usage[t.id] || 0}`));

                // Sort templates by usage count (descending), within each category
                this.templates.sort((a, b) => {
                    // First, sort by category (keep categories together)
                    if (a.category !== b.category) {
                        // Find category order
                        const catIndexA = this.categories.findIndex(c => c.id === a.category);
                        const catIndexB = this.categories.findIndex(c => c.id === b.category);
                        return catIndexA - catIndexB;
                    }
                    // Within same category, sort by usage (descending)
                    const usageA = this.templateStats.usage[a.id] || 0;
                    const usageB = this.templateStats.usage[b.id] || 0;
                    return usageB - usageA;
                });

                console.log('After template reorganization:', this.templates.slice(0, 5).map(t => `${t.name}:${this.templateStats.usage[t.id] || 0}`));

                // Save new order and update timestamp
                this.templateStats.lastReorganization = Date.now();
                this.saveToLocalStorage();
                this.saveTemplateStats();
                this.renderTemplates();

                console.log('Templates reorganized by popularity within categories');
            }

            getCategoryPopularity(categoryId) {
                const usage = this.categoryStats.usage[categoryId] || 0;
                const totalUsage = Object.values(this.categoryStats.usage).reduce((sum, count) => sum + count, 0);

                if (totalUsage === 0) return 0;
                return Math.round((usage / totalUsage) * 100);
            }

            getCategoryUsageLevel(categoryId) {
                const popularity = this.getCategoryPopularity(categoryId);
                if (popularity >= 30) return 'high';
                if (popularity >= 15) return 'medium';
                if (popularity > 0) return 'low';
                return 'none';
            }

            renderCategories() {
                const container = document.getElementById('category-buttons-container');
                if (!container) return;

                // Проверяем, есть ли услуги в категории "Не определено"
                const hasUndefinedServices = this.templates.some(t => t.category === 'undefined');
                const undefinedCount = this.templates.filter(t => t.category === 'undefined').length;

                console.log(`renderCategories: hasUndefinedServices=${hasUndefinedServices}, count=${undefinedCount}`);

                // Проверяем наличие категории "undefined" в списке всех категорий
                const undefinedCategoryExists = this.categories.some(cat => cat.id === 'undefined');
                const undefinedCategory = this.categories.find(cat => cat.id === 'undefined');
                console.log(`renderCategories: undefinedCategoryExists=${undefinedCategoryExists}`, undefinedCategory);
                console.log(`renderCategories: all categories:`, this.categories.map(c => `${c.name}(${c.id})`).join(', '));

                // Фильтруем категории: показываем "Не определено" только если там есть услуги
                const visibleCategories = this.categories.filter(cat => {
                    if (cat.id === 'undefined') {
                        console.log(`renderCategories: filtering "undefined" category, hasUndefinedServices=${hasUndefinedServices}`);
                        return hasUndefinedServices;
                    }
                    return true;
                });

                console.log(`renderCategories: visible categories=${visibleCategories.length}:`, visibleCategories.map(c => c.name).join(', '));

                container.innerHTML = visibleCategories.map(cat => `
                    <button class="category-btn" data-category="${cat.id}">
                        ${this.renderIcon(cat.icon, '11px')} ${cat.name}
                    </button>
                `).join('');

                // Инициализация Lucide иконок
                lucide.createIcons();

                // Re-bind category events
                container.querySelectorAll('.category-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        const categoryId = e.target.dataset.category;
                        this.state.activeCategory = categoryId;

                        // Track category selection (except "all")
                        if (categoryId !== 'all') {
                            this.trackCategoryUsage(categoryId);
                            console.log(`Category clicked: ${categoryId}, new usage: ${this.categoryStats.usage[categoryId]}`);
                        }

                        this.renderTemplates();
                    });
                });
            }

            toggleSearch() {
                const searchBox = document.getElementById('search-box-expandable');
                const searchInput = document.getElementById('search');

                if (searchBox.style.display === 'none') {
                    searchBox.style.display = 'block';
                    setTimeout(() => searchInput.focus(), 100);
                } else {
                    searchBox.style.display = 'none';
                    searchInput.value = '';
                    this.filterTemplates('');
                }
            }

            toggleSearchExpand() {
                const btn = document.getElementById('search-expand-btn');
                const searchInput = btn.querySelector('.search-input');

                if (btn.classList.contains('expanded')) {
                    btn.classList.remove('expanded');
                    searchInput.value = '';
                    this.filterTemplates('');
                } else {
                    btn.classList.add('expanded');
                    setTimeout(() => searchInput.focus(), 100);
                }
            }

            toggleCategories() {
                const container = document.getElementById('category-buttons-container');
                const toggleBtn = document.getElementById('categories-toggle-btn');

                if (container.style.display === 'none') {
                    container.style.display = 'flex';
                    toggleBtn.textContent = '▼';
                } else {
                    container.style.display = 'none';
                    toggleBtn.textContent = '▶';
                }
            }

            // Toggle file dropdown menu
            toggleFileMenu() {
                const menu = document.getElementById('file-dropdown-menu');
                if (menu) {
                    const isVisible = menu.style.display !== 'none';
                    menu.style.display = isVisible ? 'none' : 'block';

                    // Закрыть меню при клике вне его
                    if (!isVisible) {
                        setTimeout(() => {
                            const closeMenu = (e) => {
                                if (!e.target.closest('#file-dropdown-menu') && !e.target.closest('#file-menu-btn')) {
                                    menu.style.display = 'none';
                                    document.removeEventListener('click', closeMenu);
                                }
                            };
                            document.addEventListener('click', closeMenu);
                        }, 0);
                    }
                }
            }

            showCategoriesManager() {
                // Открываем модальное окно для управления категориями
                const modal = document.getElementById('categories-manager-modal');
                if (modal) {
                    this.renderCategoriesManager();
                    this.updateReorganizationStatus();
                    this.updateCatalogFolderDisplay();

                    // Привязываем обработчик кнопки выбора папки (один раз)
                    const folderBtn = document.getElementById('select-folder-btn');
                    if (folderBtn) {
                        // Удаляем старые обработчики если были
                        const oldHandler = folderBtn._folderHandler;
                        if (oldHandler) {
                            folderBtn.removeEventListener('click', oldHandler);
                            console.log('Removed old folder button listener');
                        }

                        // Создаем новый обработчик
                        const newHandler = async (e) => {
                            console.log('Folder button clicked');

                            // Останавливаем всплытие события
                            e.preventDefault();
                            e.stopPropagation();

                            // Защита от двойного клика - отключаем кнопку
                            if (folderBtn.disabled) {
                                console.log('Button already disabled, ignoring click');
                                return;
                            }
                            folderBtn.disabled = true;
                            folderBtn.style.opacity = '0.5';

                            const modal = document.getElementById('categories-manager-modal');

                            try {
                                // ВАЖНО: вызываем picker СРАЗУ, без setTimeout!
                                // Это сохраняет контекст user activation
                                await this.selectCatalogFolder();

                                // После успешного выбора обновляем UI
                                this.updateCatalogFolderDisplay();

                            } catch (err) {
                                console.error('Folder selection error:', err);
                            } finally {
                                // Включаем кнопку обратно
                                folderBtn.disabled = false;
                                folderBtn.style.opacity = '1';
                            }
                        };

                        folderBtn.addEventListener('click', newHandler);
                        folderBtn._folderHandler = newHandler;
                        console.log('Folder button listener attached');
                    }

                    // Рендерим список регионов
                    this.renderRegionsManager();

                    modal.classList.add('show');
                }
            }

            updateReorganizationStatus() {
                const statusElement = document.getElementById('reorganization-status');
                if (!statusElement) return;

                if (this.categoryStats.lastReorganization) {
                    const lastReorg = new Date(this.categoryStats.lastReorganization);
                    const now = new Date();
                    const diffMs = now - lastReorg;
                    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                    let timeStr = '';
                    if (diffDays > 0) {
                        timeStr = `${diffDays} дн. ${diffHours} ч. назад`;
                    } else if (diffHours > 0) {
                        timeStr = `${diffHours} ч. назад`;
                    } else {
                        timeStr = 'только что';
                    }

                    statusElement.textContent = `Последняя: ${timeStr}`;
                } else {
                    statusElement.textContent = 'Последняя: никогда';
                }

                // Update template reorganization status
                const templateStatusElement = document.getElementById('template-reorganization-status');
                if (templateStatusElement) {
                    if (this.templateStats.lastReorganization) {
                        const lastReorg = new Date(this.templateStats.lastReorganization);
                        const now = new Date();
                        const diffMs = now - lastReorg;
                        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                        const diffHours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

                        let timeStr = '';
                        if (diffDays > 0) {
                            timeStr = `${diffDays} дн. ${diffHours} ч. назад`;
                        } else if (diffHours > 0) {
                            timeStr = `${diffHours} ч. назад`;
                        } else {
                            timeStr = 'только что';
                        }

                        templateStatusElement.textContent = `Последняя: ${timeStr}`;
                    } else {
                        templateStatusElement.textContent = 'Последняя: никогда';
                    }
                }
            }

            manualReorganizeCategories() {
                const totalUsage = Object.values(this.categoryStats.usage).reduce((sum, count) => sum + count, 0);

                if (totalUsage === 0) {
                    this.showNotification('Недостаточно данных для реорганизации. Добавьте услуги из каталога.', true);
                    return;
                }

                if (confirm('Реорганизовать категории по популярности использования?')) {
                    this.reorganizeCategoriesByPopularity();
                    this.renderCategoriesManager();
                    this.updateReorganizationStatus();
                    this.showNotification('Категории реорганизованы по популярности');
                }
            }

            manualReorganizeTemplates() {
                const totalUsage = Object.values(this.templateStats.usage).reduce((sum, count) => sum + count, 0);

                if (totalUsage === 0) {
                    this.showNotification('Недостаточно данных для реорганизации услуг. Добавьте услуги из каталога в смету.', true);
                    return;
                }

                if (confirm('Реорганизовать услуги внутри категорий по популярности использования?')) {
                    this.reorganizeTemplatesByPopularity();
                    this.updateReorganizationStatus();
                    this.showNotification('Услуги реорганизованы по популярности');
                }
            }

            resetCategoryStats() {
                if (!confirm('Сбросить локальную статистику использования категорий?\n\nЭто сбросит счетчики для сортировки категорий.\nГлобальная статистика для аналитики сохранится.\n\nПродолжить?')) {
                    return;
                }

                // Reset all usage counters to 0 (только локальная статистика)
                this.categories.forEach(cat => {
                    this.categoryStats.usage[cat.id] = 0;
                });

                // Reset reorganization timestamp
                this.categoryStats.lastReorganization = null;

                // Save to localStorage
                this.saveCategoryStats();

                // ВАЖНО: Глобальная статистика (this.globalStats) НЕ сбрасывается!
                // Она используется для долгосрочной аналитики и должна накапливаться всегда.

                // Update UI
                this.renderCategoriesManager();
                this.updateReorganizationStatus();

                console.log('Local category stats reset:', this.categoryStats);
                console.log('Global stats preserved:', this.globalStats);
                this.showNotification('Локальная статистика категорий сброшена. Глобальная статистика сохранена.');
            }

            resetTemplateStats() {
                if (!confirm('Сбросить локальную статистику использования услуг?\n\nЭто сбросит счетчики для сортировки услуг внутри категорий.\nГлобальная статистика для аналитики сохранится.\n\nПродолжить?')) {
                    return;
                }

                // Reset all template usage counters to 0 (только локальная статистика)
                this.templates.forEach(tpl => {
                    this.templateStats.usage[tpl.id] = 0;
                });

                // Reset reorganization timestamp
                this.templateStats.lastReorganization = null;

                // Save to localStorage
                this.saveTemplateStats();

                // ВАЖНО: Глобальная статистика (this.globalStats) НЕ сбрасывается!
                // Она используется для долгосрочной аналитики и должна накапливаться всегда.

                // Update UI
                this.updateReorganizationStatus();

                console.log('Local template stats reset:', this.templateStats);
                console.log('Global stats preserved:', this.globalStats);
                this.showNotification('Локальная статистика услуг сброшена. Глобальная статистика сохранена.');
            }

            hideCategoriesManager() {
                const modal = document.getElementById('categories-manager-modal');
                if (modal) {
                    modal.classList.remove('show');
                }
            }

            switchSettingsTab(tabName) {
                // Скрыть все вкладки
                const allTabs = document.querySelectorAll('.settings-tab');
                const allContents = document.querySelectorAll('.settings-tab-content');

                allTabs.forEach(tab => {
                    const isActive = tab.dataset.tab === tabName;
                    if (isActive) {
                        tab.style.borderBottomColor = 'var(--primary)';
                        tab.style.color = 'var(--primary)';
                        tab.style.fontWeight = '600';
                        tab.classList.add('active');
                    } else {
                        tab.style.borderBottomColor = 'transparent';
                        tab.style.color = 'var(--gray-500)';
                        tab.style.fontWeight = '500';
                        tab.classList.remove('active');
                    }
                });

                allContents.forEach(content => {
                    content.style.display = content.dataset.tab === tabName ? 'block' : 'none';
                });
            }

            renderCategoriesManager() {
                const container = document.getElementById('categories-manager-list');
                if (!container) return;

                // В менеджере показываем ВСЕ категории, включая "Не определено"
                // Это настройки - пользователь должен видеть все доступные категории
                const visibleCategories = this.categories;

                container.innerHTML = visibleCategories.map((cat, index) => {
                    const popularity = this.getCategoryPopularity(cat.id);
                    const usageLevel = this.getCategoryUsageLevel(cat.id);
                    const usage = this.categoryStats.usage[cat.id] || 0;

                    // Color based on usage level
                    let popularityColor = '#9ca3af'; // gray - none
                    if (usageLevel === 'high') popularityColor = '#16a34a'; // green
                    else if (usageLevel === 'medium') popularityColor = '#eab308'; // yellow
                    else if (usageLevel === 'low') popularityColor = '#3b82f6'; // blue

                    // Системные категории нельзя перетаскивать и удалять
                    const isDraggable = !cat.system;
                    const dragCursor = isDraggable ? 'move' : 'default';
                    const dragIcon = isDraggable ? '☰' : '🔒';
                    const systemBadge = cat.system ? '<span style="font-size: 10px; color: #6b7280; background: #f3f4f6; padding: 2px 6px; border-radius: 3px; margin-left: 6px;">система</span>' : '';
                    const systemTooltip = cat.system ? 'Системная категория. Отображается в каталоге только когда в ней есть услуги.' : '';

                    return `
                        <div class="category-manager-item"
                             data-category-id="${cat.id}"
                             data-index="${index}"
                             draggable="${isDraggable}"
                             title="${systemTooltip}"
                             style="display: flex; justify-content: space-between; align-items: center; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; margin-bottom: 4px; cursor: ${dragCursor}; background: white; transition: all 0.2s;">
                            <span style="font-size: 12px; display: flex; align-items: center; gap: 6px;">
                                <span style="color: #9ca3af; font-size: 14px;">${dragIcon}</span>
                                <span style="font-size: 14px;">${this.renderIcon(cat.icon, '14px')}</span>
                                <span>${cat.name}</span>
                                ${systemBadge}
                            </span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 10px; color: ${popularityColor}; font-weight: 600; display: flex; align-items: center; gap: 3px;">
                                    ${popularity}% (${usage})
                                </span>
                                ${isDraggable ? `
                                    <button onclick="window.QuoteCalc.deleteCategory('${cat.id}')"
                                            style="width: 20px; height: 20px; border: none; background: transparent; color: #9ca3af; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; border-radius: 3px; transition: all 0.15s;"
                                            onmouseover="this.style.background='#fee2e2'; this.style.color='#dc2626';"
                                            onmouseout="this.style.background='transparent'; this.style.color='#9ca3af';"
                                            title="Удалить категорию">×</button>
                                ` : '<div style="width: 20px;"></div>'}
                            </div>
                        </div>
                    `;
                }).join('');

                // Add drag and drop event listeners
                const items = container.querySelectorAll('.category-manager-item');
                items.forEach(item => {
                    item.addEventListener('dragstart', (e) => this.handleDragStart(e));
                    item.addEventListener('dragover', (e) => this.handleDragOver(e));
                    item.addEventListener('drop', (e) => this.handleDrop(e));
                    item.addEventListener('dragenter', (e) => this.handleDragEnter(e));
                    item.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                    item.addEventListener('dragend', (e) => this.handleDragEnd(e));
                });

                // Инициализация Lucide иконок
                lucide.createIcons();
            }

            handleDragStart(e) {
                this.draggedElement = e.target.closest('.category-manager-item');
                this.draggedElement.style.opacity = '0.4';
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', this.draggedElement.innerHTML);
            }

            handleDragOver(e) {
                if (e.preventDefault) {
                    e.preventDefault();
                }
                e.dataTransfer.dropEffect = 'move';
                return false;
            }

            handleDragEnter(e) {
                const target = e.target.closest('.category-manager-item');
                if (target && target !== this.draggedElement) {
                    target.style.borderColor = '#2563eb';
                    target.style.background = '#eff6ff';
                }
            }

            handleDragLeave(e) {
                const target = e.target.closest('.category-manager-item');
                if (target && target !== this.draggedElement) {
                    target.style.borderColor = '#e5e7eb';
                    target.style.background = 'white';
                }
            }

            handleDrop(e) {
                if (e.stopPropagation) {
                    e.stopPropagation();
                }

                const target = e.target.closest('.category-manager-item');
                if (this.draggedElement !== target && target) {
                    const draggedIndex = parseInt(this.draggedElement.dataset.index);
                    const targetIndex = parseInt(target.dataset.index);

                    // Reorder categories array
                    const movedItem = this.categories.splice(draggedIndex, 1)[0];
                    this.categories.splice(targetIndex, 0, movedItem);

                    // Save and re-render
                    this.saveCategories();
                    this.renderCategories();
                    this.renderCategoryOptions();
                    this.renderCategoriesManager();
                    this.showNotification('Порядок категорий изменен');
                }

                return false;
            }

            handleDragEnd(e) {
                const items = document.querySelectorAll('.category-manager-item');
                items.forEach(item => {
                    item.style.opacity = '1';
                    item.style.borderColor = '#e5e7eb';
                    item.style.background = 'white';
                });
            }

            deleteCategory(categoryId) {
                // Используем выбранный регион для просмотра
                const targetRegion = this.selectedRegionForView || this.currentRegion;

                // Загружаем категории целевого региона
                const categoriesKey = `quoteCalc_categories_${targetRegion}`;
                let categories = JSON.parse(localStorage.getItem(categoriesKey) || '[]');

                // Проверка: нельзя удалить системную категорию
                const category = categories.find(c => c.id === categoryId);
                if (category && category.system) {
                    this.showNotification('Системную категорию нельзя удалить', true);
                    return;
                }

                if (!confirm('Удалить категорию?\n\nВсе услуги из этой категории будут перемещены в "Не определено".')) return;

                // Загружаем услуги целевого региона
                const templatesKey = `quoteCalc_templates_${targetRegion}`;
                let templates = JSON.parse(localStorage.getItem(templatesKey) || '[]');

                // Переместить все услуги из удаляемой категории в "Не определено"
                const affectedTemplates = templates.filter(t => t.category === categoryId);
                console.log(`Found ${affectedTemplates.length} templates in category "${categoryId}" in region "${targetRegion}"`);

                if (affectedTemplates.length > 0) {
                    affectedTemplates.forEach(template => {
                        console.log(`Moving template "${template.name}" from "${template.category}" to "undefined"`);
                        template.category = 'undefined';
                    });
                    localStorage.setItem(templatesKey, JSON.stringify(templates));

                    // Убеждаемся что категория "Не определено" существует
                    const hasUndefinedCategory = categories.some(cat => cat.id === 'undefined');
                    if (!hasUndefinedCategory) {
                        console.log('Добавляем категорию "Не определено" для перемещенных услуг');
                        categories.unshift({
                            id: 'undefined',
                            name: 'Не определено',
                            icon: '❓',
                            system: true
                        });
                        localStorage.setItem(categoriesKey, JSON.stringify(categories));
                    }

                    // Если это текущий регион - обновляем локальные данные
                    if (targetRegion === this.currentRegion) {
                        this.templates = templates;
                        this.categories = categories; // Обновляем категории тоже!
                        this.renderTemplates();
                    }

                    console.log(`Перемещено ${affectedTemplates.length} услуг в категорию "Не определено"`);
                }

                // Удалить категорию
                console.log(`Deleting category: ${categoryId} from region "${targetRegion}"`);
                categories = categories.filter(c => c.id !== categoryId);
                localStorage.setItem(categoriesKey, JSON.stringify(categories));

                // Если это текущий регион - обновляем локальные категории
                if (targetRegion === this.currentRegion) {
                    this.categories = categories;
                    this.renderCategories();
                    this.renderCategoryOptions();
                }

                // Обновляем отображение категорий
                this.loadCategoriesForRegionView(targetRegion);

                this.showNotification(`Категория удалена из региона "${targetRegion}". Услуг перемещено: ${affectedTemplates.length}`);
            }

            addCategoryFromManager() {
                const nameElement = document.getElementById('category-manager-name');
                const iconElement = document.getElementById('category-manager-icon');

                if (!nameElement || !iconElement) return;

                const name = nameElement.value.trim();
                const icon = iconElement.value;

                if (!name) {
                    this.showNotification('Введите название категории', true);
                    return;
                }

                // Используем выбранный регион для просмотра (или текущий)
                const targetRegion = this.selectedRegionForView || this.currentRegion;

                // Загружаем категории целевого региона
                const categoriesKey = `quoteCalc_categories_${targetRegion}`;
                let categories = JSON.parse(localStorage.getItem(categoriesKey) || '[]');

                // Генерируем ID из названия, для кириллицы используем timestamp
                let categoryId = name.toLowerCase()
                    .replace(/\s+/g, '_')
                    .replace(/[^a-z0-9_]/g, '');

                // Если после очистки ID пустой (например, кириллическое название),
                // используем timestamp для уникальности
                if (!categoryId || categoryId === '') {
                    categoryId = 'cat_' + Date.now();
                }

                // Check if category already exists
                const exists = categories.find(c =>
                    c.name.toLowerCase() === name.toLowerCase() ||
                    c.id === categoryId
                );

                if (exists) {
                    this.showNotification('Категория уже существует', true);
                    return;
                }

                const category = {
                    id: categoryId,
                    name: name,
                    icon: icon
                };

                console.log('Creating new category in region:', targetRegion, category);

                // Добавляем категорию в целевой регион
                categories.push(category);
                localStorage.setItem(categoriesKey, JSON.stringify(categories));

                // Если это текущий регион - обновляем локальные категории
                if (targetRegion === this.currentRegion) {
                    this.categories = categories;
                    this.renderCategories();
                    this.renderCategoryOptions();
                }

                // Обновляем отображение категорий
                this.loadCategoriesForRegionView(targetRegion);

                // Clear inputs
                nameElement.value = '';
                iconElement.selectedIndex = 0;

                this.showNotification('Категория добавлена');
            }

            renderCategoryOptions() {
                const select = document.getElementById('catalog-category');
                if (!select) return;

                // Фильтруем системные категории - их нельзя выбирать вручную при создании услуг
                const selectableCategories = this.categories.filter(cat => !cat.system);

                select.innerHTML = selectableCategories.map(cat => `
                    <option value="${cat.id}">${cat.icon} ${cat.name}</option>
                `).join('');
            }

            showCategoryModal() {
                const modal = document.getElementById('category-modal');
                if (modal) {
                    modal.classList.add('show');
                    setTimeout(() => {
                        const nameInput = document.getElementById('category-name');
                        if (nameInput) nameInput.focus();
                    }, 300);
                }
            }

            hideCategoryModal() {
                const modal = document.getElementById('category-modal');
                if (modal) {
                    modal.classList.remove('show');
                    const nameInput = document.getElementById('category-name');
                    if (nameInput) nameInput.value = '';
                }
            }

            addCategory() {
                const nameElement = document.getElementById('category-name');
                const iconElement = document.getElementById('category-icon');

                if (!nameElement || !iconElement) return;

                const name = nameElement.value.trim();
                const icon = iconElement.value;

                if (!name) {
                    this.showNotification('Введите название категории', true);
                    return;
                }

                // Генерируем ID из названия, для кириллицы используем timestamp
                let categoryId = name.toLowerCase()
                    .replace(/\s+/g, '_')
                    .replace(/[^a-z0-9_]/g, '');

                // Если после очистки ID пустой (например, кириллическое название),
                // используем timestamp для уникальности
                if (!categoryId || categoryId === '') {
                    categoryId = 'cat_' + Date.now();
                }

                // Check if category already exists
                const exists = this.categories.find(c =>
                    c.name.toLowerCase() === name.toLowerCase() ||
                    c.id === categoryId
                );

                if (exists) {
                    this.showNotification('Категория уже существует', true);
                    return;
                }

                const category = {
                    id: categoryId,
                    name: name,
                    icon: icon
                };

                console.log('Creating new category:', category);
                this.categories.push(category);
                this.saveCategories();
                this.renderCategories();
                this.renderCategoryOptions();
                this.hideCategoryModal();
                this.showNotification('Категория добавлена');
            }

            // External catalog loading
            async loadExternalCatalog() {
                // Этот метод больше не используется - каталоги загружаются через loadCatalogForRegion()
                // Оставлен для совместимости со старым кодом
                return;
            }

            // ===== NEW JSON FUNCTIONS =====

            // JSON Catalog functions
            // ===== FILE SYSTEM ACCESS API METHODS =====

            // IndexedDB для сохранения handle папки
            async saveFolderHandleToIndexedDB(handle) {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('QuoteCalcDB', 1);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('folderHandles')) {
                            db.createObjectStore('folderHandles');
                        }
                    };

                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction(['folderHandles'], 'readwrite');
                        const store = transaction.objectStore('folderHandles');
                        store.put(handle, 'catalogFolder');

                        transaction.oncomplete = () => {
                            db.close();
                            resolve();
                        };

                        transaction.onerror = () => {
                            db.close();
                            reject(transaction.error);
                        };
                    };

                    request.onerror = () => reject(request.error);
                });
            }

            async loadFolderHandleFromIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('QuoteCalcDB', 1);

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('folderHandles')) {
                            db.createObjectStore('folderHandles');
                        }
                    };

                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction(['folderHandles'], 'readonly');
                        const store = transaction.objectStore('folderHandles');
                        const getRequest = store.get('catalogFolder');

                        getRequest.onsuccess = () => {
                            db.close();
                            resolve(getRequest.result);
                        };

                        getRequest.onerror = () => {
                            db.close();
                            reject(getRequest.error);
                        };
                    };

                    request.onerror = () => reject(request.error);
                });
            }

            selectCatalogFolder() {
                console.log('selectCatalogFolder called', new Error().stack);

                // Защита от двойного вызова
                if (this._isSelectingFolder) {
                    console.log('Folder selection already in progress, ignoring...');
                    return Promise.resolve();
                }
                this._isSelectingFolder = true;
                console.log('Starting folder selection...');

                // Используем showDirectoryPicker с дополнительной защитой
                if (!('showDirectoryPicker' in window)) {
                    this.showNotification('Ваш браузер не поддерживает выбор папки. Используйте Chrome, Edge или другой современный браузер.', true);
                    this._isSelectingFolder = false;
                    return Promise.resolve();
                }

                // КРИТИЧНО: вызываем showDirectoryPicker СИНХРОННО!
                console.log('Calling showDirectoryPicker synchronously...');
                const pickerPromise = window.showDirectoryPicker({
                    mode: 'readwrite',
                    startIn: 'downloads'
                });

                // Теперь обрабатываем промис
                return pickerPromise.then(selectedHandle => {
                    console.log('Directory selected:', selectedHandle.name);

                    // Сохраняем сразу без проверки разрешений (разрешение дается автоматически при выборе)
                    this.catalogDirectoryHandle = selectedHandle;
                    this.state.saveFolder = selectedHandle.name;
                    localStorage.setItem('quoteCalc_catalogFolder', this.state.saveFolder);

                    console.log('Folder configured:', this.catalogDirectoryHandle);

                    // Сохраняем handle в IndexedDB
                    return this.saveFolderHandleToIndexedDB(this.catalogDirectoryHandle);
                }).then(() => {
                    this.showNotification(`Папка выбрана: ${this.state.saveFolder}`);
                    this.updateCatalogFolderDisplay();
                    this._isSelectingFolder = false;
                }).catch(error => {
                    console.error('selectCatalogFolder error:', error);
                    this._isSelectingFolder = false;

                    if (error.name !== 'AbortError') {
                        this.showNotification('Ошибка выбора папки: ' + error.message, true);
                    }
                });
            }

            async saveFileToSelectedFolder(filename, content) {
                try {
                    console.log('saveFileToSelectedFolder called, handle exists:', !!this.catalogDirectoryHandle);

                    if (!this.catalogDirectoryHandle) {
                        throw new Error('Папка не выбрана');
                    }

                    // Проверяем разрешение перед сохранением
                    const permission = await this.catalogDirectoryHandle.queryPermission({ mode: 'readwrite' });
                    console.log('Permission before save:', permission);

                    if (permission !== 'granted') {
                        throw new Error('Нет доступа к папке (требуется повторный выбор)');
                    }

                    // Создаём или перезаписываем файл
                    const fileHandle = await this.catalogDirectoryHandle.getFileHandle(filename, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(content);
                    await writable.close();

                    console.log('File saved successfully:', filename);
                    return true;
                } catch (error) {
                    console.error('saveFileToSelectedFolder error:', error);
                    throw new Error('Не удалось сохранить файл: ' + error.message);
                }
            }

            updateCatalogFolderDisplay() {
                const displayElement = document.getElementById('catalog-folder-display');
                const buttonElement = document.getElementById('select-folder-btn');

                if (displayElement) {
                    if (this.catalogDirectoryHandle && this.state.saveFolder) {
                        // Папка выбрана и доступ есть
                        displayElement.innerHTML = `
                            <div style="padding: calc(var(--spacing) * 1); background: var(--success-light); border: 1px solid var(--success); border-radius: var(--radius);">
                                <div class="text-xs" style="color: var(--success-dark); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i data-lucide="folder" style="width: 12px; height: 12px;"></i> .../${this.state.saveFolder}</div>
                            </div>
                        `;
                        if (buttonElement) {
                            buttonElement.textContent = 'Изменить папку';
                        }
                    } else if (this.state.saveFolder) {
                        // Папка была выбрана, но доступа нет (требуется повторный выбор)
                        displayElement.innerHTML = `
                            <div style="padding: calc(var(--spacing) * 1); background: #fef3c7; border: 1px solid #f59e0b; border-radius: var(--radius);">
                                <div class="text-xs" style="color: #92400e; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">⚠️ .../${this.state.saveFolder} (требуется повторный выбор)</div>
                            </div>
                        `;
                        if (buttonElement) {
                            buttonElement.textContent = 'Выбрать папку заново';
                        }
                    } else {
                        // Папка не выбрана
                        displayElement.innerHTML = `
                            <div style="padding: calc(var(--spacing) * 1); background: var(--gray-100); border: 1px solid var(--gray-200); border-radius: var(--radius);">
                                <span class="text-xs text-muted">Не выбрана</span>
                            </div>
                        `;
                        if (buttonElement) {
                            buttonElement.textContent = 'Выбрать папку';
                        }
                    }
                    // Инициализация Lucide иконок
                    lucide.createIcons();
                }
            }

            async saveCatalogJSON() {
                try {
                    console.log('saveCatalogJSON called, catalogDirectoryHandle:', !!this.catalogDirectoryHandle);

                    // Собираем каталоги всех регионов
                    const allRegions = {};
                    let totalServices = 0;
                    let totalCategories = 0;

                    for (const region of this.regions) {
                        const templatesKey = `quoteCalc_templates_${region}`;
                        const categoriesKey = `quoteCalc_categories_${region}`;

                        const templates = JSON.parse(localStorage.getItem(templatesKey) || '[]');
                        const categories = JSON.parse(localStorage.getItem(categoriesKey) || '[]');

                        allRegions[region] = {
                            templates: templates,
                            categories: categories
                        };

                        totalServices += templates.length;
                        totalCategories += categories.length;
                    }

                    const catalogData = {
                        version: this.CATALOG_VERSION,
                        appVersion: this.APP_VERSION,
                        timestamp: new Date().toISOString(),
                        currentRegion: this.currentRegion,
                        regions: this.regions,
                        regionData: allRegions,
                        metadata: {
                            totalRegions: this.regions.length,
                            totalServices: totalServices,
                            totalCategories: totalCategories,
                            createdBy: 'Quote Calculator v' + this.APP_VERSION
                        }
                    };

                    const jsonString = JSON.stringify(catalogData, null, 2);
                    const filename = 'catalog.json';

                    // Если выбрана папка, сохраняем туда
                    if (this.catalogDirectoryHandle) {
                        console.log('Saving to selected folder:', this.state.saveFolder);
                        await this.saveFileToSelectedFolder(filename, jsonString);
                        this.showNotification(`Каталог сохранён (${this.regions.length} регионов, ${totalServices} услуг)`);

                        // Автоматически создаём бэкап
                        await this.createBackup();
                    } else {
                        console.log('No folder selected, saving to downloads');
                        // Иначе используем стандартную загрузку
                        this.downloadJSON(jsonString, filename);
                        this.showNotification(`Каталог сохранен (${this.regions.length} регионов, ${totalServices} услуг)`);
                    }
                } catch (error) {
                    this.showNotification('Ошибка сохранения каталога: ' + error.message, true);
                }
            }

            async saveQuoteJSON() {
                try {
                    const quoteData = {
                        version: this.QUOTE_VERSION,
                        appVersion: this.APP_VERSION,
                        timestamp: new Date().toISOString(),
                        metadata: {
                            paxCount: this.state.paxCount,
                            tourStart: this.state.tourStart,
                            tourEnd: this.state.tourEnd,
                            clientName: this.state.clientName,
                            clientPhone: this.state.clientPhone,
                            clientEmail: this.state.clientEmail,
                            quoteComments: this.state.quoteComments,
                            programDescription: this.state.programDescription,
                            accommodations: this.state.accommodations,
                            bookingTerms: this.state.bookingTerms,
                            hiddenMarkup: this.state.hiddenMarkup,
                            partnerCommission: this.state.partnerCommission
                        },
                        services: this.state.services,
                        hotels: this.state.hotels || [],
                        flights: this.state.flights || [],
                        otherServices: this.state.otherServices || [],
                        optionalServices: this.state.optionalServices || [],
                        calculations: {
                            baseCost: this.calculateBaseCost(),
                            totalProfit: this.calculateTotalProfit(),
                            clientTotal: this.calculateClientTotal()
                        }
                    };

                    const jsonString = JSON.stringify(quoteData, null, 2);

                    // Если есть fileHandle - перезаписываем существующий файл
                    if (this.currentFileHandle && 'createWritable' in FileSystemFileHandle.prototype) {
                        try {
                            const writable = await this.currentFileHandle.createWritable();
                            await writable.write(jsonString);
                            await writable.close();

                            this.state.isQuoteSaved = true;
                            this.updateQuoteStatusBar();

                            // Сохраняем последнюю смету для автозагрузки
                            localStorage.setItem('quoteCalc_lastQuote', jsonString);
                            localStorage.setItem('quoteCalc_lastQuoteFileName', this.state.currentQuoteFile);

                            // Очищаем автосохранение (смета теперь сохранена в файл)
                            localStorage.removeItem('quoteCalc_autosave');
                            localStorage.removeItem('quoteCalc_autosave_timestamp');

                            this.showNotification(`Смета сохранена: ${this.state.currentQuoteFile}`);
                            return;
                        } catch (error) {
                            console.warn('Не удалось перезаписать файл:', error);
                            // Fallback на обычное сохранение
                        }
                    }

                    // Улучшенный нейминг: ФИО заказчика + дата + количество человек
                    let filename = '';

                    if (this.state.clientName) {
                        filename += this.state.clientName.replace(/[^a-zA-Z0-9а-яА-Я\s]/g, '').replace(/\s+/g, '_');
                    } else {
                        filename += 'Смета';
                    }

                    if (this.state.tourStart) {
                        filename += `_${this.state.tourStart}`;
                    } else {
                        const today = new Date().toISOString().split('T')[0];
                        filename += `_${today}`;
                    }

                    if (this.state.paxCount && this.state.paxCount > 0) {
                        filename += `_${this.state.paxCount}pax`;
                    }

                    filename += '.json';

                    // Пытаемся сохранить в выбранную папку
                    const savedToFolder = await this.saveToSelectedFolder(jsonString, filename);

                    if (!savedToFolder) {
                        // Если не удалось сохранить в выбранную папку, используем обычное скачивание
                        this.downloadJSON(jsonString, filename);

                        // Обновляем статус даже при обычном скачивании
                        this.state.currentQuoteFile = filename;
                        this.state.isQuoteSaved = true;
                        this.updateQuoteStatusBar();

                        // Очищаем автосохранение (смета теперь сохранена в файл)
                        localStorage.removeItem('quoteCalc_autosave');
                        localStorage.removeItem('quoteCalc_autosave_timestamp');

                        if (this.state.saveFolder) {
                            this.showNotification(`Файл скачан. Переместите в папку: ${this.state.saveFolder}`);
                        } else {
                            this.showNotification('Смета сохранена в JSON формате');
                        }
                    } else {
                        // Очищаем автосохранение (смета теперь сохранена в файл)
                        localStorage.removeItem('quoteCalc_autosave');
                        localStorage.removeItem('quoteCalc_autosave_timestamp');

                        this.showNotification(`Смета сохранена в папку: ${this.state.saveFolder}`);
                    }
                } catch (error) {
                    this.showNotification('Ошибка сохранения сметы: ' + error.message, true);
                }
            }

            // Helper calculation functions for JSON
            calculateBaseCost() {
                // Считаем все секции
                const servicesTotal = this.state.services.reduce((sum, service) => {
                    return sum + (service.price * service.quantity);
                }, 0);

                const hotelsTotal = this.state.hotels.reduce((sum, service) => {
                    return sum + (service.price * service.quantity);
                }, 0);

                const flightsTotal = this.state.flights.reduce((sum, service) => {
                    return sum + (service.price * service.quantity);
                }, 0);

                const otherTotal = this.state.otherServices.reduce((sum, service) => {
                    return sum + (service.price * service.quantity);
                }, 0);

                return servicesTotal + hotelsTotal + flightsTotal + otherTotal;
            }

            calculateTotalProfit() {
                // Базовая стоимость всех услуг
                const baseCost = this.calculateBaseCost();

                // Базовая стоимость только неисключенных услуг для скрытой маржи
                const baseCostForHiddenMarkup = [
                    ...this.state.services,
                    ...this.state.hotels,
                    ...this.state.flights,
                    ...this.state.otherServices
                ].reduce((sum, service) => {
                    if (!service.excludeFromMarkup) {
                        return sum + (service.price * service.quantity);
                    }
                    return sum;
                }, 0);

                const individualMarkupAmount = [
                    ...this.state.services,
                    ...this.state.hotels,
                    ...this.state.flights,
                    ...this.state.otherServices
                ].reduce((sum, service) => {
                    const serviceCost = service.price * service.quantity;
                    const serviceWithMarkup = this.calculateServiceTotal(service);
                    return sum + (serviceWithMarkup - serviceCost);
                }, 0);

                const hiddenMarkupAmount = baseCostForHiddenMarkup * (this.state.hiddenMarkup / 100);
                return individualMarkupAmount + hiddenMarkupAmount;
            }

            calculateClientTotal() {
                const totalWithIndividualMarkup = [
                    ...this.state.services,
                    ...this.state.hotels,
                    ...this.state.flights,
                    ...this.state.otherServices
                ].reduce((sum, service) => {
                    return sum + this.calculateServiceTotal(service);
                }, 0);

                // Базовая стоимость только неисключенных услуг для скрытой маржи (из всех секций)
                const baseCostForHiddenMarkup = [
                    ...this.state.services,
                    ...this.state.hotels,
                    ...this.state.flights,
                    ...this.state.otherServices
                ].reduce((sum, service) => {
                    if (!service.excludeFromMarkup) {
                        return sum + (service.price * service.quantity);
                    }
                    return sum;
                }, 0);

                const hiddenMarkupAmount = baseCostForHiddenMarkup * (this.state.hiddenMarkup / 100);
                const taxAmount = totalWithIndividualMarkup * (this.state.taxRate / 100);
                return totalWithIndividualMarkup + hiddenMarkupAmount + taxAmount;
            }

            // Автосохранение сметы в localStorage
            autoSaveQuote() {
                try {
                    // Сохраняем только если есть хоть одна услуга
                    if (this.state.services.length === 0 && this.state.optionalServices.length === 0 &&
                        this.state.hotels.length === 0 && this.state.flights.length === 0 && this.state.otherServices.length === 0) {
                        return;
                    }

                    const quoteData = {
                        version: this.QUOTE_VERSION,
                        appVersion: this.APP_VERSION,
                        timestamp: new Date().toISOString(),
                        autosave: true, // Флаг автосохранения
                        metadata: {
                            paxCount: this.state.paxCount,
                            tourStart: this.state.tourStart,
                            tourEnd: this.state.tourEnd,
                            clientName: this.state.clientName,
                            clientPhone: this.state.clientPhone,
                            clientEmail: this.state.clientEmail,
                            quoteComments: this.state.quoteComments,
                            programDescription: this.state.programDescription,
                            accommodations: this.state.accommodations,
                            bookingTerms: this.state.bookingTerms,
                            hiddenMarkup: this.state.hiddenMarkup,
                            partnerCommission: this.state.partnerCommission
                        },
                        services: this.state.services,
                        optionalServices: this.state.optionalServices || [],
                        hotels: this.state.hotels || [],
                        flights: this.state.flights || [],
                        otherServices: this.state.otherServices || [],
                        calculations: {
                            baseCost: this.calculateBaseCost(),
                            totalProfit: this.calculateTotalProfit(),
                            clientTotal: this.calculateClientTotal()
                        }
                    };

                    const jsonString = JSON.stringify(quoteData);
                    localStorage.setItem('quoteCalc_autosave', jsonString);
                    localStorage.setItem('quoteCalc_autosave_timestamp', Date.now().toString());

                    console.log('Автосохранение выполнено');
                } catch (error) {
                    console.warn('Ошибка автосохранения:', error);
                }
            }

            // Download JSON helper
            downloadJSON(jsonString, filename) {
                try {
                    const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    this.showNotification('Ошибка загрузки файла: ' + error.message, true);
                }
            }

            // JSON Load functions
            loadCatalogJSON(event) {
                const file = event.target.files[0];
                if (!file) return;

                // File size validation
                if (file.size > this.config.maxFileSize) {
                    this.showNotification(`Файл слишком большой (${(file.size/1024/1024).toFixed(1)}MB). Максимум 5MB`, true);
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);

                        // Version validation
                        if (!jsonData.version) {
                            this.showNotification('Файл не содержит информации о версии', true);
                            return;
                        }

                        if (jsonData.version > this.CATALOG_VERSION) {
                            this.showNotification(`Файл создан в более новой версии (${jsonData.version}). Текущая версия: ${this.CATALOG_VERSION}`, true);
                            return;
                        }

                        // Проверяем формат файла
                        const isMultiRegionFormat = jsonData.regionData && jsonData.regions;

                        if (isMultiRegionFormat) {
                            // НОВЫЙ ФОРМАТ: несколько регионов
                            const totalServices = jsonData.metadata?.totalServices || 0;
                            const message = `Загрузка каталога заменит все существующие данные.\n\nФайл содержит:\n- ${jsonData.regions.length} регионов\n- ${totalServices} услуг\n\nРекомендуем создать резервную копию.\n\nПродолжить?`;

                            if (!confirm(message)) {
                                event.target.value = '';
                                return;
                            }

                            // Загружаем регионы
                            this.regions = jsonData.regions;
                            localStorage.setItem('quoteCalc_regions', JSON.stringify(this.regions));

                            // Загружаем каталоги всех регионов
                            for (const region of this.regions) {
                                const regionData = jsonData.regionData[region];
                                if (regionData) {
                                    const templatesKey = `quoteCalc_templates_${region}`;
                                    const categoriesKey = `quoteCalc_categories_${region}`;

                                    // Добавляем region к каждому шаблону
                                    const templatesWithRegion = (regionData.templates || []).map(t => ({
                                        ...t,
                                        region: t.region || region // Используем region из шаблона или имя региона
                                    }));

                                    localStorage.setItem(templatesKey, JSON.stringify(templatesWithRegion));
                                    localStorage.setItem(categoriesKey, JSON.stringify(regionData.categories || []));
                                }
                            }

                            // Переключаемся на регион из файла (или первый)
                            const targetRegion = jsonData.currentRegion || this.regions[0];
                            this.currentRegion = targetRegion;
                            localStorage.setItem('quoteCalc_currentRegion', this.currentRegion);

                            // Загружаем каталог текущего региона
                            this.loadCatalogForRegion(this.currentRegion);

                            this.showNotification(`Каталог загружен: ${jsonData.regions.length} регионов, ${totalServices} услуг`);

                        } else {
                            // СТАРЫЙ ФОРМАТ: один регион (обратная совместимость)
                            const message = `Загрузка нового каталога заменит услуги текущего региона "${this.currentRegion}".\n\nРекомендуем создать резервную копию.\n\nПродолжить?`;
                            if (!confirm(message)) {
                                event.target.value = '';
                                return;
                            }

                            // Применяем к текущему региону
                            if (jsonData.categories) {
                                this.categories = jsonData.categories;
                                this.saveCategories();
                            }

                            if (jsonData.templates) {
                                // Добавляем region к каждому шаблону
                                this.templates = jsonData.templates.map(t => ({
                                    ...t,
                                    region: t.region || this.currentRegion
                                }));
                                this.saveToLocalStorage();
                            }

                            // Проверяем и исправляем категории
                            this.validateAndFixTemplateCategories();

                            // Обновляем UI
                            this.renderCategories();
                            this.renderCategoryOptions();
                            this.renderTemplates();
                            this.renderRegionsManager();

                            this.showNotification(`Каталог загружен в регион "${this.currentRegion}": ${jsonData.templates?.length || 0} услуг`);
                        }

                    } catch (error) {
                        this.showNotification('Ошибка загрузки JSON: ' + error.message, true);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }

            loadQuoteJSON(event) {
                const file = event.target.files[0];
                if (!file) return;

                // File size validation
                if (file.size > this.config.maxFileSize) {
                    this.showNotification(`Файл слишком большой (${(file.size/1024/1024).toFixed(1)}MB). Максимум 5MB`, true);
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const quoteData = JSON.parse(e.target.result);
                        
                        // Version validation
                        if (!quoteData.version) {
                            this.showNotification('Файл не содержит информации о версии', true);
                            return;
                        }

                        if (quoteData.version > this.QUOTE_VERSION) {
                            this.showNotification(`Файл создан в более новой версии (${quoteData.version}). Текущая версия: ${this.QUOTE_VERSION}`, true);
                            return;
                        }

                        // Apply metadata (с миграцией старых полей)
                        if (quoteData.metadata) {
                            // Копируем metadata с переименованием quoteDescription → quoteComments
                            const metadata = { ...quoteData.metadata };
                            // Миграция: если есть старое поле quoteDescription, переименуем в quoteComments
                            if ('quoteDescription' in metadata && !('quoteComments' in metadata)) {
                                metadata.quoteComments = metadata.quoteDescription;
                                delete metadata.quoteDescription;
                            }
                            Object.assign(this.state, metadata);
                        }

                        // Apply services с обеспечением совместимости
                        if (quoteData.services) {
                            this.state.services = quoteData.services.map(service => ({
                                ...service,
                                excludeFromMarkup: service.excludeFromMarkup || false,
                                fullProfit: service.fullProfit || false,
                                region: service.region || this.currentRegion // Для старых файлов без региона
                            }));
                            this.state.selectedServices = new Set();
                        }

                        // Apply optional services
                        if (quoteData.optionalServices) {
                            this.state.optionalServices = quoteData.optionalServices.map(service => ({
                                ...service,
                                excludeFromMarkup: service.excludeFromMarkup || false,
                                fullProfit: service.fullProfit || false,
                                region: service.region || this.currentRegion // Для старых файлов без региона
                            }));
                        } else {
                            this.state.optionalServices = [];
                        }

                        // Apply hotels
                        if (quoteData.hotels) {
                            this.state.hotels = quoteData.hotels.map(service => ({
                                ...service,
                                excludeFromMarkup: service.excludeFromMarkup || false,
                                fullProfit: service.fullProfit || false,
                                region: service.region || this.currentRegion
                            }));
                        } else {
                            this.state.hotels = [];
                        }

                        // Apply flights
                        if (quoteData.flights) {
                            this.state.flights = quoteData.flights.map(service => ({
                                ...service,
                                excludeFromMarkup: service.excludeFromMarkup || false,
                                fullProfit: service.fullProfit || false,
                                region: service.region || this.currentRegion
                            }));
                        } else {
                            this.state.flights = [];
                        }

                        // Apply other services
                        if (quoteData.otherServices) {
                            this.state.otherServices = quoteData.otherServices.map(service => ({
                                ...service,
                                excludeFromMarkup: service.excludeFromMarkup || false,
                                fullProfit: service.fullProfit || false,
                                region: service.region || this.currentRegion
                            }));
                        } else {
                            this.state.otherServices = [];
                        }

                        this.loadStateToUI();
                        this.renderServices();
                        this.renderOptionalServices();
                        this.renderHotels();
                        this.renderFlights();
                        this.renderOtherServices();
                        this.updateCalculations();

                        // Обновляем статус файла
                        this.state.currentQuoteFile = file.name;
                        this.state.isQuoteSaved = true;
                        this.updateQuoteStatusBar();
                        this.updateFiltersVisibility();

                        this.showNotification(`Смета загружена (версия ${quoteData.version}): ${quoteData.services?.length || 0} услуг`);

                    } catch (error) {
                        this.showNotification('Ошибка загрузки JSON: ' + error.message, true);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }

            // Universal file load functions
            loadCatalogFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (extension === 'json') {
                    this.loadCatalogJSON(event);
                } else if (extension === 'csv') {
                    this.loadCatalogCSV(event);
                } else {
                    this.showNotification('Поддерживаются только файлы .json и .csv', true);
                    event.target.value = '';
                }
            }

            loadQuoteFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const extension = file.name.split('.').pop().toLowerCase();
                
                if (extension === 'json') {
                    this.loadQuoteJSON(event);
                } else if (extension === 'csv') {
                    this.loadQuoteCSV(event);
                } else {
                    this.showNotification('Поддерживаются только файлы .json и .csv', true);
                    event.target.value = '';
                }
            }

            // ===== ENHANCED CSV FUNCTIONS WITH FILE SIZE VALIDATION =====

            saveCatalogCSV() {
                try {
                    // Предлагаем создать бэкап перед перезаписью
                    if (this.templates.length > 0) {
                        if (confirm('Создать резервную копию каталога перед сохранением?')) {
                            this.createBackup();
                        }
                    }
                    
                    const headers = ['type', 'id', 'name', 'category', 'description', 'contractor', 'icon', 'price'];
                    const rows = [];
                    
                    // Сначала сохранить категории
                    this.categories.forEach(cat => {
                        rows.push([
                            'category',
                            this.escapeCSVField(cat.id),
                            this.escapeCSVField(cat.name),
                            '', // category empty for categories themselves
                            '', // description empty for categories
                            '', // contractor empty for categories  
                            this.escapeCSVField(cat.icon),
                            '' // price empty for categories
                        ]);
                    });
                    
                    // Затем сохранить услуги
                    this.templates.forEach(t => {
                        rows.push([
                            'service',
                            this.escapeCSVField(t.id),
                            this.escapeCSVField(t.name),
                            this.escapeCSVField(t.category),
                            this.escapeCSVField(t.description || ''),
                            this.escapeCSVField(t.contractor || ''),
                            this.escapeCSVField(t.icon),
                            this.escapeCSVField(t.price)
                        ]);
                    });

                    const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
                    this.downloadCSV(csv, 'catalog.csv');
                    this.showNotification('Каталог сохранен');
                } catch (error) {
                    this.showNotification('Ошибка сохранения каталога: ' + error.message, true);
                }
            }

            async createBackup() {
                try {
                    if (this.templates.length === 0) {
                        // Тихо выходим, если каталог пуст (автоматический бэкап)
                        return;
                    }

                    // Сохраняем в JSON формате (более надёжный чем CSV)
                    const backupData = {
                        version: this.CATALOG_VERSION,
                        exportDate: new Date().toISOString(),
                        categories: this.categories,
                        templates: this.templates,
                        categoryStats: this.categoryStats,
                        globalStats: this.globalStats
                    };

                    // Фиксированное имя файла для перезаписи
                    const backupFilename = 'catalog_backup.json';
                    const jsonStr = JSON.stringify(backupData, null, 2);

                    // Если выбрана папка, сохраняем туда
                    if (this.catalogDirectoryHandle) {
                        await this.saveFileToSelectedFolder(backupFilename, jsonStr);
                        console.log('Автоматический бэкап создан в папке:', this.state.saveFolder);
                    } else {
                        // Иначе используем стандартную загрузку
                        this.downloadJSON(jsonStr, backupFilename);
                        console.log('Автоматический бэкап создан:', backupFilename);
                    }
                } catch (error) {
                    console.error('Ошибка создания автобэкапа:', error.message);
                }
            }

            // ===== IMPORT/EXPORT ALL DATA =====

            async handleExportAll() {
                try {
                    // Собираем все данные из localStorage и БД
                    const exportData = {
                        version: this.APP_VERSION,
                        exportDate: new Date().toISOString(),
                        metadata: {
                            appVersion: this.APP_VERSION,
                            catalogVersion: this.CATALOG_VERSION,
                            quoteVersion: this.QUOTE_VERSION
                        },
                        // Каталоги всех регионов
                        catalogs: {},
                        // Сметы из БД (через API)
                        estimates: [],
                        // Настройки
                        settings: {
                            currentRegion: this.currentRegion,
                            regions: this.regions,
                            hiddenMarkup: this.state.hiddenMarkup,
                            partnerCommission: this.state.partnerCommission
                        }
                    };

                    // Экспорт каталогов всех регионов из localStorage
                    for (const region of this.regions) {
                        const templatesKey = `quoteCalc_templates_${region}`;
                        const categoriesKey = `quoteCalc_categories_${region}`;

                        const templates = JSON.parse(localStorage.getItem(templatesKey) || '[]');
                        const categories = JSON.parse(localStorage.getItem(categoriesKey) || '[]');

                        exportData.catalogs[region] = {
                            templates,
                            categories
                        };
                    }

                    // Получение всех смет из БД через API
                    try {
                        const response = await this.apiClient.request('/api/estimates', 'GET');
                        if (response.success && response.data) {
                            exportData.estimates = response.data.map(est => ({
                                id: est.id,
                                filename: est.filename,
                                data: est.data,
                                data_version: est.data_version,
                                created_at: est.created_at,
                                updated_at: est.updated_at
                            }));
                        }
                    } catch (apiError) {
                        console.warn('Не удалось загрузить сметы из БД:', apiError);
                        this.showNotification('Предупреждение: сметы не экспортированы', false);
                    }

                    // Сохранение в файл
                    const jsonString = JSON.stringify(exportData, null, 2);
                    const filename = `quote_calculator_backup_${new Date().toISOString().split('T')[0]}.json`;

                    this.downloadJSON(jsonString, filename);
                    this.showNotification(`Экспорт завершён: ${exportData.estimates.length} смет, ${this.regions.length} регионов`);
                } catch (error) {
                    console.error('Ошибка экспорта:', error);
                    this.showNotification('Ошибка экспорта данных: ' + error.message, true);
                }
            }

            async handleImportAll(event) {
                const file = event.target.files[0];
                if (!file) return;

                // File size validation
                if (file.size > 50 * 1024 * 1024) { // 50MB max
                    this.showNotification('Файл слишком большой (макс 50MB)', true);
                    event.target.value = '';
                    return;
                }

                // Сохраняем контекст this для использования в reader.onload
                const self = this;

                const reader = new FileReader();
                reader.onload = async (e) => {
    try {
        const json = JSON.parse(e.target.result);

        if (!json.version) {
            throw new Error("Неверный формат файла: отсутствует версия");
        }

        // Поддержка ОБОИХ форматов:
        // Новый: { version, data: { estimates, catalogs, ... } }
        // Старый: { version, catalogs, regionData, ... }
        let data;
        if (json.data) {
            // Новый формат
            data = json.data;
        } else {
            // Старый формат - оборачиваем в data
            data = {
                estimates: json.estimates || [],
                catalogs: json.catalogs || json.regionData || [],
                settings: json.settings || null,
                backups: json.backups || []
            };
        }

        const estimates = data.estimates || [];
        const catalogs = data.catalogs || [];
        const settings = data.settings || null;
        const backups = data.backups || [];

        // DEBUG: Логируем структуру данных
        console.log('Parsed import data:', {
            estimates: estimates.length,
            catalogs: catalogs,
            catalogsType: typeof catalogs,
            catalogsIsArray: Array.isArray(catalogs),
            settings: settings,
            backups: backups.length
        });

        // Подсчёт каталогов
        const catalogsCount = typeof catalogs === 'object' && !Array.isArray(catalogs)
            ? Object.keys(catalogs).length
            : 0;

        if (!confirm(
            `Импортировать данные?\n\n` +
            `Сметы: ${estimates.length}\n` +
            `Регионы/Каталоги: ${catalogsCount}\n` +
            `Настройки: ${settings ? 'Да' : 'Нет'}\n\n` +
            `Текущие данные будут обновлены!`
        )) {
            event.target.value = "";
            return;
        }

        let importedEstimates = 0;
        let importedCatalogs = 0;

        // 1. ИМПОРТ КАТАЛОГОВ через API (по регионам)
        console.log('Starting catalogs import...');
        if (Array.isArray(catalogs)) {
            // Проверяем формат массива
            if (catalogs.length > 0 && catalogs[0].filename && catalogs[0].data) {
                // ✅ FIX: Новый формат экспорта с filename и data
                console.log(`Export format: importing ${catalogs.length} catalogs with filename and data structure`);

                // ✅ FIX: Группируем каталоги по региону и объединяем templates
                // Проблема: несколько файлов могут быть для одного региона (catalog.json, catalog copy.json, catalog_Ushuaia.json)
                // UPSERT перезаписывает, поэтому последний файл (часто с 0 templates) затирает предыдущие
                // Решение: объединяем templates из всех файлов одного региона
                const catalogsByRegion = {};

                for (const catalogItem of catalogs) {
                    const catalogData = catalogItem.data;
                    const region = catalogData.region || 'Unknown';
                    const templates = catalogData.templates || [];
                    const categories = catalogData.categories || [];

                    console.log(`Reading catalog file: ${catalogItem.filename} for region ${region} (${templates.length} templates)`);

                    // Инициализация региона если ещё не существует
                    if (!catalogsByRegion[region]) {
                        catalogsByRegion[region] = {
                            templates: [],
                            categories: [],
                            filesCount: 0
                        };
                    }

                    catalogsByRegion[region].filesCount++;

                    // Merge templates - дедупликация по ID
                    const existingTemplateIds = new Set(catalogsByRegion[region].templates.map(t => t.id));
                    for (const template of templates) {
                        if (!existingTemplateIds.has(template.id)) {
                            catalogsByRegion[region].templates.push(template);
                            existingTemplateIds.add(template.id);
                        }
                    }

                    // Merge categories - дедупликация по ID
                    const existingCategoryIds = new Set(catalogsByRegion[region].categories.map(c => c.id));
                    for (const category of categories) {
                        if (category.id && !existingCategoryIds.has(category.id)) {
                            catalogsByRegion[region].categories.push(category);
                            existingCategoryIds.add(category.id);
                        }
                    }
                }

                // Сохраняем по одному каталогу на регион с объединёнными templates
                for (const [region, data] of Object.entries(catalogsByRegion)) {
                    console.log(`Importing merged catalog for region: ${region} (${data.templates.length} templates from ${data.filesCount} files)`);

                    try {
                        const response = await self.apiClient.saveCatalog(region, {
                            templates: data.templates,
                            categories: data.categories,
                            region: region  // ✅ Добавляем region в data для сохранения в БД
                        }, 'organization');

                        if (response.success) {
                            console.log(`✓ Successfully imported catalog: ${region} (${data.templates.length} templates, ${data.categories.length} categories)`);
                            importedCatalogs++;
                        } else {
                            console.error(`✗ Failed to import catalog ${region}:`, response.error);
                        }
                    } catch (apiError) {
                        console.error(`✗ Exception importing catalog ${region}:`, apiError);
                    }
                }
            } else {
                // Legacy формат: массив templates без привязки к регионам
                console.log(`Legacy format: importing ${catalogs.length} catalog items to current region`);
                const currentRegion = self.currentRegion || 'Ushuaia';

                try {
                    // Сохраняем через API v1
                    const catalogData = {
                        templates: catalogs,
                        categories: [] // Legacy формат не имел categories
                    };
                    const response = await self.apiClient.saveCatalog(currentRegion, catalogData, 'organization');

                    if (response.success) {
                        console.log(`✓ Successfully imported catalog: ${currentRegion} (${catalogs.length} templates)`);
                        importedCatalogs = 1;
                    } else {
                        console.error(`✗ Failed to import catalog ${currentRegion}:`, response.error);
                    }
                } catch (apiError) {
                    console.error(`✗ Exception importing catalog ${currentRegion}:`, apiError);
                }
            }
        } else if (typeof catalogs === 'object' && catalogs !== null) {
            // Новый формат: { "Atacama": { templates: [], categories: [] }, ... }
            for (const [region, regionData] of Object.entries(catalogs)) {
                console.log(`Importing catalog for region: ${region}`, regionData);

                try {
                    // Сохраняем через API v1
                    const catalogData = {
                        templates: regionData.templates || [],
                        categories: regionData.categories || []
                    };
                    const response = await self.apiClient.saveCatalog(region, catalogData, 'organization');

                    if (response.success) {
                        console.log(`✓ Successfully imported catalog: ${region} (${catalogData.templates.length} templates, ${catalogData.categories.length} categories)`);
                        importedCatalogs++;
                        // ✅ Каталог сохранён на сервер, localStorage НЕ используется
                    } else {
                        console.error(`✗ Failed to import catalog ${region}:`, response.error);
                    }
                } catch (apiError) {
                    console.error(`✗ Exception importing catalog ${region}:`, apiError);
                }
            }
        } else {
            console.warn('Catalogs format not recognized:', catalogs);
        }

        // 2. ИМПОРТ СМЕТ через API
        console.log(`Starting estimates import (${estimates.length} estimates)...`);
        for (const est of estimates) {
            try {
                // Генерируем ID если его нет (backward compatibility)
                const estimateId = est.id || est.data?.id || self.generateQuoteId();
                const estimateData = est.data || est;
                const estimateFilename = est.filename || estimateData.filename || `estimate_${estimateId}.json`;

                console.log(`Importing estimate: ${estimateFilename} (${estimateId})`);

                // Используем API для сохранения (self вместо this!)
                // ID-First: передаем (id, data) - порядок важен!
                const response = await self.apiClient.saveEstimate(estimateId, estimateData);

                if (response.success) {
                    console.log(`✓ Successfully imported: ${estimateFilename}`);
                    importedEstimates++;
                } else {
                    console.error(`✗ Failed to import ${estimateFilename}:`, response.error);
                }
            } catch (apiError) {
                console.error(`✗ Exception importing ${est.filename || 'unknown'}:`, apiError);
            }
        }
        console.log(`Imported ${importedEstimates}/${estimates.length} estimates`);

        // 3. ИМПОРТ НАСТРОЕК
        console.log('Starting settings import...', settings);
        if (settings) {
            if (settings.currentRegion) {
                self.currentRegion = settings.currentRegion;
                console.log(`Set currentRegion: ${settings.currentRegion}`);
            }
            if (settings.regions) {
                self.regions = settings.regions;
                console.log(`Set regions:`, settings.regions);
            }
            if (settings.hiddenMarkup !== undefined) {
                self.state.hiddenMarkup = settings.hiddenMarkup;
                console.log(`Set hiddenMarkup: ${settings.hiddenMarkup}`);
            }
            if (settings.partnerCommission !== undefined) {
                self.state.partnerCommission = settings.partnerCommission;
                console.log(`Set partnerCommission: ${settings.partnerCommission}`);
            }
        } else {
            console.log('No settings to import');
        }

        const reloadMsg = `Импорт завершён!\n\nСметы: ${importedEstimates}/${estimates.length}\nКаталоги: ${importedCatalogs} регионов\n\nПерезагрузить страницу для применения изменений?`;

        event.target.value = '';

        // Предлагаем перезагрузку (с возможностью отказа для просмотра логов)
        if (confirm(reloadMsg)) {
            location.reload();
        } else {
            console.log('✅ Import completed. Page reload cancelled. You can reload manually when ready.');
        }

    } catch (err) {
        alert("Ошибка импорта: " + err.message);
        console.error(err);
        event.target.value = '';
    }
};

                reader.readAsText(file, 'UTF-8');
            }

            async handleExportDatabase() {
                try {
                    // Запрос на скачивание SQLite базы данных
                    const response = await fetch('/api/export/database');

                    if (!response.ok) {
                        throw new Error('Не удалось экспортировать базу данных');
                    }

                    // Получаем blob
                    const blob = await response.blob();
                    const filename = `quotes_${new Date().toISOString().split('T')[0]}.db`;

                    // Создаём ссылку для скачивания
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    this.showNotification('База данных экспортирована: ' + filename);
                } catch (error) {
                    console.error('Ошибка экспорта БД:', error);
                    this.showNotification('Ошибка экспорта базы данных: ' + error.message, true);
                }
            }

            async handleImportDatabase(event) {
                const file = event.target.files[0];
                if (!file) return;

                // File size validation (максимум 100MB для базы данных)
                if (file.size > 100 * 1024 * 1024) {
                    this.showNotification('Файл базы данных слишком большой (макс 100MB)', true);
                    event.target.value = '';
                    return;
                }

                // Предупреждение о полной замене данных
                if (!confirm(
                    '⚠️ ВНИМАНИЕ!\n\n' +
                    'Импорт базы данных ПОЛНОСТЬЮ ЗАМЕНИТ все текущие данные:\n' +
                    '• Все сметы\n' +
                    '• Все настройки\n' +
                    '• Все пользователи\n\n' +
                    'Это действие НЕОБРАТИМО!\n\n' +
                    'Продолжить импорт?'
                )) {
                    event.target.value = '';
                    return;
                }

                try {
                    console.log('🔄 Starting database import...', {
                        filename: file.name,
                        size: file.size,
                        type: file.type
                    });

                    // Читаем файл как ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();

                    // Отправляем на сервер
                    const response = await fetch('/api/import/database', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/octet-stream'
                        },
                        body: arrayBuffer
                    });

                    const result = await response.json();

                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Не удалось импортировать базу данных');
                    }

                    console.log('✅ Database import successful:', result);

                    this.showNotification(`База данных импортирована! Сервер перезапускается...`);

                    // Сервер перезапускается - ждем 5 секунд и проверяем доступность
                    setTimeout(async () => {
                        console.log('⏳ Waiting for server restart...');

                        // Пытаемся подключиться к серверу с интервалом 2 секунды
                        let attempts = 0;
                        const maxAttempts = 10;

                        const checkServer = async () => {
                            try {
                                attempts++;
                                console.log(`🔄 Checking server... (attempt ${attempts}/${maxAttempts})`);

                                const healthCheck = await fetch('/health');
                                if (healthCheck.ok) {
                                    console.log('✅ Server is back online!');
                                    this.showNotification('Сервер перезапущен! Обновление страницы...');
                                    setTimeout(() => location.reload(), 1000);
                                } else if (attempts < maxAttempts) {
                                    setTimeout(checkServer, 2000);
                                } else {
                                    this.showNotification('Сервер не отвечает. Обновите страницу вручную.', true);
                                }
                            } catch (err) {
                                if (attempts < maxAttempts) {
                                    setTimeout(checkServer, 2000);
                                } else {
                                    this.showNotification('Сервер не отвечает. Обновите страницу вручную.', true);
                                }
                            }
                        };

                        checkServer();
                    }, 3000);

                } catch (error) {
                    console.error('❌ Database import error:', error);
                    this.showNotification('Ошибка импорта базы данных: ' + error.message, true);
                } finally {
                    event.target.value = '';
                }
            }

            loadCatalogCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                // FIXED: File size validation
                if (file.size > this.config.maxFileSize) {
                    this.showNotification(`Файл слишком большой (${(file.size/1024/1024).toFixed(1)}MB). Максимум 5MB`, true);
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        
                        // Skip header if exists
                        let startIndex = 0;
                        const firstLine = lines[0];
                        if (firstLine && (firstLine.includes('type,') || firstLine.includes('id,') || firstLine.includes('name,'))) {
                            startIndex = 1;
                        }
                        
                        const loadedCategories = [];
                        const loadedTemplates = [];
                        
                        lines
                            .slice(startIndex)
                            .filter(line => line.trim())
                            .forEach(line => {
                                const parts = this.parseCSVLine(line);
                                
                                // New format with description: type,id,name,category,description,contractor,icon,price
                                if (parts.length >= 8 && (parts[0] === 'category' || parts[0] === 'service')) {
                                    const [type, id, name, category, description, contractor, icon, price] = parts;
                                    
                                    if (type === 'category') {
                                        loadedCategories.push({
                                            id: id.replace(/"/g, ''),
                                            name: name.replace(/"/g, ''),
                                            icon: icon.replace(/"/g, '')
                                        });
                                    } else if (type === 'service') {
                                        loadedTemplates.push({
                                            id: id.replace(/"/g, ''),
                                            name: name.replace(/"/g, ''),
                                            category: category.replace(/"/g, ''),
                                            description: description.replace(/"/g, ''),
                                            contractor: contractor.replace(/"/g, ''),
                                            icon: icon.replace(/"/g, ''),
                                            price: parseFloat(price) || 0
                                        });
                                    }
                                }
                                // Old format compatibility without description: type,id,name,category,contractor,icon,price
                                else if (parts.length >= 7 && (parts[0] === 'category' || parts[0] === 'service')) {
                                    const [type, id, name, category, contractor, icon, price] = parts;
                                    
                                    if (type === 'category') {
                                        loadedCategories.push({
                                            id: id.replace(/"/g, ''),
                                            name: name.replace(/"/g, ''),
                                            icon: icon.replace(/"/g, '')
                                        });
                                    } else if (type === 'service') {
                                        loadedTemplates.push({
                                            id: id.replace(/"/g, ''),
                                            name: name.replace(/"/g, ''),
                                            category: category.replace(/"/g, ''),
                                            description: '', // Empty description for old format
                                            contractor: contractor.replace(/"/g, ''),
                                            icon: icon.replace(/"/g, ''),
                                            price: parseFloat(price) || 0
                                        });
                                    }
                                }
                                // Legacy formats without type field 
                                else if (parts.length >= 5) {
                                    const [id, name, category, contractor_or_icon, icon_or_price, price] = parts;
                                    
                                    if (parts.length >= 6) {
                                        // Format: id, name, category, contractor, icon, price
                                        loadedTemplates.push({
                                            id: id.replace(/"/g, ''),
                                            name: name.replace(/"/g, ''),
                                            category: category.replace(/"/g, ''),
                                            description: '',
                                            contractor: contractor_or_icon.replace(/"/g, ''),
                                            icon: icon_or_price.replace(/"/g, ''),
                                            price: parseFloat(price) || 0
                                        });
                                    } else {
                                        // Format: id, name, category, icon, price
                                        loadedTemplates.push({
                                            id: id.replace(/"/g, ''),
                                            name: name.replace(/"/g, ''),
                                            category: category.replace(/"/g, ''),
                                            description: '',
                                            contractor: '',
                                            icon: contractor_or_icon.replace(/"/g, ''),
                                            price: parseFloat(icon_or_price) || 0
                                        });
                                    }
                                }
                            });
                        
                        // Validate loaded data
                        const validTemplates = loadedTemplates.filter(t => t.name && t.price >= 0);
                        
                        if (validTemplates.length === 0 && loadedCategories.length === 0) {
                            this.showNotification('Файл не содержит корректных данных', true);
                            return;
                        }

                        // Backup warning
                        if (this.templates.length > 0) {
                            const message = `Загрузка нового каталога заменит ${this.templates.length} существующих услуг.\n\nРекомендуем создать резервную копию.\n\nПродолжить?`;
                            if (!confirm(message)) {
                                event.target.value = '';
                                return;
                            }
                        }

                        // Apply loaded data
                        if (loadedCategories.length > 0) {
                            this.categories = loadedCategories;
                            this.saveCategories();
                            this.renderCategories();
                            this.renderCategoryOptions();
                        }
                        
                        if (validTemplates.length > 0) {
                            this.templates = validTemplates;
                            this.renderTemplates();
                        }
                        
                        this.saveToLocalStorage();
                        
                        // Result notification
                        let message = '';
                        if (loadedCategories.length > 0) {
                            message += `${loadedCategories.length} категорий`;
                        }
                        if (validTemplates.length > 0) {
                            if (message) message += ', ';
                            message += `${validTemplates.length} услуг`;
                        }
                        this.showNotification(`Загружено: ${message}`);
                        
                    } catch (error) {
                        this.showNotification('Ошибка загрузки каталога: ' + error.message, true);
                        console.error('Catalog load error:', error);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }

            // COMPLETELY REWRITTEN CSV Functions for better compatibility
            saveQuoteCSV() {
                try {
                    const lines = ['type,field,value'];
                    
                    // Save state fields separately
                    Object.keys(this.state).forEach(key => {
                        if (key !== 'services' && key !== 'selectedServices') { // Skip services and selection, save separately
                            const value = this.escapeCSVField(JSON.stringify(this.state[key]));
                            lines.push(`meta,${key},${value}`);
                        }
                    });

                    // Save each service separately
                    this.state.services.forEach((service, index) => {
                        Object.keys(service).forEach(key => {
                            const value = this.escapeCSVField(JSON.stringify(service[key]));
                            lines.push(`service,${index}_${key},${value}`);
                        });
                    });

                    const csv = lines.join('\n');

                    // Generate smart filename
                    let filename = 'quote';
                    if (this.state.clientName) {
                        filename = this.state.clientName.replace(/[^a-zA-Z0-9а-яА-Я\s]/g, '').replace(/\s+/g, '_');
                    }
                    if (this.state.tourStart && this.state.tourEnd) {
                        filename += `_${this.state.tourStart}_${this.state.tourEnd}`;
                    } else if (this.state.tourStart) {
                        filename += `_${this.state.tourStart}`;
                    }
                    filename += `_${Date.now()}.csv`;

                    this.downloadCSV(csv, filename);
                    this.showNotification('Смета сохранена');
                } catch (error) {
                    this.showNotification('Ошибка сохранения сметы: ' + error.message, true);
                    console.error('Save error:', error);
                }
            }

            loadQuoteCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                // FIXED: File size validation
                if (file.size > this.config.maxFileSize) {
                    this.showNotification(`Файл слишком большой (${(file.size/1024/1024).toFixed(1)}MB). Максимум 5MB`, true);
                    event.target.value = '';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const lines = csv.split('\n');
                        
                        // Skip header if exists
                        let startIndex = 0;
                        if (lines[0] && (lines[0].includes('type,field') || lines[0].includes('type,data'))) {
                            startIndex = 1;
                        }
                        
                        let loadedState = { ...this.state, services: [], selectedServices: new Set() };
                        let loadedServices = [];
                        let serviceData = {};
                        let foundData = false;

                        lines.slice(startIndex).forEach(line => {
                            if (!line.trim()) return;
                            
                            const parts = this.parseCSVLine(line);
                            if (parts.length < 3) return;
                            
                            const [type, field, value] = parts;
                            
                            try {
                                const parsedValue = this.safeDecode(value.replace(/^"|"$/g, ''));
                                
                                if (type === 'meta') {
                                    if (field !== 'selectedServices') { // Skip selectedServices as it's transient
                                        loadedState[field] = parsedValue;
                                    }
                                    foundData = true;
                                } else if (type === 'service') {
                                    const [indexStr, serviceField] = field.split('_');
                                    const index = parseInt(indexStr);
                                    
                                    if (!serviceData[index]) {
                                        serviceData[index] = {};
                                    }
                                    serviceData[index][serviceField] = parsedValue;
                                    foundData = true;
                                } else if (type === 'services') {
                                    // Old format compatibility
                                    const parsed = this.safeDecode(value.replace(/^"|"$/g, ''));
                                    if (Array.isArray(parsed)) {
                                        loadedServices = parsed;
                                        foundData = true;
                                    }
                                }
                            } catch (e) {
                                console.warn('Warning: Could not parse field', field, ':', e);
                            }
                        });

                        // Convert serviceData object to array
                        if (Object.keys(serviceData).length > 0) {
                            loadedServices = Object.keys(serviceData)
                                .sort((a, b) => parseInt(a) - parseInt(b))
                                .map(key => serviceData[key])
                                .filter(service => service && service.name); // Validate service data
                        }

                        // Validate loaded data
                        if (!foundData) {
                            this.showNotification('Файл не содержит корректных данных', true);
                            return;
                        }

                        if (!loadedServices.length) {
                            this.showNotification('Файл не содержит услуг', true);
                            return;
                        }

                        // Apply loaded data
                        this.state = { ...loadedState, services: loadedServices, selectedServices: new Set() };
                        
                        this.loadStateToUI();
                        this.renderServices();
                        this.updateCalculations();
                        this.showNotification(`Смета загружена: ${loadedServices.length} услуг`);
                    } catch (error) {
                        this.showNotification('Ошибка загрузки файла: ' + error.message, true);
                        console.error('Load error:', error);
                    }
                };
                reader.readAsText(file, 'UTF-8');
            }

            // Safe UTF-8 encoding for Russian text - SIMPLIFIED APPROACH
            safeEncode(str) {
                // Simple approach: just escape quotes and use direct JSON
                return JSON.stringify(str);
            }

            safeDecode(str) {
                try {
                    return JSON.parse(str);
                } catch (error) {
                    return str; // Return as-is if not JSON
                }
            }

            loadStateToUI() {
                const fields = {
                    'pax-count': this.state.paxCount || 27,
                    'tour-start': this.state.tourStart || '',
                    'tour-end': this.state.tourEnd || '',
                    'client-name': this.state.clientName || '',
                    'client-phone': this.state.clientPhone || '',
                    'client-email': this.state.clientEmail || '',
                    // ВАЖНО: используем ?? вместо || чтобы пустые строки загружались правильно
                    // ВАЖНО: используем quoteComments (НЕ quoteDescription) - это правильное имя из JSON
                    'quote-description': this.state.quoteComments ?? '',
                    'program-description': this.state.programDescription ?? '',
                    'booking-terms': this.state.bookingTerms ?? '',
                    'hidden-markup-slider': this.state.hiddenMarkup || 0,
                    'tax-rate': this.state.taxRate || 0,
                    'partner-commission-slider': this.state.partnerCommission || 0
                };

                Object.entries(fields).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.value = value;
                });

                // Форматируем текстовые поля для процентов с запятой
                const hiddenMarkupInput = document.getElementById('hidden-markup');
                if (hiddenMarkupInput) {
                    const value = this.state.hiddenMarkup || 0;
                    hiddenMarkupInput.value = value.toFixed(1).replace('.', ',');
                }

                const partnerCommissionInput = document.getElementById('partner-commission');
                if (partnerCommissionInput) {
                    const value = this.state.partnerCommission || 0;
                    partnerCommissionInput.value = value.toFixed(1).replace('.', ',');
                }
            }

            downloadCSV(csv, filename) {
                try {
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } catch (error) {
                    this.showNotification('Ошибка загрузки файла: ' + error.message, true);
                }
            }

            /**
             * Подготовка данных сметы для сохранения
             * @returns {Object} Данные сметы в формате API
             */
            prepareEstimateData() {
                return {
                    version: this.QUOTE_VERSION,
                    appVersion: this.APP_VERSION,
                    timestamp: new Date().toISOString(),
                    metadata: {
                        paxCount: this.state.paxCount,
                        tourStart: this.state.tourStart,
                        tourEnd: this.state.tourEnd,
                        clientName: this.state.clientName,
                        clientPhone: this.state.clientPhone,
                        clientEmail: this.state.clientEmail,
                        quoteComments: this.state.quoteComments,
                        programDescription: this.state.programDescription,
                        accommodations: this.state.accommodations,
                        bookingTerms: this.state.bookingTerms,
                        hiddenMarkup: this.state.hiddenMarkup,
                        partnerCommission: this.state.partnerCommission
                    },
                    services: this.state.services,
                    hotels: this.state.hotels || [],
                    flights: this.state.flights || [],
                    otherServices: this.state.otherServices || [],
                    optionalServices: this.state.optionalServices || [],
                    calculations: {
                        baseCost: this.calculateBaseCost(),
                        totalProfit: this.calculateTotalProfit(),
                        clientTotal: this.calculateClientTotal()
                    }
                };
            }

            // Migration v3: Delegate to server-based save (was localStorage)
            saveToLocalStorage() {
                // ✅ GUARD FLAG: Блокируем autosave во время загрузки сметы
                if (this.isLoadingQuote) {
                    console.log('[Autosave] Skipped - loading in progress');
                    return;
                }

                // ✅ DEBOUNCE: Очищаем предыдущий таймер автосохранения
                if (this.timeoutIds.autosave) {
                    clearTimeout(this.timeoutIds.autosave);
                }

                // ✅ DEBOUNCE: Устанавливаем новый таймер (8 секунд по умолчанию)
                this.timeoutIds.autosave = setTimeout(async () => {
                    try {
                        console.log(`[Autosave] Saving estimate after ${this.config.debounceDelays.autosave}ms delay`);

                        // ✅ FIX: НЕ сохраняем каталог при каждом updateCalculations!
                        // Каталог должен сохраняться только при добавлении/редактировании шаблонов
                        // через saveCatalogItem() или аналогичные методы

                        // Сохраняем ТОЛЬКО СМЕТУ (estimate), если есть текущая смета
                        if (this.currentEstimateId && this.state.services.length > 0) {
                            const estimateData = this.prepareEstimateData();
                            await this.apiClient.saveEstimate(this.currentEstimateId, estimateData);
                            console.log(`✓ Estimate ${this.currentEstimateId} auto-saved successfully`);
                        }

                    } catch (error) {
                        console.warn('Could not save estimate to server:', error);
                    } finally {
                        // Очищаем timeout ID после выполнения
                        this.timeoutIds.autosave = null;
                    }
                }, this.config.debounceDelays.autosave);
            }

            migrateServicesRegions() {
                // Миграция данных: добавляем поле region к существующим услугам без региона
                let needsSave = false;

                if (this.state.services && this.state.services.length > 0) {
                    this.state.services = this.state.services.map(service => {
                        if (!service.region) {
                            needsSave = true;
                            return {
                                ...service,
                                region: this.currentRegion
                            };
                        }
                        return service;
                    });
                }

                if (this.state.optionalServices && this.state.optionalServices.length > 0) {
                    this.state.optionalServices = this.state.optionalServices.map(service => {
                        if (!service.region) {
                            needsSave = true;
                            return {
                                ...service,
                                region: this.currentRegion
                            };
                        }
                        return service;
                    });
                }

                // Сохраняем обновленные данные
                if (needsSave) {
                    console.log('Миграция: добавлены регионы к существующим услугам');
                    this.saveToLocalStorage();
                    this.renderServices();
                    if (this.state.optionalServices && this.state.optionalServices.length > 0) {
                        this.renderOptionalServices();
                    }
                }
            }

            async loadFromLocalStorage() {
                try {
                    // Загрузка каталога с проверкой версии
                    const savedTemplates = localStorage.getItem('quoteCalc_templates');
                    if (savedTemplates) {
                        const catalogData = JSON.parse(savedTemplates);

                        if (catalogData.version && catalogData.data) {
                            // Новый формат с версионированием
                            if (catalogData.version > this.CATALOG_VERSION) {
                                console.warn(`Catalog version mismatch: file ${catalogData.version}, app ${this.CATALOG_VERSION}`);
                            }
                            this.templates = catalogData.data;
                        } else {
                            // Старый формат без версионирования
                            this.templates = catalogData;
                        }
                        this.renderTemplates();
                    }

                    // Автосохранение будет загружено позже, после инициализации apiClient
                    // (см. QuoteCalc.loadAutosaveFromServer в Server Integration Script)

                    // ВАЖНО: НЕ загружаем state из localStorage!
                    // Теперь все сметы загружаются с сервера через loadAutosaveFromServer()
                    // Очищаем старые данные из localStorage (миграция)
                    localStorage.removeItem('quoteCalc_state');
                    localStorage.removeItem('quoteCalc_autosave');
                    localStorage.removeItem('quoteCalc_autosave_timestamp');

                    // Автозагрузка последней сметы
                    const lastQuote = localStorage.getItem('quoteCalc_lastQuote');
                    const lastQuoteFileName = localStorage.getItem('quoteCalc_lastQuoteFileName');

                    if (lastQuote && lastQuoteFileName && this.state.services.length === 0) {
                        try {
                            const quoteData = JSON.parse(lastQuote);

                            // Apply metadata (с миграцией старых полей)
                            if (quoteData.metadata) {
                                // Копируем metadata с переименованием quoteDescription → quoteComments
                                const metadata = { ...quoteData.metadata };
                                // Миграция: если есть старое поле quoteDescription, переименуем в quoteComments
                                if ('quoteDescription' in metadata && !('quoteComments' in metadata)) {
                                    metadata.quoteComments = metadata.quoteDescription;
                                    delete metadata.quoteDescription;
                                }
                                Object.assign(this.state, metadata);
                            }

                            // Apply services
                            if (quoteData.services) {
                                this.state.services = quoteData.services.map(service => ({
                                    ...service,
                                    excludeFromMarkup: service.excludeFromMarkup || false,
                                    fullProfit: service.fullProfit || false,
                                    region: service.region || this.currentRegion // Миграция старых данных без региона
                                }));
                            }

                            // Apply optional services
                            if (quoteData.optionalServices) {
                                this.state.optionalServices = quoteData.optionalServices.map(service => ({
                                    ...service,
                                    excludeFromMarkup: service.excludeFromMarkup || false,
                                    fullProfit: service.fullProfit || false,
                                    region: service.region || this.currentRegion // Миграция старых данных без региона
                                }));
                            }

                            // Apply hotels
                            if (quoteData.hotels) {
                                this.state.hotels = quoteData.hotels.map(service => ({
                                    ...service,
                                    excludeFromMarkup: service.excludeFromMarkup || false,
                                    fullProfit: service.fullProfit || false,
                                    region: service.region || this.currentRegion
                                }));
                            } else {
                                this.state.hotels = [];
                            }

                            // Apply flights
                            if (quoteData.flights) {
                                this.state.flights = quoteData.flights.map(service => ({
                                    ...service,
                                    excludeFromMarkup: service.excludeFromMarkup || false,
                                    fullProfit: service.fullProfit || false,
                                    region: service.region || this.currentRegion
                                }));
                            } else {
                                this.state.flights = [];
                            }

                            // Apply other services
                            if (quoteData.otherServices) {
                                this.state.otherServices = quoteData.otherServices.map(service => ({
                                    ...service,
                                    excludeFromMarkup: service.excludeFromMarkup || false,
                                    fullProfit: service.fullProfit || false,
                                    region: service.region || this.currentRegion
                                }));
                            } else {
                                this.state.otherServices = [];
                            }

                            this.state.currentQuoteFile = lastQuoteFileName;
                            this.state.isQuoteSaved = true;
                            this.state.selectedServices = new Set();

                            this.loadStateToUI();
                            this.renderServices();
                            this.renderOptionalServices();
                            this.renderHotels();
                            this.renderFlights();
                            this.renderOtherServices();
                            this.updateCalculations();
                            this.updateQuoteStatusBar();
                            this.updateFiltersVisibility();

                            console.log(`Автоматически загружена последняя смета: ${lastQuoteFileName}`);
                        } catch (error) {
                            console.warn('Не удалось автоматически загрузить последнюю смету:', error);
                        }
                    }
                    // ===== VIEW MODE RESTORE - Восстановление режима отображения =====
                    // Загружаем сохраненный режим отображения (cards/table)
                    const savedViewMode = localStorage.getItem('quoteCalc_servicesViewMode');
                    if (savedViewMode === 'table' || savedViewMode === 'cards') {
                        this.state.servicesViewMode = savedViewMode;

                        // Обновляем визуальное состояние checkbox переключателя
                        const checkbox = document.getElementById('view-mode-checkbox');
                        if (checkbox) {
                            checkbox.checked = (savedViewMode === 'table');
                        }
                    }

                } catch (error) {
                    console.warn('Could not load from localStorage:', error);
                    this.state.selectedServices = new Set();
                    this.state.services = this.state.services || [];
                }
            }

            // Загрузка автосохраненной сметы
            loadAutosavedQuote(quoteData) {
                try {
                    console.log('Загрузка автосохраненной сметы...');

                    // Apply metadata (с миграцией старых полей)
                    if (quoteData.metadata) {
                        // Копируем metadata с переименованием quoteDescription → quoteComments
                        const metadata = { ...quoteData.metadata };
                        // Миграция: если есть старое поле quoteDescription, переименуем в quoteComments
                        if ('quoteDescription' in metadata && !('quoteComments' in metadata)) {
                            metadata.quoteComments = metadata.quoteDescription;
                            delete metadata.quoteDescription;
                        }
                        Object.assign(this.state, metadata);
                    }

                    // Apply services
                    if (quoteData.services) {
                        this.state.services = quoteData.services.map(service => ({
                            ...service,
                            excludeFromMarkup: service.excludeFromMarkup || false,
                            fullProfit: service.fullProfit || false,
                            region: service.region || this.currentRegion // Для старых автосохранений без региона
                        }));
                    }

                    // Apply optional services
                    if (quoteData.optionalServices) {
                        this.state.optionalServices = quoteData.optionalServices.map(service => ({
                            ...service,
                            excludeFromMarkup: service.excludeFromMarkup || false,
                            fullProfit: service.fullProfit || false,
                            region: service.region || this.currentRegion // Для старых автосохранений без региона
                        }));
                    }

                    // Флаг "несохраненной" сметы (т.к. это автосохранение)
                    this.state.currentQuoteFile = 'Автосохранение';
                    this.state.isQuoteSaved = false;
                    this.state.selectedServices = new Set();

                    this.loadStateToUI();
                    this.renderServices();
                    this.renderOptionalServices();
                    this.updateCalculations();
                    this.updateQuoteStatusBar();
                    this.updateFiltersVisibility();

                    console.log('Автосохраненная смета успешно загружена');

                    // НЕ удаляем автосохранение - оно будет перезаписываться при изменениях
                    // или удалено при создании новой сметы/сохранении в файл
                } catch (error) {
                    console.warn('Ошибка при загрузке автосохранения:', error);
                    this.showNotification('Ошибка при загрузке автосохранения', true);
                }
            }

            reset() {
                if (confirm('Создать новую смету? Все несохраненные данные будут потеряны.')) {
                    this.state.services = [];
                    this.state.optionalServices = []; // Сбрасываем доп услуги
                    this.state.hotels = []; // Сбрасываем отели
                    this.state.flights = []; // Сбрасываем перелёты
                    this.state.otherServices = []; // Сбрасываем прочие услуги
                    this.state.selectedServices = new Set();
                    this.state.hiddenMarkup = 0;
                    this.state.taxRate = 0;
                    this.state.partnerCommission = 0;
                    this.state.tourStart = '';
                    this.state.tourEnd = '';
                    this.state.clientName = '';
                    this.state.clientPhone = '';
                    this.state.clientEmail = '';
                    this.state.quoteComments = '';
                    this.state.programDescription = '';

                    // Сбрасываем статус файла - теперь это новая смета
                    this.state.currentQuoteFile = '';
                    this.state.isQuoteSaved = true; // Новая смета "сохранена" (нечего сохранять)
                    this.currentFileHandle = null; // Очищаем ссылку на файл

                    // Очищаем автосохранение
                    localStorage.removeItem('quoteCalc_autosave');
                    localStorage.removeItem('quoteCalc_autosave_timestamp');

                    this.loadStateToUI();
                    this.renderServices();
                    this.renderOptionalServices(); // Обновляем отображение доп услуг
                    this.renderHotels(); // Обновляем отели
                    this.renderFlights(); // Обновляем перелёты
                    this.renderOtherServices(); // Обновляем прочие услуги
                    this.updateCalculations();
                    this.updateQuoteStatusBar(); // Обновляем статус-бар (скроется)
                    this.showNotification('Создана новая смета');
                }
            }

            sendEmail() {
                // Проверяем наличие email клиента
                if (!this.state.clientEmail) {
                    alert('Пожалуйста, укажите email клиента в блоке данных о клиенте');
                    return;
                }

                // Формируем mailto ссылку с темой и телом письма
                const subject = encodeURIComponent(`Коммерческое предложение ${this.state.clientName ? '- ' + this.state.clientName : ''}`);
                const body = encodeURIComponent(`Добрый день!\n\nВо вложении коммерческое предложение на тур.\n\nКоличество пассажиров: ${this.state.paxCount} чел.\nДаты: ${this.state.tourStart ? this.formatDate(this.state.tourStart) : ''} - ${this.state.tourEnd ? this.formatDate(this.state.tourEnd) : ''}\n\nС уважением,\nMagellania Travel Company`);

                window.location.href = `mailto:${this.state.clientEmail}?subject=${subject}&body=${body}`;
                this.showNotification('Открыто окно отправки email');
            }

            print() {
                try {
                    // Создаем имя файла для PDF: ФИО заказчика + дата + количество человек
                    let pdfFilename = '';

                    if (this.state.clientName) {
                        pdfFilename += this.state.clientName.replace(/[^a-zA-Z0-9а-яА-Я\s]/g, '').replace(/\s+/g, '_');
                    } else {
                        pdfFilename += 'Смета';
                    }

                    if (this.state.tourStart) {
                        pdfFilename += `_${this.state.tourStart}`;
                    } else {
                        const today = new Date().toISOString().split('T')[0];
                        pdfFilename += `_${today}`;
                    }

                    if (this.state.paxCount && this.state.paxCount > 0) {
                        pdfFilename += `_${this.state.paxCount}pax`;
                    }

                    // Сохраняем оригинальный заголовок
                    const originalTitle = document.title;
                    // Устанавливаем новый заголовок для PDF
                    document.title = pdfFilename;

                    // Объединяем все услуги из всех секций
                    const allServices = [
                        ...this.state.services,
                        ...this.state.hotels,
                        ...this.state.flights,
                        ...this.state.otherServices
                    ];

                    // Sort services by day for printing
                    const sortedServices = [...this.state.services].sort((a, b) => a.day - b.day);

                    // Calculate base costs from ALL sections
                    const baseCost = allServices.reduce((sum, service) => {
                        return sum + (service.price * service.quantity);
                    }, 0);

                    // Базовая стоимость только неисключенных услуг для скрытой маржи (все секции)
                    const baseCostForHiddenMarkup = allServices.reduce((sum, service) => {
                        if (!service.excludeFromMarkup) {
                            return sum + (service.price * service.quantity);
                        }
                        return sum;
                    }, 0);

                    // Считаем totalWithIndividualMarkup для ВСЕХ секций
                    const totalWithIndividualMarkup = allServices.reduce((sum, service) => {
                        return sum + this.calculateServiceTotal(service);
                    }, 0);

                    // Обрабатываем услуги по дням (основная секция)
                    const servicesForPrint = sortedServices.map(service => {
                        const serviceBaseCost = service.price * service.quantity;
                        const serviceWithMarkup = this.calculateServiceTotal(service);

                        let hiddenMarkupPortion = 0;
                        // Скрытая маржа применяется только к неисключенным услугам
                        if (!service.excludeFromMarkup && baseCostForHiddenMarkup > 0) {
                            const proportion = serviceBaseCost / baseCostForHiddenMarkup;
                            hiddenMarkupPortion = (baseCostForHiddenMarkup * this.state.hiddenMarkup / 100) * proportion;
                        }
                        const totalWithHiddenMarkup = serviceWithMarkup + hiddenMarkupPortion;

                        // Don't show contractor to client
                        const displayName = service.name;

                        return {
                            ...service,
                            displayName: displayName,
                            displayPrice: Math.round(totalWithHiddenMarkup),
                            baseCost: serviceBaseCost // Сохраняем для расчета комиссии партнера
                        };
                    });

                    // Обрабатываем отели
                    const hotelsForPrint = this.state.hotels.map(service => {
                        const serviceBaseCost = service.price * service.quantity;
                        const serviceWithMarkup = this.calculateServiceTotal(service);

                        let hiddenMarkupPortion = 0;
                        if (!service.excludeFromMarkup && baseCostForHiddenMarkup > 0) {
                            const proportion = serviceBaseCost / baseCostForHiddenMarkup;
                            hiddenMarkupPortion = (baseCostForHiddenMarkup * this.state.hiddenMarkup / 100) * proportion;
                        }
                        const totalWithHiddenMarkup = serviceWithMarkup + hiddenMarkupPortion;

                        return {
                            ...service,
                            displayName: service.name,
                            displayPrice: Math.round(totalWithHiddenMarkup),
                            baseCost: serviceBaseCost
                        };
                    });

                    // Обрабатываем перелёты
                    const flightsForPrint = this.state.flights.map(service => {
                        const serviceBaseCost = service.price * service.quantity;
                        const serviceWithMarkup = this.calculateServiceTotal(service);

                        let hiddenMarkupPortion = 0;
                        if (!service.excludeFromMarkup && baseCostForHiddenMarkup > 0) {
                            const proportion = serviceBaseCost / baseCostForHiddenMarkup;
                            hiddenMarkupPortion = (baseCostForHiddenMarkup * this.state.hiddenMarkup / 100) * proportion;
                        }
                        const totalWithHiddenMarkup = serviceWithMarkup + hiddenMarkupPortion;

                        return {
                            ...service,
                            displayName: service.name,
                            displayPrice: Math.round(totalWithHiddenMarkup),
                            baseCost: serviceBaseCost
                        };
                    });

                    // Обрабатываем прочие услуги
                    const otherServicesForPrint = this.state.otherServices.map(service => {
                        const serviceBaseCost = service.price * service.quantity;
                        const serviceWithMarkup = this.calculateServiceTotal(service);

                        let hiddenMarkupPortion = 0;
                        if (!service.excludeFromMarkup && baseCostForHiddenMarkup > 0) {
                            const proportion = serviceBaseCost / baseCostForHiddenMarkup;
                            hiddenMarkupPortion = (baseCostForHiddenMarkup * this.state.hiddenMarkup / 100) * proportion;
                        }
                        const totalWithHiddenMarkup = serviceWithMarkup + hiddenMarkupPortion;

                        return {
                            ...service,
                            displayName: service.name,
                            displayPrice: Math.round(totalWithHiddenMarkup),
                            baseCost: serviceBaseCost
                        };
                    });

                    // Объединяем все обработанные услуги
                    const allServicesForPrint = [
                        ...servicesForPrint,
                        ...hotelsForPrint,
                        ...flightsForPrint,
                        ...otherServicesForPrint
                    ];

                    // Рассчитываем комиссию партнера и добавляем к каждой услуге пропорционально
                    // Комиссия партнера рассчитывается от суммы ПОСЛЕ добавления скрытой маржи
                    if (this.state.partnerCommission > 0) {
                        const totalWithHiddenMarkupForPrint = allServicesForPrint.reduce((sum, service) => sum + service.displayPrice, 0);
                        const totalPartnerCommission = totalWithHiddenMarkupForPrint * (this.state.partnerCommission / 100);

                        // Распределяем комиссию пропорционально базовой стоимости каждой услуги
                        const totalBaseCost = allServicesForPrint.reduce((sum, service) => sum + service.baseCost, 0);

                        allServicesForPrint.forEach(service => {
                            if (totalBaseCost > 0) {
                                const proportion = service.baseCost / totalBaseCost;
                                const partnerCommissionPortion = totalPartnerCommission * proportion;
                                service.displayPrice = Math.round(service.displayPrice + partnerCommissionPortion);
                            }
                        });
                    }

                    // Итоговая сумма для клиента (без НДС) - ВКЛЮЧАЕТ ВСЕ СЕКЦИИ
                    const finalClientTotal = allServicesForPrint.reduce((sum, service) => sum + service.displayPrice, 0);

                    // Set print date без проблем с часовыми поясами
                    const currentDate = new Date();
                    const year = currentDate.getFullYear();
                    const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const day = String(currentDate.getDate()).padStart(2, '0');
                    const currentDateString = `${year}-${month}-${day}`;

                    const quoteDateElement = document.getElementById('quote-date');
                    if (quoteDateElement) {
                        quoteDateElement.textContent = `Дата составления: ${this.formatDate(currentDateString)}`;
                    }
                    
                    const printContent = document.getElementById('print-content');
                    if (!printContent) {
                        this.showNotification('Ошибка: не найден элемент для печати', true);
                        return;
                    }

                    // Разделяем услуги на две группы: с днями и без дней
                    const servicesWithDays = servicesForPrint.filter(s => !s.noDayAssignment);
                    const servicesWithoutDays = servicesForPrint.filter(s => s.noDayAssignment);

                    // Group services by day for better organization
                    const servicesByDay = {};
                    servicesWithDays.forEach(service => {
                        if (!servicesByDay[service.day]) {
                            servicesByDay[service.day] = [];
                        }
                        servicesByDay[service.day].push(service);
                    });

                    // Generate table with day separation
                    let tableRows = '';
                    const days = Object.keys(servicesByDay).sort((a, b) => parseInt(a) - parseInt(b));

                    days.forEach((day, dayIndex) => {
                        const dayServices = servicesByDay[day];

                        // Calculate calendar date for this day
                        const calendarDate = this.calculateActivityDate(parseInt(day));
                        const dateDisplay = calendarDate ? ` (${calendarDate})` : '';

                        // Day header
                        if (days.length > 1) {
                            tableRows += `
                                <tr style="background: #e5e7eb;">
                                    <td colspan="3" style="padding: 8pt; border: 2px solid #333; font-weight: 700; text-align: center; font-size: 10pt;">
                                        День ${day}${dateDisplay}
                                    </td>
                                </tr>
                            `;
                        }

                        // Services for this day
                        dayServices.forEach(service => {
                            // Формируем строку с временем если оно указано
                            let timeInfo = '';
                            if (service.startTime || service.endTime) {
                                timeInfo = '<br><small style="color: #000; font-size: 8pt;">';
                                if (service.startTime && service.endTime) {
                                    const duration = this.calculateDuration(service.startTime, service.endTime);
                                    timeInfo += `${service.startTime} - ${service.endTime}`;
                                    if (duration) {
                                        timeInfo += ` (${duration})`;
                                    }
                                } else if (service.startTime) {
                                    timeInfo += `с ${service.startTime}`;
                                } else if (service.endTime) {
                                    timeInfo += `до ${service.endTime}`;
                                }
                                timeInfo += '</small>';
                            }

                            tableRows += `
                                <tr>
                                    <td style="padding: 5pt; border: 1px solid #ddd; font-size: 9.5pt; line-height: 1.2;">
                                        <strong>${service.displayName}</strong>${timeInfo}<br>
                                        <small style="color: #000; font-size: 8.5pt; line-height: 1.1;">${service.description}</small><br>
                                        <small style="color: #000; font-size: 7.5pt;">Цена за единицу: ${Math.round(service.displayPrice / service.quantity).toLocaleString()}</small>
                                    </td>
                                    <td style="padding: 5pt; border: 1px solid #ddd; text-align: center; font-size: 9pt;">${service.quantity}</td>
                                    <td style="padding: 5pt; border: 1px solid #ddd; text-align: right; font-weight: 600; font-size: 9.5pt;">${service.displayPrice.toLocaleString()}</td>
                                </tr>
                            `;
                        });

                        // Add spacing between days (except last day)
                        if (dayIndex < days.length - 1) {
                            tableRows += `
                                <tr>
                                    <td colspan="3" style="padding: 4pt; border: none;"></td>
                                </tr>
                            `;
                        }
                    });

                    printContent.innerHTML = `
                        <p><strong>Количество пассажиров:</strong> ${this.state.paxCount} чел.</p>
                        ${this.state.tourStart ? `<p><strong>Даты тура:</strong> ${this.formatDate(this.state.tourStart)} ${this.state.tourEnd ? '- ' + this.formatDate(this.state.tourEnd) : ''}</p>` : ''}
                        ${this.state.clientName ? `<p><strong>Заказчик:</strong> ${this.state.clientName}</p>` : ''}
                        ${this.state.clientPhone ? `<p><strong>Контакты:</strong> ${this.state.clientPhone} ${this.state.clientEmail ? ', ' + this.state.clientEmail : ''}</p>` : ''}
                        ${this.state.programDescription && this.state.programDescription.replace(/<[^>]*>/g, '').trim() ? `
                            <div style="margin: 0.5cm 0; padding: 12pt; background: #f9fafb;">
                                <p style="margin: 0 0 8pt 0; font-weight: 700; font-size: 10pt;">Описание программы:</p>
                                <div style="line-height: 1.4; font-size: 9.5pt;">${this.state.programDescription}</div>
                            </div>
                        ` : ''}
                        <br>
                        <table style="width: 100%; border-collapse: collapse; margin: 0.5cm 0;">
                            <thead>
                                <tr style="background: #f5f5f5;">
                                    <th style="padding: 6pt; border: 1px solid #ddd; font-size: 9.5pt; font-weight: 600;">Услуга</th>
                                    <th style="padding: 6pt; border: 1px solid #ddd; font-size: 9.5pt; font-weight: 600;">Кол-во</th>
                                    <th style="padding: 6pt; border: 1px solid #ddd; font-size: 9.5pt; font-weight: 600;">Стоимость</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows}
                            </tbody>
                        </table>

                        ${hotelsForPrint.length > 0 ? `
                            <div style="margin-top: 0.6cm; padding-top: 0.4cm; border-top: 2px dashed #aaa;">
                                <h3 style="margin: 0 0 0.3cm 0; font-size: 11pt; font-weight: 700;">Отели и размещение</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: left; width: 65%; font-weight: 600;">Отель</th>
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: center; width: 12%; font-weight: 600;">Ночей</th>
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: right; width: 23%; font-weight: 600;">Стоимость</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${hotelsForPrint.map(service => `
                                            <tr>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; line-height: 1.2;">
                                                    <strong>${service.displayName}</strong>${service.region ? '<br><small style="color: #000; font-size: 8pt;">' + service.region + '</small>' : ''}${service.description && service.description !== service.displayName ? '<br><small style="color: #000; font-size: 8pt;">' + service.description + '</small>' : ''}
                                                </td>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: center;">${service.quantity}</td>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: right; font-weight: 600;">${service.displayPrice.toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${flightsForPrint.length > 0 ? `
                            <div style="margin-top: 0.6cm; padding-top: 0.4cm; border-top: 2px dashed #aaa;">
                                <h3 style="margin: 0 0 0.3cm 0; font-size: 11pt; font-weight: 700;">Перелёты</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: left; width: 65%; font-weight: 600;">Рейс</th>
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: center; width: 12%; font-weight: 600;">Пассажиров</th>
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: right; width: 23%; font-weight: 600;">Стоимость</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${flightsForPrint.map(service => `
                                            <tr>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; line-height: 1.2;">
                                                    <strong>${service.displayName}</strong>${service.description && service.description !== service.displayName ? '<br><small style="color: #000; font-size: 8pt;">' + service.description + '</small>' : ''}
                                                </td>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: center;">${service.quantity}</td>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: right; font-weight: 600;">${service.displayPrice.toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        ${otherServicesForPrint.length > 0 ? `
                            <div style="margin-top: 0.6cm; padding-top: 0.4cm; border-top: 2px dashed #aaa;">
                                <h3 style="margin: 0 0 0.3cm 0; font-size: 11pt; font-weight: 700;">Прочие услуги</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: left; width: 65%; font-weight: 600;">Услуга</th>
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: center; width: 12%; font-weight: 600;">Кол-во</th>
                                            <th style="padding: 5pt; border: 1px solid #ddd; text-align: right; width: 23%; font-weight: 600;">Стоимость</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${otherServicesForPrint.map(service => `
                                            <tr>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; line-height: 1.2;">
                                                    <strong>${service.displayName}</strong>${service.description && service.description !== service.displayName ? '<br><small style="color: #000; font-size: 8pt;">' + service.description + '</small>' : ''}
                                                </td>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: center;">${service.quantity}</td>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: right; font-weight: 600;">${service.displayPrice.toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : ''}

                        <div style="text-align: right; font-size: 16pt; font-weight: 700; margin-top: 0.5cm; border-top: 2px solid #000; padding-top: 0.3cm;">
                            ИТОГО: ${Math.round(finalClientTotal).toLocaleString()}
                        </div>

                        ${this.state.bookingTerms ? `
                            <div style="margin-top: 0.8cm; padding: 12pt; background: #f9fafb; border: 1px solid #ddd;">
                                <p style="margin: 0 0 8pt 0; font-weight: 700; font-size: 10pt;">Условия бронирования:</p>
                                <div style="line-height: 1.4; font-size: 9pt;">${this.state.bookingTerms}</div>
                            </div>
                        ` : ''}

                        ${servicesWithoutDays.length > 0 ? `
                            <div style="margin-top: 0.8cm; padding-top: 0.4cm; border-top: 2px dashed #aaa;">
                                <h3 style="margin: 0 0 0.2cm 0; font-size: 11pt; font-weight: 700;">Дополнительные услуги (не привязаны к конкретным дням):</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 8.5pt;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: left; width: 65%; font-weight: 600;">Услуга</th>
                                            <th style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: center; width: 12%; font-weight: 600;">Кол-во</th>
                                            <th style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: right; width: 23%; font-weight: 600;">Стоимость</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${servicesWithoutDays.map(service => `
                                            <tr>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; line-height: 1.2;">
                                                    <strong>${service.displayName}</strong>${service.description && service.description !== service.displayName ? '<br><small style="color: #000; font-size: 8pt;">' + service.description + '</small>' : ''}
                                                </td>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: center;">${service.quantity}</td>
                                                <td style="padding: 4pt 5pt; border: 1px solid #ddd; text-align: right; font-weight: 600;">${service.displayPrice.toLocaleString()}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <p style="margin-top: 0.2cm; color: #000; font-size: 7.5pt; font-style: italic; line-height: 1.2;">
                                    * Данные услуги включены в основную стоимость тура и не привязаны к конкретным дням программы (перелёты, визы, страховки, и т.д.)
                                </p>
                            </div>
                        ` : ''}

                        ${this.state.optionalServices && this.state.optionalServices.length > 0 ? `
                            <div style="margin-top: 0.8cm; padding-top: 0.4cm; border-top: 2px dashed #aaa;">
                                <h3 style="margin: 0 0 0.2cm 0; color: #000; font-size: 11pt; font-weight: 600;">Опциональные услуги (на выбор):</h3>
                                <table style="width: 100%; border-collapse: collapse; font-size: 8pt;">
                                    <thead>
                                        <tr style="background: #f5f5f5;">
                                            <th style="padding: 3pt 4pt; border: 1px solid #ddd; text-align: left; width: 60%; font-weight: 600;">Услуга</th>
                                            <th style="padding: 3pt 4pt; border: 1px solid #ddd; text-align: center; width: 12%; font-weight: 600;">День</th>
                                            <th style="padding: 3pt 4pt; border: 1px solid #ddd; text-align: center; width: 8%; font-weight: 600;">Кол.</th>
                                            <th style="padding: 3pt 4pt; border: 1px solid #ddd; text-align: right; width: 20%; font-weight: 600;">Цена</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${this.state.optionalServices.map(service => {
                                            const calendarDate = this.calculateActivityDate(service.day);
                                            const serviceTotal = this.calculateServiceTotal(service);
                                            return `
                                                <tr>
                                                    <td style="padding: 3pt 4pt; border: 1px solid #ddd; line-height: 1.2;">
                                                        ${service.name}${service.description && service.description !== service.name ? ' — ' + service.description : ''}
                                                    </td>
                                                    <td style="padding: 3pt 4pt; border: 1px solid #ddd; text-align: center;">
                                                        ${service.day}${calendarDate ? ' (' + calendarDate + ')' : ''}
                                                    </td>
                                                    <td style="padding: 3pt 4pt; border: 1px solid #ddd; text-align: center;">${service.quantity}</td>
                                                    <td style="padding: 3pt 4pt; border: 1px solid #ddd; text-align: right; font-weight: 600;">${Math.round(serviceTotal).toLocaleString()}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                                <p style="margin-top: 0.2cm; color: #000; font-size: 7.5pt; font-style: italic; line-height: 1.2;">
                                    * Опциональные услуги оплачиваются дополнительно и не входят в основную стоимость тура
                                </p>
                            </div>
                        ` : ''}

                        ${(() => {
                            // Собираем все услуги с предоплатой
                            const servicesWithPrepayment = allServicesForPrint.filter(s => {
                                const prepay = parseFloat(s.prepayment) || 0;
                                return prepay > 0;
                            });

                            if (servicesWithPrepayment.length === 0) {
                                return ''; // Не показываем блок если нет предоплат
                            }

                            // Считаем общую сумму предоплаты
                            const totalPrepayment = servicesWithPrepayment.reduce((sum, s) => {
                                const prepay = parseFloat(s.prepayment) || 0;
                                return sum + prepay;
                            }, 0);

                            return `
                                <div style="margin-top: 0.8cm; padding-top: 0.4cm; border-top: 2px solid #ddd;">
                                    <h3 style="margin: 0 0 0.3cm 0; font-size: 11pt; font-weight: 700;">Предоплата</h3>
                                    <p style="margin: 0 0 0.2cm 0; font-size: 8.5pt; line-height: 1.3;">
                                        Для бронирования следующих услуг требуется внести предоплату:
                                    </p>
                                    <table style="width: 100%; border-collapse: collapse; font-size: 9pt;">
                                        <thead>
                                            <tr style="background: #f5f5f5;">
                                                <th style="padding: 6pt; border: 1px solid #ddd; text-align: left; font-weight: 600;">Услуга</th>
                                                <th style="padding: 6pt; border: 1px solid #ddd; text-align: center; font-weight: 600; width: 25%;">Срок оплаты</th>
                                                <th style="padding: 6pt; border: 1px solid #ddd; text-align: right; font-weight: 600; width: 20%;">Сумма</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${servicesWithPrepayment.map(service => {
                                                const prepay = parseFloat(service.prepayment) || 0;
                                                return `
                                                    <tr>
                                                        <td style="padding: 5pt; border: 1px solid #ddd; line-height: 1.2;">
                                                            ${service.displayName}
                                                        </td>
                                                        <td style="padding: 5pt; border: 1px solid #ddd; text-align: center; font-size: 8.5pt;">
                                                            ${service.prepaymentDeadline ? this.formatDate(service.prepaymentDeadline) : '—'}
                                                        </td>
                                                        <td style="padding: 5pt; border: 1px solid #ddd; text-align: right; font-weight: 600;">
                                                            ${Math.round(prepay).toLocaleString()}
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: #f5f5f5;">
                                                <td colspan="2" style="padding: 8pt; border: 2px solid #333; text-align: right; font-weight: 700; font-size: 10pt;">
                                                    ИТОГО ПРЕДОПЛАТА:
                                                </td>
                                                <td style="padding: 8pt; border: 2px solid #333; text-align: right; font-weight: 700; font-size: 11pt;">
                                                    ${Math.round(totalPrepayment).toLocaleString()}
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            `;
                        })()}
                    `;

                    setTimeout(() => {
                        window.print();
                        // Восстанавливаем оригинальный заголовок после печати
                        document.title = originalTitle;
                        this.showNotification('Документ отправлен на печать');
                    }, 300);
                } catch (error) {
                    this.showNotification('Ошибка печати: ' + error.message, true);
                }
            }

            // Открытие файла через File System Access API
            async openQuoteFile() {
                try {
                    // Проверяем поддержку File System Access API
                    if ('showOpenFilePicker' in window) {
                        const [fileHandle] = await window.showOpenFilePicker({
                            types: [{
                                description: 'Quote Files',
                                accept: {
                                    'application/json': ['.json'],
                                    'text/csv': ['.csv']
                                }
                            }],
                            multiple: false
                        });

                        const file = await fileHandle.getFile();
                        const content = await file.text();

                        // Определяем тип файла
                        const extension = file.name.split('.').pop().toLowerCase();

                        try {
                            if (extension === 'json') {
                                const quoteData = JSON.parse(content);

                                // Version validation
                                if (!quoteData.version) {
                                    this.showNotification('Файл не содержит информации о версии', true);
                                    return;
                                }

                                if (quoteData.version > this.QUOTE_VERSION) {
                                    this.showNotification(`Файл создан в более новой версии (${quoteData.version}). Текущая версия: ${this.QUOTE_VERSION}`, true);
                                    return;
                                }

                                // Apply metadata (с миграцией старых полей)
                                if (quoteData.metadata) {
                                    // Копируем metadata с переименованием quoteDescription → quoteComments
                                    const metadata = { ...quoteData.metadata };
                                    // Миграция: если есть старое поле quoteDescription, переименуем в quoteComments
                                    if ('quoteDescription' in metadata && !('quoteComments' in metadata)) {
                                        metadata.quoteComments = metadata.quoteDescription;
                                        delete metadata.quoteDescription;
                                    }
                                    Object.assign(this.state, metadata);
                                }

                                // Apply services
                                if (quoteData.services) {
                                    this.state.services = quoteData.services.map(service => ({
                                        ...service,
                                        excludeFromMarkup: service.excludeFromMarkup || false
                                    }));
                                    this.state.selectedServices = new Set();
                                }

                                // Apply optional services
                                if (quoteData.optionalServices) {
                                    this.state.optionalServices = quoteData.optionalServices;
                                } else {
                                    this.state.optionalServices = [];
                                }

                                // Apply hotels
                                if (quoteData.hotels) {
                                    this.state.hotels = quoteData.hotels;
                                } else {
                                    this.state.hotels = [];
                                }

                                // Apply flights
                                if (quoteData.flights) {
                                    this.state.flights = quoteData.flights;
                                } else {
                                    this.state.flights = [];
                                }

                                // Apply other services
                                if (quoteData.otherServices) {
                                    this.state.otherServices = quoteData.otherServices;
                                } else {
                                    this.state.otherServices = [];
                                }

                                this.loadStateToUI();
                                this.renderServices();
                                this.renderOptionalServices();
                                this.renderHotels();
                                this.renderFlights();
                                this.renderOtherServices();
                                this.updateCalculations();

                                // Сохраняем fileHandle для последующей перезаписи
                                this.currentFileHandle = fileHandle;
                                this.state.currentQuoteFile = file.name;
                                this.state.isQuoteSaved = true;

                                // Сохраняем последнюю загруженную смету в localStorage для автозагрузки
                                localStorage.setItem('quoteCalc_lastQuote', JSON.stringify(quoteData));
                                localStorage.setItem('quoteCalc_lastQuoteFileName', file.name);

                                // Очищаем автосохранение (загружена сохранённая смета)
                                localStorage.removeItem('quoteCalc_autosave');
                                localStorage.removeItem('quoteCalc_autosave_timestamp');

                                // Получаем папку из fileHandle (если возможно)
                                // Примечание: File System Access API не дает прямой доступ к родительской папке
                                // Но мы можем запомнить directoryHandle при "Сохранить как"

                                this.updateQuoteStatusBar();
                                this.updateFiltersVisibility();

                                this.showNotification(`Смета загружена: ${file.name}`);
                            } else if (extension === 'csv') {
                                // CSV loading через старый метод
                                this.showNotification('CSV формат поддерживается только через обычное открытие файла', true);
                            }
                        } catch (error) {
                            this.showNotification('Ошибка загрузки файла: ' + error.message, true);
                        }
                    } else {
                        // Fallback на старый метод
                        document.getElementById('load-quote').click();
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        this.showNotification('Ошибка открытия файла: ' + error.message, true);
                    }
                }
            }

            // Сохранить как... (выбрать новую папку/файл)
            async saveQuoteAsJSON() {
                try {
                    if ('showSaveFilePicker' in window) {
                        const quoteData = {
                            version: this.QUOTE_VERSION,
                            appVersion: this.APP_VERSION,
                            timestamp: new Date().toISOString(),
                            metadata: {
                                paxCount: this.state.paxCount,
                                tourStart: this.state.tourStart,
                                tourEnd: this.state.tourEnd,
                                clientName: this.state.clientName,
                                clientPhone: this.state.clientPhone,
                                clientEmail: this.state.clientEmail,
                                quoteComments: this.state.quoteComments,
                                programDescription: this.state.programDescription,
                                hiddenMarkup: this.state.hiddenMarkup,
                                partnerCommission: this.state.partnerCommission
                            },
                            services: this.state.services,
                            calculations: {
                                baseCost: this.calculateBaseCost(),
                                totalProfit: this.calculateTotalProfit(),
                                clientTotal: this.calculateClientTotal()
                            }
                        };

                        // Генерируем предложенное имя файла
                        let suggestedName = '';
                        if (this.state.clientName) {
                            suggestedName += this.state.clientName.replace(/[^a-zA-Z0-9а-яА-Я\s]/g, '').replace(/\s+/g, '_');
                        } else {
                            suggestedName += 'Смета';
                        }
                        if (this.state.tourStart) {
                            suggestedName += `_${this.state.tourStart}`;
                        } else {
                            const today = new Date().toISOString().split('T')[0];
                            suggestedName += `_${today}`;
                        }
                        if (this.state.paxCount && this.state.paxCount > 0) {
                            suggestedName += `_${this.state.paxCount}pax`;
                        }
                        suggestedName += '.json';

                        const fileHandle = await window.showSaveFilePicker({
                            suggestedName: suggestedName,
                            types: [{
                                description: 'JSON Quote File',
                                accept: { 'application/json': ['.json'] }
                            }]
                        });

                        const writable = await fileHandle.createWritable();
                        await writable.write(JSON.stringify(quoteData, null, 2));
                        await writable.close();

                        // Обновляем состояние
                        this.currentFileHandle = fileHandle;
                        this.state.currentQuoteFile = fileHandle.name;
                        this.state.isQuoteSaved = true;
                        this.updateQuoteStatusBar();

                        this.showNotification(`Смета сохранена: ${fileHandle.name}`);
                    } else {
                        // Fallback на старый метод
                        this.saveQuoteJSON();
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        this.showNotification('Ошибка сохранения: ' + error.message, true);
                    }
                }
            }

            // Функция выбора папки для сохранения (если поддерживается браузером)
            async selectSaveFolder() {
                try {
                    // Проверяем поддержку File System Access API
                    if ('showDirectoryPicker' in window) {
                        const directoryHandle = await window.showDirectoryPicker();
                        this.state.saveFolder = directoryHandle.name;
                        localStorage.setItem('quoteCalc_saveFolder', directoryHandle.name);
                        this.directoryHandle = directoryHandle;

                        // Обновляем кнопку
                        const btn = document.getElementById('select-folder-btn');
                        if (btn) {
                            btn.title = `Папка: ${directoryHandle.name}`;
                            btn.style.background = '#16a34a';
                        }

                        this.showNotification(`Папка выбрана: ${directoryHandle.name}`);
                    } else {
                        // Для браузеров без поддержки File System Access API
                        this.showNotification('Ваш браузер не поддерживает выбор папки. Файлы сохраняются в папку "Загрузки"', false);
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        this.showNotification('Ошибка выбора папки: ' + error.message, true);
                    }
                }
            }

            // Сохранение файла в выбранную папку (если поддерживается)
            async saveToSelectedFolder(content, filename) {
                try {
                    if (this.directoryHandle && 'createWritable' in FileSystemFileHandle.prototype) {
                        const fileHandle = await this.directoryHandle.getFileHandle(filename, { create: true });
                        const writable = await fileHandle.createWritable();
                        await writable.write(content);
                        await writable.close();

                        // Обновляем состояние при успешном сохранении
                        this.state.currentQuoteFile = filename;
                        this.state.isQuoteSaved = true;
                        this.state.lastSaveFolder = this.directoryHandle.name;
                        this.updateQuoteStatusBar();

                        return true;
                    }
                    return false;
                } catch (error) {
                    console.warn('Не удалось сохранить в выбранную папку:', error);
                    return false;
                }
            }

            // Обновление статус-бара с информацией о файле и папке (новый header version)
            updateQuoteStatusBar() {
                const fileStatusHeader = document.getElementById('quote-file-status-header');
                const saveStatusHeader = document.getElementById('quote-save-status-header');

                if (!fileStatusHeader || !saveStatusHeader) return;

                // Имя файла
                const fileName = this.state.currentQuoteFile || 'Новая смета';
                const shortName = fileName.length > 30
                    ? '...' + fileName.slice(-27)
                    : fileName;

                const fileNameSpan = fileStatusHeader.querySelector('span');
                if (fileNameSpan) {
                    fileNameSpan.textContent = shortName;
                    fileNameSpan.title = fileName;
                }

                // Индикатор сохранения
                if (this.state.isQuoteSaved) {
                    saveStatusHeader.innerHTML = '<span style="color: #10b981;" title="Сохранено">●</span>';
                } else {
                    saveStatusHeader.innerHTML = '<span style="color: #f59e0b;" title="Есть несохраненные изменения">●</span>';
                }

                // Инициализация Lucide иконок
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            // Получить короткий путь (показать родительскую папку)
            getShortPath(folderName) {
                if (!folderName) return '';

                // Для File System Access API у нас обычно только имя папки
                // Показываем последние 30 символов если слишком длинное
                if (folderName.length > 30) {
                    return '...' + folderName.slice(-27);
                }
                return folderName;
            }

            // Отметить смету как несохраненную
            markQuoteAsUnsaved() {
                // Помечаем как несохраненную только если есть открытый файл
                if (this.state.currentQuoteFile && this.state.currentQuoteFile !== '') {
                    this.state.isQuoteSaved = false;
                    this.updateQuoteStatusBar();
                }
                // Если файл не открыт (новая смета) - ничего не делаем

                // Запускаем автосохранение (debounced - сработает через 2 секунды)
                this.debouncedAutosave();
            }

            // Методы сортировки услуг
            handleServicesSortChange() {
                const select = document.getElementById('services-sort-by');
                if (!select) return;

                this.state.servicesSortBy = select.value;
                this.applySortToServices();
                this.renderServices();
                this.showNotification(`Сортировка: ${select.options[select.selectedIndex].text}`);
            }

            toggleSortDirection() {
                this.state.servicesSortDirection = this.state.servicesSortDirection === 'asc' ? 'desc' : 'asc';

                const btn = document.getElementById('sort-direction-btn');
                if (btn) {
                    btn.textContent = this.state.servicesSortDirection === 'asc' ? '↑' : '↓';
                }

                this.applySortToServices();
                this.renderServices();
            }

            resetServicesSort() {
                this.state.servicesSortBy = 'order';
                this.state.servicesSortDirection = 'asc';

                const select = document.getElementById('services-sort-by');
                if (select) select.value = 'order';

                const btn = document.getElementById('sort-direction-btn');
                if (btn) btn.textContent = '↑';

                this.renderServices();
                this.showNotification('Сортировка сброшена');
            }

            // ===== VIEW MODE TOGGLE FUNCTION - Переключение режима отображения =====
            // Переключает между карточками (cards) и таблицей (table)
            toggleViewMode() {
                // Переключаем режим
                this.state.servicesViewMode = this.state.servicesViewMode === 'cards' ? 'table' : 'cards';

                // Обновляем визуальное состояние checkbox переключателя
                const checkbox = document.getElementById('view-mode-checkbox');
                if (checkbox) {
                    checkbox.checked = (this.state.servicesViewMode === 'table');
                }

                // Сохраняем выбор пользователя в localStorage
                localStorage.setItem('quoteCalc_servicesViewMode', this.state.servicesViewMode);

                // Перерисовываем список услуг в новом режиме
                this.renderServices();

                // Уведомление пользователю
                const modeText = this.state.servicesViewMode === 'table' ? 'Табличный режим' : 'Режим карточек';
                this.showNotification(modeText);
            }

            applySortToServices() {
                if (!this.state.services || this.state.services.length === 0) return;

                const sortBy = this.state.servicesSortBy;
                const direction = this.state.servicesSortDirection === 'asc' ? 1 : -1;

                this.state.services.sort((a, b) => {
                    let compareA, compareB;

                    switch (sortBy) {
                        case 'region':
                            // Сортировка по региону, внутри по дням
                            const regionA = (a.region || '').toLowerCase();
                            const regionB = (b.region || '').toLowerCase();

                            if (regionA !== regionB) {
                                if (regionA < regionB) return -1 * direction;
                                if (regionA > regionB) return 1 * direction;
                            }

                            // Если регионы одинаковые, сортируем по дням
                            const dayA = parseInt(a.day) || 0;
                            const dayB = parseInt(b.day) || 0;
                            if (dayA !== dayB) {
                                return (dayA - dayB) * direction;
                            }
                            return 0;

                        case 'day':
                            compareA = parseInt(a.day) || 0;
                            compareB = parseInt(b.day) || 0;
                            break;
                        case 'contractor':
                            compareA = (a.contractor || '').toLowerCase();
                            compareB = (b.contractor || '').toLowerCase();
                            break;
                        case 'order':
                        default:
                            // Используем исходный порядок (по индексу в массиве)
                            return 0;
                    }

                    if (compareA < compareB) return -1 * direction;
                    if (compareA > compareB) return 1 * direction;
                    return 0;
                });
            }

            // Обновить видимость панели фильтров
            updateFiltersVisibility() {
                const filtersPanel = document.getElementById('services-filters');
                if (!filtersPanel) return;

                // Показываем фильтры если есть хотя бы одна услуга
                filtersPanel.style.display = this.state.services.length > 0 ? 'block' : 'none';
            }
        }

        // Initialize
        // ВАЖНО: QuoteCalc теперь инициализируется ПОСЛЕ apiClient в Server Integration Script
        // const QuoteCalc = new ProfessionalQuoteCalculator();

        // Make QuoteCalc globally accessible for inline handlers
        // window.QuoteCalc = QuoteCalc;

        // ✅ FIX: Removed beforeunload catalog save - unreliable with fetch() during page unload
        // Catalog is already saved automatically when user makes changes to templates/categories
        // Modern browsers may cancel fetch() requests during beforeunload, causing "Failed to fetch" errors
        //
        // window.addEventListener('beforeunload', function() {
        //     try {
        //         if (window.QuoteCalc && window.QuoteCalc.currentRegion) {
        //             window.QuoteCalc.saveCatalogToRegion(window.QuoteCalc.currentRegion);
        //             console.log('Каталог сохранён перед закрытием страницы');
        //         }
        //     } catch (error) {
        //         console.error('Ошибка сохранения при закрытии:', error);
        //     }
        // });

        // Загружаем сохраненную папку при инициализации
        const savedFolder = localStorage.getItem('quoteCalc_saveFolder');
        if (savedFolder) {
            QuoteCalc.state.saveFolder = savedFolder;
            const btn = document.getElementById('select-folder-btn');
            if (btn) {
                btn.title = `Папка: ${savedFolder}`;
                btn.style.background = '#16a34a';
            }
        }

        // Performance monitoring
        if (window.performance) {
            window.addEventListener('load', () => {
                setTimeout(() => {
                    const timing = performance.timing;
                    const loadTime = timing.loadEventEnd - timing.navigationStart;
                    console.log(`Page loaded in ${loadTime}ms`);
                }, 0);
            });

            // Закрытие поиска при клике вне кнопки
            document.addEventListener('click', (e) => {
                const searchBtn = document.getElementById('search-expand-btn');
                if (searchBtn && searchBtn.classList.contains('expanded')) {
                    if (!searchBtn.contains(e.target)) {
                        searchBtn.classList.remove('expanded');
                        const searchInput = searchBtn.querySelector('.search-input');
                        if (searchInput && searchInput.value) {
                            searchInput.value = '';
                            QuoteCalc.filterTemplates('');
                        }
                    }
                }
            });

            // Инициализация Lucide иконок
            lucide.createIcons();
        }
    </script>

    <!-- API Client Integration -->
    <script src="/apiClient.js"></script>

    <!-- Error Boundary Integration -->
    <script src="/errorBoundary.js"></script>

    <!-- Migration v3.0 - Frontend Components -->
    <script src="/js/CacheManager.js"></script>
    <script src="/js/SyncManager.js"></script>
    <script src="/js/APIClientV1.js"></script>

    <!-- Модальное окно для списка смет с вкладками -->
    <div id="estimates-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; width: 90%; max-width: 800px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;">
            <!-- Заголовок -->
            <div style="padding: 16px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Управление сметами</h2>
                <button id="close-estimates-modal" style="border: none; background: none; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px;">&times;</button>
            </div>

            <!-- Вкладки -->
            <div style="display: flex; border-bottom: 1px solid var(--gray-200); background: var(--gray-50);">
                <button id="tab-estimates" class="modal-tab active" style="flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent;">
                    Мои сметы
                </button>
                <button id="tab-backups" class="modal-tab" style="flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent;">
                    Автосохранения
                </button>
                <button id="tab-import" class="modal-tab" style="flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; font-weight: 500; border-bottom: 2px solid transparent;">
                    Импорт
                </button>
            </div>

            <!-- Контент вкладок -->
            <div style="flex: 1; overflow-y: auto; padding: 16px;">
                <!-- Вкладка "Мои сметы" -->
                <div id="content-estimates" class="tab-content" style="display: block;">
                    <div id="estimates-list"></div>
                </div>

                <!-- Вкладка "Автосохранения" -->
                <div id="content-backups" class="tab-content" style="display: none;">
                    <p style="color: var(--gray-600); margin-bottom: 12px; font-size: 14px;">
                        Список автосохранений, у которых нет соответствующего файла сметы
                    </p>
                    <div id="backups-list"></div>
                </div>

                <!-- Вкладка "Импорт" -->
                <div id="content-import" class="tab-content" style="display: none;">
                    <div style="text-align: center; padding: 32px;">
                        <p style="color: var(--gray-600); margin-bottom: 16px;">
                            Импортируйте смету из файла JSON
                        </p>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;">
                        <button id="import-file-btn" style="padding: 12px 24px; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
                            Выбрать файл для импорта
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .modal-tab.active {
            background: white !important;
            border-bottom-color: var(--primary-color) !important;
            color: var(--primary-color) !important;
        }
        .modal-tab:hover {
            background: rgba(0,0,0,0.02);
        }
    </style>

    <!-- Server Integration Script -->
    <script>
        // ===== Migration v3: Offline Support Classes =====

        /**
         * OfflineManager - Handles offline/online state and operation queuing
         */
        class OfflineManager {
            constructor(apiClient) {
                this.apiClient = apiClient;
                this.queue = [];
                this.isOnline = navigator.onLine;

                window.addEventListener('online', () => this.handleOnline());
                window.addEventListener('offline', () => this.handleOffline());
            }

            handleOffline() {
                this.isOnline = false;
                this.showNotification('Работа в оффлайн режиме. Изменения будут синхронизированы позже.', false);
            }

            async handleOnline() {
                this.isOnline = true;
                this.showNotification('Соединение восстановлено. Синхронизация...', false);
                await this.syncQueue();
            }

            async syncQueue() {
                while (this.queue.length > 0) {
                    const operation = this.queue.shift();
                    try {
                        await operation.execute();
                    } catch (error) {
                        this.queue.unshift(operation);  // Re-queue on failure
                        break;
                    }
                }
            }

            queueSave(catalogData) {
                this.queue.push({
                    type: 'save',
                    data: catalogData,
                    timestamp: Date.now(),
                    execute: () => this.apiClient.saveCatalog(catalogData.name, catalogData.data)
                });
            }

            showNotification(message, isError) {
                if (window.QuoteCalc && window.QuoteCalc.showNotification) {
                    window.QuoteCalc.showNotification(message, isError);
                } else {
                    console.log(message);
                }
            }
        }

        /**
         * CatalogCache - In-memory cache with TTL
         */
        class CatalogCache {
            constructor() {
                this.cache = new Map();
                this.ttl = 5 * 60 * 1000;  // 5 minutes
            }

            set(id, data) {
                this.cache.set(id, {
                    data,
                    timestamp: Date.now()
                });
            }

            get(id) {
                const entry = this.cache.get(id);
                if (!entry) return null;

                const age = Date.now() - entry.timestamp;
                if (age > this.ttl) {
                    this.cache.delete(id);
                    return null;
                }

                return entry.data;
            }

            clear() {
                this.cache.clear();
            }
        }

        // ===== End of Offline Support Classes =====

        // Ждём загрузки всех внешних ресурсов (включая Quill из CDN)
        window.addEventListener('load', function() {
            // ============================================================================
            // 🔐 AUTH GUARD - КРИТИЧЕСКИ ВАЖНО (Migration 010)
            // ============================================================================
            // Проверяем наличие JWT токена ПЕРЕД инициализацией калькулятора
            // БЕЗ токена - показываем ТОЛЬКО страницу логина, НЕ калькулятор
            // Это предотвращает несанкционированный доступ к данным организации

            const jwtToken = localStorage.getItem('jwt_token') || localStorage.getItem('authToken');

            // Проверяем, что мы НЕ на странице логина
            const isLoginPage = window.location.pathname === '/login' ||
                                window.location.pathname === '/login.html';

            if (!jwtToken && !isLoginPage) {
                // ❌ НЕТ токена и НЕ на странице логина → редирект
                console.warn('[Auth Guard] No JWT token found, redirecting to login...');
                window.location.href = '/login';
                return; // ОСТАНАВЛИВАЕМ инициализацию калькулятора
            }

            if (!jwtToken && isLoginPage) {
                // ✅ НЕТ токена, но на странице логина → это OK, не инициализируем калькулятор
                console.log('[Auth Guard] On login page, calculator not initialized');
                return;
            }

            // ✅ Токен есть → инициализируем калькулятор
            console.log('[Auth Guard] JWT token found, initializing calculator...');

            // ============================================================================
            // Инициализация калькулятора (только если есть токен)
            // ============================================================================

            // Создаем apiClient ПОСЛЕ загрузки apiClient.js
            window.apiClient = new APIClient();
            const apiClient = window.apiClient;

            // ВАЖНО: Создаём QuoteCalc ПОСЛЕ apiClient
            const QuoteCalc = new ProfessionalQuoteCalculator();
            // ✅ FIX: apiClient устанавливается в QuoteCalc.init() автоматически
            window.QuoteCalc = QuoteCalc;

            // ===== ErrorBoundary Integration =====
            // Создаём ErrorBoundary для централизованной обработки ошибок
            const errorBoundary = new ErrorBoundary(QuoteCalc);
            window.errorBoundary = errorBoundary;

            console.log('[Init] ErrorBoundary initialized successfully');

            // ===== Migration v3.0 - Sync & Cache Integration =====
            // Создаём CacheManager для управления localStorage
            const cacheManager = new CacheManager();
            window.cacheManager = cacheManager;
            console.log('[Init] CacheManager initialized');

            // Создаём SyncManager для синхронизации с сервером
            const syncManager = new SyncManager(apiClient, cacheManager);
            window.syncManager = syncManager;

            // Запускаем периодическую синхронизацию (каждые 5 минут)
            syncManager.start();
            console.log('[Init] SyncManager started');

            // ===== Migration v3: Offline Support Integration =====
            const catalogCache = new CatalogCache();
            window.catalogCache = catalogCache;

            const offlineManager = new OfflineManager(apiClient);
            window.offlineManager = offlineManager;

            console.log('[Init] Offline support initialized (cache + queue)');

            // Первая полная синхронизация (асинхронно, не блокируем UI)
            syncManager.performFullSync()
                .then(() => {
                    console.log('[Init] Full sync completed successfully');
                })
                .catch(err => {
                    console.error('[Init] Full sync failed:', err);
                });

            // ===== Migration v3.0 - Auto-load default catalog from server =====
            QuoteCalc.loadDefaultCatalog()
                .then(() => {
                    console.log('[Init] Default catalog loaded successfully');
                })
                .catch(err => {
                    console.warn('[Init] Default catalog load failed:', err);
                });

        // УДАЛЕНО: loadAutosaveFromServer() больше не нужна
        // Теперь автосохранение сохраняет напрямую в текущий файл сметы
        // При перезагрузке страницы пользователь вручную выбирает нужную смету

        // Расширение класса ProfessionalQuoteCalculator для работы с сервером
        (function() {
            const originalInit = QuoteCalc.init.bind(QuoteCalc);

            // Переопределяем метод сохранения каталога
            QuoteCalc.saveCatalogToServer = async function() {
                try {
                    const catalogData = {
                        version: this.CATALOG_VERSION,
                        timestamp: new Date().toISOString(),
                        region: this.currentRegion || 'Default',
                        templates: this.templates,
                        categories: this.categories
                    };
                    await apiClient.saveCatalog(catalogData, 'catalog.json');
                    this.showNotification('Каталог сохранён на сервере', false);
                } catch (err) {
                    console.error('Error saving catalog:', err);
                    this.showNotification('Ошибка сохранения каталога: ' + err.message, true);
                }
            };

            // Переопределяем метод загрузки каталога
            QuoteCalc.loadCatalogFromServer = async function() {
                try {
                    const data = await apiClient.loadCatalog('catalog.json');
                    if (data && data.templates) {
                        this.templates = data.templates;
                        this.categories = data.categories || [];
                        this.currentRegion = data.region || 'Default';
                        this.saveToLocalStorage();
                        this.renderTemplates();
                        this.showNotification('Каталог загружен с сервера', false);
                    }
                } catch (err) {
                    console.error('Error loading catalog:', err);
                    this.showNotification('Ошибка загрузки каталога: ' + err.message, true);
                }
            };

            // Генерация имени файла из данных клиента
            QuoteCalc.generateFilename = function() {
                // Транслитерация кириллицы в латиницу
                const translitMap = {
                    'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g', 'д': 'd', 'е': 'e', 'ё': 'yo', 'ж': 'zh',
                    'з': 'z', 'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l', 'м': 'm', 'н': 'n', 'о': 'o',
                    'п': 'p', 'р': 'r', 'с': 's', 'т': 't', 'у': 'u', 'ф': 'f', 'х': 'h', 'ц': 'ts',
                    'ч': 'ch', 'ш': 'sh', 'щ': 'sch', 'ъ': '', 'ы': 'y', 'ь': '', 'э': 'e', 'ю': 'yu', 'я': 'ya'
                };

                const translit = (str) => {
                    return str.toLowerCase().split('').map(char =>
                        translitMap[char] || char
                    ).join('');
                };

                // Формируем имя из: clientName_tourStart_paxCount
                const clientName = translit(this.state.clientName || 'Unnamed').replace(/[^a-z0-9]/g, '_');
                const tourStart = this.state.tourStart || new Date().toISOString().split('T')[0];
                const paxCount = this.state.paxCount || 0;

                return `${clientName}_${tourStart}_${paxCount}pax.json`;
            };

            // Сохранение сметы на сервер
            QuoteCalc.saveQuoteToServer = async function(filename, showNotification = true) {
                try {
                    // Получаем актуальные значения из DOM
                    const programDescField = document.getElementById('program-description');
                    const quoteCommentsField = document.getElementById('quote-description');

                    // Обновляем state перед сохранением
                    if (programDescField) this.state.programDescription = programDescField.value;
                    if (quoteCommentsField) this.state.quoteComments = quoteCommentsField.value;

                    // Если нет ID, создаём новую смету с ID
                    if (!this.state.currentQuoteId) {
                        this.state.currentQuoteId = this.generateQuoteId();
                    }

                    // Генерируем имя файла с ID
                    const newFilename = this.generateFilenameWithId({
                        id: this.state.currentQuoteId,
                        clientName: this.state.clientName,
                        tourStart: this.state.tourStart,
                        paxCount: this.state.paxCount
                    });

                    const quoteData = {
                        id: this.state.currentQuoteId,  // Добавляем ID
                        version: this.QUOTE_VERSION,
                        timestamp: new Date().toISOString(),
                        clientName: this.state.clientName,
                        clientPhone: this.state.clientPhone,
                        clientEmail: this.state.clientEmail,
                        paxCount: this.state.paxCount,
                        tourStart: this.state.tourStart,
                        tourEnd: this.state.tourEnd,
                        services: this.state.services,
                        hotels: this.state.hotels || [],
                        flights: this.state.flights || [],
                        otherServices: this.state.otherServices || [],
                        hiddenMarkup: this.state.hiddenMarkup,
                        taxRate: this.state.taxRate,
                        programDescription: this.state.programDescription,
                        quoteComments: this.state.quoteComments
                    };

                    // Если был старый файл с другим именем, переименовываем
                    if (this.state.currentQuoteFile && this.state.currentQuoteFile !== newFilename) {
                        try {
                            await apiClient.renameEstimate(this.state.currentQuoteFile, newFilename);
                        } catch (renameErr) {
                            // Если файл не найден (например, старое имя из localStorage), просто игнорируем
                            console.warn('Could not rename file, will create new:', renameErr.message);
                            // Сбрасываем старое имя
                            this.state.currentQuoteFile = null;
                        }
                    }

                    // Простое сохранение в estimates таблицу (по ID, не по filename)
                    await apiClient.saveEstimate(this.state.currentQuoteId, quoteData);

                    apiClient.setCurrentFilename(newFilename);
                    this.state.currentQuoteFile = newFilename;
                    this.state.isQuoteSaved = true;
                    this.updateQuoteStatusBar();

                    // ✅ Сохраняем ID последней открытой/созданной сметы для восстановления
                    if (this.state.currentQuoteId) {
                        localStorage.setItem('lastOpenedEstimateId', this.state.currentQuoteId);
                        console.log('[Tracking] Estimate saved, ID tracked:', this.state.currentQuoteId);
                    }

                    // Показываем уведомление только если запрошено (при явных действиях пользователя)
                    if (showNotification) {
                        this.showNotification('Смета сохранена: ' + newFilename, false);
                    }

                    return newFilename;
                } catch (err) {
                    console.error('Error saving quote:', err);
                    // Ошибки всегда показываем
                    this.showNotification('Ошибка сохранения сметы: ' + err.message, true);
                }
            };

            // Автосохранение сметы
            QuoteCalc.autoSaveQuote = async function() {
                // ВАЖНО: Не автосохраняем во время загрузки сметы
                if (this.isLoadingQuote) {
                    return;
                }

                // Если смета ещё не имеет ID, создаём его автоматически
                if (!this.state.currentQuoteId) {
                    this.state.currentQuoteId = this.generateQuoteId();
                    console.log('Auto-generated quote ID:', this.state.currentQuoteId);
                }

                // Получаем актуальные значения из DOM
                const programDescField = document.getElementById('program-description');
                const quoteCommentsField = document.getElementById('quote-description');

                // Обновляем state перед автосохранением
                if (programDescField) this.state.programDescription = programDescField.value;
                if (quoteCommentsField) this.state.quoteComments = quoteCommentsField.value;

                // Проверяем изменилось ли имя файла (например, добавили ФИО или изменили даты)
                const newFilename = this.generateFilenameWithId({
                    id: this.state.currentQuoteId,
                    clientName: this.state.clientName,
                    tourStart: this.state.tourStart,
                    paxCount: this.state.paxCount
                });

                // Если файла ещё нет - устанавливаем новое имя
                if (!this.state.currentQuoteFile) {
                    this.state.currentQuoteFile = newFilename;
                    this.updateQuoteStatusBar();
                }
                // Если имя изменилось - переименовываем файл
                else if (this.state.currentQuoteFile !== newFilename) {
                    try {
                        await apiClient.renameEstimate(this.state.currentQuoteFile, newFilename);
                        this.state.currentQuoteFile = newFilename;
                        this.updateQuoteStatusBar();
                    } catch (err) {
                        console.error('Error renaming during autosave:', err);
                    }
                }

                const quoteData = {
                    id: this.state.currentQuoteId,  // Добавляем ID
                    version: this.QUOTE_VERSION,
                    timestamp: new Date().toISOString(),
                    clientName: this.state.clientName,
                    clientPhone: this.state.clientPhone,
                    clientEmail: this.state.clientEmail,
                    paxCount: this.state.paxCount,
                    tourStart: this.state.tourStart,
                    tourEnd: this.state.tourEnd,
                    services: this.state.services,
                    hotels: this.state.hotels || [],
                    flights: this.state.flights || [],
                    otherServices: this.state.otherServices || [],
                    hiddenMarkup: this.state.hiddenMarkup,
                    taxRate: this.state.taxRate,
                    programDescription: this.state.programDescription,
                    quoteComments: this.state.quoteComments
                };

                // Автосохраняем в текущий файл сметы (тихое сохранение, без уведомлений)
                apiClient.scheduleAutosave(quoteData, this.state.currentQuoteFile);
            };

            // Загрузка сметы с сервера
            QuoteCalc.loadQuoteFromServer = async function(filename) {
                try {
                    const data = await apiClient.loadEstimate(filename);
                    if (data) {
                        // ВАЖНО: Отключаем автосохранение во время загрузки
                        this.isLoadingQuote = true;

                        // Загружаем данные в state
                        this.state.clientName = data.clientName || '';
                        this.state.clientPhone = data.clientPhone || '';
                        this.state.clientEmail = data.clientEmail || '';
                        this.state.paxCount = data.paxCount || 27;
                        this.state.tourStart = data.tourStart || '';
                        this.state.tourEnd = data.tourEnd || '';
                        this.state.services = data.services || [];
                        // ВАЖНО: Загружаем новые массивы или пустые массивы (НЕ старые значения!)
                        this.state.hotels = data.hotels || [];
                        this.state.flights = data.flights || [];
                        this.state.otherServices = data.otherServices || [];
                        this.state.hiddenMarkup = data.hiddenMarkup || 0;
                        this.state.taxRate = data.taxRate || 0;
                        // ВАЖНО: используем ?? вместо || чтобы пустые строки не заменялись на старые значения
                        this.state.programDescription = data.programDescription ?? '';
                        this.state.quoteComments = data.quoteComments ?? '';
                        this.state.accommodations = data.accommodations || {};
                        this.state.bookingTerms = data.bookingTerms ?? '';
                        this.state.currentQuoteFile = filename;
                        // ВАЖНО: Устанавливаем ID сметы из файла
                        this.state.currentQuoteId = data.id || '';

                        // ВАЖНО: Сначала обновляем DOM поля, ПОТОМ вызываем renderServices()
                        // Иначе автосохранение затрёт данные пустыми значениями из DOM
                        const clientNameInput = document.getElementById('client-name');
                        const clientPhoneInput = document.getElementById('client-phone');
                        const clientEmailInput = document.getElementById('client-email');
                        const paxInput = document.getElementById('pax-count');
                        const tourStartInput = document.getElementById('tour-start');
                        const tourEndInput = document.getElementById('tour-end');
                        const programDescField = document.getElementById('program-description');
                        const quoteCommentsField = document.getElementById('quote-description');

                        if (clientNameInput) clientNameInput.value = this.state.clientName;
                        if (clientPhoneInput) clientPhoneInput.value = this.state.clientPhone;
                        if (clientEmailInput) clientEmailInput.value = this.state.clientEmail;
                        if (paxInput) paxInput.value = this.state.paxCount;
                        if (tourStartInput) tourStartInput.value = this.state.tourStart;
                        if (tourEndInput) tourEndInput.value = this.state.tourEnd;
                        if (programDescField) programDescField.value = this.state.programDescription;
                        if (quoteCommentsField) quoteCommentsField.value = this.state.quoteComments;

                        // Обновляем Quill редакторы если они инициализированы
                        if (this.quillEditors) {
                            if (this.quillEditors.programDescription) {
                                this.quillEditors.programDescription.root.innerHTML = this.state.programDescription || '';
                            }
                            if (this.quillEditors.quoteDescription) {
                                this.quillEditors.quoteDescription.root.innerHTML = this.state.quoteComments || '';
                            }
                            if (this.quillEditors.bookingTerms) {
                                this.quillEditors.bookingTerms.root.innerHTML = this.state.bookingTerms || '';
                            }
                        }

                        // ТЕПЕРЬ обновляем UI (это может запустить автосохранение, но мы его заблокировали)
                        this.updateCalculations();
                        this.renderServices();
                        this.renderHotels();
                        this.renderFlights();
                        this.renderOtherServices();
                        this.renderServicesDetailList();

                        // Включаем автосохранение обратно
                        this.isLoadingQuote = false;

                        // ✅ Сохраняем ID последней открытой сметы для восстановления при перезагрузке
                        if (data.id) {
                            localStorage.setItem('lastOpenedEstimateId', data.id);
                            console.log('[Tracking] Last opened estimate ID saved:', data.id);
                        }

                        // Обновляем статус-бар с именем файла
                        this.state.isQuoteSaved = true;
                        this.updateQuoteStatusBar();

                        this.showNotification('Смета загружена: ' + filename, false);
                    }
                } catch (err) {
                    console.error('Error loading quote:', err);
                    this.showNotification('Ошибка загрузки сметы: ' + err.message, true);
                }
            };

            // Перехватываем изменения для автосохранения
            const originalUpdateCalculations = QuoteCalc.updateCalculations.bind(QuoteCalc);
            QuoteCalc.updateCalculations = function() {
                originalUpdateCalculations();
                this.autoSaveQuote();
            };

            // ПЕРЕОПРЕДЕЛЯЕМ методы работы с файлами на серверные

            // Сохранить каталог (заменяем File API на server API)
            QuoteCalc.saveCatalogJSON = async function() {
                await this.saveCatalogToServer();
            };

            // Загрузить каталог (заменяем File API на server API)
            QuoteCalc.loadCatalogJSON = async function(event) {
                // Если есть event (загрузка файла вручную), обрабатываем как раньше
                if (event && event.target && event.target.files && event.target.files[0]) {
                    const file = event.target.files[0];
                    try {
                        const text = await file.text();
                        const jsonData = JSON.parse(text);

                        if (jsonData.templates) {
                            this.templates = jsonData.templates;
                            this.categories = jsonData.categories || [];
                            this.currentRegion = jsonData.region || 'Default';

                            // Сохраняем загруженный каталог на сервер
                            await this.saveCatalogToServer();

                            this.saveToLocalStorage();
                            this.renderTemplates();
                            this.showNotification('Каталог загружен и сохранён на сервере', false);
                        }
                    } catch (err) {
                        console.error('Error loading catalog:', err);
                        this.showNotification('Ошибка загрузки каталога: ' + err.message, true);
                    }
                } else {
                    // Загружаем с сервера
                    await this.loadCatalogFromServer();
                }
            };

            // Сохранить смету БЕЗ prompt - тихое сохранение на сервер
            QuoteCalc.saveQuoteJSON = async function() {
                // Если смета уже открыта - сохраняем в тот же файл
                if (this.state.currentQuoteFile) {
                    await this.saveQuoteToServer(this.state.currentQuoteFile);
                    this.showNotification('Смета сохранена на сервере', false);
                } else {
                    // Для новой сметы - генерируем имя автоматически с транслитерацией
                    const filename = this.generateFilename();
                    await this.saveQuoteToServer(filename);
                    this.showNotification(`Смета сохранена: ${filename}`, false);
                }
            };

            // Скачать бэкап локально (не меняет текущую смету на сервере)
            QuoteCalc.downloadBackup = function() {
                try {
                    // Получаем актуальные значения из DOM
                    const programDescField = document.getElementById('program-description');
                    const quoteCommentsField = document.getElementById('quote-description');

                    if (programDescField) this.state.programDescription = programDescField.value;
                    if (quoteCommentsField) this.state.quoteComments = quoteCommentsField.value;

                    // Формируем данные для скачивания
                    const data = {
                        version: this.QUOTE_VERSION,
                        timestamp: new Date().toISOString(),
                        clientName: this.state.clientName,
                        clientPhone: this.state.clientPhone,
                        clientEmail: this.state.clientEmail,
                        paxCount: this.state.paxCount,
                        services: this.state.services,
                        hotels: this.state.hotels || [],
                        flights: this.state.flights || [],
                        otherServices: this.state.otherServices || [],
                        hiddenMarkup: this.state.hiddenMarkup,
                        taxRate: this.state.taxRate,
                        programDescription: this.state.programDescription,
                        quoteComments: this.state.quoteComments
                    };

                    // Генерируем имя файла для бэкапа
                    const filename = this.state.currentQuoteFile ||
                        `${this.state.clientName || 'quote'}_${new Date().toISOString().split('T')[0]}_${this.state.paxCount}pax.json`;

                    // Создаём blob и скачиваем
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.showNotification(`Бэкап скачан: ${filename}`, false);
                } catch (error) {
                    this.showNotification('Ошибка скачивания бэкапа: ' + error.message, true);
                }
            };

            // Загрузить смету (заменяем File API на server API)
            QuoteCalc.loadQuoteJSON = async function(event) {
                // Если есть event (загрузка файла вручную), обрабатываем как раньше
                if (event && event.target && event.target.files && event.target.files[0]) {
                    const file = event.target.files[0];
                    try {
                        const text = await file.text();
                        const jsonData = JSON.parse(text);

                        // ВАЖНО: Сначала очищаем textarea поля чтобы избежать "прилипания"
                        const programDescField = document.getElementById('program-description');
                        const quoteCommentsField = document.getElementById('quote-description');
                        if (programDescField) programDescField.value = '';
                        if (quoteCommentsField) quoteCommentsField.value = '';

                        this.state.clientName = jsonData.clientName || '';
                        this.state.clientPhone = jsonData.clientPhone || '';
                        this.state.clientEmail = jsonData.clientEmail || '';
                        this.state.paxCount = jsonData.paxCount || 27;
                        this.state.tourStart = jsonData.tourStart || '';
                        this.state.tourEnd = jsonData.tourEnd || '';
                        this.state.services = jsonData.services || [];
                        this.state.hiddenMarkup = jsonData.hiddenMarkup || 0;
                        this.state.taxRate = jsonData.taxRate || 0;
                        // ВАЖНО: используем ?? вместо || чтобы пустые строки не заменялись на старые значения
                        this.state.programDescription = jsonData.programDescription ?? '';
                        this.state.quoteComments = jsonData.quoteComments ?? '';

                        // Сохраняем загруженную смету на сервер с автоматически сгенерированным именем
                        const filename = this.generateFilename();
                        await this.saveQuoteToServer(filename);

                        // Обновляем UI
                        this.updateCalculations();
                        this.renderServices();
                        this.renderServicesDetailList();

                        // Обновляем поля клиента в DOM (programDescField уже объявлен выше на строке 9297)
                        const clientNameInput = document.getElementById('client-name');
                        const clientPhoneInput = document.getElementById('client-phone');
                        const clientEmailInput = document.getElementById('client-email');
                        const paxInput = document.getElementById('pax-count');
                        const tourStartInput = document.getElementById('tour-start');
                        const tourEndInput = document.getElementById('tour-end');
                        // programDescField и quoteCommentsField уже объявлены в начале функции

                        if (clientNameInput) clientNameInput.value = this.state.clientName;
                        if (clientPhoneInput) clientPhoneInput.value = this.state.clientPhone;
                        if (clientEmailInput) clientEmailInput.value = this.state.clientEmail;
                        if (paxInput) paxInput.value = this.state.paxCount;
                        if (tourStartInput) tourStartInput.value = this.state.tourStart;
                        if (tourEndInput) tourEndInput.value = this.state.tourEnd;
                        if (programDescField) programDescField.value = this.state.programDescription;
                        if (quoteCommentsField) quoteCommentsField.value = this.state.quoteComments;


                        // Обновляем статус-бар с именем файла
                        this.state.isQuoteSaved = true;
                        this.updateQuoteStatusBar();

                        this.showNotification('Смета загружена и сохранена на сервере: ' + filename, false);
                    } catch (err) {
                        console.error('Error loading quote:', err);
                        this.showNotification('Ошибка загрузки сметы: ' + err.message, true);
                    }
                } else {
                    // Показываем список смет с сервера
                    await window.showEstimatesList();
                }
            };

            // Загрузка каталога при старте
            QuoteCalc.init = async function() {
                originalInit();
                // Попытка загрузить каталог с сервера
                try {
                    await this.loadCatalogFromServer();
                } catch (err) {
                    console.log('Using local catalog');
                }
            };
        })();

        // ===== Оборачиваем критические методы с ErrorBoundary =====
        (function() {
            // Сохраняем оригинальные методы
            const originalLoadQuote = QuoteCalc.loadQuoteFromServer;
            const originalSaveQuote = QuoteCalc.saveQuoteToServer;
            const originalUpdateCalc = QuoteCalc.updateCalculations;

            // Оборачиваем loadQuoteFromServer
            if (originalLoadQuote) {
                QuoteCalc.loadQuoteFromServer = errorBoundary.wrapAsync(
                    originalLoadQuote.bind(QuoteCalc),
                    'load'
                );
                console.log('[ErrorBoundary] Wrapped loadQuoteFromServer');
            }

            // Оборачиваем saveQuoteToServer
            if (originalSaveQuote) {
                QuoteCalc.saveQuoteToServer = errorBoundary.wrapAsync(
                    originalSaveQuote.bind(QuoteCalc),
                    'save'
                );
                console.log('[ErrorBoundary] Wrapped saveQuoteToServer');
            }

            // Оборачиваем updateCalculations (синхронная, поэтому обертка для sync)
            if (originalUpdateCalc) {
                QuoteCalc.updateCalculations = function() {
                    try {
                        return originalUpdateCalc.call(this);
                    } catch (err) {
                        const snapshot = errorBoundary.captureSnapshot();
                        errorBoundary.logError('calculations', err, snapshot, 0);
                        errorBoundary.showNotification('calculations', err);
                        errorBoundary.tryRecover('calculations', err, snapshot);
                        throw err;
                    }
                };
                console.log('[ErrorBoundary] Wrapped updateCalculations');
            }
        })();

        // Глобальные функции для работы со сметами (ДОЛЖНЫ БЫТЬ ВНЕ IIFE!)
        // Показать список смет
        window.showEstimatesList = async function() {
            try {
                const estimates = await apiClient.getEstimatesList();
                const modal = document.getElementById('estimates-modal');
                const listContainer = document.getElementById('estimates-list');

                if (estimates.length === 0) {
                    listContainer.innerHTML = '<p style="text-align: center; color: var(--gray-500);">Нет сохранённых смет</p>';
                } else {
                    listContainer.innerHTML = estimates.map(est => `
                        <div style="border: 1px solid var(--gray-200); border-radius: 6px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 4px;">${est.clientName || 'Без имени'}</div>
                                <div style="font-size: 12px; color: var(--gray-600);">
                                    PAX: ${est.paxCount || 0} | ${new Date(est.updatedAt).toLocaleString('ru-RU')}
                                </div>
                                <div style="font-size: 10px; color: var(--gray-400); margin-top: 2px;">${est.filename}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button onclick="loadEstimate('${est.id}')" style="padding: 6px 12px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Открыть</button>
                                <button onclick="deleteEstimate('${est.id}')" style="padding: 6px 12px; background: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Удалить</button>
                            </div>
                        </div>
                    `).join('');
                }

                modal.style.display = 'flex';
            } catch (err) {
                console.error('Error loading estimates list:', err);
                window.QuoteCalc.showNotification('Ошибка загрузки списка смет: ' + err.message, true);
            }
        };

        // Загрузить смету из списка (ID-First Pattern)
        window.loadEstimate = async function(id) {
            document.getElementById('estimates-modal').style.display = 'none';
            await window.QuoteCalc.loadQuoteFromServer(id);
        };

        // Удалить смету (ID-First Pattern)
        window.deleteEstimate = async function(id) {
            if (!confirm('Удалить эту смету?')) {
                return;
            }
            try {
                await apiClient.deleteEstimate(id);
                window.QuoteCalc.showNotification('Смета удалена', false);
                window.showEstimatesList(); // Обновить список
            } catch (err) {
                console.error('Error deleting estimate:', err);
                window.QuoteCalc.showNotification('Ошибка удаления сметы: ' + err.message, true);
            }
        };

        // Функция импорта файла
        window.importQuoteFile = async function(file) {
            try {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        let rawData = JSON.parse(e.target.result);
                        let data = {};

                        // Поддержка формата v1.1.0+ с metadata объектом
                        if (rawData.metadata) {
                            // Новый формат: metadata содержит основные поля
                            data = {
                                id: rawData.id || window.QuoteCalc.generateQuoteId(),
                                clientName: rawData.metadata.clientName || '',
                                clientPhone: rawData.metadata.clientPhone || '',
                                clientEmail: rawData.metadata.clientEmail || '',
                                paxCount: rawData.metadata.paxCount || 27,
                                tourStart: rawData.metadata.tourStart || '',
                                tourEnd: rawData.metadata.tourEnd || '',
                                // Миграция: quoteDescription → quoteComments
                                quoteComments: rawData.metadata.quoteComments || rawData.metadata.quoteDescription || '',
                                programDescription: rawData.metadata.programDescription || '',
                                hiddenMarkup: rawData.metadata.hiddenMarkup || 0,
                                partnerCommission: rawData.metadata.partnerCommission || 0,
                                taxRate: rawData.metadata.taxRate || 0,
                                services: rawData.services || [],
                                version: rawData.version || '1.1.0',
                                appVersion: rawData.appVersion || '2.2.0'
                            };
                        } else {
                            // Старый формат: поля на верхнем уровне
                            data = {
                                id: rawData.id || window.QuoteCalc.generateQuoteId(),
                                clientName: rawData.clientName || '',
                                clientPhone: rawData.clientPhone || '',
                                clientEmail: rawData.clientEmail || '',
                                paxCount: rawData.paxCount || 27,
                                tourStart: rawData.tourStart || '',
                                tourEnd: rawData.tourEnd || '',
                                // Миграция: quoteDescription → quoteComments
                                quoteComments: rawData.quoteComments || rawData.quoteDescription || '',
                                programDescription: rawData.programDescription || '',
                                hiddenMarkup: rawData.hiddenMarkup || 0,
                                partnerCommission: rawData.partnerCommission || 0,
                                taxRate: rawData.taxRate || 0,
                                services: rawData.services || [],
                                version: rawData.version || '1.0.0',
                                appVersion: rawData.appVersion || '2.1.0'
                            };
                        }

                        // Генерируем имя файла
                        const filename = window.QuoteCalc.generateFilenameWithId(data);

                        // ID-First: сохранение по ID
                        await apiClient.saveEstimate(data.id, data);

                        // Закрываем модальное окно и загружаем импортированную смету
                        document.getElementById('estimates-modal').style.display = 'none';
                        await window.QuoteCalc.loadQuoteFromServer(data.id);
                        window.QuoteCalc.showNotification('Смета импортирована: ' + filename, false);
                    } catch (err) {
                        console.error('Error parsing JSON:', err);
                        window.QuoteCalc.showNotification('Ошибка чтения файла: ' + err.message, true);
                    }
                };
                reader.readAsText(file);
            } catch (err) {
                console.error('Error importing file:', err);
                window.QuoteCalc.showNotification('Ошибка импорта: ' + err.message, true);
            }
        };

        // Оборачиваем импорт с ErrorBoundary
        (function() {
            const originalImport = window.importQuoteFile;
            if (originalImport) {
                window.importQuoteFile = errorBoundary.wrapAsync(
                    originalImport,
                    'import'
                );
                console.log('[ErrorBoundary] Wrapped importQuoteFile');
            }
        })();

        // Инициализация серверной интеграции
        // ВАЖНО: Код уже внутри window.addEventListener('load'), поэтому DOM точно загружен
        // Обработчики модального окна
            const closeBtn = document.getElementById('close-estimates-modal');
            const modal = document.getElementById('estimates-modal');

            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }

            if (modal) {
                // Закрытие по клику вне модального окна
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            }

            // Обработчики переключения вкладок
            const tabs = ['estimates', 'backups', 'import'];
            tabs.forEach(tabName => {
                const tabBtn = document.getElementById(`tab-${tabName}`);
                if (tabBtn) {
                    tabBtn.addEventListener('click', function() {
                        // Убираем активный класс со всех вкладок
                        document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
                        // Скрываем весь контент
                        document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

                        // Активируем текущую вкладку
                        this.classList.add('active');
                        document.getElementById(`content-${tabName}`).style.display = 'block';

                        // Загружаем данные для вкладки
                        if (tabName === 'estimates') {
                            window.showEstimatesList();
                        } else if (tabName === 'backups') {
                            window.showBackupsList();
                        }
                    });
                }
            });

            // Обработчик кнопки импорта
            const importBtn = document.getElementById('import-file-btn');
            const importInput = document.getElementById('import-file-input');

            if (importBtn && importInput) {
                importBtn.addEventListener('click', function() {
                    importInput.click();
                });

                importInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        window.importQuoteFile(file);
                    }
                    // Сбрасываем input чтобы можно было импортировать тот же файл снова
                    e.target.value = '';
                });
            }

        // Серверная интеграция успешно активирована
        // Глобальные функции определены и доступны
        console.log('[Init] All systems initialized');
        }); // конец window.addEventListener('load')
    </script>
</body>
</html>